<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2024-09-16 Mon 09:58 -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Do notation for TypeScript</title>
<meta name="author" content="Michael Newton" />
<meta name="generator" content="Org Mode" />
<link rel="stylesheet" href="/org.css">
<script src="/htmx.min.js"></script>
</head>
<body hx-boost="true">
<div id="org-div-home-and-up"><span class="home-text"><a accesskey="H" href="/">HOME</span><img class="home-logo" src="http://blog.mavnn.co.uk/images/swirl.svg" /></a></div><div id="content" class="container">
<header>
<h1 class="title">Do notation for TypeScript</h1>
</header><blockquote>
<p>
This post is still here as an interesting deep dive into the mechanics of using TypeScript's type system, but
if what you're really looking for is a production ready async/result/state monad for TypeScript I'd strongly
recommend the Effect TS library rather than rolling your own - now I know it exists.
</p>

<p>
I've written a brief introduction here: <a href="../../../2024/09/16/intro_to_effect_ts.html">A gentle introduction to Effect TS</a>.
</p>
</blockquote>

<p>
This is rather an aside from recent blog posts, but something I found interesting none the less.
</p>

<p>
Fair warning to start us off: this post assumes that you are aware of and understand "do notation" (or "computational expressions" or "monad syntax") and like the idea of having it available in TypeScript.
</p>

<p>
It starts by working through a possible way of implementing a type safe representation of a sequence of monadic operations that has a much nicer user experience than nested continuation functions, and then leads into a lengthy example of both building and showing how to use a monad which I've found very useful when working in TypeScript for handling asynchronous code that needs to meaningfully respond to both successes and failures.
</p>

<p>
The idea is that we're going to go from code that looks like this:
</p>

<div class="org-src-container">
<pre class="src src-typescript"><span class="org-keyword">export</span> <span class="org-keyword">const</span> <span class="org-variable-name">processLaxCallback</span> = <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">{</span>
  laxOperations,
  commands,
  localFunctions,
<span class="org-rainbow-delimiters-depth-2">}</span>: <span class="org-type">LaxCallbackDependencies</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-keyword">=&gt;</span> <span class="org-keyword">async</span> <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-variable-name">httpRequest</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-keyword">=&gt;</span> <span class="org-rainbow-delimiters-depth-1">{</span>
  <span class="org-keyword">try</span> <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">const</span> <span class="org-variable-name">laxSignatureCheck</span> = <span class="org-keyword">await</span> laxOperations.<span class="org-function-name">checkSignature</span><span class="org-rainbow-delimiters-depth-3">(</span>httpRequest<span class="org-rainbow-delimiters-depth-3">)</span>
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-function-name">isFailure</span><span class="org-rainbow-delimiters-depth-4">(</span>signature<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-3">{</span>
      <span class="org-keyword">await</span> <span class="org-function-name">reportError</span><span class="org-rainbow-delimiters-depth-4">(</span>signature<span class="org-rainbow-delimiters-depth-4">)</span>
      <span class="org-keyword">return</span>
    <span class="org-rainbow-delimiters-depth-3">}</span>
    <span class="org-keyword">const</span> <span class="org-variable-name">laxContext</span> = laxOperations.<span class="org-function-name">parseRequest</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-rainbow-delimiters-depth-4">{</span> httpRequest, laxSignatureCheck <span class="org-rainbow-delimiters-depth-4">}</span><span class="org-rainbow-delimiters-depth-3">)</span>
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-function-name">isFailure</span><span class="org-rainbow-delimiters-depth-4">(</span>laxContext<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-3">{</span>
      <span class="org-keyword">await</span> <span class="org-function-name">reportError</span><span class="org-rainbow-delimiters-depth-4">(</span>laxContext<span class="org-rainbow-delimiters-depth-4">)</span>
      <span class="org-keyword">return</span>
    <span class="org-rainbow-delimiters-depth-3">}</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">...continued</span>
  <span class="org-rainbow-delimiters-depth-2">}</span> <span class="org-keyword">catch</span> <span class="org-rainbow-delimiters-depth-2">(</span>e<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">... etc</span>
  <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>

</pre>
</div>

<p>
&#x2026;to code that looks more like this:
</p>

<div class="org-src-container">
<pre class="src src-typescript"><span class="org-keyword">export</span> <span class="org-keyword">const</span> <span class="org-variable-name">processLaxCallback</span> = <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">{</span>
  laxOperations,
  commands,
  localFunctions,
<span class="org-rainbow-delimiters-depth-2">}</span>: <span class="org-type">LaxCallbackDependencies</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-keyword">=&gt;</span>
  SolidChain.<span class="org-function-name">start</span>&lt;<span class="org-rainbow-delimiters-depth-1">{</span> httpRequest: <span class="org-type">HttpRequest</span> <span class="org-rainbow-delimiters-depth-1">}</span>, LaxCallBackState&gt;<span class="org-rainbow-delimiters-depth-1">()</span>
    .<span class="org-function-name">chain</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"laxSignatureCheck"</span>, laxOperations.checkSignature<span class="org-rainbow-delimiters-depth-1">)</span>
    .<span class="org-function-name">chain</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"laxContext"</span>, laxOperations.parseRequest<span class="org-rainbow-delimiters-depth-1">)</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">...continued</span>
</pre>
</div>

<p>
If you're impatient you can jump straight to <a href="#orgba88beb">appendix 2</a> where you will find a cut and pastable code block with everything you need to play with the code in the TypeScript editor of your choice.
</p>

<p>
For the avoidance of any doubt, all the code in this blog post is available for re-use under the MIT license as list in <a href="#orgd41e717">appendix 3</a>.
</p>

<div id="outline-container-org5010577" class="outline-2">
<h2 id="org5010577">The idea</h2>
<div class="outline-text-2" id="text-org5010577">
<p>
TypeScript has one form of monad notation already - the <code>await</code> keyword. Unfortunately, there isn't any way to plug into the mechanism used and define your own alternative <code>bind</code> implementation without doing something dangerously hacky. And, frankly, the last thing your TypeScript code needs is an other sharp edge to cut yourself on.
</p>

<p>
But&#x2026; what does binding a value in monad notation really do? It doesn't allow you to write code you couldn't have written anyway long hand. It allows you to give the result of a calculation in your code in name in the current scope.
</p>

<p>
So: if we consider the fact that a scope is really just a mapping from names to values, and that TypeScript allows function inputs to alter the type of their output&#x2026; maybe we can do something with that?
</p>
</div>
</div>

<div id="outline-container-org9fba969" class="outline-2">
<h2 id="org9fba969">Defining a scope</h2>
<div class="outline-text-2" id="text-org9fba969">
<p>
A type that maps names to values is reasonably easy to define in TypeScript. It looks something like this:
</p>

<div class="org-src-container">
<pre class="src src-typescript"><span class="org-keyword">export</span> <span class="org-keyword">type</span> <span class="org-type">Scope</span>&lt;<span class="org-type">Keys</span> <span class="org-typescript-access-modifier">extends</span> <span class="org-typescript-primitive">string</span>&gt; = <span class="org-rainbow-delimiters-depth-1">{</span>
  <span class="org-rainbow-delimiters-depth-2">[</span>K <span class="org-keyword">in</span> Keys<span class="org-rainbow-delimiters-depth-2">]</span>: <span class="org-typescript-primitive">any</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>;
</pre>
</div>

<p>
We can say that anything we're willing to consider as a scope is a type that extends the type above: it will have some keys, which will all be strings, and they will map to some values, which will all be sub types of <code>any</code>.
</p>

<p>
Now we need a type safe way to add a value to the scope.
</p>

<p>
We start with a calculated type which works out what the result of adding a value with a name to a scope should be:
</p>

<div class="org-src-container">
<pre class="src src-typescript"><span class="org-keyword">export</span> <span class="org-keyword">type</span> <span class="org-type">ExtendedScope</span>&lt;
  OldScope <span class="org-typescript-access-modifier">extends</span> <span class="org-type">Scope</span>&lt;<span class="org-typescript-primitive">any</span>&gt;,
  NewField <span class="org-typescript-access-modifier">extends</span> <span class="org-typescript-primitive">string</span>,
  NewValue
&gt; = OldScope <span class="org-typescript-access-modifier">extends</span> <span class="org-typescript-primitive">any</span>
  ? <span class="org-rainbow-delimiters-depth-1">{</span>
      <span class="org-rainbow-delimiters-depth-2">[</span>K <span class="org-keyword">in</span> <span class="org-keyword">keyof</span> OldScope | NewField<span class="org-rainbow-delimiters-depth-2">]</span>: K <span class="org-typescript-access-modifier">extends</span> <span class="org-type">NewField</span>
        ? NewValue
        : K <span class="org-typescript-access-modifier">extends</span> <span class="org-keyword">keyof</span> OldScope
        ? OldScope<span class="org-rainbow-delimiters-depth-2">[</span>K<span class="org-rainbow-delimiters-depth-2">]</span>
        : <span class="org-typescript-primitive">never</span>;
    <span class="org-rainbow-delimiters-depth-1">}</span>
  : <span class="org-typescript-primitive">never</span>;
</pre>
</div>


<p>
<details><summary>
&#x2026;doesn't <code>OldScope</code> always extend <code>any</code>?
</summary><div class="outline-text-2">
</p>

<p>
Well, yes. But it turns out that wrapping the calculated type in a check (even one which is always true) forces <code>tsc</code> to calculate what the resulting type should be.
</p>

<p>
This makes no difference to what code <code>tsc</code> considers correct, but a big difference to how it shows it in an editor; instead of:
</p>

<div class="org-src-container">
<pre class="src src-typescript">ExtendedScope&lt;<span class="org-type">ExtendedScope</span>&lt;<span class="org-rainbow-delimiters-depth-1">{</span> <span class="org-type">aDate</span>: <span class="org-type">DateTime</span> <span class="org-rainbow-delimiters-depth-1">}</span>, <span class="org-string">"aNumber"</span>, <span class="org-typescript-primitive">number</span>&gt;, <span class="org-string">"aString"</span>, <span class="org-typescript-primitive">string</span>&gt;
</pre>
</div>

<p>
&#x2026;tool tips and error messages will show:
</p>

<div class="org-src-container">
<pre class="src src-typescript"><span class="org-rainbow-delimiters-depth-1">{</span>
    aDate: <span class="org-type">DateTime</span>,
    aNumber: <span class="org-typescript-primitive">number</span>,
    aString: <span class="org-typescript-primitive">string</span>
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
&#x2026;which is a heck of a lot easier to work with.
</p>

<p>
</div></div></details>
</p>

<p>
This basically says we want a new type that has all the keys in the old scope <i>and</i> the new key, and the fields in the new context are the same type as the old context except the field that has the name <code>NewField</code> which will be of type <code>NewValue</code>.
</p>

<p>
Now we can write a wrapper function that actually does the work at runtime:
</p>

<div class="org-src-container">
<pre class="src src-typescript"><span class="org-keyword">export</span> <span class="org-keyword">const</span> <span class="org-variable-name">extendScope</span> = &lt;
  OldScope <span class="org-typescript-access-modifier">extends</span> <span class="org-type">Scope</span>&lt;<span class="org-typescript-primitive">any</span>&gt;,
  NewField <span class="org-typescript-access-modifier">extends</span> <span class="org-typescript-primitive">string</span>,
  NewValue
&gt;<span class="org-rainbow-delimiters-depth-1">(</span>
  <span class="org-variable-name">oldScope</span>: <span class="org-type">OldScope</span>,
  <span class="org-variable-name">newField</span>: <span class="org-type">NewField</span>,
  <span class="org-variable-name">newValue</span>: <span class="org-type">NewValue</span>
<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-keyword">=&gt;</span> <span class="org-rainbow-delimiters-depth-1">{</span>
  <span class="org-keyword">const</span> <span class="org-variable-name">addToScope</span> = <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-rainbow-delimiters-depth-3">[</span>newField<span class="org-rainbow-delimiters-depth-3">]</span>: newValue,
  <span class="org-rainbow-delimiters-depth-2">}</span>;
  <span class="org-keyword">return</span> <span class="org-rainbow-delimiters-depth-2">{</span>
    ...oldScope,
    ...addToScope,
  <span class="org-rainbow-delimiters-depth-2">}</span> <span class="org-keyword">as</span> ExtendedScope&lt;<span class="org-type">OldScope</span>, <span class="org-type">NewField</span>, <span class="org-type">NewValue</span>&gt;;
<span class="org-rainbow-delimiters-depth-1">}</span>;
</pre>
</div>

<p>
You may be wondering why we bothered with the type definition above given that <code>tsc</code> will try and infer the type of a "splat" like the one we return above.
</p>

<p>
<details><summary>
The short answer is: <code>tsc</code> infers it wrong.
</summary><div class="outline-text-2">
</p>

<p>
The longer answer is: <code>tsc</code> infers it wrong when <code>NewField</code> is the same as an existing field name, but <code>NewValue</code> is different to the type of that field on <code>OldContext</code>.
</p>

<p>
<code>tsc</code> always infers the result of splatting two generic objects (<code>A</code> and <code>B</code>) as being <code>A &amp; B</code>. But if you think about an example like this one:
</p>

<div class="org-src-container">
<pre class="src src-typescript"><span class="org-keyword">type</span> <span class="org-type">AString</span> = <span class="org-rainbow-delimiters-depth-1">{</span> myField: <span class="org-typescript-primitive">string</span> <span class="org-rainbow-delimiters-depth-1">}</span>;
<span class="org-keyword">type</span> <span class="org-type">ANumber</span> = <span class="org-rainbow-delimiters-depth-1">{</span> myField: <span class="org-typescript-primitive">number</span> <span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-keyword">const</span> <span class="org-variable-name">splat</span> = &lt;A, <span class="org-variable-name">B</span>&gt;<span class="org-rainbow-delimiters-depth-1">(</span>a: A, b: B<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-keyword">=&gt;</span> <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">{</span> ...a, ...b <span class="org-rainbow-delimiters-depth-2">}</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-keyword">const</span> <span class="org-variable-name">result</span> = <span class="org-function-name">splat</span>&lt;<span class="org-type">AString</span>, <span class="org-type">ANumber</span>&gt;<span class="org-rainbow-delimiters-depth-1">(</span>
  <span class="org-rainbow-delimiters-depth-2">{</span> myField: <span class="org-string">"hello"</span> <span class="org-rainbow-delimiters-depth-2">}</span>,
  <span class="org-rainbow-delimiters-depth-2">{</span> myField: <span class="org-highlight-numbers-number">10</span> <span class="org-rainbow-delimiters-depth-2">}</span>,
<span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
You can see that <code>tsc</code> inferring the type of <code>result</code> as <code>AString &amp; ANumber</code> is obviously incorrect. Interestingly, it works out correctly that it is <code>ANumber</code> if you create the <code>splat</code> function with fixed types known at compile time, but that doesn't help us much here.
</div></details>
</p>

<p>
This is all starting to look quite hopeful with us now having a representation of a scope, and a type safe way to add values to it.
</p>
</div>
</div>

<div id="outline-container-org037d379" class="outline-2">
<h2 id="org037d379">Building an operation</h2>
<div class="outline-text-2" id="text-org037d379">
<p>
The next question we need to answer is what is this going to be the scope <i>of</i>. Monad friendly syntax normally binds names in the scope of a function body, so let's generalize that idea slightly (and with a lot of hand waving) to the idea of the scope of an operation.
</p>

<p>
We want to be able to do two main things with this operation: we want to be able to add steps to it (using the scope accumulated so far), and we want to be able to execute it. The idea of building up an operation like this brings to mind the appropriately named "builder" pattern, where we use a class with some state to "build" up the thing we want. I'm going to call the "add step" method <code>chain</code> (because it feels a fairly intuitive name for what's happening) and the "execute" method <code>execute</code> (no reason needed). To keep the theme, we'll call the builder class a <code>SomethingChain</code> where something is a monad.
</p>

<p>
If such a builder class were to exist, it would allow us to write code like this:
</p>

<div class="org-src-container">
<pre class="src src-typescript"><span class="org-keyword">export</span> <span class="org-keyword">const</span> <span class="org-variable-name">monadTest</span> = <span class="org-keyword">new</span> <span class="org-type">MonadChain</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">(</span>name: <span class="org-typescript-primitive">string</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">=&gt;</span>
  Monad.<span class="org-function-name">pure</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-rainbow-delimiters-depth-3">{</span> initialInput: name <span class="org-rainbow-delimiters-depth-3">}</span><span class="org-rainbow-delimiters-depth-2">)</span>,
<span class="org-rainbow-delimiters-depth-1">)</span>
  .<span class="org-function-name">chain</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"punctuation"</span>, <span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">=&gt;</span> <span class="org-type">Monad</span>.<span class="org-function-name">pure</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"!"</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
  .<span class="org-function-name">chain</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"finalGreeting"</span>, <span class="org-rainbow-delimiters-depth-2">(</span>scope<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">=&gt;</span>
    Monad.<span class="org-function-name">pure</span><span class="org-rainbow-delimiters-depth-2">(</span>
      <span class="org-string">`Hello ${scope.initialInput}${scope.punctuation}`</span>,
    <span class="org-rainbow-delimiters-depth-2">)</span>,
  <span class="org-rainbow-delimiters-depth-1">)</span>.execute;
</pre>
</div>

<p>
The type of <code>monadTest</code> above is a function that takes a string, and returns a monad value of an object with three string fields: "initialInput", "punctuation", and "finalGreeting". As you can see, each step in the chain adds to or overwrites a value in the scope while leaving the rest of the scope available for use later.
</p>

<p>
The pattern of how we implement the builder for each type of monad is going to be pretty much the same (that's the point), but we can also play some neat tricks based on the specific monad we're implementing. The magic is in the <code>chain</code> method, which wraps a perfectly normal "bind" with a call to <code>extendScope</code> from above. Let's see the pattern first in its purest possible form by creating an identity monad chain, along with some comments in the <code>chain</code> method.
</p>

<div class="org-src-container">
<pre class="src src-typescript"><span class="org-keyword">export</span> <span class="org-keyword">type</span> <span class="org-type">Monad</span>&lt;<span class="org-type">T</span>&gt; = T;

<span class="org-keyword">export</span> <span class="org-keyword">namespace</span> Monad <span class="org-rainbow-delimiters-depth-1">{</span>
  <span class="org-keyword">export</span> <span class="org-keyword">const</span> <span class="org-variable-name">bind</span> = &lt;A, <span class="org-variable-name">B</span>&gt;<span class="org-rainbow-delimiters-depth-2">(</span>
    <span class="org-variable-name">prev</span>: <span class="org-type">Monad</span>&lt;<span class="org-type">A</span>&gt;,
    <span class="org-variable-name">func</span>: <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-variable-name">prev</span>: A<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-keyword">=&gt;</span> <span class="org-type">Monad</span>&lt;<span class="org-type">B</span>&gt;,
  <span class="org-rainbow-delimiters-depth-2">)</span>: <span class="org-type">Monad</span>&lt;<span class="org-type">B</span>&gt; <span class="org-keyword">=&gt;</span> <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">return</span> <span class="org-function-name">func</span><span class="org-rainbow-delimiters-depth-3">(</span>prev<span class="org-rainbow-delimiters-depth-3">)</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>;
  <span class="org-keyword">export</span> <span class="org-keyword">const</span> <span class="org-variable-name">pure</span> = &lt;A,&gt;<span class="org-rainbow-delimiters-depth-2">(</span>value: A<span class="org-rainbow-delimiters-depth-2">)</span>: <span class="org-type">Monad</span>&lt;<span class="org-type">A</span>&gt; <span class="org-keyword">=&gt;</span> value;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-keyword">export</span> <span class="org-keyword">class</span> <span class="org-type">MonadChain</span>&lt;<span class="org-type">Input</span>, <span class="org-type">OutputScope</span> <span class="org-typescript-access-modifier">extends</span> <span class="org-type">Scope</span>&lt;<span class="org-typescript-primitive">any</span>&gt;&gt; <span class="org-rainbow-delimiters-depth-1">{</span>
  <span class="org-typescript-access-modifier">private</span> <span class="org-typescript-access-modifier">readonly</span> operation: <span class="org-rainbow-delimiters-depth-2">(</span>
    input: <span class="org-type">Input</span>,
  <span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">=&gt;</span> <span class="org-type">Monad</span>&lt;<span class="org-type">OutputScope</span>&gt;;
  <span class="org-keyword">constructor</span><span class="org-rainbow-delimiters-depth-2">(</span>
    starter: <span class="org-rainbow-delimiters-depth-3">(</span>input: <span class="org-type">Input</span><span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-keyword">=&gt;</span> <span class="org-type">Monad</span>&lt;<span class="org-type">OutputScope</span>&gt;,
  <span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-typescript-this">this</span>.operation = starter;
  <span class="org-rainbow-delimiters-depth-2">}</span>

  <span class="org-function-name">execute</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-variable-name">input</span>: <span class="org-type">Input</span><span class="org-rainbow-delimiters-depth-2">)</span>: <span class="org-type">Monad</span>&lt;<span class="org-type">OutputScope</span>&gt; <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">return</span> <span class="org-typescript-this">this</span>.<span class="org-function-name">operation</span><span class="org-rainbow-delimiters-depth-3">(</span>input<span class="org-rainbow-delimiters-depth-3">)</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>

  <span class="org-function-name">chain</span>&lt;<span class="org-type">NextOutput</span>, <span class="org-type">ResultName</span> <span class="org-typescript-access-modifier">extends</span> <span class="org-typescript-primitive">string</span>&gt;<span class="org-rainbow-delimiters-depth-2">(</span>
    <span class="org-variable-name">resultName</span>: <span class="org-type">ResultName</span>,
    <span class="org-variable-name">next</span>: <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-variable-name">previous</span>: <span class="org-type">OutputScope</span><span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-keyword">=&gt;</span> <span class="org-type">Monad</span>&lt;<span class="org-type">NextOutput</span>&gt;,
  <span class="org-rainbow-delimiters-depth-2">)</span>: <span class="org-type">MonadChain</span>&lt;
    Input,
    ExtendedScope&lt;<span class="org-type">OutputScope</span>, <span class="org-type">ResultName</span>, <span class="org-type">NextOutput</span>&gt;
  &gt; <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">We need to build the operation to pass to</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">the constructor of the chain we're going</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">to return</span>
    <span class="org-keyword">const</span> <span class="org-variable-name">chainedOperation</span> = <span class="org-rainbow-delimiters-depth-3">(</span>
      <span class="org-variable-name">input</span>: <span class="org-type">Input</span>,
    <span class="org-rainbow-delimiters-depth-3">)</span>: <span class="org-type">Monad</span>&lt;
      ExtendedScope&lt;<span class="org-type">OutputScope</span>, <span class="org-type">ResultName</span>, <span class="org-type">NextOutput</span>&gt;
    &gt; <span class="org-keyword">=&gt;</span> <span class="org-rainbow-delimiters-depth-3">{</span>
      <span class="org-comment-delimiter">// </span><span class="org-comment">Get the monadic value of the chain</span>
      <span class="org-comment-delimiter">// </span><span class="org-comment">up to this point.</span>
      <span class="org-keyword">const</span> <span class="org-variable-name">previousResult</span> = <span class="org-typescript-this">this</span>.<span class="org-function-name">operation</span><span class="org-rainbow-delimiters-depth-4">(</span>input<span class="org-rainbow-delimiters-depth-4">)</span>;
      <span class="org-keyword">return</span> Monad.<span class="org-function-name">bind</span><span class="org-rainbow-delimiters-depth-4">(</span>
        previousResult,
        <span class="org-rainbow-delimiters-depth-5">(</span><span class="org-variable-name">output</span>: <span class="org-type">OutputScope</span><span class="org-rainbow-delimiters-depth-5">)</span> <span class="org-keyword">=&gt;</span> <span class="org-rainbow-delimiters-depth-5">{</span>
          <span class="org-comment-delimiter">// </span><span class="org-comment">Use the output from the chain so far /twice/.</span>
          <span class="org-comment-delimiter">// </span><span class="org-comment">The first time to work out the new value that is</span>
          <span class="org-comment-delimiter">// </span><span class="org-comment">going to be added to the scope, and the second</span>
          <span class="org-comment-delimiter">// </span><span class="org-comment">time to as the starting scope passed to ~extendScope~</span>
          <span class="org-keyword">return</span> Monad.<span class="org-function-name">bind</span><span class="org-rainbow-delimiters-depth-6">(</span><span class="org-function-name">next</span><span class="org-rainbow-delimiters-depth-7">(</span>output<span class="org-rainbow-delimiters-depth-7">)</span>, <span class="org-rainbow-delimiters-depth-7">(</span><span class="org-variable-name">nextOutput</span><span class="org-rainbow-delimiters-depth-7">)</span> <span class="org-keyword">=&gt;</span> <span class="org-rainbow-delimiters-depth-7">{</span>
            <span class="org-keyword">return</span> Monad.<span class="org-function-name">pure</span><span class="org-rainbow-delimiters-depth-8">(</span>
              <span class="org-function-name">extendScope</span><span class="org-rainbow-delimiters-depth-9">(</span>output, resultName, nextOutput<span class="org-rainbow-delimiters-depth-9">)</span>,
            <span class="org-rainbow-delimiters-depth-8">)</span>;
          <span class="org-rainbow-delimiters-depth-7">}</span><span class="org-rainbow-delimiters-depth-6">)</span>;
        <span class="org-rainbow-delimiters-depth-5">}</span>,
      <span class="org-rainbow-delimiters-depth-4">)</span>;
    <span class="org-rainbow-delimiters-depth-3">}</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">Wrap the function back into the builder class</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">so we can carry on calling chain on it</span>
    <span class="org-keyword">return</span> <span class="org-keyword">new</span> <span class="org-type">MonadChain</span><span class="org-rainbow-delimiters-depth-3">(</span>chainedOperation<span class="org-rainbow-delimiters-depth-3">)</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orge71e352" class="outline-2">
<h2 id="orge71e352">Some working examples</h2>
<div class="outline-text-2" id="text-orge71e352">
</div>
<div id="outline-container-orgeef3b94" class="outline-3">
<h3 id="orgeef3b94">Maybe</h3>
<div class="outline-text-3" id="text-orgeef3b94">
<p>
Let's start with the classics. Tried of handling nulls and undefined manually? Redefine our bind method and we're done: apart from changing the name, nothing else changes.
</p>

<div class="org-src-container">
<pre class="src src-typescript"><span class="org-keyword">export</span> <span class="org-keyword">type</span> <span class="org-type">Maybe</span>&lt;<span class="org-type">T</span>&gt; = T | <span class="org-constant">null</span> | <span class="org-constant">undefined</span>;

<span class="org-keyword">export</span> <span class="org-keyword">namespace</span> Maybe <span class="org-rainbow-delimiters-depth-1">{</span>
  <span class="org-keyword">export</span> <span class="org-keyword">const</span> <span class="org-variable-name">bind</span> = &lt;A, <span class="org-variable-name">B</span>&gt;<span class="org-rainbow-delimiters-depth-2">(</span>
    <span class="org-variable-name">prev</span>: <span class="org-type">Maybe</span>&lt;<span class="org-type">A</span>&gt;,
    <span class="org-variable-name">func</span>: <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-variable-name">prev</span>: A<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-keyword">=&gt;</span> <span class="org-type">Maybe</span>&lt;<span class="org-type">B</span>&gt;,
  <span class="org-rainbow-delimiters-depth-2">)</span>: <span class="org-type">Maybe</span>&lt;<span class="org-type">B</span>&gt; <span class="org-keyword">=&gt;</span> <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>prev === <span class="org-constant">null</span> || prev === <span class="org-constant">undefined</span><span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-3">{</span>
        <span class="org-keyword">return</span> <span class="org-constant">null</span>;
    <span class="org-rainbow-delimiters-depth-3">}</span> <span class="org-keyword">else</span> <span class="org-rainbow-delimiters-depth-3">{</span>
        <span class="org-keyword">return</span> <span class="org-function-name">func</span><span class="org-rainbow-delimiters-depth-4">(</span>prev<span class="org-rainbow-delimiters-depth-4">)</span>;
    <span class="org-rainbow-delimiters-depth-3">}</span>
  <span class="org-rainbow-delimiters-depth-2">}</span>;
  <span class="org-keyword">export</span> <span class="org-keyword">const</span> <span class="org-variable-name">pure</span> = &lt;A,&gt;<span class="org-rainbow-delimiters-depth-2">(</span>value: A<span class="org-rainbow-delimiters-depth-2">)</span>: <span class="org-type">Maybe</span>&lt;<span class="org-type">A</span>&gt; <span class="org-keyword">=&gt;</span> value;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>


<p>
<details><summary>
The rest of the code is behind the cut to avoid us being too repetitive.
</summary><div class="outline-text-2">
</p>

<div class="org-src-container">
<pre class="src src-typescript"> <span class="org-keyword">export</span> <span class="org-keyword">class</span> <span class="org-type">MaybeChain</span>&lt;<span class="org-type">Input</span>, <span class="org-type">OutputScope</span> <span class="org-typescript-access-modifier">extends</span> <span class="org-type">Scope</span>&lt;<span class="org-typescript-primitive">any</span>&gt;&gt; <span class="org-rainbow-delimiters-depth-1">{</span>
  <span class="org-typescript-access-modifier">private</span> <span class="org-typescript-access-modifier">readonly</span> operation: <span class="org-rainbow-delimiters-depth-2">(</span>
    input: <span class="org-type">Input</span>,
  <span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">=&gt;</span> <span class="org-type">Maybe</span>&lt;<span class="org-type">OutputScope</span>&gt;;
  <span class="org-keyword">constructor</span><span class="org-rainbow-delimiters-depth-2">(</span>
    starter: <span class="org-rainbow-delimiters-depth-3">(</span>input: <span class="org-type">Input</span><span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-keyword">=&gt;</span> <span class="org-type">Maybe</span>&lt;<span class="org-type">OutputScope</span>&gt;,
  <span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-typescript-this">this</span>.operation = starter;
  <span class="org-rainbow-delimiters-depth-2">}</span>

  <span class="org-function-name">execute</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-variable-name">input</span>: <span class="org-type">Input</span><span class="org-rainbow-delimiters-depth-2">)</span>: <span class="org-type">Maybe</span>&lt;<span class="org-type">OutputScope</span>&gt; <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">return</span> <span class="org-typescript-this">this</span>.<span class="org-function-name">operation</span><span class="org-rainbow-delimiters-depth-3">(</span>input<span class="org-rainbow-delimiters-depth-3">)</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>

  <span class="org-function-name">chain</span>&lt;<span class="org-type">NextOutput</span>, <span class="org-type">ResultName</span> <span class="org-typescript-access-modifier">extends</span> <span class="org-typescript-primitive">string</span>&gt;<span class="org-rainbow-delimiters-depth-2">(</span>
    <span class="org-variable-name">resultName</span>: <span class="org-type">ResultName</span>,
    <span class="org-variable-name">next</span>: <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-variable-name">previous</span>: <span class="org-type">OutputScope</span><span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-keyword">=&gt;</span> <span class="org-type">Maybe</span>&lt;<span class="org-type">NextOutput</span>&gt;,
  <span class="org-rainbow-delimiters-depth-2">)</span>: <span class="org-type">MaybeChain</span>&lt;
    Input,
    ExtendedScope&lt;<span class="org-type">OutputScope</span>, <span class="org-type">ResultName</span>, <span class="org-type">NextOutput</span>&gt;
  &gt; <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">const</span> <span class="org-variable-name">chainedOperation</span> = <span class="org-rainbow-delimiters-depth-3">(</span>
      <span class="org-variable-name">input</span>: <span class="org-type">Input</span>,
    <span class="org-rainbow-delimiters-depth-3">)</span>: <span class="org-type">Maybe</span>&lt;
      ExtendedScope&lt;<span class="org-type">OutputScope</span>, <span class="org-type">ResultName</span>, <span class="org-type">NextOutput</span>&gt;
    &gt; <span class="org-keyword">=&gt;</span> <span class="org-rainbow-delimiters-depth-3">{</span>
      <span class="org-keyword">const</span> <span class="org-variable-name">previousResult</span> = <span class="org-typescript-this">this</span>.<span class="org-function-name">operation</span><span class="org-rainbow-delimiters-depth-4">(</span>input<span class="org-rainbow-delimiters-depth-4">)</span>;
      <span class="org-keyword">return</span> Maybe.<span class="org-function-name">bind</span><span class="org-rainbow-delimiters-depth-4">(</span>
        previousResult,
        <span class="org-rainbow-delimiters-depth-5">(</span><span class="org-variable-name">output</span>: <span class="org-type">OutputScope</span><span class="org-rainbow-delimiters-depth-5">)</span> <span class="org-keyword">=&gt;</span> <span class="org-rainbow-delimiters-depth-5">{</span>
          <span class="org-keyword">return</span> Maybe.<span class="org-function-name">bind</span><span class="org-rainbow-delimiters-depth-6">(</span><span class="org-function-name">next</span><span class="org-rainbow-delimiters-depth-7">(</span>output<span class="org-rainbow-delimiters-depth-7">)</span>, <span class="org-rainbow-delimiters-depth-7">(</span><span class="org-variable-name">nextOutput</span><span class="org-rainbow-delimiters-depth-7">)</span> <span class="org-keyword">=&gt;</span> <span class="org-rainbow-delimiters-depth-7">{</span>
            <span class="org-keyword">return</span> Maybe.<span class="org-function-name">pure</span><span class="org-rainbow-delimiters-depth-8">(</span>
              <span class="org-function-name">extendScope</span><span class="org-rainbow-delimiters-depth-9">(</span>output, resultName, nextOutput<span class="org-rainbow-delimiters-depth-9">)</span>,
            <span class="org-rainbow-delimiters-depth-8">)</span>;
          <span class="org-rainbow-delimiters-depth-7">}</span><span class="org-rainbow-delimiters-depth-6">)</span>;
        <span class="org-rainbow-delimiters-depth-5">}</span>,
      <span class="org-rainbow-delimiters-depth-4">)</span>;
    <span class="org-rainbow-delimiters-depth-3">}</span>;
    <span class="org-keyword">return</span> <span class="org-keyword">new</span> <span class="org-type">MaybeChain</span><span class="org-rainbow-delimiters-depth-3">(</span>chainedOperation<span class="org-rainbow-delimiters-depth-3">)</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-keyword">export</span> <span class="org-keyword">const</span> <span class="org-variable-name">maybeTest</span> = <span class="org-keyword">new</span> <span class="org-type">MaybeChain</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">(</span>name: <span class="org-typescript-primitive">string</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">=&gt;</span>
  Maybe.<span class="org-function-name">pure</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-rainbow-delimiters-depth-3">{</span> initialInput: name <span class="org-rainbow-delimiters-depth-3">}</span><span class="org-rainbow-delimiters-depth-2">)</span>,
<span class="org-rainbow-delimiters-depth-1">)</span>
  .<span class="org-function-name">chain</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"punctuation"</span>, <span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">=&gt;</span> <span class="org-type">Maybe</span>.<span class="org-function-name">pure</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"!"</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
  .<span class="org-function-name">chain</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"finalGreeting"</span>, <span class="org-rainbow-delimiters-depth-2">(</span>scope<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">=&gt;</span>
    Maybe.<span class="org-function-name">pure</span><span class="org-rainbow-delimiters-depth-2">(</span>
      <span class="org-string">`Hello ${scope.initialInput}${scope.punctuation}`</span>,
    <span class="org-rainbow-delimiters-depth-2">)</span>,
  <span class="org-rainbow-delimiters-depth-1">)</span>.execute; 
</pre>
</div>
<p>
</div></details>
</p>
</div>
</div>

<div id="outline-container-orgfa1e7d5" class="outline-3">
<h3 id="orgfa1e7d5">AsyncMaybe</h3>
<div class="outline-text-3" id="text-orgfa1e7d5">
<p>
Of course, TypeScript has fairly robust tools for handling null and undefined already. But they get pretty painfully verbose if you start needing to handle a lot of asynchronous calls. Chains to the rescue!
</p>

<p>
Our monad definition now looks like this:
</p>

<div class="org-src-container">
<pre class="src src-typescript"><span class="org-keyword">export</span> <span class="org-keyword">type</span> <span class="org-type">AsyncMaybe</span>&lt;<span class="org-type">T</span>&gt; = Promise&lt;<span class="org-type">T</span> | <span class="org-type">null</span> | <span class="org-type">undefined</span>&gt;;

<span class="org-keyword">export</span> <span class="org-keyword">namespace</span> AsyncMaybe <span class="org-rainbow-delimiters-depth-1">{</span>
  <span class="org-keyword">export</span> <span class="org-keyword">const</span> <span class="org-variable-name">bind</span> = <span class="org-keyword">async</span> &lt;<span class="org-type">A</span>, <span class="org-type">B</span>&gt;<span class="org-rainbow-delimiters-depth-2">(</span>
    <span class="org-variable-name">prevAsync</span>: <span class="org-type">AsyncMaybe</span>&lt;<span class="org-type">A</span>&gt;,
    <span class="org-variable-name">func</span>: <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-variable-name">prev</span>: A<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-keyword">=&gt;</span> <span class="org-type">AsyncMaybe</span>&lt;<span class="org-type">B</span>&gt;,
  <span class="org-rainbow-delimiters-depth-2">)</span>: <span class="org-type">AsyncMaybe</span>&lt;<span class="org-type">B</span>&gt; <span class="org-keyword">=&gt;</span> <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">const</span> <span class="org-variable-name">prev</span> = <span class="org-keyword">await</span> prevAsync
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>prev === <span class="org-constant">null</span> || prev === <span class="org-constant">undefined</span><span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-3">{</span>
        <span class="org-keyword">return</span> <span class="org-constant">null</span>;
    <span class="org-rainbow-delimiters-depth-3">}</span> <span class="org-keyword">else</span> <span class="org-rainbow-delimiters-depth-3">{</span>
        <span class="org-keyword">return</span> <span class="org-function-name">func</span><span class="org-rainbow-delimiters-depth-4">(</span>prev<span class="org-rainbow-delimiters-depth-4">)</span>;
    <span class="org-rainbow-delimiters-depth-3">}</span>
  <span class="org-rainbow-delimiters-depth-2">}</span>;
  <span class="org-keyword">export</span> <span class="org-keyword">const</span> <span class="org-variable-name">pure</span> = &lt;A,&gt;<span class="org-rainbow-delimiters-depth-2">(</span>value: A<span class="org-rainbow-delimiters-depth-2">)</span>: <span class="org-type">AsyncMaybe</span>&lt;<span class="org-type">A</span>&gt; <span class="org-keyword">=&gt;</span> <span class="org-type">Promise</span>.<span class="org-function-name">resolve</span><span class="org-rainbow-delimiters-depth-2">(</span>value<span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
After a quick search and replace, we can now use our chain to start writing significantly clearer code (in my opinion, anyway!).
</p>

<div class="org-src-container">
<pre class="src src-typescript"><span class="org-comment-delimiter">// </span><span class="org-comment">An interface representing some external services</span>
<span class="org-keyword">export</span> <span class="org-keyword">interface</span> <span class="org-type">MaybeData</span> <span class="org-rainbow-delimiters-depth-1">{</span>
  getName: <span class="org-rainbow-delimiters-depth-2">(</span>userId: <span class="org-typescript-primitive">string</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">=&gt;</span> <span class="org-type">Promise</span>&lt;<span class="org-typescript-primitive">string</span> | <span class="org-type">null</span>&gt;;
  getPunctuation: <span class="org-rainbow-delimiters-depth-2">(</span>
    name: <span class="org-typescript-primitive">string</span>,
  <span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">=&gt;</span> <span class="org-type">Promise</span>&lt;<span class="org-typescript-primitive">string</span> | <span class="org-type">undefined</span>&gt;;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Without Chain</span>
<span class="org-keyword">export</span> <span class="org-keyword">const</span> <span class="org-variable-name">before</span> = <span class="org-keyword">async</span> <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">{</span>
  <span class="org-variable-name">userId</span>,
  <span class="org-variable-name">maybeData</span>,
<span class="org-rainbow-delimiters-depth-2">}</span>: <span class="org-rainbow-delimiters-depth-2">{</span>
  <span class="org-variable-name">userId</span>: <span class="org-typescript-primitive">string</span>;
  maybeData: <span class="org-type">MaybeData</span>;
<span class="org-rainbow-delimiters-depth-2">}</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-keyword">=&gt;</span> <span class="org-rainbow-delimiters-depth-1">{</span>
  <span class="org-keyword">const</span> <span class="org-variable-name">name</span> = <span class="org-keyword">await</span> maybeData.<span class="org-function-name">getName</span><span class="org-rainbow-delimiters-depth-2">(</span>userId<span class="org-rainbow-delimiters-depth-2">)</span>;
  <span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-2">(</span>name === <span class="org-constant">null</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">return</span> <span class="org-constant">null</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>
  <span class="org-keyword">const</span> <span class="org-variable-name">punctuation</span> = <span class="org-keyword">await</span> maybeData.<span class="org-function-name">getPunctuation</span><span class="org-rainbow-delimiters-depth-2">(</span>name<span class="org-rainbow-delimiters-depth-2">)</span>;
  <span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-2">(</span>punctuation === <span class="org-constant">undefined</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">return</span> <span class="org-constant">null</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>
  <span class="org-keyword">return</span> <span class="org-string">`Hello ${name}${punctuation}`</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">With Chain</span>
<span class="org-keyword">export</span> <span class="org-keyword">const</span> <span class="org-variable-name">after</span> = <span class="org-keyword">new</span> <span class="org-type">AsyncMaybeChain</span><span class="org-rainbow-delimiters-depth-1">(</span>
  AsyncMaybe.pure&lt;<span class="org-rainbow-delimiters-depth-2">{</span> userId: <span class="org-typescript-primitive">string</span>; maybeData: <span class="org-type">MaybeData</span> <span class="org-rainbow-delimiters-depth-2">}</span>&gt;,
<span class="org-rainbow-delimiters-depth-1">)</span>
  .<span class="org-function-name">chain</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"name"</span>, <span class="org-rainbow-delimiters-depth-2">(</span>s<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">=&gt;</span> s.maybeData.<span class="org-function-name">getName</span><span class="org-rainbow-delimiters-depth-2">(</span>s.userId<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
  .<span class="org-function-name">chain</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"punctuation"</span>, <span class="org-rainbow-delimiters-depth-2">(</span>s<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">=&gt;</span>
    s.maybeData.<span class="org-function-name">getPunctuation</span><span class="org-rainbow-delimiters-depth-2">(</span>s.name<span class="org-rainbow-delimiters-depth-2">)</span>,
  <span class="org-rainbow-delimiters-depth-1">)</span>
  .<span class="org-function-name">chain</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"result"</span>, <span class="org-rainbow-delimiters-depth-2">(</span>s<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">=&gt;</span>
    AsyncMaybe.<span class="org-function-name">pure</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">`${s.name}{s.punctuation}`</span><span class="org-rainbow-delimiters-depth-2">)</span>,
  <span class="org-rainbow-delimiters-depth-1">)</span>.execute;
</pre>
</div>

<p>
Nicer, but still not fully nice. The constructor looks a bit weird, it's annoying that we have to call <code>AsyncMaybe.pure</code> in the last step, and we're returning our entire internal scope at the end of every operation.
</p>

<p>
We can deal with each of these fairly easily though, because one thing the builder pattern is great at is providing an API for building things.
</p>

<p>
A static method gives us a more intuitive way of starting the chain:
</p>

<div class="org-src-container">
<pre class="src src-typescript"><span class="org-keyword">export</span> <span class="org-keyword">class</span> <span class="org-type">AsyncMaybeChain</span>&lt;
  Input,
  OutputScope <span class="org-typescript-access-modifier">extends</span> <span class="org-type">Scope</span>&lt;<span class="org-typescript-primitive">any</span>&gt;,
&gt; <span class="org-rainbow-delimiters-depth-1">{</span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">...snip rest of code...</span>

  <span class="org-typescript-access-modifier">static</span> start&lt;
    InputScope <span class="org-typescript-access-modifier">extends</span> <span class="org-type">Scope</span>&lt;<span class="org-typescript-primitive">any</span>&gt;,
  &gt;<span class="org-rainbow-delimiters-depth-2">()</span>: <span class="org-type">AsyncMaybeChain</span>&lt;<span class="org-type">InputScope</span>, <span class="org-type">InputScope</span>&gt; <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">return</span> <span class="org-keyword">new</span> <span class="org-type">AsyncMaybeChain</span><span class="org-rainbow-delimiters-depth-3">(</span>AsyncMaybe.pure&lt;<span class="org-type">InputScope</span>&gt;<span class="org-rainbow-delimiters-depth-3">)</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
We can expose a map method on the chain to avoid having to manually wrap parts of the chain in <code>pure</code>:
</p>

<div class="org-src-container">
<pre class="src src-typescript"> <span class="org-function-name">map</span>&lt;<span class="org-type">NextOutput</span>, <span class="org-type">ResultName</span> <span class="org-typescript-access-modifier">extends</span> <span class="org-typescript-primitive">string</span>&gt;<span class="org-rainbow-delimiters-depth-1">(</span>
  <span class="org-variable-name">resultName</span>: <span class="org-type">ResultName</span>,
  <span class="org-variable-name">next</span>: <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-variable-name">previous</span>: <span class="org-type">OutputScope</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">=&gt;</span> <span class="org-type">NextOutput</span>,
<span class="org-rainbow-delimiters-depth-1">)</span>: <span class="org-type">AsyncMaybeChain</span>&lt;
  Input,
  ExtendedScope&lt;<span class="org-type">OutputScope</span>, <span class="org-type">ResultName</span>, <span class="org-type">NextOutput</span>&gt;
&gt; <span class="org-rainbow-delimiters-depth-1">{</span>
  <span class="org-keyword">return</span> <span class="org-typescript-this">this</span>.<span class="org-function-name">chain</span><span class="org-rainbow-delimiters-depth-2">(</span>resultName, <span class="org-rainbow-delimiters-depth-3">(</span>scope<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-keyword">=&gt;</span>
    AsyncMaybe.<span class="org-function-name">pure</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-function-name">next</span><span class="org-rainbow-delimiters-depth-4">(</span>scope<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>,
  <span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
And finally we can add an <code>executeTarget</code> method as an alternative to <code>execute</code> that returns only a single field from the scope.
</p>

<div class="org-src-container">
<pre class="src src-typescript"><span class="org-function-name">executeTarget</span>&lt;<span class="org-type">ResultName</span> <span class="org-typescript-access-modifier">extends</span> <span class="org-type">keyof</span> <span class="org-type">OutputScope</span>&gt;<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-variable-name">resultName</span>: <span class="org-type">ResultName</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-rainbow-delimiters-depth-1">{</span>
  <span class="org-keyword">return</span> <span class="org-rainbow-delimiters-depth-2">(</span>input: <span class="org-type">Input</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">=&gt;</span>
    AsyncMaybe.<span class="org-function-name">bind</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-typescript-this">this</span>.<span class="org-function-name">execute</span><span class="org-rainbow-delimiters-depth-3">(</span>input<span class="org-rainbow-delimiters-depth-3">)</span>, <span class="org-rainbow-delimiters-depth-3">(</span>outputScope<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-keyword">=&gt;</span>
      AsyncMaybe.<span class="org-function-name">pure</span><span class="org-rainbow-delimiters-depth-3">(</span>outputScope<span class="org-rainbow-delimiters-depth-4">[</span>resultName<span class="org-rainbow-delimiters-depth-4">]</span><span class="org-rainbow-delimiters-depth-3">)</span>
    <span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
This allows us to change our code to be just that bit cleaner and clearer:
</p>

<div class="org-src-container">
<pre class="src src-typescript"><span class="org-comment-delimiter">// </span><span class="org-comment">With Chain</span>
<span class="org-keyword">export</span> <span class="org-keyword">const</span> <span class="org-variable-name">after</span> = AsyncMaybeChain.start&lt;<span class="org-rainbow-delimiters-depth-1">{</span>
  userId: <span class="org-typescript-primitive">string</span>;
  maybeData: <span class="org-type">MaybeData</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>&gt;<span class="org-rainbow-delimiters-depth-1">()</span>
  .<span class="org-function-name">chain</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"name"</span>, <span class="org-rainbow-delimiters-depth-2">(</span>s<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">=&gt;</span> s.maybeData.<span class="org-function-name">getName</span><span class="org-rainbow-delimiters-depth-2">(</span>s.userId<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
  .<span class="org-function-name">chain</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"punctuation"</span>, <span class="org-rainbow-delimiters-depth-2">(</span>s<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">=&gt;</span>
    s.maybeData.<span class="org-function-name">getPunctuation</span><span class="org-rainbow-delimiters-depth-2">(</span>s.name<span class="org-rainbow-delimiters-depth-2">)</span>,
  <span class="org-rainbow-delimiters-depth-1">)</span>
  .<span class="org-function-name">map</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"result"</span>, <span class="org-rainbow-delimiters-depth-2">(</span>s<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">=&gt;</span> <span class="org-string">`${s.name}{s.punctuation}`</span><span class="org-rainbow-delimiters-depth-1">)</span>
  .<span class="org-function-name">executeTarget</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"result"</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>


<p>
<details><summary>
The full code is here if you want to be able to see it all in context.
</summary><div class="outline-text-2">
</p>

<div class="org-src-container">
<pre class="src src-typescript"><span class="org-keyword">export</span> <span class="org-keyword">type</span> <span class="org-type">AsyncMaybe</span>&lt;<span class="org-type">T</span>&gt; = Promise&lt;<span class="org-type">T</span> | <span class="org-type">null</span> | <span class="org-type">undefined</span>&gt;;

<span class="org-keyword">export</span> <span class="org-keyword">namespace</span> AsyncMaybe <span class="org-rainbow-delimiters-depth-1">{</span>
  <span class="org-keyword">export</span> <span class="org-keyword">const</span> <span class="org-variable-name">bind</span> = <span class="org-keyword">async</span> &lt;<span class="org-type">A</span>, <span class="org-type">B</span>&gt;<span class="org-rainbow-delimiters-depth-2">(</span>
    <span class="org-variable-name">prevAsync</span>: <span class="org-type">AsyncMaybe</span>&lt;<span class="org-type">A</span>&gt;,
    <span class="org-variable-name">func</span>: <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-variable-name">prev</span>: A<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-keyword">=&gt;</span> <span class="org-type">AsyncMaybe</span>&lt;<span class="org-type">B</span>&gt;,
  <span class="org-rainbow-delimiters-depth-2">)</span>: <span class="org-type">AsyncMaybe</span>&lt;<span class="org-type">B</span>&gt; <span class="org-keyword">=&gt;</span> <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">const</span> <span class="org-variable-name">prev</span> = <span class="org-keyword">await</span> prevAsync;
    <span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-3">(</span>prev === <span class="org-constant">null</span> || prev === <span class="org-constant">undefined</span><span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-3">{</span>
      <span class="org-keyword">return</span> <span class="org-constant">null</span>;
    <span class="org-rainbow-delimiters-depth-3">}</span> <span class="org-keyword">else</span> <span class="org-rainbow-delimiters-depth-3">{</span>
      <span class="org-keyword">return</span> <span class="org-function-name">func</span><span class="org-rainbow-delimiters-depth-4">(</span>prev<span class="org-rainbow-delimiters-depth-4">)</span>;
    <span class="org-rainbow-delimiters-depth-3">}</span>
  <span class="org-rainbow-delimiters-depth-2">}</span>;
  <span class="org-keyword">export</span> <span class="org-keyword">const</span> <span class="org-variable-name">pure</span> = &lt;A,&gt;<span class="org-rainbow-delimiters-depth-2">(</span>value: A<span class="org-rainbow-delimiters-depth-2">)</span>: <span class="org-type">AsyncMaybe</span>&lt;<span class="org-type">A</span>&gt; <span class="org-keyword">=&gt;</span>
    Promise.<span class="org-function-name">resolve</span><span class="org-rainbow-delimiters-depth-2">(</span>value<span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-keyword">export</span> <span class="org-keyword">class</span> <span class="org-type">AsyncMaybeChain</span>&lt;
  Input,
  OutputScope <span class="org-typescript-access-modifier">extends</span> <span class="org-type">Scope</span>&lt;<span class="org-typescript-primitive">any</span>&gt;,
&gt; <span class="org-rainbow-delimiters-depth-1">{</span>
  <span class="org-typescript-access-modifier">private</span> <span class="org-typescript-access-modifier">readonly</span> operation: <span class="org-rainbow-delimiters-depth-2">(</span>
    input: <span class="org-type">Input</span>,
  <span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">=&gt;</span> <span class="org-type">AsyncMaybe</span>&lt;<span class="org-type">OutputScope</span>&gt;;
  <span class="org-keyword">constructor</span><span class="org-rainbow-delimiters-depth-2">(</span>
    starter: <span class="org-rainbow-delimiters-depth-3">(</span>input: <span class="org-type">Input</span><span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-keyword">=&gt;</span> <span class="org-type">AsyncMaybe</span>&lt;<span class="org-type">OutputScope</span>&gt;,
  <span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-typescript-this">this</span>.operation = starter;
  <span class="org-rainbow-delimiters-depth-2">}</span>

  <span class="org-function-name">execute</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-variable-name">input</span>: <span class="org-type">Input</span><span class="org-rainbow-delimiters-depth-2">)</span>: <span class="org-type">AsyncMaybe</span>&lt;<span class="org-type">OutputScope</span>&gt; <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">return</span> <span class="org-typescript-this">this</span>.<span class="org-function-name">operation</span><span class="org-rainbow-delimiters-depth-3">(</span>input<span class="org-rainbow-delimiters-depth-3">)</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>

  <span class="org-function-name">chain</span>&lt;<span class="org-type">NextOutput</span>, <span class="org-type">ResultName</span> <span class="org-typescript-access-modifier">extends</span> <span class="org-typescript-primitive">string</span>&gt;<span class="org-rainbow-delimiters-depth-2">(</span>
    <span class="org-variable-name">resultName</span>: <span class="org-type">ResultName</span>,
    <span class="org-variable-name">next</span>: <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-variable-name">previous</span>: <span class="org-type">OutputScope</span><span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-keyword">=&gt;</span> <span class="org-type">AsyncMaybe</span>&lt;<span class="org-type">NextOutput</span>&gt;,
  <span class="org-rainbow-delimiters-depth-2">)</span>: <span class="org-type">AsyncMaybeChain</span>&lt;
    Input,
    ExtendedScope&lt;<span class="org-type">OutputScope</span>, <span class="org-type">ResultName</span>, <span class="org-type">NextOutput</span>&gt;
  &gt; <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">const</span> <span class="org-variable-name">chainedOperation</span> = <span class="org-rainbow-delimiters-depth-3">(</span>
      <span class="org-variable-name">input</span>: <span class="org-type">Input</span>,
    <span class="org-rainbow-delimiters-depth-3">)</span>: <span class="org-type">AsyncMaybe</span>&lt;
      ExtendedScope&lt;<span class="org-type">OutputScope</span>, <span class="org-type">ResultName</span>, <span class="org-type">NextOutput</span>&gt;
    &gt; <span class="org-keyword">=&gt;</span> <span class="org-rainbow-delimiters-depth-3">{</span>
      <span class="org-keyword">const</span> <span class="org-variable-name">previousResult</span> = <span class="org-typescript-this">this</span>.<span class="org-function-name">operation</span><span class="org-rainbow-delimiters-depth-4">(</span>input<span class="org-rainbow-delimiters-depth-4">)</span>;
      <span class="org-keyword">return</span> AsyncMaybe.<span class="org-function-name">bind</span><span class="org-rainbow-delimiters-depth-4">(</span>
        previousResult,
        <span class="org-rainbow-delimiters-depth-5">(</span><span class="org-variable-name">output</span>: <span class="org-type">OutputScope</span><span class="org-rainbow-delimiters-depth-5">)</span> <span class="org-keyword">=&gt;</span> <span class="org-rainbow-delimiters-depth-5">{</span>
          <span class="org-keyword">return</span> AsyncMaybe.<span class="org-function-name">bind</span><span class="org-rainbow-delimiters-depth-6">(</span>
            <span class="org-function-name">next</span><span class="org-rainbow-delimiters-depth-7">(</span>output<span class="org-rainbow-delimiters-depth-7">)</span>,
            <span class="org-rainbow-delimiters-depth-7">(</span><span class="org-variable-name">nextOutput</span><span class="org-rainbow-delimiters-depth-7">)</span> <span class="org-keyword">=&gt;</span> <span class="org-rainbow-delimiters-depth-7">{</span>
              <span class="org-keyword">return</span> AsyncMaybe.<span class="org-function-name">pure</span><span class="org-rainbow-delimiters-depth-8">(</span>
                <span class="org-function-name">extendScope</span><span class="org-rainbow-delimiters-depth-9">(</span>output, resultName, nextOutput<span class="org-rainbow-delimiters-depth-9">)</span>,
              <span class="org-rainbow-delimiters-depth-8">)</span>;
            <span class="org-rainbow-delimiters-depth-7">}</span>,
          <span class="org-rainbow-delimiters-depth-6">)</span>;
        <span class="org-rainbow-delimiters-depth-5">}</span>,
      <span class="org-rainbow-delimiters-depth-4">)</span>;
    <span class="org-rainbow-delimiters-depth-3">}</span>;
    <span class="org-keyword">return</span> <span class="org-keyword">new</span> <span class="org-type">AsyncMaybeChain</span><span class="org-rainbow-delimiters-depth-3">(</span>chainedOperation<span class="org-rainbow-delimiters-depth-3">)</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>

  <span class="org-function-name">map</span>&lt;<span class="org-type">NextOutput</span>, <span class="org-type">ResultName</span> <span class="org-typescript-access-modifier">extends</span> <span class="org-typescript-primitive">string</span>&gt;<span class="org-rainbow-delimiters-depth-2">(</span>
    <span class="org-variable-name">resultName</span>: <span class="org-type">ResultName</span>,
    <span class="org-variable-name">next</span>: <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-variable-name">previous</span>: <span class="org-type">OutputScope</span><span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-keyword">=&gt;</span> <span class="org-type">NextOutput</span>,
  <span class="org-rainbow-delimiters-depth-2">)</span>: <span class="org-type">AsyncMaybeChain</span>&lt;
    Input,
    ExtendedScope&lt;<span class="org-type">OutputScope</span>, <span class="org-type">ResultName</span>, <span class="org-type">NextOutput</span>&gt;
  &gt; <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">return</span> <span class="org-typescript-this">this</span>.<span class="org-function-name">chain</span><span class="org-rainbow-delimiters-depth-3">(</span>resultName, <span class="org-rainbow-delimiters-depth-4">(</span>scope<span class="org-rainbow-delimiters-depth-4">)</span> <span class="org-keyword">=&gt;</span>
      AsyncMaybe.<span class="org-function-name">pure</span><span class="org-rainbow-delimiters-depth-4">(</span><span class="org-function-name">next</span><span class="org-rainbow-delimiters-depth-5">(</span>scope<span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span>,
    <span class="org-rainbow-delimiters-depth-3">)</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>

  <span class="org-function-name">executeTarget</span>&lt;<span class="org-type">ResultName</span> <span class="org-typescript-access-modifier">extends</span> <span class="org-type">keyof</span> <span class="org-type">OutputScope</span>&gt;<span class="org-rainbow-delimiters-depth-2">(</span>
    <span class="org-variable-name">resultName</span>: <span class="org-type">ResultName</span>,
  <span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">return</span> <span class="org-rainbow-delimiters-depth-3">(</span>input: <span class="org-type">Input</span><span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-keyword">=&gt;</span>
      AsyncMaybe.<span class="org-function-name">bind</span><span class="org-rainbow-delimiters-depth-3">(</span>
        <span class="org-typescript-this">this</span>.<span class="org-function-name">execute</span><span class="org-rainbow-delimiters-depth-4">(</span>input<span class="org-rainbow-delimiters-depth-4">)</span>,
        <span class="org-rainbow-delimiters-depth-4">(</span>outputScope<span class="org-rainbow-delimiters-depth-4">)</span> <span class="org-keyword">=&gt;</span> outputScope<span class="org-rainbow-delimiters-depth-4">[</span>resultName<span class="org-rainbow-delimiters-depth-4">]</span>,
      <span class="org-rainbow-delimiters-depth-3">)</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>

  <span class="org-typescript-access-modifier">static</span> start&lt;
    InputScope <span class="org-typescript-access-modifier">extends</span> <span class="org-type">Scope</span>&lt;<span class="org-typescript-primitive">any</span>&gt;,
  &gt;<span class="org-rainbow-delimiters-depth-2">()</span>: <span class="org-type">AsyncMaybeChain</span>&lt;<span class="org-type">InputScope</span>, <span class="org-type">InputScope</span>&gt; <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">return</span> <span class="org-keyword">new</span> <span class="org-type">AsyncMaybeChain</span><span class="org-rainbow-delimiters-depth-3">(</span>AsyncMaybe.pure&lt;<span class="org-type">InputScope</span>&gt;<span class="org-rainbow-delimiters-depth-3">)</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>
<p>
</div></details>
</p>
</div>
</div>
</div>

<div id="outline-container-org04a2647" class="outline-2">
<h2 id="org04a2647">Diving deeper: handling errors with style and panache</h2>
<div class="outline-text-2" id="text-org04a2647">
<p>
For our last example we're going to both take things up a notch, and take a bit more advantage of TypeScript's type level programming.
</p>

<p>
We're going to create what I'm going to call, for brevity, the <code>Solid</code> monad. (Technically it's an asynchronous either state monad - mix and match order to taste - but that's a bit of a mouth full). This allows us to think about how to write our code in a slightly different way, separating out the logic of our "happy path" from error handling in a way that would be either very verbose or completely break type safety without some tooling like this builder.
</p>

<p>
Let's first look at the kind of use cases where this monad is useful. Imagine we've created an integration with the "Lax" messaging service, and now when a customer clicks a button in one of the messages we send out our code has to handle a call back from Lax. But we don't know anything about the incoming request initially. We don't know whether it actually comes from Lax, whether we can find the customer organization that the message was sent to, which user of Lax in that organization clicked the button, which user in our application that Lax user maps to&#x2026;
</p>

<p>
This uncertainty means there's also numerous ways this process could go wrong. Maybe the message isn't actually from Lax (who cryptographically sign their callback payloads). Maybe our database is down. Or maybe Bob clicked the button 30 seconds after Fred did and you can't do that thing anymore. We also need to respond differently and to different people depending on what has failed.
</p>

<p>
To deal with this, each step in the process can either succeed or fail. What we want to do in the case of failure is often highly dependent on both what type of failure has occurred and what information we already have available. As such, it's common to see code that either returns a union type of <code>Success | SemanticallyMeaningfulErrorType(s)</code> or where each operation in turn is wrapped in <code>try ... catch</code> blocks to respond to exceptions in context.
</p>

<p>
Normally in TypeScript the resulting code will end up looking something like this:
</p>

<div class="org-src-container">
<pre class="src src-typescript"><span class="org-keyword">export</span> <span class="org-keyword">const</span> <span class="org-variable-name">withoutChain</span> =
 <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">{</span> laxOperations, commands, localFunctions <span class="org-rainbow-delimiters-depth-2">}</span>: <span class="org-type">LaxCallbackDependencies</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-keyword">=&gt;</span>
 <span class="org-keyword">async</span> <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-variable-name">httpRequest</span>: <span class="org-type">HttpRequest</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-keyword">=&gt;</span> <span class="org-rainbow-delimiters-depth-1">{</span>
   <span class="org-keyword">const</span> <span class="org-variable-name">signatureOk</span> = <span class="org-keyword">await</span> laxOperations.<span class="org-function-name">checkSignature</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-rainbow-delimiters-depth-3">{</span> httpRequest <span class="org-rainbow-delimiters-depth-3">}</span><span class="org-rainbow-delimiters-depth-2">)</span>;
   <span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-2">(</span>signatureOk.result.kind !== <span class="org-string">"success"</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">{</span>
     <span class="org-type">console</span>.<span class="org-function-name">log</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"Error to internal logging service"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
     <span class="org-keyword">return</span>;
   <span class="org-rainbow-delimiters-depth-2">}</span>

   <span class="org-keyword">const</span> <span class="org-variable-name">laxContext</span> = <span class="org-keyword">await</span> laxOperations.<span class="org-function-name">parseRequest</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-rainbow-delimiters-depth-3">{</span>
     laxSignatureCheck: signatureOk.result.value,
   <span class="org-rainbow-delimiters-depth-3">}</span><span class="org-rainbow-delimiters-depth-2">)</span>;
   <span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-2">(</span>laxContext.result.kind !== <span class="org-string">"success"</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">{</span>
     <span class="org-type">console</span>.<span class="org-function-name">log</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"Error to internal logging service"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
     <span class="org-keyword">return</span>;
   <span class="org-rainbow-delimiters-depth-2">}</span>

   <span class="org-keyword">const</span> <span class="org-variable-name">command</span> = <span class="org-keyword">await</span> commands.<span class="org-function-name">parseUntrustedCommand</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-rainbow-delimiters-depth-3">{</span>
     untrustedCommand: laxContext.result.value.actionPayload,
   <span class="org-rainbow-delimiters-depth-3">}</span><span class="org-rainbow-delimiters-depth-2">)</span>;
   <span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-2">(</span>command.result.kind !== <span class="org-string">"success"</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">{</span>
     <span class="org-type">console</span>.<span class="org-function-name">log</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"Error to internal logging service"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
     <span class="org-comment-delimiter">// </span><span class="org-comment">Oh! We know how to contact the user now as well!</span>
     <span class="org-keyword">await</span> laxOperations.<span class="org-function-name">reply</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-rainbow-delimiters-depth-4">{</span>
       laxContext: laxContext.result.value,
       reply: <span class="org-string">"A suitable error message"</span> <span class="org-keyword">as</span> <span class="org-typescript-primitive">any</span>,
     <span class="org-rainbow-delimiters-depth-4">}</span><span class="org-rainbow-delimiters-depth-3">)</span>;
     <span class="org-keyword">return</span>;
   <span class="org-rainbow-delimiters-depth-2">}</span>

   <span class="org-comment-delimiter">// </span><span class="org-comment">... more code here ...</span>
 <span class="org-rainbow-delimiters-depth-1">}</span>;
</pre>
</div>

<p>
This code isn't ideal. Admittedly, it has one big advantage: anyone who has written any TypeScript can immediately see how it works. But it also has a number of flaws. The most important one is that it is so verbose, and in such a repetitive way, that it is actually hard to follow the flow of what the code "wants" to do - the sequence of operations that will be carried out if everything works as expected. Trying to work out how a particular type of error will be handled, or even which types of errors might occur, is even harder.
</p>

<p>
What if we could separate out the straight forward intent of our code on the one hand, but also ensure we handle all of the possible failure states? What if we could compose together multiple operations which each, individually, know how they might fail and end up with a larger operation that <i>still</i> knows all the ways it can fail.
</p>

<p>
Business logic that looks like this:
</p>

<div class="org-src-container">
<pre class="src src-typescript"><span class="org-keyword">export</span> <span class="org-keyword">const</span> <span class="org-variable-name">processLaxCallback</span> = <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">{</span>
  laxOperations,
  commands,
  localFunctions,
<span class="org-rainbow-delimiters-depth-2">}</span>: <span class="org-type">LaxCallbackDependencies</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-keyword">=&gt;</span>
  SolidChain.<span class="org-function-name">start</span>&lt;<span class="org-type">HttpRequest</span>, <span class="org-type">LaxCallBackState</span>&gt;<span class="org-rainbow-delimiters-depth-1">()</span>
    .<span class="org-function-name">chain</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"laxSignatureCheck"</span>, laxOperations.checkSignature<span class="org-rainbow-delimiters-depth-1">)</span>
    .<span class="org-function-name">chain</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"laxContext"</span>, laxOperations.parseRequest<span class="org-rainbow-delimiters-depth-1">)</span>
    .<span class="org-function-name">tap</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-rainbow-delimiters-depth-3">{</span> laxContext <span class="org-rainbow-delimiters-depth-3">}</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">=&gt;</span> <span class="org-type">Solid</span>.<span class="org-function-name">set</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"laxContext"</span>, laxContext<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
    .<span class="org-function-name">chain</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"command"</span>, <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-rainbow-delimiters-depth-3">{</span> laxContext <span class="org-rainbow-delimiters-depth-3">}</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">=&gt;</span>
      commands.<span class="org-function-name">parseUntrustedCommand</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-rainbow-delimiters-depth-3">{</span>
        untrustedCommand: laxContext.actionPayload,
      <span class="org-rainbow-delimiters-depth-3">}</span><span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-1">)</span>
    .<span class="org-function-name">chain</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"userInfo"</span>, laxOperations.findUserAndOrganization<span class="org-rainbow-delimiters-depth-1">)</span>
    .<span class="org-function-name">tap</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-rainbow-delimiters-depth-3">{</span> userInfo <span class="org-rainbow-delimiters-depth-3">}</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">=&gt;</span> <span class="org-type">Solid</span>.<span class="org-function-name">set</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"user"</span>, userInfo.user<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
    .<span class="org-function-name">tap</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-rainbow-delimiters-depth-3">{</span> userInfo <span class="org-rainbow-delimiters-depth-3">}</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">=&gt;</span> <span class="org-type">Solid</span>.<span class="org-function-name">set</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"organization"</span>, userInfo.organization<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
    .<span class="org-function-name">chain</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"eventsCaused"</span>, commands.executeCommand<span class="org-rainbow-delimiters-depth-1">)</span>
    .<span class="org-function-name">map</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"reply"</span>, localFunctions.createSuccessResponse<span class="org-rainbow-delimiters-depth-1">)</span>
    .<span class="org-function-name">tap</span><span class="org-rainbow-delimiters-depth-1">(</span>laxOperations.reply<span class="org-rainbow-delimiters-depth-1">)</span>
    .<span class="org-function-name">executeTarget</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"eventsCaused"</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
Once we've called our code, we can then exhaustively handle any errors it may have produced, safe in the knowledge that if any of the operations we're depending on add a new failure mode the compiler will force us to deal with them appropriately. This consolidates all of our error handling into an other clear and easy to read piece of code, generally looking something like the following:
</p>

<div class="org-src-container">
<pre class="src src-typescript"><span class="org-keyword">switch</span> <span class="org-rainbow-delimiters-depth-1">(</span>processResult.result.failure.<span class="org-keyword">type</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-rainbow-delimiters-depth-1">{</span>
  <span class="org-keyword">case</span> <span class="org-string">"NotPermitted"</span>:
    <span class="org-keyword">await</span> <span class="org-function-name">reportError</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"You can't do that"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">break</span>;
  <span class="org-keyword">case</span> <span class="org-string">"ValidationFailed"</span>:
    <span class="org-keyword">await</span> <span class="org-function-name">reportError</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"You sent the wrong information"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">break</span>;
  <span class="org-keyword">case</span> <span class="org-string">"UnrecognizedCommand"</span>:
    <span class="org-keyword">await</span> <span class="org-function-name">reportError</span><span class="org-rainbow-delimiters-depth-2">(</span>
      <span class="org-string">"Something is wrong with the message we sent you, sorry!"</span>
    <span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">break</span>;
  <span class="org-keyword">case</span> <span class="org-string">"OrganizationNotFound"</span>:
  <span class="org-keyword">case</span> <span class="org-string">"UserNotFound"</span>:
    <span class="org-keyword">await</span> <span class="org-function-name">reportError</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"You don't seem to be fully set up on Lax yet"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">break</span>;
  <span class="org-keyword">case</span> <span class="org-string">"UnableToParseLaxContext"</span>:
  <span class="org-keyword">case</span> <span class="org-string">"InvalidLaxSignature"</span>:
    <span class="org-keyword">await</span> <span class="org-function-name">reportError</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"Invalid callback"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">break</span>;
  <span class="org-keyword">case</span> <span class="org-string">"CouldNotContactLax"</span>:
    <span class="org-keyword">await</span> <span class="org-function-name">reportError</span><span class="org-rainbow-delimiters-depth-2">(</span>
      <span class="org-string">"We tried to send you a message, but something went wrong at Lax's end."</span>
    <span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">break</span>;
  <span class="org-keyword">case</span> <span class="org-string">"LaxRefusedReply"</span>:
    <span class="org-keyword">await</span> <span class="org-function-name">reportError</span><span class="org-rainbow-delimiters-depth-2">(</span>
      <span class="org-string">"We tried to send you a message but something went wrong on our end."</span>
    <span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">break</span>;
  <span class="org-keyword">case</span> <span class="org-string">"UnhandledException"</span>:
    <span class="org-keyword">await</span> <span class="org-function-name">reportError</span><span class="org-rainbow-delimiters-depth-2">(</span>
      <span class="org-string">"Something went wrong, our support staff will look into it"</span>
    <span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">break</span>;
  <span class="org-default">default</span>:
    <span class="org-comment-delimiter">// </span><span class="org-comment">this is just a function that takes and returns "never"</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">to enforce completeness</span>
    <span class="org-keyword">return</span> <span class="org-function-name">exhausted</span><span class="org-rainbow-delimiters-depth-2">(</span>processResult.result.failure<span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>


<p>
Let's do it! We need to both build out our monad, and then also think about how to write the code that uses it.
</p>
</div>

<div id="outline-container-org974a562" class="outline-3">
<h3 id="org974a562">The monad itself</h3>
<div class="outline-text-3" id="text-org974a562">
<p>
First let's build the monad we're going to need. To write the code we want to, we know that we need a few properties. Our operations will frequently be asynchronous, so we need to deal with that. They need to be able to declare how they can fail, so we need them to return a success or failure result type. And they need to be able to capture information during the operation <i>even if the operation then fails</i> so that we can make that information available during error handling.
</p>

<p>
Standing on the shoulders of giants, this sounds very much like we're talking about a state monad stacked on top of an either (sometimes called result) monad. The type of a state monad is a function that takes the state so far, and returns the state and a result. The either monad says that the result in question can be either a success or a failure.
</p>

<p>
We're going to place one more restriction on the "state" type, because in our case it will nearly always be true and it simplifies some of the types: all of the fields on the state object being passed through the operations are optional.
</p>

<p>
Let's try and model that as a type in TypeScript.
</p>

<div class="org-src-container">
<pre class="src src-typescript"><span class="org-keyword">export</span> <span class="org-keyword">type</span> <span class="org-type">SolidSuccess</span>&lt;<span class="org-type">Success</span>&gt; = <span class="org-rainbow-delimiters-depth-1">{</span>
  kind: <span class="org-string">"success"</span>;
  value: <span class="org-type">Success</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-keyword">export</span> <span class="org-keyword">type</span> <span class="org-type">SolidFailure</span>&lt;<span class="org-type">Failure</span>&gt; = <span class="org-rainbow-delimiters-depth-1">{</span>
  kind: <span class="org-string">"failure"</span>;
  failure: <span class="org-type">Failure</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-keyword">export</span> <span class="org-keyword">type</span> <span class="org-type">Solid</span>&lt;<span class="org-type">Success</span>, <span class="org-type">Failure</span>, <span class="org-type">State</span> <span class="org-typescript-access-modifier">extends</span> <span class="org-type">Scope</span>&lt;<span class="org-typescript-primitive">any</span>&gt;&gt; = <span class="org-rainbow-delimiters-depth-1">(</span>
  state: <span class="org-type">Partial</span>&lt;<span class="org-type">State</span>&gt;
<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-keyword">=&gt;</span> <span class="org-type">Promise</span>&lt;<span class="org-rainbow-delimiters-depth-1">{</span>
  state: <span class="org-type">Partial</span>&lt;<span class="org-type">State</span>&gt;;
  result: <span class="org-type">SolidSuccess</span>&lt;<span class="org-type">Success</span>&gt; | SolidFailure&lt;<span class="org-type">Failure</span>&gt;;
<span class="org-rainbow-delimiters-depth-1">}</span>&gt;;
</pre>
</div>

<p>
Now we need a bind and a pure method.
</p>

<div class="org-src-container">
<pre class="src src-typescript"><span class="org-keyword">export</span> <span class="org-keyword">const</span> <span class="org-variable-name">Solid</span> = <span class="org-rainbow-delimiters-depth-1">{</span>
  pure: &lt;Success, State <span class="org-typescript-access-modifier">extends</span> <span class="org-type">Scope</span>&lt;<span class="org-typescript-primitive">any</span>&gt;&gt;<span class="org-rainbow-delimiters-depth-2">(</span>
    <span class="org-variable-name">value</span>: <span class="org-type">Success</span>
  <span class="org-rainbow-delimiters-depth-2">)</span>: <span class="org-type">Solid</span>&lt;<span class="org-type">Success</span>, <span class="org-typescript-primitive">never</span>, <span class="org-type">State</span>&gt; <span class="org-keyword">=&gt;</span> <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">return</span> <span class="org-keyword">async</span> <span class="org-rainbow-delimiters-depth-3">(</span>state<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-keyword">=&gt;</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-rainbow-delimiters-depth-4">{</span> <span class="org-variable-name">state</span>, <span class="org-variable-name">result</span>: <span class="org-rainbow-delimiters-depth-5">{</span> kind: <span class="org-string">"success"</span>, value <span class="org-rainbow-delimiters-depth-5">}</span> <span class="org-rainbow-delimiters-depth-4">}</span><span class="org-rainbow-delimiters-depth-3">)</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>,
  bind: &lt;Success, NextSuccess, Failure, NextFailure, State <span class="org-typescript-access-modifier">extends</span> <span class="org-type">Scope</span>&lt;<span class="org-typescript-primitive">any</span>&gt;&gt;<span class="org-rainbow-delimiters-depth-2">(</span>
    <span class="org-variable-name">prev</span>: <span class="org-type">Solid</span>&lt;<span class="org-type">Success</span>, <span class="org-type">Failure</span>, <span class="org-type">State</span>&gt;,
    <span class="org-variable-name">func</span>: <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-variable-name">success</span>: <span class="org-type">Success</span><span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-keyword">=&gt;</span> <span class="org-type">Solid</span>&lt;<span class="org-type">NextSuccess</span>, <span class="org-type">NextFailure</span>, <span class="org-type">State</span>&gt;
  <span class="org-rainbow-delimiters-depth-2">)</span>: <span class="org-type">Solid</span>&lt;<span class="org-type">NextSuccess</span>, <span class="org-type">Failure</span> | <span class="org-type">NextFailure</span>, <span class="org-type">State</span>&gt; <span class="org-keyword">=&gt;</span> <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">return</span> <span class="org-keyword">async</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-variable-name">state</span>: <span class="org-type">Partial</span>&lt;<span class="org-type">State</span>&gt;<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-keyword">=&gt;</span> <span class="org-rainbow-delimiters-depth-3">{</span>
      <span class="org-keyword">const</span> <span class="org-variable-name">awaitedPrevious</span> = <span class="org-keyword">await</span> <span class="org-function-name">prev</span><span class="org-rainbow-delimiters-depth-4">(</span>state<span class="org-rainbow-delimiters-depth-4">)</span>;
      <span class="org-keyword">const</span> <span class="org-variable-name">prevResult</span> = awaitedPrevious.result;
      <span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-4">(</span>prevResult.kind === <span class="org-string">"success"</span><span class="org-rainbow-delimiters-depth-4">)</span> <span class="org-rainbow-delimiters-depth-4">{</span>
        <span class="org-keyword">const</span> <span class="org-variable-name">next</span> = <span class="org-keyword">await</span> <span class="org-function-name">func</span><span class="org-rainbow-delimiters-depth-5">(</span>prevResult.value<span class="org-rainbow-delimiters-depth-5">)(</span>prevResult.<span class="org-variable-name">state</span><span class="org-rainbow-delimiters-depth-5">)</span>;
        <span class="org-keyword">return</span> next;
      <span class="org-rainbow-delimiters-depth-4">}</span> <span class="org-keyword">else</span> <span class="org-rainbow-delimiters-depth-4">{</span>
        <span class="org-keyword">return</span> <span class="org-rainbow-delimiters-depth-5">{</span> state: prevResult.state, result: prevResult <span class="org-rainbow-delimiters-depth-5">}</span>;
      <span class="org-rainbow-delimiters-depth-4">}</span>
    <span class="org-rainbow-delimiters-depth-3">}</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>;
</pre>
</div>

<p>
This, as normal, is where the magic really happens. <code>pure</code> is fairly straight forward; we can lift any concrete value into our monad type by creating a function that takes the current state and returns the same state unchanged along with the concrete value as a "success" result.
</p>

<p>
<code>bind</code>, on the other hand, might have a type signature that is different from what you would expect. It does not limit the failure type of the continuation function to match the existing monad, but instead declares that the new resulting monad has a failure type of <code>Failure | NextFailure</code>. This means that if we, say, start with a monad that has a failure type of <code>NetworkFailure</code> and we bind a follow up operation with a failure type of <code>FileSystemFailure</code> we get a resulting monad that says it could fail with either a network <i>or</i> a file system failure.
</p>

<p>
Pretty snazzy, and one of the areas where TypeScript genuinely shines.
</p>

<p>
Life is much nicer if we also add some helper methods; a short hand for returning a failure, methods to get, set, and update the state being passed through, and finally a helper that captures thrown exceptions and turns them into a typed <code>UnhandledException</code> failure type while also capturing the stack trace.
</p>

<div class="org-src-container">
<pre class="src src-typescript"><span class="org-keyword">export</span> <span class="org-keyword">type</span> <span class="org-type">UnhandledExceptionFailure</span> = <span class="org-rainbow-delimiters-depth-1">{</span>
  <span class="org-default">type</span>: <span class="org-string">"UnhandledException"</span>;
  thrown: <span class="org-typescript-primitive">any</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-keyword">export</span> <span class="org-keyword">const</span> <span class="org-variable-name">Solid</span> = <span class="org-rainbow-delimiters-depth-1">{</span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">pure and bind from above go here</span>
  failure: &lt;Failure, State <span class="org-typescript-access-modifier">extends</span> <span class="org-type">Scope</span>&lt;<span class="org-typescript-primitive">any</span>&gt;&gt;<span class="org-rainbow-delimiters-depth-2">(</span>
    <span class="org-variable-name">failure</span>: <span class="org-type">Failure</span>
  <span class="org-rainbow-delimiters-depth-2">)</span>: <span class="org-type">Solid</span>&lt;<span class="org-typescript-primitive">never</span>, <span class="org-type">Failure</span>, <span class="org-type">State</span>&gt; <span class="org-keyword">=&gt;</span> <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">return</span> <span class="org-keyword">async</span> <span class="org-rainbow-delimiters-depth-3">(</span>state<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-keyword">=&gt;</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-rainbow-delimiters-depth-4">{</span> <span class="org-variable-name">state</span>, <span class="org-variable-name">result</span>: <span class="org-rainbow-delimiters-depth-5">{</span> kind: <span class="org-string">"failure"</span>, failure <span class="org-rainbow-delimiters-depth-5">}</span> <span class="org-rainbow-delimiters-depth-4">}</span><span class="org-rainbow-delimiters-depth-3">)</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>,
  <span class="org-default">get</span>: &lt;Failure, State <span class="org-typescript-access-modifier">extends</span> <span class="org-type">Scope</span>&lt;<span class="org-typescript-primitive">any</span>&gt;&gt;<span class="org-rainbow-delimiters-depth-2">()</span>: <span class="org-type">Solid</span>&lt;
    Partial&lt;<span class="org-type">State</span>&gt;,
    Failure,
    State
  &gt; <span class="org-keyword">=&gt;</span> <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">return</span> <span class="org-keyword">async</span> <span class="org-rainbow-delimiters-depth-3">(</span>state: <span class="org-type">Partial</span>&lt;<span class="org-type">State</span>&gt;<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-keyword">=&gt;</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-rainbow-delimiters-depth-4">{</span>
      state,
      result: <span class="org-rainbow-delimiters-depth-5">{</span> kind: <span class="org-string">"success"</span>, value: state <span class="org-rainbow-delimiters-depth-5">}</span>,
    <span class="org-rainbow-delimiters-depth-4">}</span><span class="org-rainbow-delimiters-depth-3">)</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>,
  modify: &lt;State <span class="org-typescript-access-modifier">extends</span> <span class="org-type">Scope</span>&lt;<span class="org-typescript-primitive">any</span>&gt;&gt;<span class="org-rainbow-delimiters-depth-2">(</span>
    <span class="org-variable-name">func</span>: <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-variable-name">prev</span>: <span class="org-type">Partial</span>&lt;<span class="org-type">State</span>&gt;<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-keyword">=&gt;</span> <span class="org-type">Partial</span>&lt;<span class="org-type">State</span>&gt;
  <span class="org-rainbow-delimiters-depth-2">)</span>: <span class="org-type">Solid</span>&lt;<span class="org-type">Partial</span>&lt;<span class="org-type">State</span>&gt;, <span class="org-typescript-primitive">never</span>, State&gt; <span class="org-keyword">=&gt;</span> <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">return</span> <span class="org-keyword">async</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-variable-name">state</span>: <span class="org-type">Partial</span>&lt;<span class="org-type">State</span>&gt;<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-keyword">=&gt;</span> <span class="org-rainbow-delimiters-depth-3">{</span>
      <span class="org-keyword">const</span> <span class="org-variable-name">newState</span> = <span class="org-function-name">func</span><span class="org-rainbow-delimiters-depth-4">(</span>state<span class="org-rainbow-delimiters-depth-4">)</span>;
      <span class="org-keyword">return</span> <span class="org-rainbow-delimiters-depth-4">{</span>
        state: newState,
        result: <span class="org-rainbow-delimiters-depth-5">{</span> kind: <span class="org-string">"success"</span>, value: newState <span class="org-rainbow-delimiters-depth-5">}</span>,
      <span class="org-rainbow-delimiters-depth-4">}</span>;
    <span class="org-rainbow-delimiters-depth-3">}</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>,
  <span class="org-default">set</span>: &lt;State <span class="org-typescript-access-modifier">extends</span> <span class="org-type">Scope</span>&lt;<span class="org-typescript-primitive">any</span>&gt;, Key <span class="org-typescript-access-modifier">extends</span> <span class="org-keyword">keyof</span> State&gt;<span class="org-rainbow-delimiters-depth-2">(</span>
    <span class="org-variable-name">key</span>: <span class="org-type">Key</span>,
    <span class="org-variable-name">value</span>: <span class="org-type">State</span><span class="org-rainbow-delimiters-depth-3">[</span>Key<span class="org-rainbow-delimiters-depth-3">]</span>
  <span class="org-rainbow-delimiters-depth-2">)</span>: <span class="org-type">Solid</span>&lt;<span class="org-typescript-primitive">void</span>, <span class="org-typescript-primitive">never</span>, <span class="org-type">State</span>&gt; <span class="org-keyword">=&gt;</span> <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">return</span> Solid.<span class="org-function-name">bind</span><span class="org-rainbow-delimiters-depth-3">(</span>
      Solid.<span class="org-function-name">modify</span><span class="org-rainbow-delimiters-depth-4">(</span><span class="org-rainbow-delimiters-depth-5">(</span>prev<span class="org-rainbow-delimiters-depth-5">)</span> <span class="org-keyword">=&gt;</span> <span class="org-rainbow-delimiters-depth-5">(</span><span class="org-rainbow-delimiters-depth-6">{</span> ...prev, <span class="org-rainbow-delimiters-depth-7">[</span>key<span class="org-rainbow-delimiters-depth-7">]</span>: value <span class="org-rainbow-delimiters-depth-6">}</span><span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span>,
      <span class="org-rainbow-delimiters-depth-4">()</span> <span class="org-keyword">=&gt;</span> <span class="org-type">Solid</span>.<span class="org-function-name">pure</span><span class="org-rainbow-delimiters-depth-4">(</span><span class="org-constant">undefined</span><span class="org-rainbow-delimiters-depth-4">)</span>
    <span class="org-rainbow-delimiters-depth-3">)</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>,
  noThrow: &lt;Success, Failure, State <span class="org-typescript-access-modifier">extends</span> <span class="org-type">Scope</span>&lt;<span class="org-typescript-primitive">any</span>&gt;&gt;<span class="org-rainbow-delimiters-depth-2">(</span>
    <span class="org-variable-name">solid</span>: <span class="org-type">Solid</span>&lt;<span class="org-type">Success</span>, <span class="org-type">Failure</span>, <span class="org-type">State</span>&gt;
  <span class="org-rainbow-delimiters-depth-2">)</span>: <span class="org-type">Solid</span>&lt;<span class="org-type">Success</span>, <span class="org-type">Failure</span> | <span class="org-type">UnhandledExceptionFailure</span>, <span class="org-type">State</span>&gt; <span class="org-keyword">=&gt;</span> <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">return</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-variable-name">state</span>: <span class="org-type">Partial</span>&lt;<span class="org-type">State</span>&gt;<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-keyword">=&gt;</span> <span class="org-rainbow-delimiters-depth-3">{</span>
      <span class="org-keyword">try</span> <span class="org-rainbow-delimiters-depth-4">{</span>
        <span class="org-keyword">return</span> <span class="org-function-name">solid</span><span class="org-rainbow-delimiters-depth-5">(</span>state<span class="org-rainbow-delimiters-depth-5">)</span>;
      <span class="org-rainbow-delimiters-depth-4">}</span> <span class="org-keyword">catch</span> <span class="org-rainbow-delimiters-depth-4">(</span>e<span class="org-rainbow-delimiters-depth-4">)</span> <span class="org-rainbow-delimiters-depth-4">{</span>
        <span class="org-keyword">return</span> Solid.<span class="org-function-name">failure</span><span class="org-rainbow-delimiters-depth-5">(</span><span class="org-rainbow-delimiters-depth-6">{</span>
          <span class="org-default">type</span>: <span class="org-string">"UnhandledException"</span> <span class="org-keyword">as</span> <span class="org-keyword">const</span>,
          thrown: e,
        <span class="org-rainbow-delimiters-depth-6">}</span><span class="org-rainbow-delimiters-depth-5">)(</span><span class="org-variable-name">state</span><span class="org-rainbow-delimiters-depth-5">)</span>;
      <span class="org-rainbow-delimiters-depth-4">}</span>
    <span class="org-rainbow-delimiters-depth-3">}</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>,
<span class="org-rainbow-delimiters-depth-1">}</span>;
</pre>
</div>

<p>
We have a monad now, so our chain should look very familiar; let's put the whole thing here in full so we can admire it in all its abstract beauty. We've added a <code>tap</code> method which puts an operation in the chain that doesn't add anything to the scope, useful for things like updating the state or sending messages, and we've added a call to <code>noThrow</code> in the "execute" methods to make sure that we don't accidentally forget to capture exceptions and so break all our lovely new error handling. Apart from that, it should all look very familiar.
</p>

<div class="org-src-container">
<pre class="src src-typescript"><span class="org-keyword">export</span> <span class="org-keyword">class</span> <span class="org-type">SolidChain</span>&lt;
  Input,
  OutputScope <span class="org-typescript-access-modifier">extends</span> <span class="org-type">Scope</span>&lt;<span class="org-typescript-primitive">any</span>&gt;,
  Failure,
  State <span class="org-typescript-access-modifier">extends</span> <span class="org-type">Scope</span>&lt;<span class="org-typescript-primitive">any</span>&gt;
&gt; <span class="org-rainbow-delimiters-depth-1">{</span>
  <span class="org-typescript-access-modifier">private</span> <span class="org-typescript-access-modifier">readonly</span> operation: <span class="org-rainbow-delimiters-depth-2">(</span>
    input: <span class="org-type">Input</span>
  <span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">=&gt;</span> <span class="org-type">Solid</span>&lt;<span class="org-type">OutputScope</span>, <span class="org-type">Failure</span>, <span class="org-type">State</span>&gt;;
  <span class="org-keyword">constructor</span><span class="org-rainbow-delimiters-depth-2">(</span>starter: <span class="org-rainbow-delimiters-depth-3">(</span>input: <span class="org-type">Input</span><span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-keyword">=&gt;</span> <span class="org-type">Solid</span>&lt;<span class="org-type">OutputScope</span>, <span class="org-type">Failure</span>, <span class="org-type">State</span>&gt;<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-typescript-this">this</span>.operation = starter;
  <span class="org-rainbow-delimiters-depth-2">}</span>

  <span class="org-function-name">execute</span><span class="org-rainbow-delimiters-depth-2">(</span>
    <span class="org-variable-name">input</span>: <span class="org-type">Input</span>
  <span class="org-rainbow-delimiters-depth-2">)</span>: <span class="org-type">Solid</span>&lt;<span class="org-type">OutputScope</span>, <span class="org-type">Failure</span> | <span class="org-type">UnhandledExceptionFailure</span>, <span class="org-type">State</span>&gt; <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">return</span> Solid.<span class="org-function-name">noThrow</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-typescript-this">this</span>.<span class="org-function-name">operation</span><span class="org-rainbow-delimiters-depth-4">(</span>input<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>

  <span class="org-function-name">chain</span>&lt;<span class="org-type">NextOutput</span>, <span class="org-type">NextFailure</span>, <span class="org-type">ResultName</span> <span class="org-typescript-access-modifier">extends</span> <span class="org-typescript-primitive">string</span>&gt;<span class="org-rainbow-delimiters-depth-2">(</span>
    <span class="org-variable-name">resultName</span>: <span class="org-type">ResultName</span>,
    <span class="org-variable-name">next</span>: <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-variable-name">previous</span>: <span class="org-type">OutputScope</span><span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-keyword">=&gt;</span> <span class="org-type">Solid</span>&lt;<span class="org-type">NextOutput</span>, <span class="org-type">NextFailure</span>, <span class="org-type">State</span>&gt;
  <span class="org-rainbow-delimiters-depth-2">)</span>: <span class="org-type">SolidChain</span>&lt;
    Input,
    ExtendedScope&lt;<span class="org-type">OutputScope</span>, <span class="org-type">ResultName</span>, <span class="org-type">NextOutput</span>&gt;,
    Failure | NextFailure,
    State
  &gt; <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">const</span> <span class="org-variable-name">chainedOperation</span> = <span class="org-rainbow-delimiters-depth-3">(</span>
      <span class="org-variable-name">input</span>: <span class="org-type">Input</span>
    <span class="org-rainbow-delimiters-depth-3">)</span>: <span class="org-type">Solid</span>&lt;
      ExtendedScope&lt;<span class="org-type">OutputScope</span>, <span class="org-type">ResultName</span>, <span class="org-type">NextOutput</span>&gt;,
      Failure | NextFailure,
      State
    &gt; <span class="org-keyword">=&gt;</span> <span class="org-rainbow-delimiters-depth-3">{</span>
      <span class="org-keyword">const</span> <span class="org-variable-name">previousResult</span> = <span class="org-typescript-this">this</span>.<span class="org-function-name">operation</span><span class="org-rainbow-delimiters-depth-4">(</span>input<span class="org-rainbow-delimiters-depth-4">)</span>;
      <span class="org-keyword">return</span> Solid.<span class="org-function-name">bind</span><span class="org-rainbow-delimiters-depth-4">(</span>previousResult, <span class="org-rainbow-delimiters-depth-5">(</span><span class="org-variable-name">output</span>: <span class="org-type">OutputScope</span><span class="org-rainbow-delimiters-depth-5">)</span> <span class="org-keyword">=&gt;</span> <span class="org-rainbow-delimiters-depth-5">{</span>
        <span class="org-keyword">return</span> Solid.<span class="org-function-name">bind</span><span class="org-rainbow-delimiters-depth-6">(</span><span class="org-function-name">next</span><span class="org-rainbow-delimiters-depth-7">(</span>output<span class="org-rainbow-delimiters-depth-7">)</span>, <span class="org-rainbow-delimiters-depth-7">(</span><span class="org-variable-name">nextOutput</span><span class="org-rainbow-delimiters-depth-7">)</span> <span class="org-keyword">=&gt;</span> <span class="org-rainbow-delimiters-depth-7">{</span>
          <span class="org-keyword">return</span> Solid.<span class="org-function-name">pure</span><span class="org-rainbow-delimiters-depth-8">(</span><span class="org-function-name">extendScope</span><span class="org-rainbow-delimiters-depth-9">(</span>output, resultName, nextOutput<span class="org-rainbow-delimiters-depth-9">)</span><span class="org-rainbow-delimiters-depth-8">)</span>;
        <span class="org-rainbow-delimiters-depth-7">}</span><span class="org-rainbow-delimiters-depth-6">)</span>;
      <span class="org-rainbow-delimiters-depth-5">}</span><span class="org-rainbow-delimiters-depth-4">)</span>;
    <span class="org-rainbow-delimiters-depth-3">}</span>;
    <span class="org-keyword">return</span> <span class="org-keyword">new</span> <span class="org-type">SolidChain</span><span class="org-rainbow-delimiters-depth-3">(</span>chainedOperation<span class="org-rainbow-delimiters-depth-3">)</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>

  <span class="org-function-name">map</span>&lt;<span class="org-type">NextOutput</span>, <span class="org-type">ResultName</span> <span class="org-typescript-access-modifier">extends</span> <span class="org-typescript-primitive">string</span>&gt;<span class="org-rainbow-delimiters-depth-2">(</span>
    <span class="org-variable-name">resultName</span>: <span class="org-type">ResultName</span>,
    <span class="org-variable-name">next</span>: <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-variable-name">previous</span>: <span class="org-type">OutputScope</span><span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-keyword">=&gt;</span> <span class="org-type">NextOutput</span>
  <span class="org-rainbow-delimiters-depth-2">)</span>: <span class="org-type">SolidChain</span>&lt;
    Input,
    ExtendedScope&lt;<span class="org-type">OutputScope</span>, <span class="org-type">ResultName</span>, <span class="org-type">NextOutput</span>&gt;,
    Failure,
    State
  &gt; <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">return</span> <span class="org-typescript-this">this</span>.<span class="org-function-name">chain</span><span class="org-rainbow-delimiters-depth-3">(</span>resultName, <span class="org-rainbow-delimiters-depth-4">(</span>scope<span class="org-rainbow-delimiters-depth-4">)</span> <span class="org-keyword">=&gt;</span> <span class="org-type">Solid</span>.<span class="org-function-name">pure</span><span class="org-rainbow-delimiters-depth-4">(</span><span class="org-function-name">next</span><span class="org-rainbow-delimiters-depth-5">(</span>scope<span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>

  <span class="org-function-name">tap</span>&lt;<span class="org-type">NextFailure</span>&gt;<span class="org-rainbow-delimiters-depth-2">(</span>
    <span class="org-variable-name">func</span>: <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-variable-name">previous</span>: <span class="org-type">OutputScope</span><span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-keyword">=&gt;</span> <span class="org-type">Solid</span>&lt;<span class="org-typescript-primitive">void</span>, <span class="org-type">NextFailure</span>, <span class="org-type">State</span>&gt;
  <span class="org-rainbow-delimiters-depth-2">)</span>: <span class="org-type">SolidChain</span>&lt;<span class="org-type">Input</span>, <span class="org-type">OutputScope</span>, <span class="org-type">Failure</span> | <span class="org-type">NextFailure</span>, <span class="org-type">State</span>&gt; <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">return</span> <span class="org-keyword">new</span> <span class="org-type">SolidChain</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-rainbow-delimiters-depth-4">(</span>input: <span class="org-type">Input</span><span class="org-rainbow-delimiters-depth-4">)</span> <span class="org-keyword">=&gt;</span>
      Solid.<span class="org-function-name">bind</span><span class="org-rainbow-delimiters-depth-4">(</span><span class="org-typescript-this">this</span>.<span class="org-function-name">operation</span><span class="org-rainbow-delimiters-depth-5">(</span>input<span class="org-rainbow-delimiters-depth-5">)</span>, <span class="org-rainbow-delimiters-depth-5">(</span>scope<span class="org-rainbow-delimiters-depth-5">)</span> <span class="org-keyword">=&gt;</span>
        Solid.<span class="org-function-name">bind</span><span class="org-rainbow-delimiters-depth-5">(</span><span class="org-function-name">func</span><span class="org-rainbow-delimiters-depth-6">(</span>scope<span class="org-rainbow-delimiters-depth-6">)</span>, <span class="org-rainbow-delimiters-depth-6">()</span> <span class="org-keyword">=&gt;</span> <span class="org-type">Solid</span>.<span class="org-function-name">pure</span><span class="org-rainbow-delimiters-depth-6">(</span>scope<span class="org-rainbow-delimiters-depth-6">)</span><span class="org-rainbow-delimiters-depth-5">)</span>
      <span class="org-rainbow-delimiters-depth-4">)</span>
    <span class="org-rainbow-delimiters-depth-3">)</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>

  <span class="org-function-name">executeTarget</span>&lt;<span class="org-type">ResultName</span> <span class="org-typescript-access-modifier">extends</span> <span class="org-type">keyof</span> <span class="org-type">OutputScope</span>&gt;<span class="org-rainbow-delimiters-depth-2">(</span>
    <span class="org-variable-name">resultName</span>: <span class="org-type">ResultName</span>
  <span class="org-rainbow-delimiters-depth-2">)</span>: <span class="org-rainbow-delimiters-depth-2">(</span>
    input: <span class="org-type">Input</span>
  <span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">=&gt;</span> <span class="org-type">Solid</span>&lt;
    OutputScope<span class="org-rainbow-delimiters-depth-2">[</span>ResultName<span class="org-rainbow-delimiters-depth-2">]</span>,
    Failure | UnhandledExceptionFailure,
    State
  &gt; <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">return</span> <span class="org-rainbow-delimiters-depth-3">(</span>input: <span class="org-type">Input</span><span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-keyword">=&gt;</span>
      Solid.<span class="org-function-name">noThrow</span><span class="org-rainbow-delimiters-depth-3">(</span>
        Solid.<span class="org-function-name">bind</span><span class="org-rainbow-delimiters-depth-4">(</span><span class="org-typescript-this">this</span>.<span class="org-function-name">execute</span><span class="org-rainbow-delimiters-depth-5">(</span>input<span class="org-rainbow-delimiters-depth-5">)</span>, <span class="org-rainbow-delimiters-depth-5">(</span>outputScope<span class="org-rainbow-delimiters-depth-5">)</span> <span class="org-keyword">=&gt;</span>
          Solid.<span class="org-function-name">pure</span><span class="org-rainbow-delimiters-depth-5">(</span>outputScope<span class="org-rainbow-delimiters-depth-6">[</span>resultName<span class="org-rainbow-delimiters-depth-6">]</span><span class="org-rainbow-delimiters-depth-5">)</span>
        <span class="org-rainbow-delimiters-depth-4">)</span>
      <span class="org-rainbow-delimiters-depth-3">)</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>

  <span class="org-typescript-access-modifier">static</span> start&lt;
    InputScope <span class="org-typescript-access-modifier">extends</span> <span class="org-type">Scope</span>&lt;<span class="org-typescript-primitive">any</span>&gt;,
    State <span class="org-typescript-access-modifier">extends</span> <span class="org-type">Partial</span>&lt;<span class="org-type">Scope</span>&lt;<span class="org-typescript-primitive">any</span>&gt;&gt;
  &gt;<span class="org-rainbow-delimiters-depth-2">()</span>: <span class="org-type">SolidChain</span>&lt;<span class="org-type">InputScope</span>, <span class="org-type">InputScope</span>, <span class="org-typescript-primitive">never</span>, <span class="org-type">State</span>&gt; <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">return</span> <span class="org-keyword">new</span> <span class="org-type">SolidChain</span><span class="org-rainbow-delimiters-depth-3">(</span>Solid.pure&lt;<span class="org-type">InputScope</span>, <span class="org-type">State</span>&gt;<span class="org-rainbow-delimiters-depth-3">)</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org8dbd076" class="outline-3">
<h3 id="org8dbd076">Writing the code</h3>
<div class="outline-text-3" id="text-org8dbd076">
<p>
To fully take advantage of our new shiny monad, there's a few simple rules we want to follow.
</p>

<ul class="org-ul">
<li>It should be easy to distinguish between error types; a discriminator field is great for this</li>
<li>We should aim to write our "business" functions to take a single object argument, so that a scope object can be built up that can call them</li>
<li>If at all possible, those arguments should use well known field names for well known pieces of data</li>
</ul>

<p>
This means that we'll end up with external dependencies represented as functions that look something like this (either globally, or wrapped locally for use in the chain if you're not basing your whole code architecture off this blog post: shame on you!):
</p>

<div class="org-src-container">
<pre class="src src-typescript"><span class="org-keyword">export</span> <span class="org-keyword">interface</span> <span class="org-type">Commands</span> <span class="org-rainbow-delimiters-depth-1">{</span>
  parseUntrustedCommand: &lt;State <span class="org-typescript-access-modifier">extends</span> <span class="org-type">Scope</span>&lt;<span class="org-typescript-primitive">any</span>&gt;&gt;<span class="org-rainbow-delimiters-depth-2">(</span>scope: <span class="org-rainbow-delimiters-depth-3">{</span>
    untrustedCommand: <span class="org-typescript-primitive">any</span>;
  <span class="org-rainbow-delimiters-depth-3">}</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">=&gt;</span> <span class="org-type">Solid</span>&lt;<span class="org-variable-name">Command</span>, <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-variable-name">type</span>: <span class="org-string">"UnrecognizedCommand"</span>; <span class="org-variable-name">message</span>: <span class="org-typescript-primitive">string</span> <span class="org-rainbow-delimiters-depth-2">}</span>, <span class="org-type">State</span>&gt;;
  executeCommand: &lt;State <span class="org-typescript-access-modifier">extends</span> <span class="org-type">Scope</span>&lt;<span class="org-typescript-primitive">any</span>&gt;&gt;<span class="org-rainbow-delimiters-depth-2">(</span>args: <span class="org-rainbow-delimiters-depth-3">{</span>
    userInfo: <span class="org-rainbow-delimiters-depth-4">{</span> user: <span class="org-type">User</span>; organization: <span class="org-type">Organization</span> <span class="org-rainbow-delimiters-depth-4">}</span>;
    command: <span class="org-type">Command</span>;
  <span class="org-rainbow-delimiters-depth-3">}</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">=&gt;</span> <span class="org-type">Solid</span>&lt;
    Events,
    <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-default">type</span>: <span class="org-string">"NotPermitted"</span> | <span class="org-string">"ValidationFailed"</span>; message: <span class="org-typescript-primitive">string</span> <span class="org-rainbow-delimiters-depth-2">}</span>,
    State
  &gt;;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
Following these patterns and combining them with the type safety of the chain builder is enormously powerful, especially for helping out new developers. For example, if you want to call the <code>executeCommand</code> operation you'll find that you can't put it in the chain before the operations that get the command and the user info, and you can't return a chain that doesn't explicitly flag that it may fail with the "NotPermitted" and "ValidationFailed" errors.
</p>
</div>
</div>
</div>

<div id="outline-container-orgd877b4e" class="outline-2">
<h2 id="orgd877b4e">Appendix 1: Stealing from the best</h2>
<div class="outline-text-2" id="text-orgd877b4e">
<p>
The advantage of using a standard abstraction like a monad is that someone has done most of the hard thinking already for you. In TypeScript we don't have a nice way of defining code that works on "anything which is a monad", but in Haskell you can - and that means that there's <a href="https://hackage.haskell.org/package/base-4.19.0.0/docs/Control-Monad.html#g:4">collections of functions</a> that you can refer to that are implemented on the basis of something being a monad. This means that if you have a working knowledge of Haskell (or Scala, or an other language where someone has done this work for you already) you can easily add features to your <code>XChain</code> class as you discover you need them.
</p>

<p>
For example, what do you do if you have an array of inputs that you want to map using a <code>Solid</code> returning function?
</p>

<p>
Well, if you check the link above you'll find the <code>mapM</code> function with the signature <code>mapM :: (Traversable t, Monad m) =&gt; (a -&gt; m b) -&gt; t a -&gt; m (t b)</code>. A <code>Traversable</code> is roughly an iterable in TypeScript speak, so we can check how <code>mapM</code> is implemented on a type that would be useful in TypeScript. It turns out it is an alias for the <code>traverse</code> function of whichever <code>t</code> is traversable, so we pick the list implementation as probably being close to what we'd want <a href="https://hackage.haskell.org/package/base-4.19.0.0/docs/src/Data.Traversable.html#line-299">and it is</a>:
</p>

<div class="org-src-container">
<pre class="src src-haskell"><span class="org-haskell-keyword">instance</span> <span class="org-haskell-type">Traversable</span> <span class="org-haskell-constructor"><span class="org-rainbow-delimiters-depth-1">[]</span></span> <span class="org-haskell-keyword">where</span>
  <span class="org-haskell-pragma">{-# INLINE traverse #-}</span> <span class="org-comment-delimiter">-- </span><span class="org-comment">so that traverse can fuse</span>
  traverse f <span class="org-haskell-operator">=</span> List.foldr cons_f <span class="org-rainbow-delimiters-depth-1">(</span>pure <span class="org-haskell-constructor"><span class="org-rainbow-delimiters-depth-2">[]</span></span><span class="org-rainbow-delimiters-depth-1">)</span>
    <span class="org-haskell-keyword">where</span> cons_f x ys <span class="org-haskell-operator">=</span> liftA2 <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-haskell-constructor">:</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-rainbow-delimiters-depth-1">(</span>f x<span class="org-rainbow-delimiters-depth-1">)</span> ys
</pre>
</div>

<p>
Hmm. <code>liftA2</code> is a bit weirdly named but it allows a binary operation to happen in our monadic context. We can in turn look up a default implementation of <i>that</i> in terms of what's available in a monad, and we end up with some new helper functions on monad.
</p>

<div class="org-src-container">
<pre class="src src-typescript"><span class="org-keyword">export</span> <span class="org-keyword">const</span> <span class="org-variable-name">Solid</span> = <span class="org-rainbow-delimiters-depth-1">{</span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">All the existing monad operations like bind etc...</span>
  map: &lt;Previous, Next, Failure, State <span class="org-typescript-access-modifier">extends</span> <span class="org-type">Scope</span>&lt;<span class="org-typescript-primitive">any</span>&gt;&gt;<span class="org-rainbow-delimiters-depth-2">(</span>
    <span class="org-variable-name">func</span>: <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-variable-name">previous</span>: <span class="org-type">Previous</span><span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-keyword">=&gt;</span> <span class="org-type">Next</span>,
    <span class="org-variable-name">prev</span>: <span class="org-type">Solid</span>&lt;<span class="org-type">Previous</span>, <span class="org-type">Failure</span>, <span class="org-type">State</span>&gt;
  <span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">=&gt;</span> <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">return</span> Solid.<span class="org-function-name">bind</span><span class="org-rainbow-delimiters-depth-3">(</span>prev, <span class="org-rainbow-delimiters-depth-4">(</span>success<span class="org-rainbow-delimiters-depth-4">)</span> <span class="org-keyword">=&gt;</span> <span class="org-type">Solid</span>.<span class="org-function-name">pure</span><span class="org-rainbow-delimiters-depth-4">(</span><span class="org-function-name">func</span><span class="org-rainbow-delimiters-depth-5">(</span>success<span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>,
  apply: &lt;Success, NextSuccess, Failure, NextFailure, State <span class="org-typescript-access-modifier">extends</span> <span class="org-type">Scope</span>&lt;<span class="org-typescript-primitive">any</span>&gt;&gt;<span class="org-rainbow-delimiters-depth-2">(</span>
    <span class="org-variable-name">funcInMonad</span>: <span class="org-type">Solid</span>&lt;<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-variable-name">prev</span>: <span class="org-type">Success</span><span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-keyword">=&gt;</span> <span class="org-type">NextSuccess</span>, NextFailure, State&gt;,
    <span class="org-variable-name">prev</span>: <span class="org-type">Solid</span>&lt;<span class="org-type">Success</span>, <span class="org-type">Failure</span>, <span class="org-type">State</span>&gt;
  <span class="org-rainbow-delimiters-depth-2">)</span>: <span class="org-type">Solid</span>&lt;<span class="org-type">NextSuccess</span>, <span class="org-type">Failure</span> | <span class="org-type">NextFailure</span>, <span class="org-type">State</span>&gt; <span class="org-keyword">=&gt;</span> <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">return</span> Solid.<span class="org-function-name">bind</span><span class="org-rainbow-delimiters-depth-3">(</span>funcInMonad, <span class="org-rainbow-delimiters-depth-4">(</span>func<span class="org-rainbow-delimiters-depth-4">)</span> <span class="org-keyword">=&gt;</span> <span class="org-type">Solid</span>.<span class="org-function-name">map</span><span class="org-rainbow-delimiters-depth-4">(</span>func, prev<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>,
  lift2: &lt;
    Left,
    Right,
    Result,
    LeftFailure,
    RightFailure,
    State <span class="org-typescript-access-modifier">extends</span> <span class="org-type">Scope</span>&lt;<span class="org-typescript-primitive">any</span>&gt;
  &gt;<span class="org-rainbow-delimiters-depth-2">(</span>
    <span class="org-variable-name">operation</span>: <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-variable-name">left</span>: <span class="org-type">Left</span>, <span class="org-variable-name">right</span>: <span class="org-type">Right</span><span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-keyword">=&gt;</span> <span class="org-type">Result</span>,
    <span class="org-variable-name">left</span>: <span class="org-type">Solid</span>&lt;<span class="org-type">Left</span>, <span class="org-type">LeftFailure</span>, <span class="org-type">State</span>&gt;,
    <span class="org-variable-name">right</span>: <span class="org-type">Solid</span>&lt;<span class="org-type">Right</span>, <span class="org-type">RightFailure</span>, <span class="org-type">State</span>&gt;
  <span class="org-rainbow-delimiters-depth-2">)</span>: <span class="org-type">Solid</span>&lt;<span class="org-type">Result</span>, <span class="org-type">LeftFailure</span> | <span class="org-type">RightFailure</span>, <span class="org-type">State</span>&gt; <span class="org-keyword">=&gt;</span> <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">return</span> Solid.<span class="org-function-name">apply</span><span class="org-rainbow-delimiters-depth-3">(</span>
      Solid.<span class="org-function-name">map</span><span class="org-rainbow-delimiters-depth-4">(</span><span class="org-rainbow-delimiters-depth-5">(</span>left: <span class="org-type">Left</span><span class="org-rainbow-delimiters-depth-5">)</span> <span class="org-keyword">=&gt;</span> <span class="org-rainbow-delimiters-depth-5">(</span>right: <span class="org-type">Right</span><span class="org-rainbow-delimiters-depth-5">)</span> <span class="org-keyword">=&gt;</span> <span class="org-function-name">operation</span><span class="org-rainbow-delimiters-depth-5">(</span>left, right<span class="org-rainbow-delimiters-depth-5">)</span>, left<span class="org-rainbow-delimiters-depth-4">)</span>,
      right
    <span class="org-rainbow-delimiters-depth-3">)</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>,
  traverse: &lt;Input, Success, Failure, State <span class="org-typescript-access-modifier">extends</span> <span class="org-type">Scope</span>&lt;<span class="org-typescript-primitive">any</span>&gt;&gt;<span class="org-rainbow-delimiters-depth-2">(</span>
    <span class="org-variable-name">inputs</span>: <span class="org-type">Input</span><span class="org-rainbow-delimiters-depth-3">[]</span>,
    <span class="org-variable-name">func</span>: <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-variable-name">input</span>: <span class="org-type">Input</span><span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-keyword">=&gt;</span> <span class="org-type">Solid</span>&lt;<span class="org-type">Success</span>, <span class="org-type">Failure</span>, <span class="org-type">State</span>&gt;
  <span class="org-rainbow-delimiters-depth-2">)</span>: <span class="org-type">Solid</span>&lt;<span class="org-type">Success</span><span class="org-rainbow-delimiters-depth-2">[]</span>, <span class="org-type">Failure</span>, <span class="org-type">State</span>&gt; <span class="org-keyword">=&gt;</span> <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">return</span> inputs.<span class="org-function-name">reduce</span>&lt;<span class="org-type">Solid</span>&lt;<span class="org-type">Success</span><span class="org-rainbow-delimiters-depth-3">[]</span>, <span class="org-type">Failure</span>, <span class="org-type">State</span>&gt;&gt;<span class="org-rainbow-delimiters-depth-3">(</span>
      <span class="org-rainbow-delimiters-depth-4">(</span>acc, next<span class="org-rainbow-delimiters-depth-4">)</span> <span class="org-keyword">=&gt;</span>
        Solid.<span class="org-function-name">lift2</span><span class="org-rainbow-delimiters-depth-4">(</span>
          <span class="org-rainbow-delimiters-depth-5">(</span><span class="org-variable-name">results</span>: <span class="org-type">Success</span><span class="org-rainbow-delimiters-depth-6">[]</span>, <span class="org-variable-name">next</span>: <span class="org-type">Success</span><span class="org-rainbow-delimiters-depth-5">)</span> <span class="org-keyword">=&gt;</span> <span class="org-rainbow-delimiters-depth-5">{</span>
            results.<span class="org-function-name">push</span><span class="org-rainbow-delimiters-depth-6">(</span>next<span class="org-rainbow-delimiters-depth-6">)</span>;
            <span class="org-keyword">return</span> results;
          <span class="org-rainbow-delimiters-depth-5">}</span>,
          acc,
          <span class="org-function-name">func</span><span class="org-rainbow-delimiters-depth-5">(</span>next<span class="org-rainbow-delimiters-depth-5">)</span>
        <span class="org-rainbow-delimiters-depth-4">)</span>,
      Solid.<span class="org-function-name">pure</span><span class="org-rainbow-delimiters-depth-4">(</span><span class="org-rainbow-delimiters-depth-5">[]</span><span class="org-rainbow-delimiters-depth-4">)</span>
    <span class="org-rainbow-delimiters-depth-3">)</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>,
<span class="org-rainbow-delimiters-depth-1">}</span>;
</pre>
</div>

<p>
Did translating that make my brain hurt a bit? Yes, but it made my brain hurt a lot less than working out that logic for myself. And now you are just a cut and paste away from being able to reuse this same code on any other monads you want to create, and in your solid chains you can right things like:
</p>

<div class="org-src-container">
<pre class="src src-typescript"><span class="org-keyword">export</span> <span class="org-keyword">const</span> <span class="org-variable-name">traverseExample</span> =
  <span class="org-rainbow-delimiters-depth-1">(</span>commandOperations: <span class="org-type">Commands</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-keyword">=&gt;</span> <span class="org-rainbow-delimiters-depth-1">(</span>untrustedInput: <span class="org-typescript-primitive">any</span><span class="org-rainbow-delimiters-depth-2">[]</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-keyword">=&gt;</span>
    SolidChain.start&lt;
      <span class="org-rainbow-delimiters-depth-1">{</span>
        untrustedInput: <span class="org-typescript-primitive">any</span><span class="org-rainbow-delimiters-depth-2">[]</span>;
        userInfo: <span class="org-rainbow-delimiters-depth-2">{</span> user: <span class="org-type">User</span>; organization: <span class="org-type">Organization</span> <span class="org-rainbow-delimiters-depth-2">}</span>;
      <span class="org-rainbow-delimiters-depth-1">}</span>,
      <span class="org-rainbow-delimiters-depth-1">{}</span>
    &gt;<span class="org-rainbow-delimiters-depth-1">()</span>
      .<span class="org-function-name">chain</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"parsedCommands"</span>, <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-rainbow-delimiters-depth-3">{</span> untrustedInput <span class="org-rainbow-delimiters-depth-3">}</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">=&gt;</span>
        Solid.<span class="org-function-name">traverse</span><span class="org-rainbow-delimiters-depth-2">(</span>untrustedInput, commandOperations.parseUntrustedCommand<span class="org-rainbow-delimiters-depth-2">)</span>
      <span class="org-rainbow-delimiters-depth-1">)</span>
      .<span class="org-function-name">chain</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"resultingEvents"</span>, <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-rainbow-delimiters-depth-3">{</span> parsedCommands, userInfo <span class="org-rainbow-delimiters-depth-3">}</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">=&gt;</span>
        Solid.<span class="org-function-name">traverse</span><span class="org-rainbow-delimiters-depth-2">(</span>parsedCommands, <span class="org-rainbow-delimiters-depth-3">(</span>command<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-keyword">=&gt;</span>
          commandOperations.<span class="org-function-name">executeCommand</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-rainbow-delimiters-depth-4">{</span> command, userInfo <span class="org-rainbow-delimiters-depth-4">}</span><span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-2">)</span>
      <span class="org-rainbow-delimiters-depth-1">)</span>
      .<span class="org-function-name">executeTarget</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"resultingEvents"</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
Warning: there's an argument for not adding too many of these helpers too quickly or to not make all of the intermediate abstractions publicly available. Developers new to functional programming will quickly see the point of a method like <code>traverse</code> when shown an example, but finding something like <code>lift2</code> is going to leave a lot of people scratching their heads.
</p>
</div>
</div>

<div id="outline-container-orgba88beb" class="outline-2">
<h2 id="orgba88beb">Appendix 2: A slightly excessive example of the Solid monad in action</h2>
<div class="outline-text-2" id="text-orgba88beb">
<p>
<details><summary>
You can cut and paste this big fat code block into the TS editor of your choice and have a play with the Solid monad. Go on. It's fun!
</summary><div class="outline-text-2">
</p>


<div class="org-src-container">
<pre class="src src-typescript"><span class="org-keyword">export</span> <span class="org-keyword">type</span> <span class="org-type">Scope</span>&lt;<span class="org-type">Keys</span> <span class="org-typescript-access-modifier">extends</span> <span class="org-typescript-primitive">string</span>&gt; = <span class="org-rainbow-delimiters-depth-1">{</span>
  <span class="org-rainbow-delimiters-depth-2">[</span>K <span class="org-keyword">in</span> Keys<span class="org-rainbow-delimiters-depth-2">]</span>: <span class="org-typescript-primitive">any</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-keyword">export</span> <span class="org-keyword">type</span> <span class="org-type">ExtendedScope</span>&lt;
  OldScope <span class="org-typescript-access-modifier">extends</span> <span class="org-type">Scope</span>&lt;<span class="org-typescript-primitive">any</span>&gt;,
  NewField <span class="org-typescript-access-modifier">extends</span> <span class="org-typescript-primitive">string</span>,
  NewValue
&gt; = OldScope <span class="org-typescript-access-modifier">extends</span> <span class="org-typescript-primitive">any</span>
  ? <span class="org-rainbow-delimiters-depth-1">{</span>
      <span class="org-rainbow-delimiters-depth-2">[</span>K <span class="org-keyword">in</span> <span class="org-keyword">keyof</span> OldScope | NewField<span class="org-rainbow-delimiters-depth-2">]</span>: K <span class="org-typescript-access-modifier">extends</span> <span class="org-type">NewField</span>
        ? NewValue
        : K <span class="org-typescript-access-modifier">extends</span> <span class="org-keyword">keyof</span> OldScope
        ? OldScope<span class="org-rainbow-delimiters-depth-2">[</span>K<span class="org-rainbow-delimiters-depth-2">]</span>
        : <span class="org-typescript-primitive">never</span>;
    <span class="org-rainbow-delimiters-depth-1">}</span>
  : <span class="org-typescript-primitive">never</span>;

<span class="org-keyword">export</span> <span class="org-keyword">const</span> <span class="org-variable-name">extendScope</span> = &lt;
  OldScope <span class="org-typescript-access-modifier">extends</span> <span class="org-type">Scope</span>&lt;<span class="org-typescript-primitive">any</span>&gt;,
  NewField <span class="org-typescript-access-modifier">extends</span> <span class="org-typescript-primitive">string</span>,
  NewValue
&gt;<span class="org-rainbow-delimiters-depth-1">(</span>
  <span class="org-variable-name">oldScope</span>: <span class="org-type">OldScope</span>,
  <span class="org-variable-name">newField</span>: <span class="org-type">NewField</span>,
  <span class="org-variable-name">newValue</span>: <span class="org-type">NewValue</span>
<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-keyword">=&gt;</span> <span class="org-rainbow-delimiters-depth-1">{</span>
  <span class="org-keyword">const</span> <span class="org-variable-name">addToScope</span> = <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-rainbow-delimiters-depth-3">[</span>newField<span class="org-rainbow-delimiters-depth-3">]</span>: newValue,
  <span class="org-rainbow-delimiters-depth-2">}</span>;
  <span class="org-keyword">return</span> <span class="org-rainbow-delimiters-depth-2">{</span>
    ...oldScope,
    ...addToScope,
  <span class="org-rainbow-delimiters-depth-2">}</span> <span class="org-keyword">as</span> ExtendedScope&lt;<span class="org-type">OldScope</span>, <span class="org-type">NewField</span>, <span class="org-type">NewValue</span>&gt;;
<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-keyword">export</span> <span class="org-keyword">type</span> <span class="org-type">AsyncMaybe</span>&lt;<span class="org-type">T</span>&gt; = Promise&lt;<span class="org-type">T</span> | <span class="org-type">null</span> | <span class="org-type">undefined</span>&gt;;

<span class="org-keyword">export</span> <span class="org-keyword">namespace</span> AsyncMaybe <span class="org-rainbow-delimiters-depth-1">{</span>
  <span class="org-keyword">export</span> <span class="org-keyword">const</span> <span class="org-variable-name">bind</span> = <span class="org-keyword">async</span> &lt;<span class="org-type">A</span>, <span class="org-type">B</span>&gt;<span class="org-rainbow-delimiters-depth-2">(</span>
    <span class="org-variable-name">prevAsync</span>: <span class="org-type">AsyncMaybe</span>&lt;<span class="org-type">A</span>&gt;,
    <span class="org-variable-name">func</span>: <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-variable-name">prev</span>: A<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-keyword">=&gt;</span> <span class="org-type">AsyncMaybe</span>&lt;<span class="org-type">B</span>&gt;
  <span class="org-rainbow-delimiters-depth-2">)</span>: <span class="org-type">AsyncMaybe</span>&lt;<span class="org-type">B</span>&gt; <span class="org-keyword">=&gt;</span> <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">const</span> <span class="org-variable-name">prev</span> = <span class="org-keyword">await</span> prevAsync;
    <span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-3">(</span>prev === <span class="org-constant">null</span> || prev === <span class="org-constant">undefined</span><span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-3">{</span>
      <span class="org-keyword">return</span> <span class="org-constant">null</span>;
    <span class="org-rainbow-delimiters-depth-3">}</span> <span class="org-keyword">else</span> <span class="org-rainbow-delimiters-depth-3">{</span>
      <span class="org-keyword">return</span> <span class="org-function-name">func</span><span class="org-rainbow-delimiters-depth-4">(</span>prev<span class="org-rainbow-delimiters-depth-4">)</span>;
    <span class="org-rainbow-delimiters-depth-3">}</span>
  <span class="org-rainbow-delimiters-depth-2">}</span>;
  <span class="org-keyword">export</span> <span class="org-keyword">const</span> <span class="org-variable-name">pure</span> = &lt;A&gt;<span class="org-rainbow-delimiters-depth-2">(</span>value: A<span class="org-rainbow-delimiters-depth-2">)</span>: <span class="org-type">AsyncMaybe</span>&lt;<span class="org-type">A</span>&gt; <span class="org-keyword">=&gt;</span> <span class="org-type">Promise</span>.<span class="org-function-name">resolve</span><span class="org-rainbow-delimiters-depth-2">(</span>value<span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-keyword">export</span> <span class="org-keyword">class</span> <span class="org-type">AsyncMaybeChain</span>&lt;<span class="org-type">Input</span>, <span class="org-type">OutputScope</span> <span class="org-typescript-access-modifier">extends</span> <span class="org-type">Scope</span>&lt;<span class="org-typescript-primitive">any</span>&gt;&gt; <span class="org-rainbow-delimiters-depth-1">{</span>
  <span class="org-typescript-access-modifier">private</span> <span class="org-typescript-access-modifier">readonly</span> operation: <span class="org-rainbow-delimiters-depth-2">(</span>input: <span class="org-type">Input</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">=&gt;</span> <span class="org-type">AsyncMaybe</span>&lt;<span class="org-type">OutputScope</span>&gt;;
  <span class="org-keyword">constructor</span><span class="org-rainbow-delimiters-depth-2">(</span>starter: <span class="org-rainbow-delimiters-depth-3">(</span>input: <span class="org-type">Input</span><span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-keyword">=&gt;</span> <span class="org-type">AsyncMaybe</span>&lt;<span class="org-type">OutputScope</span>&gt;<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-typescript-this">this</span>.operation = starter;
  <span class="org-rainbow-delimiters-depth-2">}</span>

  <span class="org-function-name">execute</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-variable-name">input</span>: <span class="org-type">Input</span><span class="org-rainbow-delimiters-depth-2">)</span>: <span class="org-type">AsyncMaybe</span>&lt;<span class="org-type">OutputScope</span>&gt; <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">return</span> <span class="org-typescript-this">this</span>.<span class="org-function-name">operation</span><span class="org-rainbow-delimiters-depth-3">(</span>input<span class="org-rainbow-delimiters-depth-3">)</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>

  <span class="org-function-name">chain</span>&lt;<span class="org-type">NextOutput</span>, <span class="org-type">ResultName</span> <span class="org-typescript-access-modifier">extends</span> <span class="org-typescript-primitive">string</span>&gt;<span class="org-rainbow-delimiters-depth-2">(</span>
    <span class="org-variable-name">resultName</span>: <span class="org-type">ResultName</span>,
    <span class="org-variable-name">next</span>: <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-variable-name">previous</span>: <span class="org-type">OutputScope</span><span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-keyword">=&gt;</span> <span class="org-type">AsyncMaybe</span>&lt;<span class="org-type">NextOutput</span>&gt;
  <span class="org-rainbow-delimiters-depth-2">)</span>: <span class="org-type">AsyncMaybeChain</span>&lt;
    Input,
    ExtendedScope&lt;<span class="org-type">OutputScope</span>, <span class="org-type">ResultName</span>, <span class="org-type">NextOutput</span>&gt;
  &gt; <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">const</span> <span class="org-variable-name">chainedOperation</span> = <span class="org-rainbow-delimiters-depth-3">(</span>
      <span class="org-variable-name">input</span>: <span class="org-type">Input</span>
    <span class="org-rainbow-delimiters-depth-3">)</span>: <span class="org-type">AsyncMaybe</span>&lt;<span class="org-type">ExtendedScope</span>&lt;<span class="org-type">OutputScope</span>, <span class="org-type">ResultName</span>, <span class="org-type">NextOutput</span>&gt;&gt; <span class="org-keyword">=&gt;</span> <span class="org-rainbow-delimiters-depth-3">{</span>
      <span class="org-keyword">const</span> <span class="org-variable-name">previousResult</span> = <span class="org-typescript-this">this</span>.<span class="org-function-name">operation</span><span class="org-rainbow-delimiters-depth-4">(</span>input<span class="org-rainbow-delimiters-depth-4">)</span>;
      <span class="org-keyword">return</span> AsyncMaybe.<span class="org-function-name">bind</span><span class="org-rainbow-delimiters-depth-4">(</span>previousResult, <span class="org-rainbow-delimiters-depth-5">(</span><span class="org-variable-name">output</span>: <span class="org-type">OutputScope</span><span class="org-rainbow-delimiters-depth-5">)</span> <span class="org-keyword">=&gt;</span> <span class="org-rainbow-delimiters-depth-5">{</span>
        <span class="org-keyword">return</span> AsyncMaybe.<span class="org-function-name">bind</span><span class="org-rainbow-delimiters-depth-6">(</span><span class="org-function-name">next</span><span class="org-rainbow-delimiters-depth-7">(</span>output<span class="org-rainbow-delimiters-depth-7">)</span>, <span class="org-rainbow-delimiters-depth-7">(</span><span class="org-variable-name">nextOutput</span><span class="org-rainbow-delimiters-depth-7">)</span> <span class="org-keyword">=&gt;</span> <span class="org-rainbow-delimiters-depth-7">{</span>
          <span class="org-keyword">return</span> AsyncMaybe.<span class="org-function-name">pure</span><span class="org-rainbow-delimiters-depth-8">(</span><span class="org-function-name">extendScope</span><span class="org-rainbow-delimiters-depth-9">(</span>output, resultName, nextOutput<span class="org-rainbow-delimiters-depth-9">)</span><span class="org-rainbow-delimiters-depth-8">)</span>;
        <span class="org-rainbow-delimiters-depth-7">}</span><span class="org-rainbow-delimiters-depth-6">)</span>;
      <span class="org-rainbow-delimiters-depth-5">}</span><span class="org-rainbow-delimiters-depth-4">)</span>;
    <span class="org-rainbow-delimiters-depth-3">}</span>;
    <span class="org-keyword">return</span> <span class="org-keyword">new</span> <span class="org-type">AsyncMaybeChain</span><span class="org-rainbow-delimiters-depth-3">(</span>chainedOperation<span class="org-rainbow-delimiters-depth-3">)</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>

  <span class="org-function-name">map</span>&lt;<span class="org-type">NextOutput</span>, <span class="org-type">ResultName</span> <span class="org-typescript-access-modifier">extends</span> <span class="org-typescript-primitive">string</span>&gt;<span class="org-rainbow-delimiters-depth-2">(</span>
    <span class="org-variable-name">resultName</span>: <span class="org-type">ResultName</span>,
    <span class="org-variable-name">next</span>: <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-variable-name">previous</span>: <span class="org-type">OutputScope</span><span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-keyword">=&gt;</span> <span class="org-type">NextOutput</span>
  <span class="org-rainbow-delimiters-depth-2">)</span>: <span class="org-type">AsyncMaybeChain</span>&lt;
    Input,
    ExtendedScope&lt;<span class="org-type">OutputScope</span>, <span class="org-type">ResultName</span>, <span class="org-type">NextOutput</span>&gt;
  &gt; <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">return</span> <span class="org-typescript-this">this</span>.<span class="org-function-name">chain</span><span class="org-rainbow-delimiters-depth-3">(</span>resultName, <span class="org-rainbow-delimiters-depth-4">(</span>scope<span class="org-rainbow-delimiters-depth-4">)</span> <span class="org-keyword">=&gt;</span> <span class="org-type">AsyncMaybe</span>.<span class="org-function-name">pure</span><span class="org-rainbow-delimiters-depth-4">(</span><span class="org-function-name">next</span><span class="org-rainbow-delimiters-depth-5">(</span>scope<span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>

  <span class="org-function-name">executeTarget</span>&lt;<span class="org-type">ResultName</span> <span class="org-typescript-access-modifier">extends</span> <span class="org-type">keyof</span> <span class="org-type">OutputScope</span>&gt;<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-variable-name">resultName</span>: <span class="org-type">ResultName</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">return</span> <span class="org-rainbow-delimiters-depth-3">(</span>input: <span class="org-type">Input</span><span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-keyword">=&gt;</span>
      AsyncMaybe.<span class="org-function-name">bind</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-typescript-this">this</span>.<span class="org-function-name">execute</span><span class="org-rainbow-delimiters-depth-4">(</span>input<span class="org-rainbow-delimiters-depth-4">)</span>, <span class="org-rainbow-delimiters-depth-4">(</span>outputScope<span class="org-rainbow-delimiters-depth-4">)</span> <span class="org-keyword">=&gt;</span>
        AsyncMaybe.<span class="org-function-name">pure</span><span class="org-rainbow-delimiters-depth-4">(</span>outputScope<span class="org-rainbow-delimiters-depth-5">[</span>resultName<span class="org-rainbow-delimiters-depth-5">]</span><span class="org-rainbow-delimiters-depth-4">)</span>
      <span class="org-rainbow-delimiters-depth-3">)</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>

  <span class="org-typescript-access-modifier">static</span> <span class="org-function-name">start</span>&lt;<span class="org-type">InputScope</span> <span class="org-typescript-access-modifier">extends</span> <span class="org-type">Scope</span>&lt;<span class="org-typescript-primitive">any</span>&gt;&gt;<span class="org-rainbow-delimiters-depth-2">()</span>: <span class="org-type">AsyncMaybeChain</span>&lt;
    InputScope,
    InputScope
  &gt; <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">return</span> <span class="org-keyword">new</span> <span class="org-type">AsyncMaybeChain</span><span class="org-rainbow-delimiters-depth-3">(</span>AsyncMaybe.pure&lt;<span class="org-type">InputScope</span>&gt;<span class="org-rainbow-delimiters-depth-3">)</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-keyword">export</span> <span class="org-keyword">const</span> <span class="org-variable-name">maybeTest</span> = AsyncMaybeChain.<span class="org-function-name">start</span>&lt;<span class="org-rainbow-delimiters-depth-1">{</span> initialInput: <span class="org-typescript-primitive">string</span> <span class="org-rainbow-delimiters-depth-1">}</span>&gt;<span class="org-rainbow-delimiters-depth-1">()</span>
  .<span class="org-function-name">chain</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"punctuation"</span>, <span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">=&gt;</span> <span class="org-type">AsyncMaybe</span>.<span class="org-function-name">pure</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"!"</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
  .<span class="org-function-name">chain</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"finalGreeting"</span>, <span class="org-rainbow-delimiters-depth-2">(</span>scope<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">=&gt;</span>
    AsyncMaybe.<span class="org-function-name">pure</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">`Hello ${scope.initialInput}${scope.punctuation}`</span><span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-1">)</span>.execute;

<span class="org-keyword">export</span> <span class="org-keyword">interface</span> <span class="org-type">MaybeData</span> <span class="org-rainbow-delimiters-depth-1">{</span>
  getName: <span class="org-rainbow-delimiters-depth-2">(</span>userId: <span class="org-typescript-primitive">string</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">=&gt;</span> <span class="org-type">Promise</span>&lt;<span class="org-typescript-primitive">string</span> | <span class="org-type">null</span>&gt;;
  getPunctuation: <span class="org-rainbow-delimiters-depth-2">(</span>name: <span class="org-typescript-primitive">string</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">=&gt;</span> <span class="org-type">Promise</span>&lt;<span class="org-typescript-primitive">string</span> | <span class="org-type">undefined</span>&gt;;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Without Chain</span>
<span class="org-keyword">export</span> <span class="org-keyword">const</span> <span class="org-variable-name">before</span> = <span class="org-keyword">async</span> <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">{</span>
  <span class="org-variable-name">userId</span>,
  <span class="org-variable-name">maybeData</span>,
<span class="org-rainbow-delimiters-depth-2">}</span>: <span class="org-rainbow-delimiters-depth-2">{</span>
  <span class="org-variable-name">userId</span>: <span class="org-typescript-primitive">string</span>;
  maybeData: <span class="org-type">MaybeData</span>;
<span class="org-rainbow-delimiters-depth-2">}</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-keyword">=&gt;</span> <span class="org-rainbow-delimiters-depth-1">{</span>
  <span class="org-keyword">const</span> <span class="org-variable-name">name</span> = <span class="org-keyword">await</span> maybeData.<span class="org-function-name">getName</span><span class="org-rainbow-delimiters-depth-2">(</span>userId<span class="org-rainbow-delimiters-depth-2">)</span>;
  <span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-2">(</span>name === <span class="org-constant">null</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">return</span> <span class="org-constant">null</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>
  <span class="org-keyword">const</span> <span class="org-variable-name">punctuation</span> = <span class="org-keyword">await</span> maybeData.<span class="org-function-name">getPunctuation</span><span class="org-rainbow-delimiters-depth-2">(</span>name<span class="org-rainbow-delimiters-depth-2">)</span>;
  <span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-2">(</span>punctuation === <span class="org-constant">undefined</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">return</span> <span class="org-constant">null</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>
  <span class="org-keyword">return</span> <span class="org-string">`Hello ${name}${punctuation}`</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">With Chain</span>
<span class="org-keyword">export</span> <span class="org-keyword">const</span> <span class="org-variable-name">after</span> = AsyncMaybeChain.start&lt;<span class="org-rainbow-delimiters-depth-1">{</span>
  userId: <span class="org-typescript-primitive">string</span>;
  maybeData: <span class="org-type">MaybeData</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>&gt;<span class="org-rainbow-delimiters-depth-1">()</span>
  .<span class="org-function-name">chain</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"name"</span>, <span class="org-rainbow-delimiters-depth-2">(</span>s<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">=&gt;</span> s.maybeData.<span class="org-function-name">getName</span><span class="org-rainbow-delimiters-depth-2">(</span>s.userId<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
  .<span class="org-function-name">chain</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"punctuation"</span>, <span class="org-rainbow-delimiters-depth-2">(</span>s<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">=&gt;</span> s.maybeData.<span class="org-function-name">getPunctuation</span><span class="org-rainbow-delimiters-depth-2">(</span>s.name<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
  .<span class="org-function-name">map</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"result"</span>, <span class="org-rainbow-delimiters-depth-2">(</span>s<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">=&gt;</span> <span class="org-string">`${s.name}{s.punctuation}`</span><span class="org-rainbow-delimiters-depth-1">)</span>
  .<span class="org-function-name">executeTarget</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"result"</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-keyword">export</span> <span class="org-keyword">const</span> <span class="org-variable-name">exhausted</span> = <span class="org-rainbow-delimiters-depth-1">(</span>narrowedType: <span class="org-typescript-primitive">never</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-keyword">=&gt;</span> narrowedType;

<span class="org-keyword">export</span> <span class="org-keyword">type</span> <span class="org-type">SolidSuccess</span>&lt;<span class="org-type">Success</span>&gt; = <span class="org-rainbow-delimiters-depth-1">{</span>
  kind: <span class="org-string">"success"</span>;
  value: <span class="org-type">Success</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-keyword">export</span> <span class="org-keyword">type</span> <span class="org-type">SolidFailure</span>&lt;<span class="org-type">Failure</span>&gt; = <span class="org-rainbow-delimiters-depth-1">{</span>
  kind: <span class="org-string">"failure"</span>;
  failure: <span class="org-type">Failure</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-keyword">export</span> <span class="org-keyword">type</span> <span class="org-type">Solid</span>&lt;<span class="org-type">Success</span>, <span class="org-type">Failure</span>, <span class="org-type">State</span> <span class="org-typescript-access-modifier">extends</span> <span class="org-type">Scope</span>&lt;<span class="org-typescript-primitive">any</span>&gt;&gt; = <span class="org-rainbow-delimiters-depth-1">(</span>
  state: <span class="org-type">Partial</span>&lt;<span class="org-type">State</span>&gt;
<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-keyword">=&gt;</span> <span class="org-type">Promise</span>&lt;<span class="org-rainbow-delimiters-depth-1">{</span>
  state: <span class="org-type">Partial</span>&lt;<span class="org-type">State</span>&gt;;
  result: <span class="org-type">SolidSuccess</span>&lt;<span class="org-type">Success</span>&gt; | SolidFailure&lt;<span class="org-type">Failure</span>&gt;;
<span class="org-rainbow-delimiters-depth-1">}</span>&gt;;

<span class="org-keyword">export</span> <span class="org-keyword">const</span> <span class="org-variable-name">Solid</span> = <span class="org-rainbow-delimiters-depth-1">{</span>
  pure: &lt;Success, State <span class="org-typescript-access-modifier">extends</span> <span class="org-type">Scope</span>&lt;<span class="org-typescript-primitive">any</span>&gt;&gt;<span class="org-rainbow-delimiters-depth-2">(</span>
    <span class="org-variable-name">value</span>: <span class="org-type">Success</span>
  <span class="org-rainbow-delimiters-depth-2">)</span>: <span class="org-type">Solid</span>&lt;<span class="org-type">Success</span>, <span class="org-typescript-primitive">never</span>, <span class="org-type">State</span>&gt; <span class="org-keyword">=&gt;</span> <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">return</span> <span class="org-keyword">async</span> <span class="org-rainbow-delimiters-depth-3">(</span>state<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-keyword">=&gt;</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-rainbow-delimiters-depth-4">{</span> <span class="org-variable-name">state</span>, <span class="org-variable-name">result</span>: <span class="org-rainbow-delimiters-depth-5">{</span> kind: <span class="org-string">"success"</span>, value <span class="org-rainbow-delimiters-depth-5">}</span> <span class="org-rainbow-delimiters-depth-4">}</span><span class="org-rainbow-delimiters-depth-3">)</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>,
  failure: &lt;Failure, State <span class="org-typescript-access-modifier">extends</span> <span class="org-type">Scope</span>&lt;<span class="org-typescript-primitive">any</span>&gt;&gt;<span class="org-rainbow-delimiters-depth-2">(</span>
    <span class="org-variable-name">failure</span>: <span class="org-type">Failure</span>
  <span class="org-rainbow-delimiters-depth-2">)</span>: <span class="org-type">Solid</span>&lt;<span class="org-typescript-primitive">never</span>, <span class="org-type">Failure</span>, <span class="org-type">State</span>&gt; <span class="org-keyword">=&gt;</span> <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">return</span> <span class="org-keyword">async</span> <span class="org-rainbow-delimiters-depth-3">(</span>state<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-keyword">=&gt;</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-rainbow-delimiters-depth-4">{</span> <span class="org-variable-name">state</span>, <span class="org-variable-name">result</span>: <span class="org-rainbow-delimiters-depth-5">{</span> kind: <span class="org-string">"failure"</span>, failure <span class="org-rainbow-delimiters-depth-5">}</span> <span class="org-rainbow-delimiters-depth-4">}</span><span class="org-rainbow-delimiters-depth-3">)</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>,
  bind: &lt;Success, NextSuccess, Failure, NextFailure, State <span class="org-typescript-access-modifier">extends</span> <span class="org-type">Scope</span>&lt;<span class="org-typescript-primitive">any</span>&gt;&gt;<span class="org-rainbow-delimiters-depth-2">(</span>
    <span class="org-variable-name">prev</span>: <span class="org-type">Solid</span>&lt;<span class="org-type">Success</span>, <span class="org-type">Failure</span>, <span class="org-type">State</span>&gt;,
    <span class="org-variable-name">func</span>: <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-variable-name">success</span>: <span class="org-type">Success</span><span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-keyword">=&gt;</span> <span class="org-type">Solid</span>&lt;<span class="org-type">NextSuccess</span>, <span class="org-type">NextFailure</span>, <span class="org-type">State</span>&gt;
  <span class="org-rainbow-delimiters-depth-2">)</span>: <span class="org-type">Solid</span>&lt;<span class="org-type">NextSuccess</span>, <span class="org-type">Failure</span> | <span class="org-type">NextFailure</span>, <span class="org-type">State</span>&gt; <span class="org-keyword">=&gt;</span> <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">return</span> <span class="org-keyword">async</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-variable-name">state</span>: <span class="org-type">Partial</span>&lt;<span class="org-type">State</span>&gt;<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-keyword">=&gt;</span> <span class="org-rainbow-delimiters-depth-3">{</span>
      <span class="org-keyword">const</span> <span class="org-variable-name">awaitedPrevious</span> = <span class="org-keyword">await</span> <span class="org-function-name">prev</span><span class="org-rainbow-delimiters-depth-4">(</span>state<span class="org-rainbow-delimiters-depth-4">)</span>;
      <span class="org-keyword">const</span> <span class="org-variable-name">prevResult</span> = awaitedPrevious.result;
      <span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-4">(</span>prevResult.kind === <span class="org-string">"success"</span><span class="org-rainbow-delimiters-depth-4">)</span> <span class="org-rainbow-delimiters-depth-4">{</span>
        <span class="org-keyword">const</span> <span class="org-variable-name">next</span> = <span class="org-keyword">await</span> <span class="org-function-name">func</span><span class="org-rainbow-delimiters-depth-5">(</span>prevResult.value<span class="org-rainbow-delimiters-depth-5">)(</span>prevResult.<span class="org-variable-name">state</span><span class="org-rainbow-delimiters-depth-5">)</span>;
        <span class="org-keyword">return</span> next;
      <span class="org-rainbow-delimiters-depth-4">}</span> <span class="org-keyword">else</span> <span class="org-rainbow-delimiters-depth-4">{</span>
        <span class="org-keyword">return</span> <span class="org-rainbow-delimiters-depth-5">{</span> state: prevResult.state, result: prevResult <span class="org-rainbow-delimiters-depth-5">}</span>;
      <span class="org-rainbow-delimiters-depth-4">}</span>
    <span class="org-rainbow-delimiters-depth-3">}</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>,
  <span class="org-default">get</span>: &lt;Failure, State <span class="org-typescript-access-modifier">extends</span> <span class="org-type">Scope</span>&lt;<span class="org-typescript-primitive">any</span>&gt;&gt;<span class="org-rainbow-delimiters-depth-2">()</span>: <span class="org-type">Solid</span>&lt;
    Partial&lt;<span class="org-type">State</span>&gt;,
    Failure,
    State
  &gt; <span class="org-keyword">=&gt;</span> <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">return</span> <span class="org-keyword">async</span> <span class="org-rainbow-delimiters-depth-3">(</span>state: <span class="org-type">Partial</span>&lt;<span class="org-type">State</span>&gt;<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-keyword">=&gt;</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-rainbow-delimiters-depth-4">{</span>
      state,
      result: <span class="org-rainbow-delimiters-depth-5">{</span> kind: <span class="org-string">"success"</span>, value: state <span class="org-rainbow-delimiters-depth-5">}</span>,
    <span class="org-rainbow-delimiters-depth-4">}</span><span class="org-rainbow-delimiters-depth-3">)</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>,
  modify: &lt;State <span class="org-typescript-access-modifier">extends</span> <span class="org-type">Scope</span>&lt;<span class="org-typescript-primitive">any</span>&gt;&gt;<span class="org-rainbow-delimiters-depth-2">(</span>
    <span class="org-variable-name">func</span>: <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-variable-name">prev</span>: <span class="org-type">Partial</span>&lt;<span class="org-type">State</span>&gt;<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-keyword">=&gt;</span> <span class="org-type">Partial</span>&lt;<span class="org-type">State</span>&gt;
  <span class="org-rainbow-delimiters-depth-2">)</span>: <span class="org-type">Solid</span>&lt;<span class="org-type">Partial</span>&lt;<span class="org-type">State</span>&gt;, <span class="org-typescript-primitive">never</span>, State&gt; <span class="org-keyword">=&gt;</span> <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">return</span> <span class="org-keyword">async</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-variable-name">state</span>: <span class="org-type">Partial</span>&lt;<span class="org-type">State</span>&gt;<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-keyword">=&gt;</span> <span class="org-rainbow-delimiters-depth-3">{</span>
      <span class="org-keyword">const</span> <span class="org-variable-name">newState</span> = <span class="org-function-name">func</span><span class="org-rainbow-delimiters-depth-4">(</span>state<span class="org-rainbow-delimiters-depth-4">)</span>;
      <span class="org-keyword">return</span> <span class="org-rainbow-delimiters-depth-4">{</span>
        state: newState,
        result: <span class="org-rainbow-delimiters-depth-5">{</span> kind: <span class="org-string">"success"</span>, value: newState <span class="org-rainbow-delimiters-depth-5">}</span>,
      <span class="org-rainbow-delimiters-depth-4">}</span>;
    <span class="org-rainbow-delimiters-depth-3">}</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>,
  <span class="org-default">set</span>: &lt;State <span class="org-typescript-access-modifier">extends</span> <span class="org-type">Scope</span>&lt;<span class="org-typescript-primitive">any</span>&gt;, Key <span class="org-typescript-access-modifier">extends</span> <span class="org-keyword">keyof</span> State&gt;<span class="org-rainbow-delimiters-depth-2">(</span>
    <span class="org-variable-name">key</span>: <span class="org-type">Key</span>,
    <span class="org-variable-name">value</span>: <span class="org-type">State</span><span class="org-rainbow-delimiters-depth-3">[</span>Key<span class="org-rainbow-delimiters-depth-3">]</span>
  <span class="org-rainbow-delimiters-depth-2">)</span>: <span class="org-type">Solid</span>&lt;<span class="org-typescript-primitive">void</span>, <span class="org-typescript-primitive">never</span>, <span class="org-type">State</span>&gt; <span class="org-keyword">=&gt;</span> <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">return</span> Solid.<span class="org-function-name">bind</span><span class="org-rainbow-delimiters-depth-3">(</span>
      Solid.<span class="org-function-name">modify</span><span class="org-rainbow-delimiters-depth-4">(</span><span class="org-rainbow-delimiters-depth-5">(</span>prev<span class="org-rainbow-delimiters-depth-5">)</span> <span class="org-keyword">=&gt;</span> <span class="org-rainbow-delimiters-depth-5">(</span><span class="org-rainbow-delimiters-depth-6">{</span> ...prev, <span class="org-rainbow-delimiters-depth-7">[</span>key<span class="org-rainbow-delimiters-depth-7">]</span>: value <span class="org-rainbow-delimiters-depth-6">}</span><span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span>,
      <span class="org-rainbow-delimiters-depth-4">()</span> <span class="org-keyword">=&gt;</span> <span class="org-type">Solid</span>.<span class="org-function-name">pure</span><span class="org-rainbow-delimiters-depth-4">(</span><span class="org-constant">undefined</span><span class="org-rainbow-delimiters-depth-4">)</span>
    <span class="org-rainbow-delimiters-depth-3">)</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>,
  noThrow: &lt;Success, Failure, State <span class="org-typescript-access-modifier">extends</span> <span class="org-type">Scope</span>&lt;<span class="org-typescript-primitive">any</span>&gt;&gt;<span class="org-rainbow-delimiters-depth-2">(</span>
    <span class="org-variable-name">solid</span>: <span class="org-type">Solid</span>&lt;<span class="org-type">Success</span>, <span class="org-type">Failure</span>, <span class="org-type">State</span>&gt;
  <span class="org-rainbow-delimiters-depth-2">)</span>: <span class="org-type">Solid</span>&lt;<span class="org-type">Success</span>, <span class="org-type">Failure</span> | <span class="org-type">UnhandledExceptionFailure</span>, <span class="org-type">State</span>&gt; <span class="org-keyword">=&gt;</span> <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">return</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-variable-name">state</span>: <span class="org-type">Partial</span>&lt;<span class="org-type">State</span>&gt;<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-keyword">=&gt;</span> <span class="org-rainbow-delimiters-depth-3">{</span>
      <span class="org-keyword">try</span> <span class="org-rainbow-delimiters-depth-4">{</span>
        <span class="org-keyword">return</span> <span class="org-function-name">solid</span><span class="org-rainbow-delimiters-depth-5">(</span>state<span class="org-rainbow-delimiters-depth-5">)</span>;
      <span class="org-rainbow-delimiters-depth-4">}</span> <span class="org-keyword">catch</span> <span class="org-rainbow-delimiters-depth-4">(</span>e<span class="org-rainbow-delimiters-depth-4">)</span> <span class="org-rainbow-delimiters-depth-4">{</span>
        <span class="org-keyword">return</span> Solid.<span class="org-function-name">failure</span><span class="org-rainbow-delimiters-depth-5">(</span><span class="org-rainbow-delimiters-depth-6">{</span>
          <span class="org-default">type</span>: <span class="org-string">"UnhandledException"</span> <span class="org-keyword">as</span> <span class="org-keyword">const</span>,
          thrown: e,
        <span class="org-rainbow-delimiters-depth-6">}</span><span class="org-rainbow-delimiters-depth-5">)(</span><span class="org-variable-name">state</span><span class="org-rainbow-delimiters-depth-5">)</span>;
      <span class="org-rainbow-delimiters-depth-4">}</span>
    <span class="org-rainbow-delimiters-depth-3">}</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>,
  map: &lt;Previous, Next, Failure, State <span class="org-typescript-access-modifier">extends</span> <span class="org-type">Scope</span>&lt;<span class="org-typescript-primitive">any</span>&gt;&gt;<span class="org-rainbow-delimiters-depth-2">(</span>
    <span class="org-variable-name">func</span>: <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-variable-name">previous</span>: <span class="org-type">Previous</span><span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-keyword">=&gt;</span> <span class="org-type">Next</span>,
    <span class="org-variable-name">prev</span>: <span class="org-type">Solid</span>&lt;<span class="org-type">Previous</span>, <span class="org-type">Failure</span>, <span class="org-type">State</span>&gt;
  <span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">=&gt;</span> <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">return</span> Solid.<span class="org-function-name">bind</span><span class="org-rainbow-delimiters-depth-3">(</span>prev, <span class="org-rainbow-delimiters-depth-4">(</span>success<span class="org-rainbow-delimiters-depth-4">)</span> <span class="org-keyword">=&gt;</span> <span class="org-type">Solid</span>.<span class="org-function-name">pure</span><span class="org-rainbow-delimiters-depth-4">(</span><span class="org-function-name">func</span><span class="org-rainbow-delimiters-depth-5">(</span>success<span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>,
  apply: &lt;Success, NextSuccess, Failure, NextFailure, State <span class="org-typescript-access-modifier">extends</span> <span class="org-type">Scope</span>&lt;<span class="org-typescript-primitive">any</span>&gt;&gt;<span class="org-rainbow-delimiters-depth-2">(</span>
    <span class="org-variable-name">funcInMonad</span>: <span class="org-type">Solid</span>&lt;<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-variable-name">prev</span>: <span class="org-type">Success</span><span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-keyword">=&gt;</span> <span class="org-type">NextSuccess</span>, NextFailure, State&gt;,
    <span class="org-variable-name">prev</span>: <span class="org-type">Solid</span>&lt;<span class="org-type">Success</span>, <span class="org-type">Failure</span>, <span class="org-type">State</span>&gt;
  <span class="org-rainbow-delimiters-depth-2">)</span>: <span class="org-type">Solid</span>&lt;<span class="org-type">NextSuccess</span>, <span class="org-type">Failure</span> | <span class="org-type">NextFailure</span>, <span class="org-type">State</span>&gt; <span class="org-keyword">=&gt;</span> <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">return</span> Solid.<span class="org-function-name">bind</span><span class="org-rainbow-delimiters-depth-3">(</span>funcInMonad, <span class="org-rainbow-delimiters-depth-4">(</span>func<span class="org-rainbow-delimiters-depth-4">)</span> <span class="org-keyword">=&gt;</span> <span class="org-type">Solid</span>.<span class="org-function-name">map</span><span class="org-rainbow-delimiters-depth-4">(</span>func, prev<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>,
  lift2: &lt;
    Left,
    Right,
    Result,
    LeftFailure,
    RightFailure,
    State <span class="org-typescript-access-modifier">extends</span> <span class="org-type">Scope</span>&lt;<span class="org-typescript-primitive">any</span>&gt;
  &gt;<span class="org-rainbow-delimiters-depth-2">(</span>
    <span class="org-variable-name">operation</span>: <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-variable-name">left</span>: <span class="org-type">Left</span>, <span class="org-variable-name">right</span>: <span class="org-type">Right</span><span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-keyword">=&gt;</span> <span class="org-type">Result</span>,
    <span class="org-variable-name">left</span>: <span class="org-type">Solid</span>&lt;<span class="org-type">Left</span>, <span class="org-type">LeftFailure</span>, <span class="org-type">State</span>&gt;,
    <span class="org-variable-name">right</span>: <span class="org-type">Solid</span>&lt;<span class="org-type">Right</span>, <span class="org-type">RightFailure</span>, <span class="org-type">State</span>&gt;
  <span class="org-rainbow-delimiters-depth-2">)</span>: <span class="org-type">Solid</span>&lt;<span class="org-type">Result</span>, <span class="org-type">LeftFailure</span> | <span class="org-type">RightFailure</span>, <span class="org-type">State</span>&gt; <span class="org-keyword">=&gt;</span> <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">return</span> Solid.<span class="org-function-name">apply</span><span class="org-rainbow-delimiters-depth-3">(</span>
      Solid.<span class="org-function-name">map</span><span class="org-rainbow-delimiters-depth-4">(</span><span class="org-rainbow-delimiters-depth-5">(</span>left: <span class="org-type">Left</span><span class="org-rainbow-delimiters-depth-5">)</span> <span class="org-keyword">=&gt;</span> <span class="org-rainbow-delimiters-depth-5">(</span>right: <span class="org-type">Right</span><span class="org-rainbow-delimiters-depth-5">)</span> <span class="org-keyword">=&gt;</span> <span class="org-function-name">operation</span><span class="org-rainbow-delimiters-depth-5">(</span>left, right<span class="org-rainbow-delimiters-depth-5">)</span>, left<span class="org-rainbow-delimiters-depth-4">)</span>,
      right
    <span class="org-rainbow-delimiters-depth-3">)</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>,
  traverse: &lt;Input, Success, Failure, State <span class="org-typescript-access-modifier">extends</span> <span class="org-type">Scope</span>&lt;<span class="org-typescript-primitive">any</span>&gt;&gt;<span class="org-rainbow-delimiters-depth-2">(</span>
    <span class="org-variable-name">inputs</span>: <span class="org-type">Input</span><span class="org-rainbow-delimiters-depth-3">[]</span>,
    <span class="org-variable-name">func</span>: <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-variable-name">input</span>: <span class="org-type">Input</span><span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-keyword">=&gt;</span> <span class="org-type">Solid</span>&lt;<span class="org-type">Success</span>, <span class="org-type">Failure</span>, <span class="org-type">State</span>&gt;
  <span class="org-rainbow-delimiters-depth-2">)</span>: <span class="org-type">Solid</span>&lt;<span class="org-type">Success</span><span class="org-rainbow-delimiters-depth-2">[]</span>, <span class="org-type">Failure</span>, <span class="org-type">State</span>&gt; <span class="org-keyword">=&gt;</span> <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">return</span> inputs.<span class="org-function-name">reduce</span>&lt;<span class="org-type">Solid</span>&lt;<span class="org-type">Success</span><span class="org-rainbow-delimiters-depth-3">[]</span>, <span class="org-type">Failure</span>, <span class="org-type">State</span>&gt;&gt;<span class="org-rainbow-delimiters-depth-3">(</span>
      <span class="org-rainbow-delimiters-depth-4">(</span>acc, next<span class="org-rainbow-delimiters-depth-4">)</span> <span class="org-keyword">=&gt;</span>
        Solid.<span class="org-function-name">lift2</span><span class="org-rainbow-delimiters-depth-4">(</span>
          <span class="org-rainbow-delimiters-depth-5">(</span><span class="org-variable-name">results</span>: <span class="org-type">Success</span><span class="org-rainbow-delimiters-depth-6">[]</span>, <span class="org-variable-name">next</span>: <span class="org-type">Success</span><span class="org-rainbow-delimiters-depth-5">)</span> <span class="org-keyword">=&gt;</span> <span class="org-rainbow-delimiters-depth-5">{</span>
            results.<span class="org-function-name">push</span><span class="org-rainbow-delimiters-depth-6">(</span>next<span class="org-rainbow-delimiters-depth-6">)</span>;
            <span class="org-keyword">return</span> results;
          <span class="org-rainbow-delimiters-depth-5">}</span>,
          acc,
          <span class="org-function-name">func</span><span class="org-rainbow-delimiters-depth-5">(</span>next<span class="org-rainbow-delimiters-depth-5">)</span>
        <span class="org-rainbow-delimiters-depth-4">)</span>,
      Solid.<span class="org-function-name">pure</span><span class="org-rainbow-delimiters-depth-4">(</span><span class="org-rainbow-delimiters-depth-5">[]</span><span class="org-rainbow-delimiters-depth-4">)</span>
    <span class="org-rainbow-delimiters-depth-3">)</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>,
<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-keyword">export</span> <span class="org-keyword">type</span> <span class="org-type">UnhandledExceptionFailure</span> = <span class="org-rainbow-delimiters-depth-1">{</span>
  <span class="org-default">type</span>: <span class="org-string">"UnhandledException"</span>;
  thrown: <span class="org-typescript-primitive">any</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-keyword">export</span> <span class="org-keyword">class</span> <span class="org-type">SolidChain</span>&lt;
  Input,
  OutputScope <span class="org-typescript-access-modifier">extends</span> <span class="org-type">Scope</span>&lt;<span class="org-typescript-primitive">any</span>&gt;,
  Failure,
  State <span class="org-typescript-access-modifier">extends</span> <span class="org-type">Scope</span>&lt;<span class="org-typescript-primitive">any</span>&gt;
&gt; <span class="org-rainbow-delimiters-depth-1">{</span>
  <span class="org-typescript-access-modifier">private</span> <span class="org-typescript-access-modifier">readonly</span> operation: <span class="org-rainbow-delimiters-depth-2">(</span>
    input: <span class="org-type">Input</span>
  <span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">=&gt;</span> <span class="org-type">Solid</span>&lt;<span class="org-type">OutputScope</span>, <span class="org-type">Failure</span>, <span class="org-type">State</span>&gt;;
  <span class="org-keyword">constructor</span><span class="org-rainbow-delimiters-depth-2">(</span>starter: <span class="org-rainbow-delimiters-depth-3">(</span>input: <span class="org-type">Input</span><span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-keyword">=&gt;</span> <span class="org-type">Solid</span>&lt;<span class="org-type">OutputScope</span>, <span class="org-type">Failure</span>, <span class="org-type">State</span>&gt;<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-typescript-this">this</span>.operation = starter;
  <span class="org-rainbow-delimiters-depth-2">}</span>

  <span class="org-function-name">execute</span><span class="org-rainbow-delimiters-depth-2">(</span>
    <span class="org-variable-name">input</span>: <span class="org-type">Input</span>
  <span class="org-rainbow-delimiters-depth-2">)</span>: <span class="org-type">Solid</span>&lt;<span class="org-type">OutputScope</span>, <span class="org-type">Failure</span> | <span class="org-type">UnhandledExceptionFailure</span>, <span class="org-type">State</span>&gt; <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">return</span> Solid.<span class="org-function-name">noThrow</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-typescript-this">this</span>.<span class="org-function-name">operation</span><span class="org-rainbow-delimiters-depth-4">(</span>input<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>

  <span class="org-function-name">chain</span>&lt;<span class="org-type">NextOutput</span>, <span class="org-type">NextFailure</span>, <span class="org-type">ResultName</span> <span class="org-typescript-access-modifier">extends</span> <span class="org-typescript-primitive">string</span>&gt;<span class="org-rainbow-delimiters-depth-2">(</span>
    <span class="org-variable-name">resultName</span>: <span class="org-type">ResultName</span>,
    <span class="org-variable-name">next</span>: <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-variable-name">previous</span>: <span class="org-type">OutputScope</span><span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-keyword">=&gt;</span> <span class="org-type">Solid</span>&lt;<span class="org-type">NextOutput</span>, <span class="org-type">NextFailure</span>, <span class="org-type">State</span>&gt;
  <span class="org-rainbow-delimiters-depth-2">)</span>: <span class="org-type">SolidChain</span>&lt;
    Input,
    ExtendedScope&lt;<span class="org-type">OutputScope</span>, <span class="org-type">ResultName</span>, <span class="org-type">NextOutput</span>&gt;,
    Failure | NextFailure,
    State
  &gt; <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">const</span> <span class="org-variable-name">chainedOperation</span> = <span class="org-rainbow-delimiters-depth-3">(</span>
      <span class="org-variable-name">input</span>: <span class="org-type">Input</span>
    <span class="org-rainbow-delimiters-depth-3">)</span>: <span class="org-type">Solid</span>&lt;
      ExtendedScope&lt;<span class="org-type">OutputScope</span>, <span class="org-type">ResultName</span>, <span class="org-type">NextOutput</span>&gt;,
      Failure | NextFailure,
      State
    &gt; <span class="org-keyword">=&gt;</span> <span class="org-rainbow-delimiters-depth-3">{</span>
      <span class="org-keyword">const</span> <span class="org-variable-name">previousResult</span> = <span class="org-typescript-this">this</span>.<span class="org-function-name">operation</span><span class="org-rainbow-delimiters-depth-4">(</span>input<span class="org-rainbow-delimiters-depth-4">)</span>;
      <span class="org-keyword">return</span> Solid.<span class="org-function-name">bind</span><span class="org-rainbow-delimiters-depth-4">(</span>previousResult, <span class="org-rainbow-delimiters-depth-5">(</span><span class="org-variable-name">output</span>: <span class="org-type">OutputScope</span><span class="org-rainbow-delimiters-depth-5">)</span> <span class="org-keyword">=&gt;</span> <span class="org-rainbow-delimiters-depth-5">{</span>
        <span class="org-keyword">return</span> Solid.<span class="org-function-name">bind</span><span class="org-rainbow-delimiters-depth-6">(</span><span class="org-function-name">next</span><span class="org-rainbow-delimiters-depth-7">(</span>output<span class="org-rainbow-delimiters-depth-7">)</span>, <span class="org-rainbow-delimiters-depth-7">(</span><span class="org-variable-name">nextOutput</span><span class="org-rainbow-delimiters-depth-7">)</span> <span class="org-keyword">=&gt;</span> <span class="org-rainbow-delimiters-depth-7">{</span>
          <span class="org-keyword">return</span> Solid.<span class="org-function-name">pure</span><span class="org-rainbow-delimiters-depth-8">(</span><span class="org-function-name">extendScope</span><span class="org-rainbow-delimiters-depth-9">(</span>output, resultName, nextOutput<span class="org-rainbow-delimiters-depth-9">)</span><span class="org-rainbow-delimiters-depth-8">)</span>;
        <span class="org-rainbow-delimiters-depth-7">}</span><span class="org-rainbow-delimiters-depth-6">)</span>;
      <span class="org-rainbow-delimiters-depth-5">}</span><span class="org-rainbow-delimiters-depth-4">)</span>;
    <span class="org-rainbow-delimiters-depth-3">}</span>;
    <span class="org-keyword">return</span> <span class="org-keyword">new</span> <span class="org-type">SolidChain</span><span class="org-rainbow-delimiters-depth-3">(</span>chainedOperation<span class="org-rainbow-delimiters-depth-3">)</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>

  <span class="org-function-name">map</span>&lt;<span class="org-type">NextOutput</span>, <span class="org-type">ResultName</span> <span class="org-typescript-access-modifier">extends</span> <span class="org-typescript-primitive">string</span>&gt;<span class="org-rainbow-delimiters-depth-2">(</span>
    <span class="org-variable-name">resultName</span>: <span class="org-type">ResultName</span>,
    <span class="org-variable-name">next</span>: <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-variable-name">previous</span>: <span class="org-type">OutputScope</span><span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-keyword">=&gt;</span> <span class="org-type">NextOutput</span>
  <span class="org-rainbow-delimiters-depth-2">)</span>: <span class="org-type">SolidChain</span>&lt;
    Input,
    ExtendedScope&lt;<span class="org-type">OutputScope</span>, <span class="org-type">ResultName</span>, <span class="org-type">NextOutput</span>&gt;,
    Failure,
    State
  &gt; <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">return</span> <span class="org-typescript-this">this</span>.<span class="org-function-name">chain</span><span class="org-rainbow-delimiters-depth-3">(</span>resultName, <span class="org-rainbow-delimiters-depth-4">(</span>scope<span class="org-rainbow-delimiters-depth-4">)</span> <span class="org-keyword">=&gt;</span> <span class="org-type">Solid</span>.<span class="org-function-name">pure</span><span class="org-rainbow-delimiters-depth-4">(</span><span class="org-function-name">next</span><span class="org-rainbow-delimiters-depth-5">(</span>scope<span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>

  <span class="org-function-name">tap</span>&lt;<span class="org-type">NextFailure</span>&gt;<span class="org-rainbow-delimiters-depth-2">(</span>
    <span class="org-variable-name">func</span>: <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-variable-name">previous</span>: <span class="org-type">OutputScope</span><span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-keyword">=&gt;</span> <span class="org-type">Solid</span>&lt;<span class="org-typescript-primitive">void</span>, <span class="org-type">NextFailure</span>, <span class="org-type">State</span>&gt;
  <span class="org-rainbow-delimiters-depth-2">)</span>: <span class="org-type">SolidChain</span>&lt;<span class="org-type">Input</span>, <span class="org-type">OutputScope</span>, <span class="org-type">Failure</span> | <span class="org-type">NextFailure</span>, <span class="org-type">State</span>&gt; <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">return</span> <span class="org-keyword">new</span> <span class="org-type">SolidChain</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-rainbow-delimiters-depth-4">(</span>input: <span class="org-type">Input</span><span class="org-rainbow-delimiters-depth-4">)</span> <span class="org-keyword">=&gt;</span>
      Solid.<span class="org-function-name">bind</span><span class="org-rainbow-delimiters-depth-4">(</span><span class="org-typescript-this">this</span>.<span class="org-function-name">operation</span><span class="org-rainbow-delimiters-depth-5">(</span>input<span class="org-rainbow-delimiters-depth-5">)</span>, <span class="org-rainbow-delimiters-depth-5">(</span>scope<span class="org-rainbow-delimiters-depth-5">)</span> <span class="org-keyword">=&gt;</span>
        Solid.<span class="org-function-name">bind</span><span class="org-rainbow-delimiters-depth-5">(</span><span class="org-function-name">func</span><span class="org-rainbow-delimiters-depth-6">(</span>scope<span class="org-rainbow-delimiters-depth-6">)</span>, <span class="org-rainbow-delimiters-depth-6">()</span> <span class="org-keyword">=&gt;</span> <span class="org-type">Solid</span>.<span class="org-function-name">pure</span><span class="org-rainbow-delimiters-depth-6">(</span>scope<span class="org-rainbow-delimiters-depth-6">)</span><span class="org-rainbow-delimiters-depth-5">)</span>
      <span class="org-rainbow-delimiters-depth-4">)</span>
    <span class="org-rainbow-delimiters-depth-3">)</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>

  <span class="org-function-name">executeTarget</span>&lt;<span class="org-type">ResultName</span> <span class="org-typescript-access-modifier">extends</span> <span class="org-type">keyof</span> <span class="org-type">OutputScope</span>&gt;<span class="org-rainbow-delimiters-depth-2">(</span>
    <span class="org-variable-name">resultName</span>: <span class="org-type">ResultName</span>
  <span class="org-rainbow-delimiters-depth-2">)</span>: <span class="org-rainbow-delimiters-depth-2">(</span>
    input: <span class="org-type">Input</span>
  <span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">=&gt;</span> <span class="org-type">Solid</span>&lt;
    OutputScope<span class="org-rainbow-delimiters-depth-2">[</span>ResultName<span class="org-rainbow-delimiters-depth-2">]</span>,
    Failure | UnhandledExceptionFailure,
    State
  &gt; <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">return</span> <span class="org-rainbow-delimiters-depth-3">(</span>input: <span class="org-type">Input</span><span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-keyword">=&gt;</span>
      Solid.<span class="org-function-name">noThrow</span><span class="org-rainbow-delimiters-depth-3">(</span>
        Solid.<span class="org-function-name">bind</span><span class="org-rainbow-delimiters-depth-4">(</span><span class="org-typescript-this">this</span>.<span class="org-function-name">execute</span><span class="org-rainbow-delimiters-depth-5">(</span>input<span class="org-rainbow-delimiters-depth-5">)</span>, <span class="org-rainbow-delimiters-depth-5">(</span>outputScope<span class="org-rainbow-delimiters-depth-5">)</span> <span class="org-keyword">=&gt;</span>
          Solid.<span class="org-function-name">pure</span><span class="org-rainbow-delimiters-depth-5">(</span>outputScope<span class="org-rainbow-delimiters-depth-6">[</span>resultName<span class="org-rainbow-delimiters-depth-6">]</span><span class="org-rainbow-delimiters-depth-5">)</span>
        <span class="org-rainbow-delimiters-depth-4">)</span>
      <span class="org-rainbow-delimiters-depth-3">)</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>

  <span class="org-typescript-access-modifier">static</span> start&lt;
    InputScope <span class="org-typescript-access-modifier">extends</span> <span class="org-type">Scope</span>&lt;<span class="org-typescript-primitive">any</span>&gt;,
    State <span class="org-typescript-access-modifier">extends</span> <span class="org-type">Partial</span>&lt;<span class="org-type">Scope</span>&lt;<span class="org-typescript-primitive">any</span>&gt;&gt;
  &gt;<span class="org-rainbow-delimiters-depth-2">()</span>: <span class="org-type">SolidChain</span>&lt;<span class="org-type">InputScope</span>, <span class="org-type">InputScope</span>, <span class="org-typescript-primitive">never</span>, <span class="org-type">State</span>&gt; <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">return</span> <span class="org-keyword">new</span> <span class="org-type">SolidChain</span><span class="org-rainbow-delimiters-depth-3">(</span>Solid.pure&lt;<span class="org-type">InputScope</span>, <span class="org-type">State</span>&gt;<span class="org-rainbow-delimiters-depth-3">)</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-keyword">type</span> <span class="org-type">HttpRequest</span> = <span class="org-rainbow-delimiters-depth-1">{}</span>;
<span class="org-keyword">type</span> <span class="org-type">User</span> = <span class="org-rainbow-delimiters-depth-1">{}</span>;
<span class="org-keyword">type</span> <span class="org-type">Organization</span> = <span class="org-rainbow-delimiters-depth-1">{}</span>;
<span class="org-keyword">type</span> <span class="org-type">Command</span> = <span class="org-rainbow-delimiters-depth-1">{}</span>;
<span class="org-keyword">type</span> <span class="org-type">Events</span> = <span class="org-rainbow-delimiters-depth-1">{}</span>;
<span class="org-keyword">type</span> <span class="org-type">LaxMessage</span> = <span class="org-rainbow-delimiters-depth-1">{}</span>;

<span class="org-keyword">type</span> <span class="org-type">LaxContext</span> = <span class="org-rainbow-delimiters-depth-1">{</span>
  laxUserId: <span class="org-typescript-primitive">string</span>;
  laxOrganizationId: <span class="org-typescript-primitive">string</span>;
  laxResponseUrl: <span class="org-type">URL</span>;
  actionPayload: <span class="org-typescript-primitive">any</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-keyword">export</span> <span class="org-keyword">interface</span> <span class="org-type">LaxOperations</span> <span class="org-rainbow-delimiters-depth-1">{</span>
  checkSignature: &lt;State <span class="org-typescript-access-modifier">extends</span> <span class="org-type">Scope</span>&lt;<span class="org-typescript-primitive">any</span>&gt;&gt;<span class="org-rainbow-delimiters-depth-2">(</span>scope: <span class="org-rainbow-delimiters-depth-3">{</span>
    httpRequest: <span class="org-type">HttpRequest</span>;
  <span class="org-rainbow-delimiters-depth-3">}</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">=&gt;</span> <span class="org-type">Solid</span>&lt;
    <span class="org-string">"laxSignatureOk"</span>,
    <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-default">type</span>: <span class="org-string">"InvalidLaxSignature"</span>; message: <span class="org-typescript-primitive">string</span> <span class="org-rainbow-delimiters-depth-2">}</span>,
    State
  &gt;;
  parseRequest: &lt;State <span class="org-typescript-access-modifier">extends</span> <span class="org-rainbow-delimiters-depth-2">{</span> laxContext: <span class="org-type">LaxContext</span> <span class="org-rainbow-delimiters-depth-2">}</span>&gt;<span class="org-rainbow-delimiters-depth-2">(</span>scope: <span class="org-rainbow-delimiters-depth-3">{</span>
    laxSignatureCheck: <span class="org-string">"laxSignatureOk"</span>;
  <span class="org-rainbow-delimiters-depth-3">}</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">=&gt;</span> <span class="org-type">Solid</span>&lt;
    LaxContext,
    <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-default">type</span>: <span class="org-string">"UnableToParseLaxContext"</span>; message: <span class="org-typescript-primitive">string</span> <span class="org-rainbow-delimiters-depth-2">}</span>,
    State
  &gt;;
  reply: &lt;State <span class="org-typescript-access-modifier">extends</span> <span class="org-rainbow-delimiters-depth-2">{</span> laxContext: <span class="org-type">LaxContext</span> <span class="org-rainbow-delimiters-depth-2">}</span>&gt;<span class="org-rainbow-delimiters-depth-2">(</span>scope: <span class="org-rainbow-delimiters-depth-3">{</span>
    laxContext: <span class="org-type">LaxContext</span>;
    reply: <span class="org-type">LaxMessage</span>;
  <span class="org-rainbow-delimiters-depth-3">}</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">=&gt;</span> <span class="org-type">Solid</span>&lt;
    <span class="org-typescript-primitive">void</span>,
    <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-default">type</span>: <span class="org-string">"CouldNotContactLax"</span> | <span class="org-string">"LaxRefusedReply"</span>; message: <span class="org-typescript-primitive">string</span> <span class="org-rainbow-delimiters-depth-2">}</span>,
    State
  &gt;;
  findUserAndOrganization: &lt;State <span class="org-typescript-access-modifier">extends</span> <span class="org-type">Scope</span>&lt;<span class="org-typescript-primitive">any</span>&gt;&gt;<span class="org-rainbow-delimiters-depth-2">(</span>scope: <span class="org-rainbow-delimiters-depth-3">{</span>
    laxContext: <span class="org-type">LaxContext</span>;
  <span class="org-rainbow-delimiters-depth-3">}</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">=&gt;</span> <span class="org-type">Solid</span>&lt;
    <span class="org-rainbow-delimiters-depth-2">{</span> user: <span class="org-type">User</span>; organization: <span class="org-type">Organization</span> <span class="org-rainbow-delimiters-depth-2">}</span>,
    <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-default">type</span>: <span class="org-string">"OrganizationNotFound"</span> | <span class="org-string">"UserNotFound"</span>; message: <span class="org-typescript-primitive">string</span> <span class="org-rainbow-delimiters-depth-2">}</span>,
    State
  &gt;;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-keyword">export</span> <span class="org-keyword">interface</span> <span class="org-type">Commands</span> <span class="org-rainbow-delimiters-depth-1">{</span>
  parseUntrustedCommand: &lt;State <span class="org-typescript-access-modifier">extends</span> <span class="org-type">Scope</span>&lt;<span class="org-typescript-primitive">any</span>&gt;&gt;<span class="org-rainbow-delimiters-depth-2">(</span>scope: <span class="org-rainbow-delimiters-depth-3">{</span>
    untrustedCommand: <span class="org-typescript-primitive">any</span>;
  <span class="org-rainbow-delimiters-depth-3">}</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">=&gt;</span> <span class="org-type">Solid</span>&lt;<span class="org-variable-name">Command</span>, <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-variable-name">type</span>: <span class="org-string">"UnrecognizedCommand"</span>; <span class="org-variable-name">message</span>: <span class="org-typescript-primitive">string</span> <span class="org-rainbow-delimiters-depth-2">}</span>, <span class="org-type">State</span>&gt;;
  executeCommand: &lt;State <span class="org-typescript-access-modifier">extends</span> <span class="org-type">Scope</span>&lt;<span class="org-typescript-primitive">any</span>&gt;&gt;<span class="org-rainbow-delimiters-depth-2">(</span>args: <span class="org-rainbow-delimiters-depth-3">{</span>
    userInfo: <span class="org-rainbow-delimiters-depth-4">{</span> user: <span class="org-type">User</span>; organization: <span class="org-type">Organization</span> <span class="org-rainbow-delimiters-depth-4">}</span>;
    command: <span class="org-type">Command</span>;
  <span class="org-rainbow-delimiters-depth-3">}</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">=&gt;</span> <span class="org-type">Solid</span>&lt;
    Events,
    <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-default">type</span>: <span class="org-string">"NotPermitted"</span> | <span class="org-string">"ValidationFailed"</span>; message: <span class="org-typescript-primitive">string</span> <span class="org-rainbow-delimiters-depth-2">}</span>,
    State
  &gt;;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-keyword">export</span> <span class="org-keyword">interface</span> <span class="org-type">TheseWouldBeLocalFunctions</span> <span class="org-rainbow-delimiters-depth-1">{</span>
  createSuccessResponse: <span class="org-rainbow-delimiters-depth-2">(</span>scope: <span class="org-rainbow-delimiters-depth-3">{</span>
    command: <span class="org-type">Command</span>;
    userInfo: <span class="org-rainbow-delimiters-depth-4">{</span> user: <span class="org-type">User</span>; organization: <span class="org-type">Organization</span> <span class="org-rainbow-delimiters-depth-4">}</span>;
    eventsCaused: <span class="org-type">Events</span>;
  <span class="org-rainbow-delimiters-depth-3">}</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">=&gt;</span> <span class="org-type">LaxMessage</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-keyword">export</span> <span class="org-keyword">type</span> <span class="org-type">LaxCallBackState</span> = <span class="org-rainbow-delimiters-depth-1">{</span>
  laxContext: <span class="org-type">LaxContext</span>;
  user: <span class="org-type">User</span>;
  organization: <span class="org-type">Organization</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-keyword">export</span> <span class="org-keyword">type</span> <span class="org-type">LaxCallbackDependencies</span> = <span class="org-rainbow-delimiters-depth-1">{</span>
  laxOperations: <span class="org-type">LaxOperations</span>;
  commands: <span class="org-type">Commands</span>;
  localFunctions: <span class="org-type">TheseWouldBeLocalFunctions</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-keyword">export</span> <span class="org-keyword">const</span> <span class="org-variable-name">processLaxCallback</span> = <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">{</span>
  laxOperations,
  commands,
  localFunctions,
<span class="org-rainbow-delimiters-depth-2">}</span>: <span class="org-type">LaxCallbackDependencies</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-keyword">=&gt;</span>
  SolidChain.<span class="org-function-name">start</span>&lt;<span class="org-rainbow-delimiters-depth-1">{</span> httpRequest: <span class="org-type">HttpRequest</span> <span class="org-rainbow-delimiters-depth-1">}</span>, LaxCallBackState&gt;<span class="org-rainbow-delimiters-depth-1">()</span>
    .<span class="org-function-name">chain</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"laxSignatureCheck"</span>, laxOperations.checkSignature<span class="org-rainbow-delimiters-depth-1">)</span>
    .<span class="org-function-name">chain</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"laxContext"</span>, laxOperations.parseRequest<span class="org-rainbow-delimiters-depth-1">)</span>
    .<span class="org-function-name">tap</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-rainbow-delimiters-depth-3">{</span> laxContext <span class="org-rainbow-delimiters-depth-3">}</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">=&gt;</span> <span class="org-type">Solid</span>.<span class="org-function-name">set</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"laxContext"</span>, laxContext<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
    .<span class="org-function-name">chain</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"command"</span>, <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-rainbow-delimiters-depth-3">{</span> laxContext <span class="org-rainbow-delimiters-depth-3">}</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">=&gt;</span>
      commands.<span class="org-function-name">parseUntrustedCommand</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-rainbow-delimiters-depth-3">{</span>
        untrustedCommand: laxContext.actionPayload,
      <span class="org-rainbow-delimiters-depth-3">}</span><span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-1">)</span>
    .<span class="org-function-name">chain</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"userInfo"</span>, laxOperations.findUserAndOrganization<span class="org-rainbow-delimiters-depth-1">)</span>
    .<span class="org-function-name">tap</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-rainbow-delimiters-depth-3">{</span> userInfo <span class="org-rainbow-delimiters-depth-3">}</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">=&gt;</span> <span class="org-type">Solid</span>.<span class="org-function-name">set</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"user"</span>, userInfo.user<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
    .<span class="org-function-name">tap</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-rainbow-delimiters-depth-3">{</span> userInfo <span class="org-rainbow-delimiters-depth-3">}</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">=&gt;</span> <span class="org-type">Solid</span>.<span class="org-function-name">set</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"organization"</span>, userInfo.organization<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
    .<span class="org-function-name">chain</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"eventsCaused"</span>, commands.executeCommand<span class="org-rainbow-delimiters-depth-1">)</span>
    .<span class="org-function-name">map</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"reply"</span>, localFunctions.createSuccessResponse<span class="org-rainbow-delimiters-depth-1">)</span>
    .<span class="org-function-name">tap</span><span class="org-rainbow-delimiters-depth-1">(</span>laxOperations.reply<span class="org-rainbow-delimiters-depth-1">)</span>
    .<span class="org-function-name">executeTarget</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"eventsCaused"</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-keyword">export</span> <span class="org-keyword">const</span> <span class="org-variable-name">laxCallbackHandler</span> =
  <span class="org-rainbow-delimiters-depth-1">(</span>deps: <span class="org-type">LaxCallbackDependencies</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-keyword">=&gt;</span> <span class="org-keyword">async</span> <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-variable-name">httpRequest</span>: <span class="org-type">HttpRequest</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-keyword">=&gt;</span> <span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-keyword">const</span> <span class="org-variable-name">processResult</span> = <span class="org-keyword">await</span> <span class="org-function-name">processLaxCallback</span><span class="org-rainbow-delimiters-depth-2">(</span>deps<span class="org-rainbow-delimiters-depth-2">)(</span><span class="org-rainbow-delimiters-depth-3">{</span> httpRequest <span class="org-rainbow-delimiters-depth-3">}</span><span class="org-rainbow-delimiters-depth-2">)(</span><span class="org-rainbow-delimiters-depth-3">{}</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-2">(</span>processResult.result.kind === <span class="org-string">"success"</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">{</span>
      <span class="org-type">console</span>.<span class="org-function-name">log</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"Woot! Created events: "</span>, processResult.result.value<span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span> <span class="org-keyword">else</span> <span class="org-rainbow-delimiters-depth-2">{</span>
      <span class="org-comment-delimiter">// </span><span class="org-comment">Error handling</span>
      <span class="org-keyword">const</span> <span class="org-variable-name">reportError</span> = <span class="org-keyword">async</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-variable-name">message</span>: <span class="org-typescript-primitive">string</span><span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-keyword">=&gt;</span> <span class="org-rainbow-delimiters-depth-3">{</span>
        <span class="org-type">console</span>.<span class="org-function-name">log</span><span class="org-rainbow-delimiters-depth-4">(</span>
          <span class="org-string">"Always report errors internally with full info including stack trace for unhandled exceptions"</span>,
          processResult
        <span class="org-rainbow-delimiters-depth-4">)</span>;
        <span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-4">(</span>processResult.state.laxContext<span class="org-rainbow-delimiters-depth-4">)</span> <span class="org-rainbow-delimiters-depth-4">{</span>
          <span class="org-comment-delimiter">// </span><span class="org-comment">We have enough info to tell the user something went wrong.</span>
          <span class="org-comment-delimiter">// </span><span class="org-comment">In theory we could check if this operation failed, but</span>
          <span class="org-comment-delimiter">// </span><span class="org-comment">we also can't do anything about it so :shrug:</span>
          <span class="org-keyword">await</span> deps.laxOperations.<span class="org-function-name">reply</span><span class="org-rainbow-delimiters-depth-5">(</span><span class="org-rainbow-delimiters-depth-6">{</span>
            laxContext: processResult.state.laxContext,
            reply: message <span class="org-keyword">as</span> <span class="org-typescript-primitive">any</span> <span class="org-keyword">as</span> LaxMessage, <span class="org-comment-delimiter">// </span><span class="org-comment">Let's pretend :)</span>
          <span class="org-rainbow-delimiters-depth-6">}</span><span class="org-rainbow-delimiters-depth-5">)(</span><span class="org-rainbow-delimiters-depth-6">{}</span><span class="org-rainbow-delimiters-depth-5">)</span>;
        <span class="org-rainbow-delimiters-depth-4">}</span>
      <span class="org-rainbow-delimiters-depth-3">}</span>;
      <span class="org-keyword">switch</span> <span class="org-rainbow-delimiters-depth-3">(</span>processResult.result.failure.<span class="org-keyword">type</span><span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-3">{</span>
        <span class="org-keyword">case</span> <span class="org-string">"NotPermitted"</span>:
          <span class="org-keyword">await</span> <span class="org-function-name">reportError</span><span class="org-rainbow-delimiters-depth-4">(</span><span class="org-string">"You can't do that"</span><span class="org-rainbow-delimiters-depth-4">)</span>;
          <span class="org-keyword">break</span>;
        <span class="org-keyword">case</span> <span class="org-string">"ValidationFailed"</span>:
          <span class="org-keyword">await</span> <span class="org-function-name">reportError</span><span class="org-rainbow-delimiters-depth-4">(</span><span class="org-string">"You sent the wrong information"</span><span class="org-rainbow-delimiters-depth-4">)</span>;
          <span class="org-keyword">break</span>;
        <span class="org-keyword">case</span> <span class="org-string">"UnrecognizedCommand"</span>:
          <span class="org-keyword">await</span> <span class="org-function-name">reportError</span><span class="org-rainbow-delimiters-depth-4">(</span>
            <span class="org-string">"Something is wrong with the message we sent you, sorry!"</span>
          <span class="org-rainbow-delimiters-depth-4">)</span>;
          <span class="org-keyword">break</span>;
        <span class="org-keyword">case</span> <span class="org-string">"OrganizationNotFound"</span>:
        <span class="org-keyword">case</span> <span class="org-string">"UserNotFound"</span>:
          <span class="org-keyword">await</span> <span class="org-function-name">reportError</span><span class="org-rainbow-delimiters-depth-4">(</span><span class="org-string">"You don't seem to be fully set up on Lax yet"</span><span class="org-rainbow-delimiters-depth-4">)</span>;
          <span class="org-keyword">break</span>;
        <span class="org-keyword">case</span> <span class="org-string">"UnableToParseLaxContext"</span>:
        <span class="org-keyword">case</span> <span class="org-string">"InvalidLaxSignature"</span>:
          <span class="org-keyword">await</span> <span class="org-function-name">reportError</span><span class="org-rainbow-delimiters-depth-4">(</span><span class="org-string">"Invalid callback"</span><span class="org-rainbow-delimiters-depth-4">)</span>;
          <span class="org-keyword">break</span>;
        <span class="org-keyword">case</span> <span class="org-string">"CouldNotContactLax"</span>:
          <span class="org-keyword">await</span> <span class="org-function-name">reportError</span><span class="org-rainbow-delimiters-depth-4">(</span>
            <span class="org-string">"We tried to send you a message, but something went wrong at Lax's end."</span>
          <span class="org-rainbow-delimiters-depth-4">)</span>;
          <span class="org-keyword">break</span>;
        <span class="org-keyword">case</span> <span class="org-string">"LaxRefusedReply"</span>:
          <span class="org-keyword">await</span> <span class="org-function-name">reportError</span><span class="org-rainbow-delimiters-depth-4">(</span>
            <span class="org-string">"We tried to send you a message but something went wrong on our end."</span>
          <span class="org-rainbow-delimiters-depth-4">)</span>;
          <span class="org-keyword">break</span>;
        <span class="org-keyword">case</span> <span class="org-string">"UnhandledException"</span>:
          <span class="org-keyword">await</span> <span class="org-function-name">reportError</span><span class="org-rainbow-delimiters-depth-4">(</span>
            <span class="org-string">"Something went wrong, our support staff will look into it"</span>
          <span class="org-rainbow-delimiters-depth-4">)</span>;
          <span class="org-keyword">break</span>;
        <span class="org-default">default</span>:
          <span class="org-keyword">return</span> <span class="org-function-name">exhausted</span><span class="org-rainbow-delimiters-depth-4">(</span>processResult.result.failure<span class="org-rainbow-delimiters-depth-4">)</span>;
      <span class="org-rainbow-delimiters-depth-3">}</span>
    <span class="org-rainbow-delimiters-depth-2">}</span>
  <span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-keyword">export</span> <span class="org-keyword">const</span> <span class="org-variable-name">traverseExample</span> =
  <span class="org-rainbow-delimiters-depth-1">(</span>commandOperations: <span class="org-type">Commands</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-keyword">=&gt;</span> <span class="org-rainbow-delimiters-depth-1">(</span>untrustedInput: <span class="org-typescript-primitive">any</span><span class="org-rainbow-delimiters-depth-2">[]</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-keyword">=&gt;</span>
    SolidChain.start&lt;
      <span class="org-rainbow-delimiters-depth-1">{</span>
        untrustedInput: <span class="org-typescript-primitive">any</span><span class="org-rainbow-delimiters-depth-2">[]</span>;
        userInfo: <span class="org-rainbow-delimiters-depth-2">{</span> user: <span class="org-type">User</span>; organization: <span class="org-type">Organization</span> <span class="org-rainbow-delimiters-depth-2">}</span>;
      <span class="org-rainbow-delimiters-depth-1">}</span>,
      <span class="org-rainbow-delimiters-depth-1">{}</span>
    &gt;<span class="org-rainbow-delimiters-depth-1">()</span>
      .<span class="org-function-name">chain</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"parsedCommands"</span>, <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-rainbow-delimiters-depth-3">{</span> untrustedInput <span class="org-rainbow-delimiters-depth-3">}</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">=&gt;</span>
        Solid.<span class="org-function-name">traverse</span><span class="org-rainbow-delimiters-depth-2">(</span>untrustedInput, commandOperations.parseUntrustedCommand<span class="org-rainbow-delimiters-depth-2">)</span>
      <span class="org-rainbow-delimiters-depth-1">)</span>
      .<span class="org-function-name">chain</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"resultingEvents"</span>, <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-rainbow-delimiters-depth-3">{</span> parsedCommands, userInfo <span class="org-rainbow-delimiters-depth-3">}</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">=&gt;</span>
        Solid.<span class="org-function-name">traverse</span><span class="org-rainbow-delimiters-depth-2">(</span>parsedCommands, <span class="org-rainbow-delimiters-depth-3">(</span>command<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-keyword">=&gt;</span>
          commandOperations.<span class="org-function-name">executeCommand</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-rainbow-delimiters-depth-4">{</span> command, userInfo <span class="org-rainbow-delimiters-depth-4">}</span><span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-2">)</span>
      <span class="org-rainbow-delimiters-depth-1">)</span>
      .<span class="org-function-name">executeTarget</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"resultingEvents"</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-keyword">const</span> <span class="org-variable-name">expandingErrors</span> =
  <span class="org-rainbow-delimiters-depth-1">(</span>commandOperations: <span class="org-type">Commands</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-keyword">=&gt;</span>
  <span class="org-rainbow-delimiters-depth-1">(</span>untrustedInput: <span class="org-typescript-primitive">any</span>, userInfo: <span class="org-rainbow-delimiters-depth-2">{</span> user: <span class="org-type">User</span>; organization: <span class="org-type">Organization</span> <span class="org-rainbow-delimiters-depth-2">}</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-keyword">=&gt;</span>
    Solid.<span class="org-function-name">bind</span><span class="org-rainbow-delimiters-depth-1">(</span>
      commandOperations.<span class="org-function-name">parseUntrustedCommand</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-rainbow-delimiters-depth-3">{</span>
        untrustedCommand: untrustedInput,
      <span class="org-rainbow-delimiters-depth-3">}</span><span class="org-rainbow-delimiters-depth-2">)</span>,
      <span class="org-rainbow-delimiters-depth-2">(</span>command<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">=&gt;</span> commandOperations.<span class="org-function-name">executeCommand</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-rainbow-delimiters-depth-3">{</span> command, userInfo <span class="org-rainbow-delimiters-depth-3">}</span><span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>
<p>
</div></details>
</p>
</div>
</div>

<div id="outline-container-orgd41e717" class="outline-2">
<h2 id="orgd41e717">Appendix 3: license</h2>
<div class="outline-text-2" id="text-orgd41e717">
<p>
All the code (and only the code) in this blog post is licensed with the MIT license below:
</p>

<blockquote>
<p>
Copyright 2024 Michael Newton
</p>

<p>
Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the Software), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:
</p>

<p>
The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.
</p>

<p>
THE SOFTWARE IS PROVIDED AS IS, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
</p>
</blockquote>
</div>
</div>

<div id="outline-container-org248fa37" class="outline-2">
<h2 id="org248fa37">I have <i>opinions</i></h2>
<div class="outline-text-2" id="text-org248fa37">
<p>
Good stuff! You may have noticed I do as well: the "official" place to comment is on this mastodon post. <a href="https://mastodon.sdf.org/@mavnn/111957791763779112">https://mastodon.sdf.org/@mavnn/111957791763779112</a>
</p>
</div>
</div>
</div>
<div id="postamble" class="status">
<footer id="my-contacts">
<p hx-boost="false"><a href="https://blog.mavnn.co.uk/rss.xml">RSS</a></p>
<p><a href="https://mastodon.sdf.org/@mavnn">Mastodon</a></p>
<p>Git(<a href="https://github.com/mavnn">Hub</a>|<a href="https://gitlab.com/mavnn">Lab</a>)</p>
</footer>
</div>
</body>
</html>
