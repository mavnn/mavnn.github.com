
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Mavnn's blog</title>
  <meta name="author" content="mavnn">

  
  <meta name="description" content="So, in a fit of enthusiasm my boss bought 15 tickets to the London Progressive F# Tutorials when he saw the early birds pricing (did I mention it& &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">


  <link rel="canonical" href="http://blog.mavnn.co.uk/blog/page/4/index.html">
  <link href="/favicon.ico" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Mavnn's blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
<!-- Google Analytics -->
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-37561687-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Mavnn's blog</a></h1>
  
    <h2>Stuff from my brain</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:blog.mavnn.co.uk" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/teaching-f-number-to-c-number-devs/">Teaching F# to C# Devs</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-09-17T11:12:00+01:00" pubdate data-updated="true">Sep 17<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>So, in a fit of enthusiasm my boss bought 15 tickets to the <a href="" title="http://skillsmatter.com/event/scala/progressive-f-tutorials-2013">London Progressive F# Tutorials</a> when he saw the early birds pricing (did I mention it&rsquo;s nice working here?). Several of the people who have been assigned tickets have asked to go largely because they are new to F#, so I&rsquo;ve been asked to put together a starter session to teach them the basics. I&rsquo;ve tried this <a href="" title="http://blog.mavnn.co.uk/an-introduction-to-f-screencast-and-pdf-slide">once before</a> and it was a fairly successful session (F# was adopted as a official supported language in the company partly due to feedback following it). But it was still pretty rough around the edges, and as normal with these things, you always want to do them better the next time round&hellip;</p>

<p>So, with a target audience of curious, experienced C# devs I&rsquo;m wondering about the best approach. The initial session needs to fit in an hour, although I can do individual follow ups afterwards.</p>

<p>My current thinking is to take a block of C# code (smtp sender?) that is fairly straight forward but &lsquo;production ready&rsquo; in the sense that it includes error handling, logging, etc. Then do a straight re-write in F# live coding. And then start refactoring to more idiomatic F# as we go along.</p>

<p>Features I feel would be important to cover:</p>

<ul>
<li>Basic syntax (let, functions, if &hellip; then, etc)</li>
<li>Common idioms (|>, Seq.map)</li>
<li>At least one computational expression (probably an error handling one; simpler than async in some ways)</li>
<li>Several examples of using the match statements</li>
<li>&hellip;which probably means at least one DU, possibly for error handling</li>
<li>Records and { &hellip; with &hellip; } expressions</li>
</ul>


<p>I&rsquo;ve got a week or two to prepare, so what I&rsquo;m really hoping for at this point is suggestions and ideas from people for how to improve this as a session idea, things that threw you when you first started writing F# you think should be covered, whether you think this is a stupid idea for a session from the concept up, etc. Once the session is completed I&rsquo;ll be posting the slides and hopefully a screen cast of it as I did last time for use by <a href="" title="http://fsharp.org">fsharp.org</a>.</p>

<p>Suggestions on the piece of C# code to translate would also be appreciated &ndash; either in terms of ideas of the type of code, or actual open source code that would serve as a code starting point.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/fscheck-breaking-your-code-in-new-and-exciting-ways/">FsCheck - Breaking Your Code in New and Exciting Ways</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-07-12T11:55:00+01:00" pubdate data-updated="true">Jul 12<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="https://github.com/fsharp/FsCheck">FsCheck</a> is a property based testing library for .net. Based on <a href="http://book.realworldhaskell.org/read/testing-and-quality-assurance.html">QuickCheck</a> and <a href="https://github.com/rickynils/scalacheck">scalacheck</a> it can be easily called from any .net language.</p>

<p>But what is property based testing? It&rsquo;s a technique that allows us to define &lsquo;properties&rsquo; for our code, and then let the library try and find input values that break these properties. Let&rsquo;s take an example and see what happens.</p>

<h3>The Brief</h3>

<p>I&rsquo;ve been tasked with writing the backend of a public facing endpoint. Customers can pass user defined input into the endpoint, and we&rsquo;ll add it to their &lsquo;booking&rsquo;. Once they have called the service once with any particular input, we should ignore any further calls with the same value.</p>

<p>Previous architectural decisions mean that we are storing the bookings as XML documents.</p>

<p>(Why yes, I do know this is slightly contrived. Thank you for asking. Hopefully though, you should begin to see similarities to real scenarios you&rsquo;ve coded against.)</p>

<h3>What can we get out of this?</h3>

<p>Well, as well as any normal exploratory unit tests we may decide to write (which I&rsquo;ll ignore for this article to keep things succinct) we can determine a few properties that should always hold true in the brief above:</p>

<ul>
<li>Repeatedly calling the code with the same input xml document and the same input text should always give us the same result. I.E., the code should be idempotent.</li>
<li>Our code should never remove nodes from the XML. The result document will always be the same or longer than the original.</li>
<li>The input is supplied by the customer. It&rsquo;s about as trustworthy as a hungry stoat on speed.</li>
</ul>


<h3>Let&rsquo;s get started</h3>

<p>Let&rsquo;s start off with the core &lsquo;business logic&rsquo; function of this code. We&rsquo;ll ignore for this post how the input gets to the function, and how the document is persisted. It&rsquo;s signature (F# style) will be:</p>

<pre><code>val AddEnhancement :
  xDoc:System.Xml.Linq.XDocument -&gt; input:string -&gt; System.Xml.Linq.XDocument
</code></pre>

<p>After referencing <code>System.Xml</code> and <code>System.Xml.Linq</code>, our first, very naive, attempt at the implementation looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">module</span> <span class="nn">DevEd</span><span class="p">.</span><span class="nc">FsCheck</span>
</span><span class='line'><span class="k">open</span> <span class="nn">System</span><span class="p">.</span><span class="nc">Xml</span>
</span><span class='line'><span class="k">open</span> <span class="nn">System</span><span class="p">.</span><span class="nn">Xml</span><span class="p">.</span><span class="nc">Linq</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="nc">AddEnhancement</span> <span class="o">(</span><span class="n">xDoc</span> <span class="o">:</span> <span class="nc">XDocument</span><span class="o">)</span> <span class="o">(</span><span class="n">input</span> <span class="o">:</span> <span class="kt">string</span><span class="o">)</span> <span class="o">=</span>
</span><span class='line'>    <span class="n">xDoc</span><span class="o">.</span><span class="nn">Root</span><span class="p">.</span><span class="nc">Add</span><span class="o">(</span><span class="nc">XElement</span><span class="o">(</span><span class="nn">XName</span><span class="p">.</span><span class="nc">Get</span> <span class="s2">&quot;Enhancement&quot;</span><span class="o">,</span> <span class="n">input</span><span class="o">))</span>
</span><span class='line'>    <span class="n">xDoc</span>
</span></code></pre></td></tr></table></div></figure>


<p>We know this isn&rsquo;t right &ndash; it&rsquo;s blatantly not idempotent. So let&rsquo;s try and get our failing test.</p>

<p>Although FsCheck does expose a set of NUnit plugin attributes, for this blog post I&rsquo;m just going to run the tests via a console app. So; add a new F# console app to your solution, add references to <code>System.Xml</code>, <code>System.Xml.Linq</code> and your library project then grab FsCheck (it&rsquo;s on NuGet) and we&rsquo;ll see what we can do.</p>

<p>First, we&rsquo;ll need to add a property that we want to test. A property is simply a function that takes a data type FsCheck knows how to generate, and returns a bool. FsCheck knows how to generate strings, so our idempotence property looks something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">open</span> <span class="nc">FsCheck</span>
</span><span class='line'><span class="k">open</span> <span class="nn">DevEd</span><span class="p">.</span><span class="nc">FsCheck</span>
</span><span class='line'><span class="k">open</span> <span class="nn">System</span><span class="p">.</span><span class="nn">Xml</span><span class="p">.</span><span class="nc">Linq</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">baseDoc</span> <span class="o">=</span> <span class="s2">&quot;&lt;root /&gt;&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="o">``</span><span class="nc">Add</span> <span class="n">enhancement</span> <span class="n">must</span> <span class="n">be</span> <span class="n">idempotent</span><span class="o">``</span> <span class="n">input</span> <span class="o">=</span>
</span><span class='line'>    <span class="k">let</span> <span class="n">xml1</span> <span class="o">=</span> <span class="nn">XDocument</span><span class="p">.</span><span class="nc">Parse</span> <span class="n">baseDoc</span>
</span><span class='line'>    <span class="k">let</span> <span class="n">xml2</span> <span class="o">=</span> <span class="nn">XDocument</span><span class="p">.</span><span class="nc">Parse</span> <span class="n">baseDoc</span>
</span><span class='line'>    <span class="o">(</span><span class="nc">AddEnhancement</span> <span class="n">xml1</span> <span class="n">input</span><span class="o">).</span><span class="nc">ToString</span><span class="bp">()</span> <span class="o">=</span>
</span><span class='line'>        <span class="o">(</span><span class="nc">AddEnhancement</span> <span class="o">(</span><span class="nc">AddEnhancement</span> <span class="n">xml2</span> <span class="n">input</span><span class="o">)</span> <span class="n">input</span><span class="o">).</span><span class="nc">ToString</span><span class="bp">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>Looking good. How do we run it? Just add this to the end of the file:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="nn">Check</span><span class="p">.</span><span class="nc">Quick</span> <span class="o">``</span><span class="nc">Add</span> <span class="n">enhancement</span> <span class="n">must</span> <span class="n">be</span> <span class="n">idempotent</span><span class="o">``</span>
</span><span class='line'>
</span><span class='line'><span class="nn">System</span><span class="p">.</span><span class="nn">Console</span><span class="p">.</span><span class="nc">ReadLine</span><span class="bp">()</span> <span class="o">|&gt;</span> <span class="n">ignore</span>
</span></code></pre></td></tr></table></div></figure>


<p>And hey presto:</p>

<p><img src="/images/FsCheck1.png" alt="&quot;&quot; broke my code :(" /></p>

<p>Failing test. Interestingly (and if you check the documents, not coincidently), FsCheck has found the &lsquo;simplest&rsquo; possible failure case: <code>""</code>. Of course, it was helped on this occasion by the fact it was also the first input it tried.</p>

<p>So; let&rsquo;s add some checking to <code>AddEnhancement</code> to make sure we don&rsquo;t re-add the same input more than once.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">let</span> <span class="nc">AddEnhancement</span> <span class="o">(</span><span class="n">xDoc</span> <span class="o">:</span> <span class="nc">XDocument</span><span class="o">)</span> <span class="o">(</span><span class="n">input</span> <span class="o">:</span> <span class="kt">string</span><span class="o">)</span> <span class="o">=</span>
</span><span class='line'>    <span class="k">if</span>
</span><span class='line'>        <span class="n">xDoc</span><span class="o">.</span><span class="nn">Root</span><span class="p">.</span><span class="nc">Elements</span><span class="o">(</span><span class="nn">XName</span><span class="p">.</span><span class="nc">Get</span> <span class="s2">&quot;Enhancement&quot;</span><span class="o">)</span>
</span><span class='line'>        <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">exists</span> <span class="o">(</span><span class="k">fun</span> <span class="n">e</span> <span class="o">-&gt;</span> <span class="n">e</span><span class="o">.</span><span class="nc">Value</span> <span class="o">=</span> <span class="n">input</span><span class="o">)</span>
</span><span class='line'>        <span class="o">|&gt;</span> <span class="ow">not</span> <span class="k">then</span>
</span><span class='line'>            <span class="n">xDoc</span><span class="o">.</span><span class="nn">Root</span><span class="p">.</span><span class="nc">Add</span><span class="o">(</span><span class="nc">XElement</span><span class="o">(</span><span class="nn">XName</span><span class="p">.</span><span class="nc">Get</span> <span class="s2">&quot;Enhancement&quot;</span><span class="o">,</span> <span class="n">input</span><span class="o">))</span>
</span><span class='line'>    <span class="n">xDoc</span>
</span></code></pre></td></tr></table></div></figure>


<p>And re-run the test and&hellip; oops.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="nn">System</span><span class="p">.</span><span class="nc">ArgumentException</span> <span class="n">was</span> <span class="n">unhandled</span> <span class="n">by</span> <span class="n">user</span> <span class="n">code</span>
</span><span class='line'>  <span class="nc">HResult</span><span class="o">=-</span><span class="mi">2147024809</span>
</span><span class='line'>  <span class="nc">Message</span><span class="o">=</span><span class="sc">&#39; &#39;</span><span class="o">,</span> <span class="n">hexadecimal</span> <span class="n">value</span> <span class="mi">0</span><span class="n">x18</span><span class="o">,</span> <span class="n">is</span> <span class="n">an</span> <span class="n">invalid</span> <span class="n">character</span><span class="o">.</span>
</span><span class='line'>  <span class="nc">Source</span><span class="o">=</span><span class="nn">System</span><span class="p">.</span><span class="nc">Xml</span>
</span><span class='line'>  <span class="nc">StackTrace</span><span class="o">:</span>
</span><span class='line'>       <span class="n">at</span> <span class="nn">System</span><span class="p">.</span><span class="nn">Xml</span><span class="p">.</span><span class="nn">XmlEncodedRawTextWriter</span><span class="p">.</span><span class="nc">InvalidXmlChar</span><span class="o">(</span><span class="nc">Int32</span> <span class="n">ch</span><span class="o">,</span> <span class="nc">Char</span><span class="o">*</span> <span class="n">pDst</span><span class="o">,</span> <span class="nc">Boolean</span> <span class="n">entitize</span><span class="o">)</span>
</span><span class='line'>       <span class="n">at</span> <span class="nn">System</span><span class="p">.</span><span class="nn">Xml</span><span class="p">.</span><span class="nn">XmlEncodedRawTextWriter</span><span class="p">.</span><span class="nc">WriteElementTextBlock</span><span class="o">(</span><span class="nc">Char</span><span class="o">*</span> <span class="n">pSrc</span><span class="o">,</span> <span class="nc">Char</span><span class="o">*</span> <span class="n">pSrcEnd</span><span class="o">)</span>
</span><span class='line'>       <span class="n">at</span> <span class="nn">System</span><span class="p">.</span><span class="nn">Xml</span><span class="p">.</span><span class="nn">XmlEncodedRawTextWriter</span><span class="p">.</span><span class="nc">WriteString</span><span class="o">(</span><span class="nc">String</span> <span class="n">text</span><span class="o">)</span>
</span><span class='line'>       <span class="n">at</span> <span class="nn">System</span><span class="p">.</span><span class="nn">Xml</span><span class="p">.</span><span class="nn">XmlEncodedRawTextWriterIndent</span><span class="p">.</span><span class="nc">WriteString</span><span class="o">(</span><span class="nc">String</span> <span class="n">text</span><span class="o">)</span>
</span><span class='line'>       <span class="n">at</span> <span class="nn">System</span><span class="p">.</span><span class="nn">Xml</span><span class="p">.</span><span class="nn">XmlWellFormedWriter</span><span class="p">.</span><span class="nc">WriteString</span><span class="o">(</span><span class="nc">String</span> <span class="n">text</span><span class="o">)</span>
</span><span class='line'>       <span class="n">at</span> <span class="nn">System</span><span class="p">.</span><span class="nn">Xml</span><span class="p">.</span><span class="nn">Linq</span><span class="p">.</span><span class="nn">ElementWriter</span><span class="p">.</span><span class="nc">WriteElement</span><span class="o">(</span><span class="nc">XElement</span> <span class="n">e</span><span class="o">)</span>
</span><span class='line'>       <span class="n">at</span> <span class="nn">System</span><span class="p">.</span><span class="nn">Xml</span><span class="p">.</span><span class="nn">Linq</span><span class="p">.</span><span class="nn">XElement</span><span class="p">.</span><span class="nc">WriteTo</span><span class="o">(</span><span class="nc">XmlWriter</span> <span class="n">writer</span><span class="o">)</span>
</span><span class='line'>       <span class="n">at</span> <span class="nn">System</span><span class="p">.</span><span class="nn">Xml</span><span class="p">.</span><span class="nn">Linq</span><span class="p">.</span><span class="nn">XContainer</span><span class="p">.</span><span class="nc">WriteContentTo</span><span class="o">(</span><span class="nc">XmlWriter</span> <span class="n">writer</span><span class="o">)</span>
</span><span class='line'>       <span class="n">at</span> <span class="nn">System</span><span class="p">.</span><span class="nn">Xml</span><span class="p">.</span><span class="nn">Linq</span><span class="p">.</span><span class="nn">XNode</span><span class="p">.</span><span class="nc">GetXmlString</span><span class="o">(</span><span class="nc">SaveOptions</span> <span class="n">o</span><span class="o">)</span>
</span><span class='line'>       <span class="n">at</span> <span class="nn">System</span><span class="p">.</span><span class="nn">Xml</span><span class="p">.</span><span class="nn">Linq</span><span class="p">.</span><span class="nn">XNode</span><span class="p">.</span><span class="nc">ToString</span><span class="bp">()</span>
</span><span class='line'>       <span class="n">at</span> <span class="nn">Program</span><span class="p">.</span><span class="nc">Add</span> <span class="n">enhancement</span> <span class="n">must</span> <span class="n">be</span> <span class="n">idompotent</span><span class="o">(</span><span class="nc">String</span> <span class="n">input</span><span class="o">)</span> <span class="k">in</span> <span class="nc">C</span><span class="o">:</span><span class="err">\</span><span class="nc">Users</span><span class="err">\</span><span class="n">michael</span><span class="o">.</span><span class="n">newton</span><span class="err">\</span><span class="n">documents</span><span class="err">\</span><span class="n">visual</span> <span class="n">studio</span> <span class="mi">2012</span><span class="err">\</span><span class="nc">Projects</span><span class="err">\</span><span class="nn">DevEd</span><span class="p">.</span><span class="nc">FsCheck</span><span class="err">\</span><span class="nc">TestRunner</span><span class="err">\</span><span class="nn">Program</span><span class="p">.</span><span class="n">fs</span><span class="o">:</span><span class="n">line</span> <span class="mi">10</span>
</span><span class='line'>       <span class="n">at</span> <span class="nn">Program</span><span class="p">.</span><span class="n">clo</span><span class="o">@</span><span class="mi">13</span><span class="o">.</span><span class="nc">Invoke</span><span class="o">(</span><span class="nc">String</span> <span class="n">input</span><span class="o">)</span> <span class="k">in</span> <span class="nc">C</span><span class="o">:</span><span class="err">\</span><span class="nc">Users</span><span class="err">\</span><span class="n">michael</span><span class="o">.</span><span class="n">newton</span><span class="err">\</span><span class="n">documents</span><span class="err">\</span><span class="n">visual</span> <span class="n">studio</span> <span class="mi">2012</span><span class="err">\</span><span class="nc">Projects</span><span class="err">\</span><span class="nn">DevEd</span><span class="p">.</span><span class="nc">FsCheck</span><span class="err">\</span><span class="nc">TestRunner</span><span class="err">\</span><span class="nn">Program</span><span class="p">.</span><span class="n">fs</span><span class="o">:</span><span class="n">line</span> <span class="mi">13</span>
</span><span class='line'>       <span class="n">at</span> <span class="nn">FsCheck</span><span class="p">.</span><span class="nn">Testable</span><span class="p">.</span><span class="n">evaluate</span><span class="o">[</span><span class="n">a</span><span class="o">,</span><span class="n">b</span><span class="o">](</span><span class="nc">FSharpFunc</span><span class="o">`</span><span class="mi">2</span> <span class="n">body</span><span class="o">,</span> <span class="n">a</span> <span class="n">a</span><span class="o">)</span>
</span><span class='line'>  <span class="nc">InnerException</span><span class="o">:</span>
</span></code></pre></td></tr></table></div></figure>


<p>And this is where the full power of FsCheck starts becoming apparent. I know my input is untrusted, so I&rsquo;ve told it to generate <em>any</em> string. And it believed me, and has created an input string that breaks <code>System.Xml.XmlEncodedRawTextWriter.WriteElementTextBlock</code>. This is not a unit test I would have thought to write myself, as I&rsquo;d managed to miss that the fact that <a href="http://blog.mark-mclaren.info/2007/02/invalid-xml-characters-when-valid-utf8_5873.html">not all utf-8 characters are valid in utf-8 encoded xml</a>. In fact, it took me more than a few minutes to work out why it was throwing.</p>

<p>At this point FsCheck has revealed to us that our initial brief is actually incomplete; we&rsquo;ve told the customer that we&rsquo;re willing to accept utf-8 strings as input, but our storage mechanism doesn&rsquo;t support all utf-8 strings. To even get FsCheck to run, we&rsquo;ll have to decide on an error handling strategy &ndash; and importantly, it will have to be a strategy that still fulfils the initial properties specified (unless we decide that what we&rsquo;ve discovered so fundamentally breaks our initial assumptions that they need to be re-visited).</p>

<p>This is a toy project so I&rsquo;m going to bail slightly on this one: I&rsquo;m going to assume that invalid values just add an error node with a &lsquo;cleaned&rsquo; version of the input which could then be reviewed by a human at a later date. This has the advantage that it still fulfils all of our properties above.</p>

<p>Fortunately for us, in .NET 4.0 and above there is a function in the <code>System.Xml</code> namespace called <code>XmlConvert.IsXmlChar</code> which does roughly what you would expect from the name. Let&rsquo;s add an invalid character filter, and an active pattern to tell us if any characters have been removed:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">let</span> <span class="n">filterInvalidChars</span> <span class="o">(</span><span class="n">input</span> <span class="o">:</span> <span class="kt">string</span><span class="o">)</span> <span class="o">=</span>
</span><span class='line'>    <span class="n">input</span>
</span><span class='line'>    <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">filter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">c</span> <span class="o">-&gt;</span> <span class="nn">XmlConvert</span><span class="p">.</span><span class="nc">IsXmlChar</span> <span class="n">c</span><span class="o">)</span>
</span><span class='line'>    <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">map</span> <span class="kt">string</span>
</span><span class='line'>    <span class="o">|&gt;</span> <span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="o">(|</span><span class="nc">ValidXml</span><span class="o">|</span><span class="nc">InvalidXml</span><span class="o">|)</span> <span class="n">str</span> <span class="o">=</span>
</span><span class='line'>    <span class="k">let</span> <span class="n">filtered</span> <span class="o">=</span> <span class="n">filterInvalidChars</span> <span class="n">str</span>
</span><span class='line'>    <span class="k">if</span> <span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">filtered</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">str</span> <span class="k">then</span>
</span><span class='line'>        <span class="nc">ValidXml</span> <span class="n">str</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>        <span class="nc">InvalidXml</span> <span class="n">filtered</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now we can amend <code>AddEnhancement</code> to add enhancement nodes for valid XML text or an error node for sanitized invalid XML text:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">let</span> <span class="nc">AddEnhancement</span> <span class="o">(</span><span class="n">xDoc</span> <span class="o">:</span> <span class="nc">XDocument</span><span class="o">)</span> <span class="o">(</span><span class="n">input</span> <span class="o">:</span> <span class="kt">string</span><span class="o">)</span> <span class="o">=</span>
</span><span class='line'>    <span class="k">match</span> <span class="n">input</span> <span class="k">with</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">ValidXml</span> <span class="n">text</span> <span class="o">-&gt;</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">xDoc</span><span class="o">.</span><span class="nn">Root</span><span class="p">.</span><span class="nc">Elements</span><span class="o">(</span><span class="nn">XName</span><span class="p">.</span><span class="nc">Get</span> <span class="s2">&quot;Enhancement&quot;</span><span class="o">)</span> <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">exists</span><span class="o">(</span><span class="k">fun</span> <span class="n">enhance</span> <span class="o">-&gt;</span> <span class="n">enhance</span><span class="o">.</span><span class="nc">Value</span> <span class="o">=</span> <span class="n">text</span><span class="o">)</span> <span class="k">then</span>
</span><span class='line'>            <span class="n">xDoc</span><span class="o">.</span><span class="nn">Root</span><span class="p">.</span><span class="nc">Add</span><span class="o">(</span><span class="nc">XElement</span><span class="o">(</span><span class="nn">XName</span><span class="p">.</span><span class="nc">Get</span> <span class="s2">&quot;Enhancement&quot;</span><span class="o">,</span> <span class="n">text</span><span class="o">))</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">InvalidXml</span> <span class="n">text</span> <span class="o">-&gt;</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">xDoc</span><span class="o">.</span><span class="nn">Root</span><span class="p">.</span><span class="nc">Elements</span><span class="o">(</span><span class="nn">XName</span><span class="p">.</span><span class="nc">Get</span> <span class="s2">&quot;Error&quot;</span><span class="o">)</span> <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">exists</span><span class="o">(</span><span class="k">fun</span> <span class="n">error</span> <span class="o">-&gt;</span> <span class="n">error</span><span class="o">.</span><span class="nc">Value</span> <span class="o">=</span> <span class="n">text</span><span class="o">)</span> <span class="k">then</span>
</span><span class='line'>            <span class="n">xDoc</span><span class="o">.</span><span class="nn">Root</span><span class="p">.</span><span class="nc">Add</span><span class="o">(</span><span class="nc">XElement</span><span class="o">(</span><span class="nn">XName</span><span class="p">.</span><span class="nc">Get</span> <span class="s2">&quot;Error&quot;</span><span class="o">,</span> <span class="n">text</span><span class="o">))</span>
</span><span class='line'>    <span class="n">xDoc</span>
</span></code></pre></td></tr></table></div></figure>


<p>And when we run FsCheck again:</p>

<p><img src="/images/FsCheck2.png" alt="Hurrah!" /></p>

<p>Excellent stuff.</p>

<p>As a bonus extra, I&rsquo;ve included below a somewhat expanded version of the test code. Remember I said that FsCheck already knows how to generate strings? Unfortunately it doesn&rsquo;t know how to generate XML out of the box, but I was pleasantly surprised how quick and easy it was to write a naive XML generator. It generates <a href="https://gist.github.com/mavnn/5976004#file-example-xml">XML like this</a>. Also, check out the <code>CheckAll</code> function used at the end which allows you to build and run &lsquo;property classes&rsquo; to group families of properties together.</p>

<p>And, of course, per the specification, it checks that the 3rd property above holds true (that adding enhancements never reduces the size of the document).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">module</span> <span class="nn">FsCheck</span><span class="p">.</span><span class="nn">Examples</span><span class="p">.</span><span class="nc">Tests</span>
</span><span class='line'>
</span><span class='line'><span class="k">open</span> <span class="nc">FsCheck</span>
</span><span class='line'><span class="k">open</span> <span class="nn">DevEd</span><span class="p">.</span><span class="nc">FsCheck</span>
</span><span class='line'><span class="k">open</span> <span class="nn">System</span><span class="p">.</span><span class="nn">Xml</span><span class="p">.</span><span class="nc">Linq</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">baseDocText</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;&lt;?xml version=&quot;</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="s2">&quot; encoding=&quot;</span><span class="nc">UTF</span><span class="o">-</span><span class="mi">8</span><span class="s2">&quot;?&gt;</span>
</span><span class='line'><span class="s2">&lt;root /&gt;</span>
</span><span class='line'><span class="s2">&quot;&quot;&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">type</span> <span class="nc">XmlTree</span> <span class="o">=</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">NodeName</span> <span class="k">of</span> <span class="kt">string</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">Container</span> <span class="k">of</span> <span class="kt">string</span> <span class="o">*</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">XmlTree</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">nodeNames</span> <span class="o">=</span>
</span><span class='line'>    <span class="o">[</span><span class="s2">&quot;myNode&quot;</span><span class="o">;</span>
</span><span class='line'>     <span class="s2">&quot;myOtherNode&quot;</span><span class="o">;</span>
</span><span class='line'>     <span class="s2">&quot;someDifferentNode&quot;</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">tree</span> <span class="o">=</span>
</span><span class='line'>    <span class="k">let</span> <span class="k">rec</span> <span class="n">tree&#39;</span> <span class="n">s</span> <span class="o">=</span>
</span><span class='line'>        <span class="k">match</span> <span class="n">s</span> <span class="k">with</span>
</span><span class='line'>        <span class="o">|</span> <span class="mi">0</span> <span class="o">-&gt;</span> <span class="nn">Gen</span><span class="p">.</span><span class="n">map</span> <span class="nc">NodeName</span> <span class="o">(</span><span class="nn">Gen</span><span class="p">.</span><span class="n">elements</span> <span class="n">nodeNames</span><span class="o">)</span>
</span><span class='line'>        <span class="o">|</span> <span class="n">n</span> <span class="k">when</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">-&gt;</span>
</span><span class='line'>            <span class="k">let</span> <span class="n">subtrees</span> <span class="o">=</span>
</span><span class='line'>                <span class="nn">Gen</span><span class="p">.</span><span class="n">sized</span> <span class="o">&lt;|</span> <span class="k">fun</span> <span class="n">s</span> <span class="o">-&gt;</span>
</span><span class='line'>                    <span class="nn">Gen</span><span class="p">.</span><span class="n">resize</span> <span class="o">(</span><span class="n">s</span>
</span><span class='line'>                                <span class="o">|&gt;</span> <span class="kt">float</span>
</span><span class='line'>                                <span class="o">|&gt;</span> <span class="n">sqrt</span>
</span><span class='line'>                                <span class="o">|&gt;</span> <span class="kt">int</span><span class="o">)</span> <span class="o">(</span><span class="nn">Gen</span><span class="p">.</span><span class="n">listOf</span><span class="o">(</span><span class="n">tree&#39;</span><span class="o">(</span><span class="n">n</span> <span class="o">/</span> <span class="mi">2</span><span class="o">)))</span>
</span><span class='line'>            <span class="nn">Gen</span><span class="p">.</span><span class="n">oneof</span>
</span><span class='line'>                <span class="o">[</span><span class="nn">Gen</span><span class="p">.</span><span class="n">map</span> <span class="nc">NodeName</span> <span class="o">(</span><span class="nn">Gen</span><span class="p">.</span><span class="n">elements</span> <span class="n">nodeNames</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>                 <span class="nn">Gen</span><span class="p">.</span><span class="n">map2</span> <span class="o">(</span><span class="k">fun</span> <span class="n">name</span> <span class="n">contents</span> <span class="o">-&gt;</span> <span class="nc">Container</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">contents</span><span class="o">))</span>
</span><span class='line'>                     <span class="o">(</span><span class="nn">Gen</span><span class="p">.</span><span class="n">elements</span> <span class="n">nodeNames</span><span class="o">)</span> <span class="n">subtrees</span><span class="o">]</span>
</span><span class='line'>        <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">invalidArg</span> <span class="s2">&quot;s&quot;</span> <span class="s2">&quot;Size most be positive.&quot;</span>
</span><span class='line'>    <span class="nn">Gen</span><span class="p">.</span><span class="n">sized</span> <span class="n">tree&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">treeToXDoc</span> <span class="n">xmlTree</span> <span class="o">=</span>
</span><span class='line'>    <span class="k">let</span> <span class="k">rec</span> <span class="n">inner</span> <span class="n">currentNode</span> <span class="n">children</span> <span class="o">=</span>
</span><span class='line'>        <span class="k">let</span> <span class="n">childMatch</span> <span class="n">child</span> <span class="o">=</span>
</span><span class='line'>            <span class="k">match</span> <span class="n">child</span> <span class="k">with</span>
</span><span class='line'>            <span class="o">|</span> <span class="nc">NodeName</span> <span class="n">name</span> <span class="o">-&gt;</span> <span class="nc">XElement</span><span class="o">(</span><span class="nn">XName</span><span class="p">.</span><span class="nc">Get</span> <span class="n">name</span><span class="o">)</span>
</span><span class='line'>            <span class="o">|</span> <span class="nc">Container</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">contents</span><span class="o">)</span> <span class="o">-&gt;</span>
</span><span class='line'>                <span class="k">let</span> <span class="n">element</span> <span class="o">=</span> <span class="nc">XElement</span><span class="o">(</span><span class="nn">XName</span><span class="p">.</span><span class="nc">Get</span> <span class="n">name</span><span class="o">)</span>
</span><span class='line'>                <span class="n">inner</span> <span class="n">element</span> <span class="n">contents</span>
</span><span class='line'>        <span class="n">currentNode</span><span class="o">.</span><span class="nc">Add</span><span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="n">childMatch</span> <span class="n">children</span> <span class="o">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">toArray</span><span class="o">)</span>
</span><span class='line'>        <span class="n">currentNode</span>
</span><span class='line'>    <span class="k">match</span> <span class="n">xmlTree</span> <span class="k">with</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">NodeName</span> <span class="n">name</span> <span class="o">-&gt;</span> <span class="nc">XDocument</span><span class="o">(</span><span class="nc">XElement</span><span class="o">(</span><span class="nn">XName</span><span class="p">.</span><span class="nc">Get</span> <span class="n">name</span><span class="o">))</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">Container</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">contents</span><span class="o">)</span> <span class="o">-&gt;</span>
</span><span class='line'>        <span class="k">let</span> <span class="n">doc</span> <span class="o">=</span> <span class="nc">XDocument</span><span class="o">(</span><span class="nc">XElement</span><span class="o">(</span><span class="nn">XName</span><span class="p">.</span><span class="nc">Get</span> <span class="n">name</span><span class="o">))</span>
</span><span class='line'>        <span class="n">inner</span> <span class="n">doc</span><span class="o">.</span><span class="nc">Root</span> <span class="n">contents</span> <span class="o">|&gt;</span> <span class="n">ignore</span>
</span><span class='line'>        <span class="n">doc</span>
</span><span class='line'>
</span><span class='line'><span class="k">type</span> <span class="nc">XmlGenerator</span><span class="bp">()</span> <span class="o">=</span>
</span><span class='line'>    <span class="k">static</span> <span class="k">member</span> <span class="nc">XmlTree</span><span class="bp">()</span> <span class="o">=</span>
</span><span class='line'>        <span class="o">{</span> <span class="k">new</span> <span class="nc">Arbitrary</span><span class="o">&lt;</span><span class="nc">XmlTree</span><span class="o">&gt;</span><span class="bp">()</span> <span class="k">with</span>
</span><span class='line'>              <span class="k">member</span> <span class="n">x</span><span class="o">.</span><span class="nc">Generator</span> <span class="o">=</span> <span class="n">tree</span>
</span><span class='line'>              <span class="k">member</span> <span class="n">x</span><span class="o">.</span><span class="nc">Shrinker</span> <span class="n">t</span> <span class="o">=</span>
</span><span class='line'>                  <span class="k">match</span> <span class="n">t</span> <span class="k">with</span>
</span><span class='line'>                  <span class="o">|</span> <span class="nc">NodeName</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">empty</span>
</span><span class='line'>                  <span class="o">|</span> <span class="nc">Container</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">contents</span><span class="o">)</span> <span class="o">-&gt;</span>
</span><span class='line'>                      <span class="k">match</span> <span class="n">contents</span> <span class="k">with</span>
</span><span class='line'>                      <span class="o">|</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="n">seq</span> <span class="o">{</span> <span class="k">yield</span> <span class="nc">NodeName</span> <span class="n">name</span> <span class="o">}</span>
</span><span class='line'>                      <span class="o">|</span> <span class="n">c</span> <span class="o">-&gt;</span>
</span><span class='line'>                          <span class="n">seq</span> <span class="o">{</span>
</span><span class='line'>                              <span class="k">for</span> <span class="n">n</span> <span class="k">in</span> <span class="n">c</span> <span class="o">-&gt;</span> <span class="n">n</span> <span class="o">}</span> <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">type</span> <span class="nc">XmlUpdaterProperties</span><span class="bp">()</span> <span class="o">=</span>
</span><span class='line'>    <span class="k">static</span> <span class="k">member</span> <span class="o">``</span><span class="nc">AddEnhancement</span> <span class="n">is</span> <span class="n">idempotent</span><span class="o">``(</span><span class="n">data</span> <span class="o">:</span> <span class="kt">string</span><span class="o">)</span> <span class="o">=</span>
</span><span class='line'>        <span class="o">((</span><span class="nc">AddEnhancement</span> <span class="o">&lt;|</span> <span class="nc">AddEnhancement</span> <span class="o">(</span><span class="nn">XDocument</span><span class="p">.</span><span class="nc">Parse</span> <span class="n">baseDocText</span><span class="o">)</span> <span class="n">data</span><span class="o">)</span> <span class="n">data</span><span class="o">)</span>
</span><span class='line'>            <span class="o">.</span><span class="nc">ToString</span><span class="bp">()</span> <span class="o">=</span> <span class="o">(</span><span class="nc">AddEnhancement</span> <span class="o">(</span><span class="nn">XDocument</span><span class="p">.</span><span class="nc">Parse</span> <span class="n">baseDocText</span><span class="o">)</span> <span class="n">data</span><span class="o">)</span>
</span><span class='line'>            <span class="o">.</span><span class="nc">ToString</span><span class="bp">()</span>
</span><span class='line'>    <span class="k">static</span> <span class="k">member</span> <span class="o">``</span><span class="nc">AddEnhancement</span> <span class="n">is</span> <span class="n">idempotent</span> <span class="n">on</span> <span class="n">different</span> <span class="n">xml</span> <span class="n">structures</span><span class="o">``(</span><span class="n">xmlDoc</span> <span class="o">:</span> <span class="nc">XmlTree</span><span class="o">,</span>
</span><span class='line'>                                                                           <span class="n">data</span> <span class="o">:</span> <span class="kt">string</span><span class="o">)</span> <span class="o">=</span>
</span><span class='line'>        <span class="o">(</span><span class="nc">AddEnhancement</span> <span class="o">(</span><span class="n">treeToXDoc</span> <span class="n">xmlDoc</span><span class="o">)</span> <span class="n">data</span><span class="o">).</span><span class="nc">ToString</span><span class="bp">()</span> <span class="o">=</span> <span class="o">(</span><span class="nc">AddEnhancement</span> <span class="o">(</span><span class="nc">AddEnhancement</span> <span class="o">(</span><span class="n">treeToXDoc</span> <span class="n">xmlDoc</span><span class="o">)</span> <span class="n">data</span><span class="o">)</span> <span class="n">data</span><span class="o">)</span>
</span><span class='line'>            <span class="o">.</span><span class="nc">ToString</span><span class="bp">()</span>
</span><span class='line'>    <span class="k">static</span> <span class="k">member</span> <span class="o">``</span><span class="nc">AddEnhancement</span> <span class="n">never</span> <span class="n">reduces</span> <span class="n">the</span> <span class="n">number</span> <span class="k">of</span> <span class="n">nodes</span><span class="o">``</span> <span class="o">(</span><span class="n">xmlDoc</span> <span class="o">:</span> <span class="nc">XmlTree</span><span class="o">,</span> <span class="n">data</span> <span class="o">:</span> <span class="kt">string</span><span class="o">)</span> <span class="o">=</span>
</span><span class='line'>        <span class="nn">Seq</span><span class="p">.</span><span class="n">length</span> <span class="o">((</span><span class="n">treeToXDoc</span> <span class="n">xmlDoc</span><span class="o">).</span><span class="nc">DescendantNodes</span><span class="bp">()</span><span class="o">)</span> <span class="o">=</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">length</span> <span class="o">((</span><span class="nc">AddEnhancement</span> <span class="o">(</span><span class="n">treeToXDoc</span> <span class="n">xmlDoc</span><span class="o">)</span> <span class="n">data</span><span class="o">).</span><span class="nc">DescendantNodes</span><span class="bp">()</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="nn">Arb</span><span class="p">.</span><span class="n">register</span><span class="o">&lt;</span><span class="nc">XmlGenerator</span><span class="o">&gt;</span><span class="bp">()</span> <span class="o">|&gt;</span> <span class="n">ignore</span>
</span><span class='line'><span class="nn">Check</span><span class="p">.</span><span class="nc">QuickAll</span><span class="o">&lt;</span><span class="nc">XmlUpdaterProperties</span><span class="o">&gt;</span><span class="bp">()</span>
</span><span class='line'><span class="nn">System</span><span class="p">.</span><span class="nn">Console</span><span class="p">.</span><span class="nc">ReadLine</span><span class="bp">()</span> <span class="o">|&gt;</span> <span class="n">ignore</span>
</span></code></pre></td></tr></table></div></figure>


<p>Thanks for reading this far. If you want to play yourself, a full copy of the example code is <a href="https://github.com/mavnn/DevEd.FsCheck">on GitHub</a> with an MIT license.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/useful-find-a-decent-windows-console/">Useful Find: A Decent Windows Console</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-07-09T16:12:00+01:00" pubdate data-updated="true">Jul 9<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>New machine, new Octopress set up. On Windows, no less.</p>

<p>So let&rsquo;s hope a blog post actually appears!</p>

<p>Just in case it does, I&rsquo;ll include a useful piece of side
info &ndash; a actually decent Windows console called ConEmu.</p>

<p>I&rsquo;ll leave you with <a href="http://www.hanselman.com/blog/ConEmuTheWindowsTerminalConsolePromptWeveBeenWaitingFor.aspx">Scott Hanselman&rsquo;s excellent review</a>.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/coding-hygiene-moving-from-project-references-to-nuget-dependencies/">Coding Hygiene: Moving From Project References to NuGet Dependencies</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-03-08T17:08:00+00:00" pubdate data-updated="true">Mar 8<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>So, first post with the new blogging engine. Let&rsquo;s see how it goes.</p>

<p>Our code base at <a href="http://15below.com">15below</a> started it&rsquo;s life a fair
while ago, well before any form of .NET package management became
practical. Because of that, we ended up building a lot of code in
&lsquo;lockstep&rsquo; with project references in code as there was no sensible way
of taking versioned binary dependencies.</p>

<p>That&rsquo;s fine and all, but it encourages bad code hygiene: rather than
having sharply defined contracts between components, if you&rsquo;ve got them
all open in the same solution it becomes far too tempting to just nudge
changes around as it&rsquo;s convenient at the time. Changes can infect other
pieces of code, and the power of automatic refactoring across the entire
solution becomes intoxicating.</p>

<p>The result? It becomes very hard to do incremental builds (or
deployments, for that matter). This in turn makes for a long feed back
cycle between making a change, and being able to see it rolled out to a
testing environment.</p>

<p>So as part of the ongoing refactoring that any long lived code base needs to
keep it maintainable and under control, we&rsquo;ve embarked on the process of
splitting our code down into more logically separated repositories that
reference each other via NuGet. This will require us to start being much
more disciplined in our <a href="http://semver.org">semantic versioning</a> than we
have been in the past, but will also allow us to build and deploy
incrementally and massively reduce our feed back times.</p>

<p>As part of splitting out the first logical division (I&rsquo;d like to say
<a href="http://en.wikipedia.org/wiki/Domain-driven_design">domain</a> but we&rsquo;re
not there yet!), I created the new repository and got the included
assemblies up and building on TeamCity. It was only then (stupidly) that
I realised that we had several hundred project references to these
assemblies in our code. There was no way I was going to update them all
by hand, so after a few hours development we now have a script for
idempotently updating a project reference in a [cs|vb|fs]proj file to a
NuGet reference. It does require you to do one update manually first;
especially with assemblies that are strongly signed, I chickened out of
trying to generate the reference nodes that needed to be added
automatically. The script also makes sure that you end up with a
packages.config file with the project that includes the new dependency.</p>

<p>It should be noted that this script has only seen minimal testing, was
coded up for one time use and does not come with a warranty of any kind!
Use at your own risk, and once you understand what it&rsquo;s doing. But for
all that, I hope you find it useful.</p>

<div><script src='https://gist.github.com/mavnn/5983379.js'></script>
<noscript><pre><code></code></pre></noscript></div>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/throttling-the-level-of-concurrency-in-f/">Throttling the Level of Concurrency in F#</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-02-15T00:00:00+00:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Async.Parallel |> Async.RunSynchronously is great for running a load of stuff in parallel in F#, as long as you don&rsquo;t mind them all running at the same time.</p>

<p>Often, though, you want to map across a sequence and run functions on the elements in parallel, but with a limit to how many are being processed concurrently. Whether you&rsquo;re doing something CPU heavy and there&rsquo;s no point running more than the number of processors on the box, or whether you know that you&rsquo;ll swamp a remote server if you just dump all of your connections on it at once, this issue comes up surprisingly often.</p>

<p>As a first stab, you might be tempted to do something like this (if you think like I do):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">let</span> <span class="k">inline</span> <span class="n">doParallelWithThrottle</span> <span class="n">limit</span> <span class="n">f</span> <span class="n">items</span> <span class="o">=</span>
</span><span class='line'>    <span class="k">use</span> <span class="n">sem</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">System</span><span class="p">.</span><span class="nn">Threading</span><span class="p">.</span><span class="nc">Semaphore</span><span class="o">(</span><span class="n">limit</span><span class="o">,</span> <span class="n">limit</span><span class="o">)</span>
</span><span class='line'>    <span class="n">items</span>
</span><span class='line'>    <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="k">fun</span> <span class="n">element</span> <span class="o">-&gt;</span> <span class="n">async</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">sem</span><span class="o">.</span><span class="nc">WaitOne</span><span class="bp">()</span> <span class="o">|&gt;</span> <span class="n">ignore</span>
</span><span class='line'>            <span class="k">let</span> <span class="n">result</span> <span class="o">=</span> <span class="nn">Async</span><span class="p">.</span><span class="nc">RunSynchronously</span> <span class="o">&lt;|</span> <span class="n">async</span> <span class="o">{</span> <span class="k">return</span> <span class="n">f</span> <span class="n">element</span> <span class="o">}</span>
</span><span class='line'>            <span class="n">sem</span><span class="o">.</span><span class="nc">Release</span><span class="bp">()</span> <span class="o">|&gt;</span> <span class="n">ignore</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">result</span>
</span><span class='line'>        <span class="o">})</span>
</span><span class='line'>    <span class="o">|&gt;</span> <span class="nn">Async</span><span class="p">.</span><span class="nc">Parallel</span>
</span><span class='line'>    <span class="o">|&gt;</span> <span class="nn">Async</span><span class="p">.</span><span class="nc">RunSynchronously</span>
</span></code></pre></td></tr></table></div></figure>


<p>In a word: don&rsquo;t. The contention in the Semaphore make this enormously inefficient with even a few hundred tasks.</p>

<p>In the end, the simplest  implementation I could come up with that didn&rsquo;t involve dragging in external dependencies was the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">open</span> <span class="nn">System</span><span class="p">.</span><span class="nn">Collections</span><span class="p">.</span><span class="nc">Concurrent</span>
</span><span class='line'>
</span><span class='line'><span class="k">type</span> <span class="nc">JobRequest</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="nc">T</span><span class="o">&gt;</span> <span class="o">=</span>
</span><span class='line'>    <span class="o">{</span>
</span><span class='line'>        <span class="nc">Id</span> <span class="o">:</span> <span class="kt">int</span>
</span><span class='line'>        <span class="nc">WorkItem</span> <span class="o">:</span> <span class="k">&#39;</span><span class="nc">T</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">type</span> <span class="nc">WorkRequest</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="nc">T</span><span class="o">&gt;</span> <span class="o">=</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">Job</span> <span class="k">of</span> <span class="nc">JobRequest</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="nc">T</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">End</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="k">inline</span> <span class="n">doParallelWithThrottle</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">a</span><span class="o">,</span> <span class="k">&#39;</span><span class="n">b</span><span class="o">&gt;</span> <span class="n">limit</span> <span class="n">f</span> <span class="n">items</span> <span class="o">=</span>
</span><span class='line'>    <span class="k">let</span> <span class="n">itemArray</span> <span class="o">=</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">toArray</span> <span class="n">items</span>
</span><span class='line'>    <span class="k">let</span> <span class="n">itemCount</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="n">itemArray</span>
</span><span class='line'>    <span class="k">let</span> <span class="n">resultMap</span> <span class="o">=</span> <span class="nc">ConcurrentDictionary</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">,</span> <span class="k">&#39;</span><span class="n">b</span><span class="o">&gt;</span><span class="bp">()</span>
</span><span class='line'>    <span class="k">use</span> <span class="n">block</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BlockingCollection</span><span class="o">&lt;</span><span class="nc">WorkRequest</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">a</span><span class="o">&gt;&gt;(</span><span class="mi">1</span><span class="o">)</span>
</span><span class='line'>    <span class="k">use</span> <span class="n">completeBlock</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BlockingCollection</span><span class="o">&lt;</span><span class="kt">unit</span><span class="o">&gt;(</span><span class="mi">1</span><span class="o">)</span>
</span><span class='line'>    <span class="k">let</span> <span class="n">monitor</span> <span class="o">=</span>
</span><span class='line'>        <span class="nn">MailboxProcessor</span><span class="p">.</span><span class="nc">Start</span><span class="o">(</span><span class="k">fun</span> <span class="n">inbox</span> <span class="o">-&gt;</span>
</span><span class='line'>            <span class="k">let</span> <span class="k">rec</span> <span class="n">inner</span> <span class="n">complete</span> <span class="o">=</span>
</span><span class='line'>                <span class="n">async</span> <span class="o">{</span>
</span><span class='line'>                    <span class="k">do</span><span class="o">!</span> <span class="n">inbox</span><span class="o">.</span><span class="nc">Receive</span><span class="bp">()</span>
</span><span class='line'>                    <span class="k">if</span> <span class="n">complete</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">=</span> <span class="n">limit</span> <span class="k">then</span>
</span><span class='line'>                        <span class="n">completeBlock</span><span class="o">.</span><span class="nc">Add</span><span class="o">(</span><span class="bp">()</span><span class="o">)</span>
</span><span class='line'>                        <span class="k">return</span> <span class="bp">()</span>
</span><span class='line'>                    <span class="k">else</span>
</span><span class='line'>                        <span class="k">return</span><span class="o">!</span> <span class="n">inner</span> <span class="o">&lt;|</span> <span class="n">complete</span> <span class="o">+</span> <span class="mi">1</span>
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'>            <span class="n">inner</span> <span class="mi">0</span><span class="o">)</span>
</span><span class='line'>    <span class="k">let</span> <span class="n">createAgent</span> <span class="bp">()</span> <span class="o">=</span>
</span><span class='line'>        <span class="nn">MailboxProcessor</span><span class="p">.</span><span class="nc">Start</span><span class="o">(</span>
</span><span class='line'>            <span class="k">fun</span> <span class="n">inbox</span> <span class="o">-&gt;</span>
</span><span class='line'>                <span class="k">let</span> <span class="k">rec</span> <span class="n">inner</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">async</span> <span class="o">{</span>
</span><span class='line'>                        <span class="k">let</span><span class="o">!</span> <span class="n">request</span> <span class="o">=</span> <span class="n">async</span> <span class="o">{</span> <span class="k">return</span> <span class="n">block</span><span class="o">.</span><span class="nc">Take</span><span class="bp">()</span> <span class="o">}</span>
</span><span class='line'>                        <span class="k">match</span> <span class="n">request</span> <span class="k">with</span>
</span><span class='line'>                        <span class="o">|</span> <span class="nc">Job</span> <span class="n">job</span> <span class="o">-&gt;</span>
</span><span class='line'>                            <span class="k">let</span><span class="o">!</span> <span class="n">result</span> <span class="o">=</span> <span class="n">async</span> <span class="o">{</span> <span class="k">return</span> <span class="n">f</span> <span class="o">(</span><span class="n">job</span><span class="o">.</span><span class="nc">WorkItem</span><span class="o">)</span> <span class="o">}</span>
</span><span class='line'>                            <span class="n">resultMap</span><span class="o">.</span><span class="nc">AddOrUpdate</span><span class="o">(</span><span class="n">job</span><span class="o">.</span><span class="nc">Id</span><span class="o">,</span> <span class="n">result</span><span class="o">,</span> <span class="k">fun</span> <span class="o">_</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">result</span><span class="o">)</span> <span class="o">|&gt;</span> <span class="n">ignore</span>
</span><span class='line'>                            <span class="k">return</span><span class="o">!</span> <span class="n">inner</span> <span class="bp">()</span>
</span><span class='line'>                        <span class="o">|</span> <span class="nc">End</span>  <span class="o">-&gt;</span>
</span><span class='line'>                            <span class="n">monitor</span><span class="o">.</span><span class="nc">Post</span> <span class="bp">()</span>
</span><span class='line'>                            <span class="k">return</span> <span class="bp">()</span>
</span><span class='line'>                    <span class="o">}</span>
</span><span class='line'>                <span class="n">inner</span> <span class="bp">()</span>
</span><span class='line'>        <span class="o">)</span>
</span><span class='line'>    <span class="k">let</span> <span class="n">agents</span> <span class="o">=</span>
</span><span class='line'>        <span class="o">[|</span> <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mi">1</span><span class="o">..</span><span class="n">limit</span> <span class="o">-&gt;</span> <span class="n">createAgent</span><span class="bp">()</span> <span class="o">|]</span>
</span><span class='line'>    <span class="n">itemArray</span>
</span><span class='line'>    <span class="o">|&gt;</span> <span class="nn">Array</span><span class="p">.</span><span class="n">mapi</span> <span class="o">(</span><span class="k">fun</span> <span class="n">i</span> <span class="n">item</span> <span class="o">-&gt;</span> <span class="nc">Job</span> <span class="o">{</span> <span class="nc">Id</span> <span class="o">=</span> <span class="n">i</span><span class="o">;</span> <span class="nc">WorkItem</span> <span class="o">=</span> <span class="n">item</span> <span class="o">})</span>
</span><span class='line'>    <span class="o">|&gt;</span> <span class="nn">Array</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="n">block</span><span class="o">.</span><span class="nc">Add</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="o">[</span><span class="mi">1</span><span class="o">..</span><span class="n">limit</span><span class="o">]</span>
</span><span class='line'>    <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">block</span><span class="o">.</span><span class="nc">Add</span><span class="o">(</span><span class="nc">End</span><span class="o">))</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">completeBlock</span><span class="o">.</span><span class="nc">Take</span><span class="bp">()</span>
</span><span class='line'>    <span class="k">let</span> <span class="n">results</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">zeroCreate</span> <span class="n">itemCount</span>
</span><span class='line'>    <span class="n">resultMap</span>
</span><span class='line'>    <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">kv</span> <span class="o">-&gt;</span> <span class="n">results</span><span class="o">.[</span><span class="n">kv</span><span class="o">.</span><span class="nc">Key</span><span class="o">]</span> <span class="o">&lt;-</span> <span class="n">kv</span><span class="o">.</span><span class="nc">Value</span><span class="o">)</span>
</span><span class='line'>    <span class="n">results</span>
</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/fake-part-2-build-and-test/index.html">Fake Part 2: Build and Test</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-02-13T00:00:00+00:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>The introduction to this series can be found at <a href="http://blog.mavnn.co.uk/getting-started-with-fake-an-introduction-tag">http://blog.mavnn.co.uk/getting-started-with-fake-an-introduction-tag</a> or just check out my Fake tag.</p>
<p><strong>The scenario</strong></p>
<p>So, you&#8217;ve written your brave new F# 3.0 solution, and now you want to build, test and package it with a shared build setup between your CI environment (which, of course, doesn&#8217;t have Visual Studio installed) and your developer&#8217;s machines.</p>
<p><span style="font-size: 13px;">Hopefully this will walk you through most of the potential pitfalls you might find along the way.</span></p>
<p><span style="font-size: 13px;">This post has been written using an actual build.fsx script that we use for a utility project at <a href="http://15below.com" title="15below" target="_blank">15below</a>. We&#8217;re hiring, so if you&#8217;re interested in this kind of thing, drop me a line.</span></p>
<p><strong><span style="font-size: 13px;">Set up</span></strong></p>
<p><span style="font-size: 13px;">There is no installer for the F# 3 compiler, so we&#8217;re going to be playing some games to support building on a TeamCity build agent without VS 2012 installed.</span></p>
<p><span style="font-size: 13px;">The script assumes a few things about your repository:</span></p>
<p>&nbsp;</p>
<ul>
<li><span style="font-size: 13px;">a tools directory with the same NuGet and FSharp directories as at <a href="https://github.com/fsharp/FAKE/tree/develop/tools">https://github.com/fsharp/FAKE/tree/develop/tools</a> (basically a recent nuget.exe in one, and a recent build of the open source F# compiler project in the other)</span></li>
<li><span style="font-size: 13px;">a tools/FAKE directory with a recent build of FAKE (I prefer to have a known version checked into git, but you can read instructions on how to bootstrap it via nuget at <a href="http://www.navision-blog.de/blog/2009/04/01/getting-started-with-fake-a-f-sharp-make-tool/)">http://www.navision-blog.de/blog/2009/04/01/getting-started-with-fake-a-f-sha&#8230;</a></span></li>
</ul>
<p>&nbsp;</p>
<p><span style="font-size: 13px;">From here on down is just a heavily commented build.fsx file. I was going to use FSharp.Formatting to nicely format this, but unfortunately the combination of FSharp.Formatting itself and Posterous have defeated me. Something to play with more at a later date.</span></p>
<p><span style="font-size: 13px;"><script src="https://gist.github.com/4944580.js"></script></span></p>
<p><span style="font-size: 13px;">Hopefully this example will give you a start on using FAKE in real projects.</span></p>
<p><span style="font-size: 13px;">In future posts I&#8217;d like to address some of the more esoteric bits and pieces we&#8217;ve been using FAKE for, such as building Octopus deployment packages, running integration tests (with full setup and database deployment) and running unit tests in parallel. Stay tuned&#8230;</span></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/a-short-interlude-into-adaptive-polling-tag-f/">A Short Interlude Into Adaptive Polling</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-01-22T00:00:00+00:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Your windows service is watching an email inbox.</p>

<p>How often should it poll?</p>

<p>Once every 5 minutes? Every 10? Then of course you realise that it should be different for every customer… or maybe every mailbox. You need more config!</p>

<h3>Or not.</h3>

<p>The real answer, of course, is something completely different: it should poll a lot when a lot of emails are arriving, and not very much when they aren’t.</p>

<p>It took a lot longer than it should have done to get my maths brain back on, but with the help of my wife I eventually settled on this code for deciding the intervals between polls:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">let</span> <span class="n">interval</span> <span class="n">i</span> <span class="o">=</span>
</span><span class='line'>    <span class="k">let</span> <span class="n">x</span> <span class="o">=</span> <span class="kt">float</span> <span class="n">i</span>
</span><span class='line'>    <span class="k">let</span> <span class="n">maxWait</span> <span class="o">=</span> <span class="mi">60</span><span class="o">.</span> <span class="o">*</span> <span class="mi">10</span><span class="o">.</span>
</span><span class='line'>    <span class="k">let</span> <span class="n">raisePower</span> <span class="n">x</span> <span class="o">=</span> <span class="n">pown</span> <span class="o">(</span><span class="n">x</span> <span class="o">/</span><span class="mi">10</span><span class="o">.)</span> <span class="mi">4</span>
</span><span class='line'>    <span class="o">(</span><span class="n">maxWait</span> <span class="o">*</span> <span class="o">(</span><span class="n">raisePower</span> <span class="n">x</span><span class="o">))</span> <span class="o">/</span> <span class="o">(</span><span class="n">raisePower</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="o">.)</span>
</span><span class='line'>    <span class="o">|&gt;</span> <span class="o">(*)</span> <span class="mi">1000</span><span class="o">.</span> <span class="o">|&gt;</span> <span class="kt">int</span>
</span></code></pre></td></tr></table></div></figure>


<p>The ‘i’ in this function is the number of times we’ve polled since the last time a new email was received (if one is received, we reset i to 0).</p>

<p>If you plot this out on a graph, you get something that looks like this:</p>

<p><img src="http://www.wolframalpha.com/share/img?i=d41d8cd98f00b204e9800998ecf8427ehd954rh40i&amp;f=HBQTQYZYGY4TOM3CGRSGMMBWGAYDCM3DGYZGMOBWGFRDANDCMUZAaaaa" alt="" /></p>

<p>You can play with the shape of the graph at <a href="http://www.wolframalpha.com/share/clip?f=d41d8cd98f00b204e9800998ecf8427ehd954rh40i">Wolfram|Alpha if you&rsquo;re feeling really geeky</a> :).</p>

<p>This gives us very aggressive polling for the first few minutes after discovering an email, then dropping off rapidly to close to the one every ten minutes mark that I decided was a reasonable background polling rate.</p>

<p>It&rsquo;s not truly adaptive in the machine learning sense, but it gives a very good first cut that is an awful lot better than any fixed value could be.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/corrected-error-handling-computational-expres/index.html">Corrected Error Handling Computational Expression</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-01-18T00:00:00+00:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I&rsquo;ve been wanting to write code like this in F#, and know that any
exceptions within a bound expression in an audit { } block will not
only get caught, but that an external auditing service will get
notified that the operation has failed.</p>

<p><script src="https://gist.github.com/4565937.js"></script></p>

<p>Unfortunately, it turns out my code in my post on error handling
( <a href="http://blog.mavnn.co.uk/playing-with-error-handling-strategies">http://blog.mavnn.co.uk/playing-with-error-handling-strategies</a> ) was
flawed in its ability to handle errors. The irony has not escaped me.</p>

<p>The issue is with the eager evaluation of arguments to the TryFinally
method of the builder. If it takes you a while to work out what that
means, don&rsquo;t worry: it took me about 2 days to wrap my head round it
and work out how to correct the code to make it behave as I would have
expected.</p>

<p>To make things work correctly, the type returned by the computational
expression pretty much has to be a deferred function of some kind.</p>

<p>So, the Interface, now renamed IAuditBuilder, gains a couple of helper
functions and becomes:</p>

<p><script src="https://gist.github.com/4565812.js"></script></p>

<p>The implementation of the TestAuditBuilder (only logs to console on
error) becomes:</p>

<p><script src="https://gist.github.com/4565838.js"></script></p>

<p>So: many thanks to Johann Deneux for patiently pointing out to me what
the flaw in the original code was. I hope this example of a lazy
computational expression is useful to other starting out down this
rabbit hole of monadic weirdness. At least the resulting code looks
pretty nice and readable now that the builder is fixed.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/in-which-our-intrepid-author-de-sugars-a-mona/index.html">In Which Our Intrepid Author De-sugars a Monad by Hand</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-01-16T00:00:00+00:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In my previous post ( <a href="http://blog.mavnn.co.uk/playing-with-error-handling-strategies">http://blog.mavnn.co.uk/playing-with-error-handling-strategies</a> ), Johann Deneux asked me whether my implementation of TryFinally actually worked. <p /> TD;LR: It works. But thank you Johann for making me check!</p>
<p>Editted TD;LR: It&#8217;s broken, but not for the reason I thought. See the comments for details, and corrected code here&nbsp;<a href="http://blog.mavnn.co.uk/corrected-error-handling-computational-expres">http://blog.mavnn.co.uk/corrected-error-handling-computational-expres</a><p /> This gave me a bit of a pause, as it&#8217;s actually an implementation I took from another source. One I trust, but it was still embarrassing to realise I couldn&#8217;t answer this question with full confidence as I didn&#8217;t quite understand the code myself. <p /> In the end (especially given I&#8217;m planning to actually use this code in production at some point), I decided to go the whole hog and de-sugar a couple of simple versions of the computational expression. <p /> So, first, the audit monad as used in my example code from the last post with just a simple let binding: <p /> <script src="https://gist.github.com/4550342.js"></script><p /> This raised my confidence slightly - the code I&#8217;d written did what I expected. But, what happened when I tried to bind a disposable resource using use! rather than let!? Time for the moment of truth: <p /> <script src="https://gist.github.com/4550496.js"></script><p /> So there you have it. The code does actually behave as expected, protecting the use of the disposable resource and ensuring it&#8217;s disposal. And I can breath easy that my code is doing what I thought it should be. Hopefully this will also serve as a useful example for anyone else starting out on the happy road of using computational expressions.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/playing-with-error-handling-strategies/index.html">Playing With Error Handling Strategies</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-01-14T00:00:00+00:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Taking a break from Fake for a moment (I&#8217;ll get back to it, I promise!) <p /> Note: this post assumes a basic understanding of computation expressions in F#; if you&#8217;re looking for a primer on them,&nbsp;<a href="http://en.wikibooks.org/wiki/F_Sharp_Programming/Computation_Expressions">http://en.wikibooks.org/wiki/F_Sharp_Programming/Computation_Expressions</a> <br />is a good place to start.</p>
<p>Note 2: the code in this post is actually broken if you use a use! or try finally block within your audit block. Check out&nbsp;<a href="http://blog.mavnn.co.uk/corrected-error-handling-computational-expres" style="font-size: 13px;">http://blog.mavnn.co.uk/corrected-error-handling-computational-expres</a>&nbsp;for the corrected code.</p>
<p><br />I had a series of small services I needed to add error handling to today to polish them up from nice clean prototype to production ready status. <p /> Thinking about the joys of re-implementing the same error handling strategy in each of them, it occurred to me that this was exactly the kind of thing that computational expressions were built for. But my requirements went a bit further than just log the error and continue: each of these services contain critical locations where if a error occurred, we didn&#8217;t just want it logged locally, but we wanted (in some cases) an alert sent to a remote auditing* server. <p /> Of course, mocking out the auditing service for testing is a bit of a pain in the backside, and how auditing is achieved shouldn&#8217;t really be the responsibility of these services anyway. <p /> So, I decided to experiment with a builder interface. <p /> Meet the IErrorHandlerBuilder interface: <p /> <script src="https://gist.github.com/4533440.js"></script><p /> Should look awfully familiar if you&#8217;ve recently checked out the msdn page on computational expressions: <a href="http://msdn.microsoft.com/en-us/library/dd233182.aspx">http://msdn.microsoft.com/en-us/library/dd233182.aspx</a> (except, you know, mine has the right signatures; that might want to be fixed at some point). <p /> How do we use it? <p /> Well, first we need an implementation. In fact, let&#8217;s have two. Our first candidate, the AuditBuilder, takes an unhealthy number of dependencies that (in turn) take an unhealthy number of dependencies that you almost certainly want to supply from an IoC container. <p /> <script src="https://gist.github.com/4533554.js"></script><p /> What does it do? Well, basically if any bound function throws it logs the error via log4net and our in house audit server and then returns None. Otherwise it returns Some result from the computation. Obviously, if a computation further up the chain has already thrown we already have a None and we just pass it along. TryFinally and Using are implemented to make sure that you can still use disposable resources as you would expect within the expression. <p /> Our second candidate is the TestErrorBuilder: <p /> <script src="https://gist.github.com/4533560.js"></script><p /> This is almost identical to the implementation above, except that it takes no dependencies at all and if there is an error it just logs to the console via printfn. Very useful for debugging - you might even want a unit test version that logs nothing, depending on your unit tests. <p /> And now, our preparation is complete. How do we use our new toy, you ask? <p /> Something like this: <p /> <script src="https://gist.github.com/4533619.js"></script><p /> This little service persists interesting email messages to a document store, and sends the contents back to you when you request them. If an email is not persisted, or a request for an email fails, we want a remote alert to be triggered in production. Both the persist and content requests are handled as RabbitMq messages (using the EasyNetQ client). <p /> So in the message handler callbacks, declare an audit { } block and let! bind our message. Then we simply pass that bound message on to a handling function or object and return the resulting value, safe in the knowledge that our hosting program will have supplied an appropriate IErrorHandlerBuilder for our current purposes. The beauty of all of this is that the service object does not need to know what the error handling strategy is, and the objects/functions doing the work do not need to worry about error handling at all. <p /> This technique is especially useful in situations where you are making use of asynchronous programming techniques such as agents and you really don&#8217;t want a single failure taking out your whole agent or async expression. If for some reason it&#8217;s important to your code what the error is, as well as knowing it&#8217;s been handled, it would be easy to modify this technique to return a Choice or custom MaybeError discriminated union that you could pull the exception out of later. <p /> It would also be helpful for managing things like SQL connections with multiple retry attempts: for testing you may not want that kind of complexity and you could pass in a simpler strategy builder, while testing your robust, multiple retry computational builder for use in actual deployed environments (test or production). <p /> And, of course, just knowing that builder interfaces are possible raises up a whole new world of possibilities. <p /> As always, I tend to write about stuff that is fresh and new to me (i.e. not fully considered and maybe fatally flawed). Comments and suggestions welcome. <p /> * To avoid any confusion, I should note that the word audit is used loosely in this blog post, with a meaning more related to a namespace within our code than the normal meaning of the word &#8216;audit&#8217;.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/5/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog/page/3/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/functional-programming-in-an-imperitive-world/">Functional Programming in an Imperative World</a>
      </li>
    
      <li class="post">
        <a href="/sdd-conf-2015/">Property Based Testing at SDD Conf 2015</a>
      </li>
    
      <li class="post">
        <a href="/serialization-in-net/">Serialization in .net</a>
      </li>
    
      <li class="post">
        <a href="/api-design-workshop/">API Design Workshop</a>
      </li>
    
      <li class="post">
        <a href="/ecumenical-apis/">Ecumenical APIs</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Tip the author</h1>
  <p><script data-gittip-username="mavnn"
        data-gittip-widget="button"
        src="//gttp.co/v1.js"></script></p>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/mavnn">@mavnn</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'mavnn',
            count: 3,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>



<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/+MichaelNewtonmavnn?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - mavnn -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'mavnn';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
