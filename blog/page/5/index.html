
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Mavnn's blog</title>
  <meta name="author" content="mavnn">

  
  <meta name="description" content="As of a few days ago, the embedded module was merged into Suave master. Enjoy! I&#39;m a great fan of Suave for simple web development in F#. I &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">


  <link rel="canonical" href="https://blog.mavnn.co.uk/blog/page/5/index.html">
  <link href="/favicon.ico" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Mavnn's blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
<!-- Google Analytics -->
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-37561687-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


</head>

<body   >
  <header role="banner"><hgroup>
  <a href="http://mavnn.co.uk"><img class="swirl-logo" src="/images/swirl.svg"/></a>
  <h1><a href="/">Mavnn's blog</a></h1>
  
    <h2>Stuff from my brain</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:blog.mavnn.co.uk" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/single-file-websites-with-suave/">Single File Websites With Suave</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-02-28T09:54:46+00:00" pubdate data-updated="true">Feb 28<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><blockquote>
<p>As of a few days ago, the embedded module <a href="https://github.com/SuaveIO/suave/pull/100/files">was merged</a> into Suave master. Enjoy!</p>
</blockquote>

<p>I&#39;m a great fan of <a href="http://suave.io/">Suave</a> for simple web development in F#. I highly recommend checking out the site for details, but in the mean time I&#39;d like to share a little trick I&#39;ve been using for rapid prototyping that I&#39;m finding very useful.</p>

<p>The Suave.Http module contains a few helpers for serving static files from disk. Unfortunately, depending on use case and deployment strategy, relying on the location of a bunch of files on disk can be problematic.</p>

<p>So (open source to the rescue!) I cracked open the code and wrote a small alternative implementation that serves files from the current assembly&#39;s embedded resources. I&#39;m finding it especially useful for single page JavaScript apps where you have a small number of resources and then a lot of end points providing api functionality.</p>

<p>Setting up your website looks something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">module</span> <span class="nc">Website</span>
</span><span class='line'><span class="k">open</span> <span class="nc">System</span>
</span><span class='line'><span class="k">open</span> <span class="nn">Suave</span><span class="p">.</span><span class="nc">Http</span>
</span><span class='line'><span class="k">open</span> <span class="nn">Suave</span><span class="p">.</span><span class="nc">Types</span>
</span><span class='line'><span class="k">open</span> <span class="nc">Embedded</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">app</span> <span class="o">=</span>
</span><span class='line'>    <span class="n">choose</span> <span class="o">[</span>
</span><span class='line'>        <span class="c1">// serve the embedded index.html for &quot;/&quot;</span>
</span><span class='line'>        <span class="nc">GET</span> <span class="o">&gt;&gt;=</span> <span class="n">url</span> <span class="s2">&quot;/&quot;</span> <span class="o">&gt;&gt;=</span> <span class="n">resource</span> <span class="s2">&quot;index.html&quot;</span>
</span><span class='line'>        <span class="c1">// check if the request matches the name of an embedded resource</span>
</span><span class='line'>        <span class="c1">// if it does, serve it up with a reasonable cache</span>
</span><span class='line'>        <span class="nc">GET</span> <span class="o">&gt;&gt;=</span> <span class="n">browse_embedded</span>
</span><span class='line'>        <span class="c1">// If it doesn&#39;t, try and trigger your api end points</span>
</span><span class='line'>        <span class="nc">GET</span> <span class="o">&gt;&gt;=</span> <span class="n">url</span> <span class="s2">&quot;/json&quot;</span> <span class="o">&gt;&gt;==</span> <span class="o">(</span><span class="k">fun</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">serveJson</span> <span class="o">&lt;|</span> <span class="n">makeData</span><span class="bp">()</span><span class="o">)</span>
</span><span class='line'>        <span class="nc">GET</span> <span class="o">&gt;&gt;=</span> <span class="n">url</span> <span class="s2">&quot;/carrier&quot;</span> <span class="o">&gt;&gt;==</span> <span class="o">(</span><span class="k">fun</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">getCarrierCodes</span> <span class="bp">()</span><span class="o">)</span>
</span><span class='line'>        <span class="c1">// Nothing else has worked - 404</span>
</span><span class='line'>        <span class="nc">NOT_FOUND</span> <span class="s2">&quot;Sorry, couldn&#39;t find your page&quot;</span>
</span><span class='line'>    <span class="o">]</span>
</span><span class='line'>
</span><span class='line'><span class="n">web_server</span> <span class="n">default_config</span> <span class="n">app</span>
</span></code></pre></td></tr></table></div></figure>

<p>And the embedded module looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">module</span> <span class="nc">Embedded</span>
</span><span class='line'>
</span><span class='line'><span class="k">open</span> <span class="nc">System</span>
</span><span class='line'><span class="k">open</span> <span class="nn">System</span><span class="p">.</span><span class="nc">IO</span>
</span><span class='line'><span class="k">open</span> <span class="nn">System</span><span class="p">.</span><span class="nc">Reflection</span>
</span><span class='line'><span class="k">open</span> <span class="nc">Suave</span>
</span><span class='line'><span class="k">open</span> <span class="nn">Suave</span><span class="p">.</span><span class="nc">Http</span>
</span><span class='line'><span class="k">open</span> <span class="nn">Suave</span><span class="p">.</span><span class="nc">Types</span>
</span><span class='line'><span class="k">open</span> <span class="nn">Suave</span><span class="p">.</span><span class="nc">Socket</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="k">private</span> <span class="n">ass</span> <span class="o">=</span> <span class="nn">Assembly</span><span class="p">.</span><span class="nc">GetExecutingAssembly</span><span class="bp">()</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="k">private</span> <span class="n">resources</span> <span class="o">=</span>
</span><span class='line'>    <span class="n">ass</span><span class="o">.</span><span class="nc">GetManifestResourceNames</span><span class="bp">()</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="k">private</span> <span class="nc">CACHE_CONTROL_MAX_AGE</span> <span class="o">=</span> <span class="mi">600</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="k">private</span> <span class="n">lastModified</span> <span class="o">=</span> <span class="nn">DateTime</span><span class="p">.</span><span class="nc">UtcNow</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="k">private</span> <span class="n">send_embedded</span> <span class="n">resourceName</span> <span class="n">r</span> <span class="o">=</span>
</span><span class='line'>    <span class="k">let</span> <span class="n">write_embedded</span> <span class="n">file</span> <span class="o">(</span><span class="n">r</span> <span class="o">:</span> <span class="nc">HttpRequest</span><span class="o">)</span> <span class="o">=</span> <span class="n">async</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">use</span> <span class="n">s</span> <span class="o">=</span> <span class="n">ass</span><span class="o">.</span><span class="nc">GetManifestResourceStream</span><span class="o">(</span><span class="n">resourceName</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="nc">Length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="n">L</span> <span class="k">then</span>
</span><span class='line'>        <span class="k">do</span><span class="o">!</span> <span class="n">async_writeln</span> <span class="n">r</span><span class="o">.</span><span class="n">connection</span> <span class="o">(</span><span class="n">sprintf</span> <span class="s2">&quot;Content-Length: %d&quot;</span> <span class="n">s</span><span class="o">.</span><span class="nc">Length</span><span class="o">)</span> <span class="n">r</span><span class="o">.</span><span class="n">line_buffer</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">do</span><span class="o">!</span> <span class="n">async_writeln</span> <span class="n">r</span><span class="o">.</span><span class="n">connection</span> <span class="s2">&quot;&quot;</span> <span class="n">r</span><span class="o">.</span><span class="n">line_buffer</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="nc">Length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="n">L</span> <span class="k">then</span>
</span><span class='line'>        <span class="k">do</span><span class="o">!</span> <span class="n">transfer_x</span> <span class="n">r</span><span class="o">.</span><span class="n">connection</span> <span class="n">s</span> <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">async</span> <span class="o">{</span> <span class="k">do</span><span class="o">!</span> <span class="n">response_f</span> <span class="mi">200</span> <span class="s2">&quot;OK&quot;</span> <span class="o">(</span><span class="n">write_embedded</span> <span class="n">resourceName</span><span class="o">)</span> <span class="n">r</span> <span class="o">}</span> <span class="o">|&gt;</span> <span class="n">succeed</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">resource</span> <span class="n">resourceName</span> <span class="o">=</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">resources</span> <span class="o">|&gt;</span> <span class="nn">Array</span><span class="p">.</span><span class="n">exists</span> <span class="o">((=)</span> <span class="n">resourceName</span><span class="o">)</span> <span class="k">then</span>
</span><span class='line'>      <span class="k">let</span> <span class="n">send_it</span> <span class="o">_</span> <span class="o">=</span>
</span><span class='line'>        <span class="k">let</span> <span class="n">mimes</span> <span class="o">=</span> <span class="n">mime_type</span> <span class="o">&lt;|</span> <span class="nn">IO</span><span class="p">.</span><span class="nn">Path</span><span class="p">.</span><span class="nc">GetExtension</span> <span class="n">resourceName</span>
</span><span class='line'>        <span class="o">#</span><span class="k">if</span> <span class="nc">DEBUG</span>
</span><span class='line'>        <span class="n">set_mime_type</span> <span class="n">mimes</span>
</span><span class='line'>        <span class="o">&gt;&gt;</span> <span class="n">send_embedded</span> <span class="o">(</span><span class="n">resourceName</span><span class="o">)</span>
</span><span class='line'>        <span class="o">#</span><span class="k">else</span>
</span><span class='line'>        <span class="n">set_header</span> <span class="s2">&quot;Cache-Control&quot;</span> <span class="o">(</span><span class="n">sprintf</span> <span class="s2">&quot;max-age=%d&quot;</span> <span class="nc">CACHE_CONTROL_MAX_AGE</span><span class="o">)</span>
</span><span class='line'>        <span class="o">&gt;&gt;</span> <span class="n">set_header</span> <span class="s2">&quot;Last-Modified&quot;</span> <span class="o">(</span><span class="n">lastModified</span><span class="o">.</span><span class="nc">ToString</span><span class="o">(</span><span class="s2">&quot;R&quot;</span><span class="o">))</span>
</span><span class='line'>        <span class="o">&gt;&gt;</span> <span class="n">set_header</span> <span class="s2">&quot;Expires&quot;</span> <span class="o">(</span><span class="nn">DateTime</span><span class="p">.</span><span class="nn">UtcNow</span><span class="p">.</span><span class="nc">AddSeconds</span><span class="o">(</span><span class="kt">float</span><span class="o">(</span><span class="nc">CACHE_CONTROL_MAX_AGE</span><span class="o">)).</span><span class="nc">ToString</span><span class="o">(</span><span class="s2">&quot;R&quot;</span><span class="o">))</span>
</span><span class='line'>        <span class="o">&gt;&gt;</span> <span class="n">set_mime_type</span> <span class="n">mimes</span>
</span><span class='line'>        <span class="o">&gt;&gt;</span> <span class="n">send_embedded</span> <span class="o">(</span><span class="n">resourceName</span><span class="o">)</span>
</span><span class='line'>        <span class="o">#</span><span class="n">endif</span>
</span><span class='line'>      <span class="n">warbler</span> <span class="o">(</span> <span class="k">fun</span> <span class="o">(</span><span class="n">r</span><span class="o">:</span><span class="nc">HttpRequest</span><span class="o">)</span> <span class="o">-&gt;</span>
</span><span class='line'>        <span class="k">let</span> <span class="n">modified_since</span> <span class="o">=</span> <span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="n">headers</span> <span class="o">?</span> <span class="o">``</span><span class="k">if</span><span class="o">-</span><span class="n">modified</span><span class="o">-</span><span class="n">since</span><span class="o">``</span> <span class="o">)</span>
</span><span class='line'>        <span class="k">match</span> <span class="n">modified_since</span> <span class="k">with</span>
</span><span class='line'>        <span class="o">|</span> <span class="nc">Some</span> <span class="n">v</span> <span class="o">-&gt;</span> <span class="k">let</span> <span class="n">date</span> <span class="o">=</span> <span class="nn">DateTime</span><span class="p">.</span><span class="nc">Parse</span> <span class="n">v</span>
</span><span class='line'>                    <span class="k">if</span> <span class="n">lastModified</span> <span class="o">&gt;</span> <span class="n">date</span> <span class="k">then</span> <span class="n">send_it</span> <span class="bp">()</span>
</span><span class='line'>                    <span class="k">else</span> <span class="nc">NOT_MODIFIED</span>
</span><span class='line'>        <span class="o">|</span> <span class="nc">None</span>   <span class="o">-&gt;</span> <span class="n">send_it</span> <span class="bp">()</span><span class="o">)</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="n">never</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">browse_embedded</span> <span class="o">:</span> <span class="nc">WebPart</span> <span class="o">=</span>
</span><span class='line'>    <span class="n">warbler</span> <span class="o">(</span><span class="k">fun</span> <span class="n">req</span> <span class="o">-&gt;</span> <span class="n">resource</span> <span class="o">(</span><span class="n">req</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="nc">TrimStart</span><span class="o">([|</span> <span class="sc">&#39;/&#39;</span> <span class="o">|])))</span>
</span></code></pre></td></tr></table></div></figure>

<p><a href="https://twitter.com/ad3mar">@ad3mar</a> if you feel like rolling this into Suave, you can consider it licenced under what ever is most convenient. An official licence file would make me much happier using Suave in production, by the way (hint, hint).</p>

<p>Edit: ad3mar has pointed out in the comments that Suave is already Apache2 licensed, I just failed to find the file last time I looked.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/type-provider-protip/">Type Provider ProTip</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-01-10T12:15:15+00:00" pubdate data-updated="true">Jan 10<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>While type providers are incredibly powerful, the ProvidedTypes api for creating them is sometimes a bit rough around the edges. And not always as functional as you might hope.</p>

<p>At some point I&#39;d like to do something about that, but for the moment I&#39;m just going to collect a few helpful tips and hints (mostly for own reference).</p>

<p>Tip one is in the case where you have XmlDocs to add to ProvidedTypes, ProvidedMethods and ProvidedProperties; in our case we have an optional description field in our metadata and the boiler plate was getting tiresome.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">let</span> <span class="k">inline</span> <span class="n">addDoc</span> <span class="o">(</span><span class="n">desc</span> <span class="o">:</span> <span class="nc">Descriptor</span><span class="o">)</span> <span class="n">def</span> <span class="o">=</span>
</span><span class='line'>    <span class="k">match</span> <span class="n">desc</span><span class="o">.</span><span class="nc">Description</span> <span class="k">with</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">Some</span> <span class="n">d</span> <span class="o">-&gt;</span>
</span><span class='line'>        <span class="o">(^</span><span class="nc">T</span> <span class="o">:</span> <span class="o">(</span><span class="k">member</span> <span class="nc">AddXmlDoc</span> <span class="o">:</span> <span class="kt">string</span> <span class="o">-&gt;</span> <span class="kt">unit</span><span class="o">)</span> <span class="o">(</span><span class="n">def</span><span class="o">,</span> <span class="n">d</span><span class="o">))</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="bp">()</span>
</span></code></pre></td></tr></table></div></figure>

<p>This function takes a <code>Descriptor</code> with a <code>string option</code> Description field and any <code>def</code> with an AddXmlDoc member with the noted signature - and adds description as the xml doc if it exists.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/pygments/">Pygments</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-01-03T12:23:00+00:00" pubdate data-updated="true">Jan 3<span>rd</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Apparently I should be able to do inline F# code using one of the Octopress plugins, rather than having to use gists every where.</p>

<p>Let&#39;s try it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">let</span> <span class="n">hello</span> <span class="o">=</span> <span class="s2">&quot;world&quot;</span>
</span></code></pre></td></tr></table></div></figure>

<p>Thanks <a href="https://twitter.com/ovatsus/status/411496863591067648">Gustavo</a></p>

<p>Only issue is that having Python 3.x installed broke Octopress&#39; Pygments support. Which kept me going for a while&#8230;</p>

<p>Given I&#39;m not currently doing any Python development, a uninstall and adding 2.7 to the path did the job.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/type-providers-from-the-ground-up/">Type Providers From the Ground Up</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-12-05T11:28:00+00:00" pubdate data-updated="true">Dec 5<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><em>This post is part of a series: <a href="/type-providers-from-the-first-floor/">part 2</a> follows on directly from this post.</em></p>

<p>In the ground tradition of blog posts as both documentation and augmented memory, I&#39;ve just added our first <a href="http://blogs.msdn.com/b/dsyme/archive/2013/01/30/twelve-type-providers-in-pictures.aspx">Type Provider</a> to the code base. Time to write up the details before a) I forget them and b) anyone else needs to modify the code.</p>

<p>So, first things first. Before we get to the actual problem space at hand, let&#39;s try and provide a type. Any type&#8230;</p>

<p>1) Create yourself a new Visual Studio F# library project (2012 or up should work).</p>

<p>2a) Install the <a href="https://www.nuget.org/packages/FSharp.TypeProviders.StarterPack/">F# TypeProvider Starter Pack</a> or</p>

<p>2b) add <a href="https://raw.github.com/fsharp/FSharp.Data/master/src/CommonProviderImplementation/ProvidedTypes.fs">ProvidedTypes.fs</a> and <a href="https://raw.github.com/fsharp/FSharp.Data/master/src/CommonProviderImplementation/ProvidedTypes.fsi">ProvidedTypes.fsi</a> to the project as the first couple of files.</p>

<p>In either case, make sure that the .fsi file appears before the .fs file in your project listing, and that both appear before any type provider code - you will probably have to manually re-order them.</p>

<p>These are provided as code files rather than as compiled dlls due to complications with security and AppDomains when referencing dlls in the type provider assembly. For now just add them in - you really don&#39;t want to be re-creating the code in there by hand.</p>

<p>3) Replace the contents of Library1.fs with something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">module</span> <span class="nn">Mavnn</span><span class="p">.</span><span class="nn">Blog</span><span class="p">.</span><span class="nc">TypeProvider</span>
</span><span class='line'>
</span><span class='line'><span class="k">open</span> <span class="nn">ProviderImplementation</span><span class="p">.</span><span class="nc">ProvidedTypes</span>
</span><span class='line'><span class="k">open</span> <span class="nn">Microsoft</span><span class="p">.</span><span class="nn">FSharp</span><span class="p">.</span><span class="nn">Core</span><span class="p">.</span><span class="nc">CompilerServices</span>
</span><span class='line'>
</span><span class='line'><span class="o">[&lt;</span><span class="nc">TypeProvider</span><span class="o">&gt;]</span>
</span><span class='line'><span class="k">type</span> <span class="nc">MavnnProvider</span> <span class="o">(</span><span class="n">config</span> <span class="o">:</span> <span class="nc">TypeProviderConfig</span><span class="o">)</span> <span class="k">as</span> <span class="n">this</span> <span class="o">=</span>
</span><span class='line'>    <span class="k">inherit</span> <span class="nc">TypeProviderForNamespaces</span> <span class="bp">()</span>
</span><span class='line'>
</span><span class='line'><span class="o">[&lt;</span><span class="n">assembly</span><span class="o">:</span><span class="nc">TypeProviderAssembly</span><span class="o">&gt;]</span>
</span><span class='line'><span class="k">do</span> <span class="bp">()</span>
</span></code></pre></td></tr></table></div></figure>

<p>So, that&#39;s great and it builds. We have a type provider class and an assembly that knows it&#39;s a type providing assembly. Unfortunately, it doesn&#39;t actually provide any types yet. Let&#39;s try it.</p>

</div>
  
  
    <footer>
      <a rel="full-article" href="/type-providers-from-the-ground-up/">Read on &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/to-infinity/">To Infinity and Beyond</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-10-31T07:41:00+00:00" pubdate data-updated="true">Oct 31<span>st</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>So, a couple of weeks ago I went to the Brighton Functional Programmers meet up. It was a fun night, and at one point I ended up live coding in front of a room of functional programmers trying to give examples of lazy and strict evaluation.</p>

<p>The canonical go to tool for the job, is of course the infinite sequence and being stared at by a bunch of people and having syntax highlighting but no compiler, the first thing my brain pulled out of the air was this:</p>

<div><script src='https://gist.githubusercontent.com/mavnn/7246744.js?file=Part1.fs'></script>
<noscript><pre><code>let ones =
    seq {
        while true do
            yield 1
    }
// seq [1; 1; 1; 1; ...]</code></pre></noscript></div>

<p>Which prompted one of the people attending (hi <a href="https://twitter.com/milessabin">Miles!</a>) to comment &quot;let&#39;s see that in Haskell without the bizarre looping generator&quot;. Roughly - I&#39;m slightly paraphrasing here given the couple of weeks in between. He has a bit of a point, this isn&#39;t the most functional looking sequence generator in the world, and it looks like quite a lot of code to just generate a lot of ones.</p>

<p>As always in these situations, I had of course thought of several other alternatives before I even reached my chair, so I thought I&#39;d have a quick survey of them and their advantages and disadvantages.</p>

<p>My first thought was that I&#39;d missed the obvious and succinct option of just generating a range. In F# (as in Haskell) the 1 .. 10 notation generates a list of the integers from 1 to 10. Unfortunately:</p>

<div><script src='https://gist.githubusercontent.com/mavnn/7246744.js?file=Part2.fs'></script>
<noscript><pre><code>// Can&#39;t do this, unfortunately
// seq { 1 .. }
//
// or this:
// seq { 1 .. 0 .. 2 }
//
// Which I thought might be a nice hack.
</code></pre></noscript></div>

<p>Unlike Haskell, you can&#39;t have an unbounded range, nor can you set the &quot;step&quot; to zero to just keep on generating the same number. So you&#39;re limited to generating very big, but definitely not infinite sequences:</p>

<div><script src='https://gist.githubusercontent.com/mavnn/7246744.js?file=Part3.fs'></script>
<noscript><pre><code>let notInfiniteOrOnes = seq { 1 .. System.Int32.MaxValue }
// seq [1; 2; 3; 4; ...]

let notInfinite = seq { for _ in 1 .. System.Int32.MaxValue -&gt; 1 }
// seq [1; 1; 1; 1; ...]
</code></pre></noscript></div>

<p>But hey! We&#39;re in functional world. So if we can&#39;t use sneaky built in syntax constructs, the next obvious choice is a recursive function:</p>

<div><script src='https://gist.githubusercontent.com/mavnn/7246744.js?file=Part4.fs'></script>
<noscript><pre><code>let ones&#39; =
    let rec gen () =
        seq {
            yield 1
            yield! gen ()
        }
    gen ()
// seq [1; 1; 1; 1; ...]
</code></pre></noscript></div>

<p>This is definitely infinite, and definitely functional in style. Bit verbose, of course, but it least it won&#39;t stack overflow as F# implements tail call recursion. It&#39;s verbose, but it does also have its advantages. It&#39;s trivial to pass things round in the recursive function (previous values from the sequence, etc) making this a very flexible way of generating sequences.</p>

<p>And, of course, let&#39;s not ignore the standard library. The <code>Seq</code> module gives us a couple of methods designed specifically for generating (potentially) infinite sequences.</p>

<p><code>Seq.initInfinite</code> just takes a function that returns a sequence value based on the index of that value:</p>

<div><script src='https://gist.githubusercontent.com/mavnn/7246744.js?file=Part5.fs'></script>
<noscript><pre><code>let ones&#39;&#39; = Seq.initInfinite (fun _ -&gt; 1)
// seq [1; 1; 1; 1; ...]
</code></pre></noscript></div>

<p>As long as a simple mapping from index to value exists, this is both clear and concise. In theory, of course, it also suffers from the same issue as my range generators above: if your index exceeds the valid size of an Int32 you&#39;re out of luck.</p>

<p><code>Seq.unfold</code> may seem less intuitive, but in my mind is the more flexible and powerful solution. I tend to come across examples where it&#39;s easier to generate a sequence based on either some state or the previous term than by index, and that&#39;s exactly what unfold allows you to do:</p>

<div><script src='https://gist.githubusercontent.com/mavnn/7246744.js?file=Part6.fs'></script>
<noscript><pre><code>let ones&#39;&#39;&#39; = Seq.unfold (fun _ -&gt; Some (1, ())) ()
// seq [1; 1; 1; 1; ...]
</code></pre></noscript></div>

<p>It will also happily generate sequences forever if your generating function allows.</p>

<p>So, how does it actually work? Let&#39;s look at a (slightly) more complex example that actually makes use of some state:</p>

<div><script src='https://gist.githubusercontent.com/mavnn/7246744.js?file=Part7.fs'></script>
<noscript><pre><code>let moreInterestingUnfold =
    Seq.unfold
        (fun state -&gt;
            Some (state, state + 1)) 1
// seq [1; 2; 3; 4; ...]
</code></pre></noscript></div>

<p>What&#39;s going on here then? Well, <code>unfold</code> takes two arguments. The first is a function that takes a &#39;State and returns an Option&lt;&#39;T * &#39;State&gt;. In our simple example above, both &#39;State and &#39;T are of type <code>int</code> but there&#39;s no requirement for them to be of the same type. If at any point the function returns <code>None</code>, the sequence ends. In our example, we always return <code>Some</code>, so our sequence is infinite (at least until it runs out of integers) and we&#39;re return a tuple of two values - the first of which will be used as the next term in the sequence, and the second which will become the new state.</p>

<p>The second argument to <code>unfold</code> is the starting state. In our case, this means the number that will be the first term in the sequence, and then we&#39;ll add one to it each time.</p>

<p>Let&#39;s round this out with an example that uses different types for the state and the terms of the sequence, which will hopefully now make some sense:</p>

<div><script src='https://gist.githubusercontent.com/mavnn/7246744.js?file=Part8.fs'></script>
<noscript><pre><code>type Time =
    {
        Hour : int
        Minute : int
    }

let addMinute time =
    match time with
    | { Hour = 23; Minute = 59 } -&gt;
        { Hour = 0; Minute = 0 }
    | { Minute = 59 } -&gt;
        { Hour = time.Hour + 1; Minute = 0 }
    | _ -&gt;
        { Hour = time.Hour; Minute = time.Minute + 1 }

let unfold&#39; =
    Seq.unfold
        (fun state -&gt;
            Some (sprintf &quot;%02d:%02d&quot; state.Hour state.Minute, addMinute state)
            ) { Hour = 22; Minute = 59 }
// seq [&quot;23:59&quot;; &quot;00:00&quot;; &quot;00:01&quot;; &quot;00:02&quot;; ...]
</code></pre></noscript></div>

<p>I&#39;m sure that you&#39;ve always needed a convenient way of cycling through every minute of the day repeatedly, with a nice readable string representation.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/introducing-f-number-to-experienced-developers/">Introducing F# to Experienced Developers</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-10-14T12:30:00+01:00" pubdate data-updated="true">Oct 14<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>So, as a follow up to <a href="https//blog.mavnn.co.uk/teaching-f-number-to-c-number-devs/">this post</a> I&#39;m in the final stages of preparing a presentation for this Friday introducing an audience of (mostly) fairly experienced developers to F# and F# syntax. The main reason for this is to get a number of people up to speed enough on reading F# that they can have a better experience at <a href="http://skillsmatter.com/event/scala/progressive-f-tutorials-2013">the Progressive F# Tutorials</a> at the end of the month. So the aim here isn&#39;t to get people fully autonomous and writing code <em>right now</em>, but to allow them to read the bulk of the example code in the tutorials and follow what&#39;s going on.</p>

<p>The general approach I&#39;ve gone for is to set up a Git repository that has a series of tagged snap shots I can check out as I work through the concepts I&#39;m planning to cover. This will enable me to actually demonstrate and run pieces of code, answer questions and make live modifications and then always jump back to a known starting point for the next section of the talk. Given the people involved have all done some .net development and I don&#39;t need to cover things like Visual Studio usage and projects, all of the code is contained in a single Program.fs file in a console app. I&#39;ve included the snapshot of the file from each tagged commit below, with a brief overview of what I&#39;m planning to introduce before skipping to the next snapshot.</p>

<p>With a full screen Visual Studio editing session, I should be able to make the code large enough to be visible and reasonably rapidly guide people to the areas where the code has changed.</p>

<p>A combination of the excellent <a href="http://papercut.codeplex.com/">PaperCut</a> project and a local &#39;http request to email&#39; service pretending to be an SMS sender, we should be able to see messages being generated by the code as we go along.</p>

<p>After the session, I&#39;m planning to mention <a href="https://github.com/ChrisMarinos/FSharpKoans">Chris Marinos&#39; koans</a> and <a href="http://www.tryfsharp.org/">Try F#</a> (especially given that Rachel Reese is <a href="http://skillsmatter.com/podcast/scala/try-f-from-zero-to-data-science">running a session</a> at the tutorials for those who are going).</p>

<p>Please note that these are up here for comment and suggestions at this point - I&#39;ll be pushing up the actual Git repository and a screencast (I hope) after the event. The code is designed to be a prop for the talk rather than an independent resource - for that I&#39;d always point people to the koans/Try F# first.</p>

<p>So, show me the codez:</p>

</div>
  
  
    <footer>
      <a rel="full-article" href="/introducing-f-number-to-experienced-developers/">Read on &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/being-a-priest-and-programming/">Being a Priest and Programming</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-09-29T20:19:00+01:00" pubdate data-updated="true">Sep 29<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><blockquote>
<p>But you are a chosen people, a royal priesthood, a holy nation, God’s special possession, that you may declare the praises of him who called you out of darkness into his wonderful light. <a href="http://www.biblegateway.com/passage/?search=1%20Peter+2:9&amp;version=NIV">(1 Peter 2:9)</a></p>
</blockquote>

<p>Warning: this post may contain theology and other non-programming related
material. You have been warned&#8230;</p>

<p><a href="http://hrbc.org.uk">Our church</a> started a new sermon series last week, and as the
sermon was going on various other bits and pieces came together in my mind, and
I knew that I was going to have to at least try and get them down in writing or
they were going to run around my head for the next few days.</p>

<p>It comes up regularly for us as Christians that God isn&#39;t small enough to be
contained to Sunday mornings - he wants a larger part of our lives than that,
in fact the central part. But the idea of worshipping God with your whole
life often begins to get a bit weird when you actually stop and think about it.
Worship (&#39;to assign worth to something&#39;) is not a strange idea to any of us,
although we might not use that language - I&#39;m sure you can all think of a
respected author, favourite footballer or awe inspiring musician. And if you
buy into the whole Christian idea of who and what God is (infinitely powerful
and awesomely loving, perfect judge who offers grace, amazing sense of humour)
then the idea that a Christian is going to worship God also shouldn&#39;t seem that
strange.</p>

<p>But with your whole life? There&#39;s <a href="http://biblia.com/bible/esv/Romans%2012.1%E2%80%932">no doubt</a>
<a href="http://www.biblegateway.com/passage/?search=Deuteronomy+6&amp;version=NIV">biblically</a>
or in the teachings of both <a href="http://www.desiringgod.org/resource-library/sermons/all-of-life-as-worship">Christian teachers</a>
and <a href="http://www.jewfaq.org/prayer/shema.htm">Jewish tradition</a> that this is
precisely what is expected of us. But&#8230; when you write computer code as a day
job, what does that actually mean?</p>

<p>And then it struck me. It means being a <a href="https://people.gnome.org/%7Emichael/">Michael Meeks</a> or a <a href="https://twitter.com/jonskeet/status/8423111419">Jon Skeet</a>. Probably not in the
specific details - I&#39;ve not met either of them personally, but in the attitude
they show to life and the people around them. If you&#39;re not in the programming
field (probably, if you don&#39;t happen to be in a similar area of the programming
field to me&#8230;) you&#39;re not likely to have heard of them. But they&#39;ve both
developed an enormous amount of respect in a field that is frequently full of
highly opinionated staunch atheists while being openly professing Christians.</p>

<p>So we wrap round to where we started - the idea from 1 Peter of
all Christians being priests. (I&#39;m not using the term here in the catholic
sense, so bear with me&#8230;). This comes up a lot when people relate one of the
core Christian doctrines - that people who have come into a relation with
Christ can come directly to God without an intermediary. But that wasn&#39;t the only
role of priests in the Old Testament. Yes, they were the only people who could
enter God&#39;s presence&#8230; but they weren&#39;t only going there for themselves. They
<em>were</em> the intermediaries, &#39;introducing&#39; others to God&#39;s presence, carrying
blessings from God to them and petitions from them to God.</p>

<p>Jon and Michael are dedicated to
what they do, they are good at it and they are &#39;graceful&#39;. In the sense that
they treat the people around them with respect and as professionals, teaching
and helping without regard to the others faith and without forcing argument and
discussion where it&#39;s not wanted. Both are obviously willing to talk to people
who want to (Michael even links to a fun page on <a href="http://christianthinktank.com/objedex.html">Christian Think Tank</a> for those who are
interested), but there isn&#39;t a pressure there.</p>

<p>And maybe that&#39;s what some small part of everyday worship looks like; I can&#39;t help feeling that by
being respectable (in the sense of, worthy of some respect) and making the fact
of their faith public, people like Jon and Michael have been doing their bit to
draw others closer to this God I worship. They&#39;ve caused a doubt and a second
look at what faith really means in the mind of those who would otherwise live
in an atheist bubble, carelessly dismissing the idea of God as the ramblings of
the obviously stupid and insane. Because these men are clearly neither.</p>

<p>This is encouraging to me, and I hope to a lot of out there who go to work, work hard
and tell people that you made it to church this Sunday. Because if you look
around you&#39;ll probably begin to see these people around you, the Jons and Michaels
who are making a difference just by living a life based on Christ&#39;s in the everyday.</p>

<p>And guess what? If you&#39;re a Christian, letting people know without pressure and
getting your coding/plumbing/teaching/building/etc. done you&#39;re probably making a difference
too. You might be the last to see
it, but I&#39;m sure others do. </p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/implementing-classic-oo-style-code-in-f-number/">Implementing Classic OO Style Code in F#</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-09-24T14:21:00+01:00" pubdate data-updated="true">Sep 24<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>As part of writing up notes for introducing F# as a programming language to experienced C# devs I was looking for examples
of heavily OO code being implemented in F#. Then I realised that I&#39;d written at least one suitable example myself.</p>

<p>In the <a href="%22https://github.com/mavnn/NuGetPlus%22">NuGetPlus project</a> I needed to implement a ProjectSystem class that was almost a direct copy of the MSBuildProjectSystem in the NuGet commandline client.</p>

<p>So without further ado, F# and then C# versions of a class with inheritance and which implements several interfaces.</p>

</div>
  
  
    <footer>
      <a rel="full-article" href="/implementing-classic-oo-style-code-in-f-number/">Read on &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/teaching-f-number-to-c-number-devs/">Teaching F# to C# Devs</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-09-17T11:12:00+01:00" pubdate data-updated="true">Sep 17<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>So, in a fit of enthusiasm my boss bought 15 tickets to the <a href="%22http://skillsmatter.com/event/scala/progressive-f-tutorials-2013%22">London Progressive F# Tutorials</a> when he saw the early birds pricing (did I mention it&#39;s nice working here?). Several of the people who have been assigned tickets have asked to go largely because they are new to F#, so I&#39;ve been asked to put together a starter session to teach them the basics. I&#39;ve tried this <a href="%22https//blog.mavnn.co.uk/an-introduction-to-f-screencast-and-pdf-slide%22">once before</a> and it was a fairly successful session (F# was adopted as a official supported language in the company partly due to feedback following it). But it was still pretty rough around the edges, and as normal with these things, you always want to do them better the next time round&#8230;</p>

<p>So, with a target audience of curious, experienced C# devs I&#39;m wondering about the best approach. The initial session needs to fit in an hour, although I can do individual follow ups afterwards.</p>

<p>My current thinking is to take a block of C# code (smtp sender?) that is fairly straight forward but &#39;production ready&#39; in the sense that it includes error handling, logging, etc. Then do a straight re-write in F# live coding. And then start refactoring to more idiomatic F# as we go along.</p>

<p>Features I feel would be important to cover:</p>

<ul>
<li>Basic syntax (let, functions, if &#8230; then, etc)</li>
<li>Common idioms (|&gt;, Seq.map)</li>
<li>At least one computational expression (probably an error handling one; simpler than async in some ways)</li>
<li>Several examples of using the match statements</li>
<li>&#8230;which probably means at least one DU, possibly for error handling</li>
<li>Records and { &#8230; with &#8230; } expressions</li>
</ul>

<p>I&#39;ve got a week or two to prepare, so what I&#39;m really hoping for at this point is suggestions and ideas from people for how to improve this as a session idea, things that threw you when you first started writing F# you think should be covered, whether you think this is a stupid idea for a session from the concept up, etc. Once the session is completed I&#39;ll be posting the slides and hopefully a screen cast of it as I did last time for use by <a href="%22http://fsharp.org%22">fsharp.org</a>.</p>

<p>Suggestions on the piece of C# code to translate would also be appreciated - either in terms of ideas of the type of code, or actual open source code that would serve as a code starting point.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/fscheck-breaking-your-code-in-new-and-exciting-ways/">FsCheck - Breaking Your Code in New and Exciting Ways</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-07-12T11:55:00+01:00" pubdate data-updated="true">Jul 12<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="https://github.com/fsharp/FsCheck">FsCheck</a> is a property based testing library for .net. Based on <a href="http://book.realworldhaskell.org/read/testing-and-quality-assurance.html">QuickCheck</a> and <a href="https://github.com/rickynils/scalacheck">scalacheck</a> it can be easily called from any .net language.</p>

<p>But what is property based testing? It&#39;s a technique that allows us to define &#39;properties&#39; for our code, and then let the library try and find input values that break these properties. Let&#39;s take an example and see what happens.</p>

<h3>The Brief</h3>

<p>I&#39;ve been tasked with writing the backend of a public facing endpoint. Customers can pass user defined input into the endpoint, and we&#39;ll add it to their &#39;booking&#39;. Once they have called the service once with any particular input, we should ignore any further calls with the same value.</p>

<p>Previous architectural decisions mean that we are storing the bookings as XML documents.</p>

<p>(Why yes, I do know this is slightly contrived. Thank you for asking. Hopefully though, you should begin to see similarities to real scenarios you&#39;ve coded against.)</p>

<h3>What can we get out of this?</h3>

<p>Well, as well as any normal exploratory unit tests we may decide to write (which I&#39;ll ignore for this article to keep things succinct) we can determine a few properties that should always hold true in the brief above:</p>

<ul>
<li>Repeatedly calling the code with the same input xml document and the same input text should always give us the same result. I.E., the code should be idempotent.</li>
<li>Our code should never remove nodes from the XML. The result document will always be the same or longer than the original.</li>
<li>The input is supplied by the customer. It&#39;s about as trustworthy as a hungry stoat on speed.</li>
</ul>

<h3>Let&#39;s get started</h3>

<p>Let&#39;s start off with the core &#39;business logic&#39; function of this code. We&#39;ll ignore for this post how the input gets to the function, and how the document is persisted. It&#39;s signature (F# style) will be:</p>
<div class="highlight"><pre><code class="text">val AddEnhancement :
  xDoc:System.Xml.Linq.XDocument -&gt; input:string -&gt; System.Xml.Linq.XDocument
</code></pre></div>
<p>After referencing <code>System.Xml</code> and <code>System.Xml.Linq</code>, our first, very naive, attempt at the implementation looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">module</span> <span class="nn">DevEd</span><span class="p">.</span><span class="nc">FsCheck</span>
</span><span class='line'><span class="k">open</span> <span class="nn">System</span><span class="p">.</span><span class="nc">Xml</span>
</span><span class='line'><span class="k">open</span> <span class="nn">System</span><span class="p">.</span><span class="nn">Xml</span><span class="p">.</span><span class="nc">Linq</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="nc">AddEnhancement</span> <span class="o">(</span><span class="n">xDoc</span> <span class="o">:</span> <span class="nc">XDocument</span><span class="o">)</span> <span class="o">(</span><span class="n">input</span> <span class="o">:</span> <span class="kt">string</span><span class="o">)</span> <span class="o">=</span>
</span><span class='line'>    <span class="n">xDoc</span><span class="o">.</span><span class="nn">Root</span><span class="p">.</span><span class="nc">Add</span><span class="o">(</span><span class="nc">XElement</span><span class="o">(</span><span class="nn">XName</span><span class="p">.</span><span class="nc">Get</span> <span class="s2">&quot;Enhancement&quot;</span><span class="o">,</span> <span class="n">input</span><span class="o">))</span>
</span><span class='line'>    <span class="n">xDoc</span>
</span></code></pre></td></tr></table></div></figure>

<p>We know this isn&#39;t right - it&#39;s blatantly not idempotent. So let&#39;s try and get our failing test.</p>

<p>Although FsCheck does expose a set of NUnit plugin attributes, for this blog post I&#39;m just going to run the tests via a console app. So; add a new F# console app to your solution, add references to <code>System.Xml</code>, <code>System.Xml.Linq</code> and your library project then grab FsCheck (it&#39;s on NuGet) and we&#39;ll see what we can do.</p>

<p>First, we&#39;ll need to add a property that we want to test. A property is simply a function that takes a data type FsCheck knows how to generate, and returns a bool. FsCheck knows how to generate strings, so our idempotence property looks something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">open</span> <span class="nc">FsCheck</span>
</span><span class='line'><span class="k">open</span> <span class="nn">DevEd</span><span class="p">.</span><span class="nc">FsCheck</span>
</span><span class='line'><span class="k">open</span> <span class="nn">System</span><span class="p">.</span><span class="nn">Xml</span><span class="p">.</span><span class="nc">Linq</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">baseDoc</span> <span class="o">=</span> <span class="s2">&quot;&lt;root /&gt;&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="o">``</span><span class="nc">Add</span> <span class="n">enhancement</span> <span class="n">must</span> <span class="n">be</span> <span class="n">idempotent</span><span class="o">``</span> <span class="n">input</span> <span class="o">=</span>
</span><span class='line'>    <span class="k">let</span> <span class="n">xml1</span> <span class="o">=</span> <span class="nn">XDocument</span><span class="p">.</span><span class="nc">Parse</span> <span class="n">baseDoc</span>
</span><span class='line'>    <span class="k">let</span> <span class="n">xml2</span> <span class="o">=</span> <span class="nn">XDocument</span><span class="p">.</span><span class="nc">Parse</span> <span class="n">baseDoc</span>
</span><span class='line'>    <span class="o">(</span><span class="nc">AddEnhancement</span> <span class="n">xml1</span> <span class="n">input</span><span class="o">).</span><span class="nc">ToString</span><span class="bp">()</span> <span class="o">=</span>
</span><span class='line'>        <span class="o">(</span><span class="nc">AddEnhancement</span> <span class="o">(</span><span class="nc">AddEnhancement</span> <span class="n">xml2</span> <span class="n">input</span><span class="o">)</span> <span class="n">input</span><span class="o">).</span><span class="nc">ToString</span><span class="bp">()</span>
</span></code></pre></td></tr></table></div></figure>

<p>Looking good. How do we run it? Just add this to the end of the file:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="nn">Check</span><span class="p">.</span><span class="nc">Quick</span> <span class="o">``</span><span class="nc">Add</span> <span class="n">enhancement</span> <span class="n">must</span> <span class="n">be</span> <span class="n">idempotent</span><span class="o">``</span>
</span><span class='line'>
</span><span class='line'><span class="nn">System</span><span class="p">.</span><span class="nn">Console</span><span class="p">.</span><span class="nc">ReadLine</span><span class="bp">()</span> <span class="o">|&gt;</span> <span class="n">ignore</span>
</span></code></pre></td></tr></table></div></figure>

<p>And hey presto:</p>

<p><img src="/images/FsCheck1.png" alt="&quot;&quot; broke my code :("></p>

<p>Failing test. Interestingly (and if you check the documents, not coincidently), FsCheck has found the &#39;simplest&#39; possible failure case: <code>&quot;&quot;</code>. Of course, it was helped on this occasion by the fact it was also the first input it tried.</p>

<p>So; let&#39;s add some checking to <code>AddEnhancement</code> to make sure we don&#39;t re-add the same input more than once.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">let</span> <span class="nc">AddEnhancement</span> <span class="o">(</span><span class="n">xDoc</span> <span class="o">:</span> <span class="nc">XDocument</span><span class="o">)</span> <span class="o">(</span><span class="n">input</span> <span class="o">:</span> <span class="kt">string</span><span class="o">)</span> <span class="o">=</span>
</span><span class='line'>    <span class="k">if</span>
</span><span class='line'>        <span class="n">xDoc</span><span class="o">.</span><span class="nn">Root</span><span class="p">.</span><span class="nc">Elements</span><span class="o">(</span><span class="nn">XName</span><span class="p">.</span><span class="nc">Get</span> <span class="s2">&quot;Enhancement&quot;</span><span class="o">)</span>
</span><span class='line'>        <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">exists</span> <span class="o">(</span><span class="k">fun</span> <span class="n">e</span> <span class="o">-&gt;</span> <span class="n">e</span><span class="o">.</span><span class="nc">Value</span> <span class="o">=</span> <span class="n">input</span><span class="o">)</span>
</span><span class='line'>        <span class="o">|&gt;</span> <span class="ow">not</span> <span class="k">then</span>
</span><span class='line'>            <span class="n">xDoc</span><span class="o">.</span><span class="nn">Root</span><span class="p">.</span><span class="nc">Add</span><span class="o">(</span><span class="nc">XElement</span><span class="o">(</span><span class="nn">XName</span><span class="p">.</span><span class="nc">Get</span> <span class="s2">&quot;Enhancement&quot;</span><span class="o">,</span> <span class="n">input</span><span class="o">))</span>
</span><span class='line'>    <span class="n">xDoc</span>
</span></code></pre></td></tr></table></div></figure>

<p>And re-run the test and&#8230; oops.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="nn">System</span><span class="p">.</span><span class="nc">ArgumentException</span> <span class="n">was</span> <span class="n">unhandled</span> <span class="n">by</span> <span class="n">user</span> <span class="n">code</span>
</span><span class='line'>  <span class="nc">HResult</span><span class="o">=-</span><span class="mi">2147024809</span>
</span><span class='line'>  <span class="nc">Message</span><span class="o">=</span><span class="sc">&#39; &#39;</span><span class="o">,</span> <span class="n">hexadecimal</span> <span class="n">value</span> <span class="mi">0</span><span class="n">x18</span><span class="o">,</span> <span class="n">is</span> <span class="n">an</span> <span class="n">invalid</span> <span class="n">character</span><span class="o">.</span>
</span><span class='line'>  <span class="nc">Source</span><span class="o">=</span><span class="nn">System</span><span class="p">.</span><span class="nc">Xml</span>
</span><span class='line'>  <span class="nc">StackTrace</span><span class="o">:</span>
</span><span class='line'>       <span class="n">at</span> <span class="nn">System</span><span class="p">.</span><span class="nn">Xml</span><span class="p">.</span><span class="nn">XmlEncodedRawTextWriter</span><span class="p">.</span><span class="nc">InvalidXmlChar</span><span class="o">(</span><span class="nc">Int32</span> <span class="n">ch</span><span class="o">,</span> <span class="nc">Char</span><span class="o">*</span> <span class="n">pDst</span><span class="o">,</span> <span class="nc">Boolean</span> <span class="n">entitize</span><span class="o">)</span>
</span><span class='line'>       <span class="n">at</span> <span class="nn">System</span><span class="p">.</span><span class="nn">Xml</span><span class="p">.</span><span class="nn">XmlEncodedRawTextWriter</span><span class="p">.</span><span class="nc">WriteElementTextBlock</span><span class="o">(</span><span class="nc">Char</span><span class="o">*</span> <span class="n">pSrc</span><span class="o">,</span> <span class="nc">Char</span><span class="o">*</span> <span class="n">pSrcEnd</span><span class="o">)</span>
</span><span class='line'>       <span class="n">at</span> <span class="nn">System</span><span class="p">.</span><span class="nn">Xml</span><span class="p">.</span><span class="nn">XmlEncodedRawTextWriter</span><span class="p">.</span><span class="nc">WriteString</span><span class="o">(</span><span class="nc">String</span> <span class="n">text</span><span class="o">)</span>
</span><span class='line'>       <span class="n">at</span> <span class="nn">System</span><span class="p">.</span><span class="nn">Xml</span><span class="p">.</span><span class="nn">XmlEncodedRawTextWriterIndent</span><span class="p">.</span><span class="nc">WriteString</span><span class="o">(</span><span class="nc">String</span> <span class="n">text</span><span class="o">)</span>
</span><span class='line'>       <span class="n">at</span> <span class="nn">System</span><span class="p">.</span><span class="nn">Xml</span><span class="p">.</span><span class="nn">XmlWellFormedWriter</span><span class="p">.</span><span class="nc">WriteString</span><span class="o">(</span><span class="nc">String</span> <span class="n">text</span><span class="o">)</span>
</span><span class='line'>       <span class="n">at</span> <span class="nn">System</span><span class="p">.</span><span class="nn">Xml</span><span class="p">.</span><span class="nn">Linq</span><span class="p">.</span><span class="nn">ElementWriter</span><span class="p">.</span><span class="nc">WriteElement</span><span class="o">(</span><span class="nc">XElement</span> <span class="n">e</span><span class="o">)</span>
</span><span class='line'>       <span class="n">at</span> <span class="nn">System</span><span class="p">.</span><span class="nn">Xml</span><span class="p">.</span><span class="nn">Linq</span><span class="p">.</span><span class="nn">XElement</span><span class="p">.</span><span class="nc">WriteTo</span><span class="o">(</span><span class="nc">XmlWriter</span> <span class="n">writer</span><span class="o">)</span>
</span><span class='line'>       <span class="n">at</span> <span class="nn">System</span><span class="p">.</span><span class="nn">Xml</span><span class="p">.</span><span class="nn">Linq</span><span class="p">.</span><span class="nn">XContainer</span><span class="p">.</span><span class="nc">WriteContentTo</span><span class="o">(</span><span class="nc">XmlWriter</span> <span class="n">writer</span><span class="o">)</span>
</span><span class='line'>       <span class="n">at</span> <span class="nn">System</span><span class="p">.</span><span class="nn">Xml</span><span class="p">.</span><span class="nn">Linq</span><span class="p">.</span><span class="nn">XNode</span><span class="p">.</span><span class="nc">GetXmlString</span><span class="o">(</span><span class="nc">SaveOptions</span> <span class="n">o</span><span class="o">)</span>
</span><span class='line'>       <span class="n">at</span> <span class="nn">System</span><span class="p">.</span><span class="nn">Xml</span><span class="p">.</span><span class="nn">Linq</span><span class="p">.</span><span class="nn">XNode</span><span class="p">.</span><span class="nc">ToString</span><span class="bp">()</span>
</span><span class='line'>       <span class="n">at</span> <span class="nn">Program</span><span class="p">.</span><span class="nc">Add</span> <span class="n">enhancement</span> <span class="n">must</span> <span class="n">be</span> <span class="n">idompotent</span><span class="o">(</span><span class="nc">String</span> <span class="n">input</span><span class="o">)</span> <span class="k">in</span> <span class="nc">C</span><span class="o">:</span><span class="err">\</span><span class="nc">Users</span><span class="err">\</span><span class="n">michael</span><span class="o">.</span><span class="n">newton</span><span class="err">\</span><span class="n">documents</span><span class="err">\</span><span class="n">visual</span> <span class="n">studio</span> <span class="mi">2012</span><span class="err">\</span><span class="nc">Projects</span><span class="err">\</span><span class="nn">DevEd</span><span class="p">.</span><span class="nc">FsCheck</span><span class="err">\</span><span class="nc">TestRunner</span><span class="err">\</span><span class="nn">Program</span><span class="p">.</span><span class="n">fs</span><span class="o">:</span><span class="n">line</span> <span class="mi">10</span>
</span><span class='line'>       <span class="n">at</span> <span class="nn">Program</span><span class="p">.</span><span class="n">clo</span><span class="o">@</span><span class="mi">13</span><span class="o">.</span><span class="nc">Invoke</span><span class="o">(</span><span class="nc">String</span> <span class="n">input</span><span class="o">)</span> <span class="k">in</span> <span class="nc">C</span><span class="o">:</span><span class="err">\</span><span class="nc">Users</span><span class="err">\</span><span class="n">michael</span><span class="o">.</span><span class="n">newton</span><span class="err">\</span><span class="n">documents</span><span class="err">\</span><span class="n">visual</span> <span class="n">studio</span> <span class="mi">2012</span><span class="err">\</span><span class="nc">Projects</span><span class="err">\</span><span class="nn">DevEd</span><span class="p">.</span><span class="nc">FsCheck</span><span class="err">\</span><span class="nc">TestRunner</span><span class="err">\</span><span class="nn">Program</span><span class="p">.</span><span class="n">fs</span><span class="o">:</span><span class="n">line</span> <span class="mi">13</span>
</span><span class='line'>       <span class="n">at</span> <span class="nn">FsCheck</span><span class="p">.</span><span class="nn">Testable</span><span class="p">.</span><span class="n">evaluate</span><span class="o">[</span><span class="n">a</span><span class="o">,</span><span class="n">b</span><span class="o">](</span><span class="nc">FSharpFunc</span><span class="o">`</span><span class="mi">2</span> <span class="n">body</span><span class="o">,</span> <span class="n">a</span> <span class="n">a</span><span class="o">)</span>
</span><span class='line'>  <span class="nc">InnerException</span><span class="o">:</span>
</span></code></pre></td></tr></table></div></figure>

<p>And this is where the full power of FsCheck starts becoming apparent. I know my input is untrusted, so I&#39;ve told it to generate <em>any</em> string. And it believed me, and has created an input string that breaks <code>System.Xml.XmlEncodedRawTextWriter.WriteElementTextBlock</code>. This is not a unit test I would have thought to write myself, as I&#39;d managed to miss that the fact that <a href="http://blog.mark-mclaren.info/2007/02/invalid-xml-characters-when-valid-utf8_5873.html">not all utf-8 characters are valid in utf-8 encoded xml</a>. In fact, it took me more than a few minutes to work out why it was throwing.</p>

<p>At this point FsCheck has revealed to us that our initial brief is actually incomplete; we&#39;ve told the customer that we&#39;re willing to accept utf-8 strings as input, but our storage mechanism doesn&#39;t support all utf-8 strings. To even get FsCheck to run, we&#39;ll have to decide on an error handling strategy - and importantly, it will have to be a strategy that still fulfils the initial properties specified (unless we decide that what we&#39;ve discovered so fundamentally breaks our initial assumptions that they need to be re-visited).</p>

<p>This is a toy project so I&#39;m going to bail slightly on this one: I&#39;m going to assume that invalid values just add an error node with a &#39;cleaned&#39; version of the input which could then be reviewed by a human at a later date. This has the advantage that it still fulfils all of our properties above.</p>

<p>Fortunately for us, in .NET 4.0 and above there is a function in the <code>System.Xml</code> namespace called <code>XmlConvert.IsXmlChar</code> which does roughly what you would expect from the name. Let&#39;s add an invalid character filter, and an active pattern to tell us if any characters have been removed:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">let</span> <span class="n">filterInvalidChars</span> <span class="o">(</span><span class="n">input</span> <span class="o">:</span> <span class="kt">string</span><span class="o">)</span> <span class="o">=</span>
</span><span class='line'>    <span class="n">input</span>
</span><span class='line'>    <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">filter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">c</span> <span class="o">-&gt;</span> <span class="nn">XmlConvert</span><span class="p">.</span><span class="nc">IsXmlChar</span> <span class="n">c</span><span class="o">)</span>
</span><span class='line'>    <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">map</span> <span class="kt">string</span>
</span><span class='line'>    <span class="o">|&gt;</span> <span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="o">(|</span><span class="nc">ValidXml</span><span class="o">|</span><span class="nc">InvalidXml</span><span class="o">|)</span> <span class="n">str</span> <span class="o">=</span>
</span><span class='line'>    <span class="k">let</span> <span class="n">filtered</span> <span class="o">=</span> <span class="n">filterInvalidChars</span> <span class="n">str</span>
</span><span class='line'>    <span class="k">if</span> <span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">filtered</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">str</span> <span class="k">then</span>
</span><span class='line'>        <span class="nc">ValidXml</span> <span class="n">str</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>        <span class="nc">InvalidXml</span> <span class="n">filtered</span>
</span></code></pre></td></tr></table></div></figure>

<p>Now we can amend <code>AddEnhancement</code> to add enhancement nodes for valid XML text or an error node for sanitized invalid XML text:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">let</span> <span class="nc">AddEnhancement</span> <span class="o">(</span><span class="n">xDoc</span> <span class="o">:</span> <span class="nc">XDocument</span><span class="o">)</span> <span class="o">(</span><span class="n">input</span> <span class="o">:</span> <span class="kt">string</span><span class="o">)</span> <span class="o">=</span>
</span><span class='line'>    <span class="k">match</span> <span class="n">input</span> <span class="k">with</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">ValidXml</span> <span class="n">text</span> <span class="o">-&gt;</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">xDoc</span><span class="o">.</span><span class="nn">Root</span><span class="p">.</span><span class="nc">Elements</span><span class="o">(</span><span class="nn">XName</span><span class="p">.</span><span class="nc">Get</span> <span class="s2">&quot;Enhancement&quot;</span><span class="o">)</span> <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">exists</span><span class="o">(</span><span class="k">fun</span> <span class="n">enhance</span> <span class="o">-&gt;</span> <span class="n">enhance</span><span class="o">.</span><span class="nc">Value</span> <span class="o">=</span> <span class="n">text</span><span class="o">)</span> <span class="k">then</span>
</span><span class='line'>            <span class="n">xDoc</span><span class="o">.</span><span class="nn">Root</span><span class="p">.</span><span class="nc">Add</span><span class="o">(</span><span class="nc">XElement</span><span class="o">(</span><span class="nn">XName</span><span class="p">.</span><span class="nc">Get</span> <span class="s2">&quot;Enhancement&quot;</span><span class="o">,</span> <span class="n">text</span><span class="o">))</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">InvalidXml</span> <span class="n">text</span> <span class="o">-&gt;</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">xDoc</span><span class="o">.</span><span class="nn">Root</span><span class="p">.</span><span class="nc">Elements</span><span class="o">(</span><span class="nn">XName</span><span class="p">.</span><span class="nc">Get</span> <span class="s2">&quot;Error&quot;</span><span class="o">)</span> <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">exists</span><span class="o">(</span><span class="k">fun</span> <span class="n">error</span> <span class="o">-&gt;</span> <span class="n">error</span><span class="o">.</span><span class="nc">Value</span> <span class="o">=</span> <span class="n">text</span><span class="o">)</span> <span class="k">then</span>
</span><span class='line'>            <span class="n">xDoc</span><span class="o">.</span><span class="nn">Root</span><span class="p">.</span><span class="nc">Add</span><span class="o">(</span><span class="nc">XElement</span><span class="o">(</span><span class="nn">XName</span><span class="p">.</span><span class="nc">Get</span> <span class="s2">&quot;Error&quot;</span><span class="o">,</span> <span class="n">text</span><span class="o">))</span>
</span><span class='line'>    <span class="n">xDoc</span>
</span></code></pre></td></tr></table></div></figure>

<p>And when we run FsCheck again:</p>

<p><img src="/images/FsCheck2.png" alt="Hurrah!"></p>

<p>Excellent stuff.</p>

<p>As a bonus extra, I&#39;ve included below a somewhat expanded version of the test code. Remember I said that FsCheck already knows how to generate strings? Unfortunately it doesn&#39;t know how to generate XML out of the box, but I was pleasantly surprised how quick and easy it was to write a naive XML generator. It generates <a href="https://gist.github.com/mavnn/5976004#file-example-xml">XML like this</a>. Also, check out the <code>CheckAll</code> function used at the end which allows you to build and run &#39;property classes&#39; to group families of properties together.</p>

<p>And, of course, per the specification, it checks that the 3rd property above holds true (that adding enhancements never reduces the size of the document).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">module</span> <span class="nn">FsCheck</span><span class="p">.</span><span class="nn">Examples</span><span class="p">.</span><span class="nc">Tests</span>
</span><span class='line'>
</span><span class='line'><span class="k">open</span> <span class="nc">FsCheck</span>
</span><span class='line'><span class="k">open</span> <span class="nn">DevEd</span><span class="p">.</span><span class="nc">FsCheck</span>
</span><span class='line'><span class="k">open</span> <span class="nn">System</span><span class="p">.</span><span class="nn">Xml</span><span class="p">.</span><span class="nc">Linq</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">baseDocText</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;&lt;?xml version=&quot;</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="s2">&quot; encoding=&quot;</span><span class="nc">UTF</span><span class="o">-</span><span class="mi">8</span><span class="s2">&quot;?&gt;</span>
</span><span class='line'><span class="s2">&lt;root /&gt;</span>
</span><span class='line'><span class="s2">&quot;&quot;&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">type</span> <span class="nc">XmlTree</span> <span class="o">=</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">NodeName</span> <span class="k">of</span> <span class="kt">string</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">Container</span> <span class="k">of</span> <span class="kt">string</span> <span class="o">*</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">XmlTree</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">nodeNames</span> <span class="o">=</span>
</span><span class='line'>    <span class="o">[</span><span class="s2">&quot;myNode&quot;</span><span class="o">;</span>
</span><span class='line'>     <span class="s2">&quot;myOtherNode&quot;</span><span class="o">;</span>
</span><span class='line'>     <span class="s2">&quot;someDifferentNode&quot;</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">tree</span> <span class="o">=</span>
</span><span class='line'>    <span class="k">let</span> <span class="k">rec</span> <span class="n">tree&#39;</span> <span class="n">s</span> <span class="o">=</span>
</span><span class='line'>        <span class="k">match</span> <span class="n">s</span> <span class="k">with</span>
</span><span class='line'>        <span class="o">|</span> <span class="mi">0</span> <span class="o">-&gt;</span> <span class="nn">Gen</span><span class="p">.</span><span class="n">map</span> <span class="nc">NodeName</span> <span class="o">(</span><span class="nn">Gen</span><span class="p">.</span><span class="n">elements</span> <span class="n">nodeNames</span><span class="o">)</span>
</span><span class='line'>        <span class="o">|</span> <span class="n">n</span> <span class="k">when</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">-&gt;</span>
</span><span class='line'>            <span class="k">let</span> <span class="n">subtrees</span> <span class="o">=</span>
</span><span class='line'>                <span class="nn">Gen</span><span class="p">.</span><span class="n">sized</span> <span class="o">&lt;|</span> <span class="k">fun</span> <span class="n">s</span> <span class="o">-&gt;</span>
</span><span class='line'>                    <span class="nn">Gen</span><span class="p">.</span><span class="n">resize</span> <span class="o">(</span><span class="n">s</span>
</span><span class='line'>                                <span class="o">|&gt;</span> <span class="kt">float</span>
</span><span class='line'>                                <span class="o">|&gt;</span> <span class="n">sqrt</span>
</span><span class='line'>                                <span class="o">|&gt;</span> <span class="kt">int</span><span class="o">)</span> <span class="o">(</span><span class="nn">Gen</span><span class="p">.</span><span class="n">listOf</span><span class="o">(</span><span class="n">tree&#39;</span><span class="o">(</span><span class="n">n</span> <span class="o">/</span> <span class="mi">2</span><span class="o">)))</span>
</span><span class='line'>            <span class="nn">Gen</span><span class="p">.</span><span class="n">oneof</span>
</span><span class='line'>                <span class="o">[</span><span class="nn">Gen</span><span class="p">.</span><span class="n">map</span> <span class="nc">NodeName</span> <span class="o">(</span><span class="nn">Gen</span><span class="p">.</span><span class="n">elements</span> <span class="n">nodeNames</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>                 <span class="nn">Gen</span><span class="p">.</span><span class="n">map2</span> <span class="o">(</span><span class="k">fun</span> <span class="n">name</span> <span class="n">contents</span> <span class="o">-&gt;</span> <span class="nc">Container</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">contents</span><span class="o">))</span>
</span><span class='line'>                     <span class="o">(</span><span class="nn">Gen</span><span class="p">.</span><span class="n">elements</span> <span class="n">nodeNames</span><span class="o">)</span> <span class="n">subtrees</span><span class="o">]</span>
</span><span class='line'>        <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">invalidArg</span> <span class="s2">&quot;s&quot;</span> <span class="s2">&quot;Size most be positive.&quot;</span>
</span><span class='line'>    <span class="nn">Gen</span><span class="p">.</span><span class="n">sized</span> <span class="n">tree&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">treeToXDoc</span> <span class="n">xmlTree</span> <span class="o">=</span>
</span><span class='line'>    <span class="k">let</span> <span class="k">rec</span> <span class="n">inner</span> <span class="n">currentNode</span> <span class="n">children</span> <span class="o">=</span>
</span><span class='line'>        <span class="k">let</span> <span class="n">childMatch</span> <span class="n">child</span> <span class="o">=</span>
</span><span class='line'>            <span class="k">match</span> <span class="n">child</span> <span class="k">with</span>
</span><span class='line'>            <span class="o">|</span> <span class="nc">NodeName</span> <span class="n">name</span> <span class="o">-&gt;</span> <span class="nc">XElement</span><span class="o">(</span><span class="nn">XName</span><span class="p">.</span><span class="nc">Get</span> <span class="n">name</span><span class="o">)</span>
</span><span class='line'>            <span class="o">|</span> <span class="nc">Container</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">contents</span><span class="o">)</span> <span class="o">-&gt;</span>
</span><span class='line'>                <span class="k">let</span> <span class="n">element</span> <span class="o">=</span> <span class="nc">XElement</span><span class="o">(</span><span class="nn">XName</span><span class="p">.</span><span class="nc">Get</span> <span class="n">name</span><span class="o">)</span>
</span><span class='line'>                <span class="n">inner</span> <span class="n">element</span> <span class="n">contents</span>
</span><span class='line'>        <span class="n">currentNode</span><span class="o">.</span><span class="nc">Add</span><span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="n">childMatch</span> <span class="n">children</span> <span class="o">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">toArray</span><span class="o">)</span>
</span><span class='line'>        <span class="n">currentNode</span>
</span><span class='line'>    <span class="k">match</span> <span class="n">xmlTree</span> <span class="k">with</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">NodeName</span> <span class="n">name</span> <span class="o">-&gt;</span> <span class="nc">XDocument</span><span class="o">(</span><span class="nc">XElement</span><span class="o">(</span><span class="nn">XName</span><span class="p">.</span><span class="nc">Get</span> <span class="n">name</span><span class="o">))</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">Container</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">contents</span><span class="o">)</span> <span class="o">-&gt;</span>
</span><span class='line'>        <span class="k">let</span> <span class="n">doc</span> <span class="o">=</span> <span class="nc">XDocument</span><span class="o">(</span><span class="nc">XElement</span><span class="o">(</span><span class="nn">XName</span><span class="p">.</span><span class="nc">Get</span> <span class="n">name</span><span class="o">))</span>
</span><span class='line'>        <span class="n">inner</span> <span class="n">doc</span><span class="o">.</span><span class="nc">Root</span> <span class="n">contents</span> <span class="o">|&gt;</span> <span class="n">ignore</span>
</span><span class='line'>        <span class="n">doc</span>
</span><span class='line'>
</span><span class='line'><span class="k">type</span> <span class="nc">XmlGenerator</span><span class="bp">()</span> <span class="o">=</span>
</span><span class='line'>    <span class="k">static</span> <span class="k">member</span> <span class="nc">XmlTree</span><span class="bp">()</span> <span class="o">=</span>
</span><span class='line'>        <span class="o">{</span> <span class="k">new</span> <span class="nc">Arbitrary</span><span class="o">&lt;</span><span class="nc">XmlTree</span><span class="o">&gt;</span><span class="bp">()</span> <span class="k">with</span>
</span><span class='line'>              <span class="k">member</span> <span class="n">x</span><span class="o">.</span><span class="nc">Generator</span> <span class="o">=</span> <span class="n">tree</span>
</span><span class='line'>              <span class="k">member</span> <span class="n">x</span><span class="o">.</span><span class="nc">Shrinker</span> <span class="n">t</span> <span class="o">=</span>
</span><span class='line'>                  <span class="k">match</span> <span class="n">t</span> <span class="k">with</span>
</span><span class='line'>                  <span class="o">|</span> <span class="nc">NodeName</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">empty</span>
</span><span class='line'>                  <span class="o">|</span> <span class="nc">Container</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">contents</span><span class="o">)</span> <span class="o">-&gt;</span>
</span><span class='line'>                      <span class="k">match</span> <span class="n">contents</span> <span class="k">with</span>
</span><span class='line'>                      <span class="o">|</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="n">seq</span> <span class="o">{</span> <span class="k">yield</span> <span class="nc">NodeName</span> <span class="n">name</span> <span class="o">}</span>
</span><span class='line'>                      <span class="o">|</span> <span class="n">c</span> <span class="o">-&gt;</span>
</span><span class='line'>                          <span class="n">seq</span> <span class="o">{</span>
</span><span class='line'>                              <span class="k">for</span> <span class="n">n</span> <span class="k">in</span> <span class="n">c</span> <span class="o">-&gt;</span> <span class="n">n</span> <span class="o">}</span> <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">type</span> <span class="nc">XmlUpdaterProperties</span><span class="bp">()</span> <span class="o">=</span>
</span><span class='line'>    <span class="k">static</span> <span class="k">member</span> <span class="o">``</span><span class="nc">AddEnhancement</span> <span class="n">is</span> <span class="n">idempotent</span><span class="o">``(</span><span class="n">data</span> <span class="o">:</span> <span class="kt">string</span><span class="o">)</span> <span class="o">=</span>
</span><span class='line'>        <span class="o">((</span><span class="nc">AddEnhancement</span> <span class="o">&lt;|</span> <span class="nc">AddEnhancement</span> <span class="o">(</span><span class="nn">XDocument</span><span class="p">.</span><span class="nc">Parse</span> <span class="n">baseDocText</span><span class="o">)</span> <span class="n">data</span><span class="o">)</span> <span class="n">data</span><span class="o">)</span>
</span><span class='line'>            <span class="o">.</span><span class="nc">ToString</span><span class="bp">()</span> <span class="o">=</span> <span class="o">(</span><span class="nc">AddEnhancement</span> <span class="o">(</span><span class="nn">XDocument</span><span class="p">.</span><span class="nc">Parse</span> <span class="n">baseDocText</span><span class="o">)</span> <span class="n">data</span><span class="o">)</span>
</span><span class='line'>            <span class="o">.</span><span class="nc">ToString</span><span class="bp">()</span>
</span><span class='line'>    <span class="k">static</span> <span class="k">member</span> <span class="o">``</span><span class="nc">AddEnhancement</span> <span class="n">is</span> <span class="n">idempotent</span> <span class="n">on</span> <span class="n">different</span> <span class="n">xml</span> <span class="n">structures</span><span class="o">``(</span><span class="n">xmlDoc</span> <span class="o">:</span> <span class="nc">XmlTree</span><span class="o">,</span>
</span><span class='line'>                                                                           <span class="n">data</span> <span class="o">:</span> <span class="kt">string</span><span class="o">)</span> <span class="o">=</span>
</span><span class='line'>        <span class="o">(</span><span class="nc">AddEnhancement</span> <span class="o">(</span><span class="n">treeToXDoc</span> <span class="n">xmlDoc</span><span class="o">)</span> <span class="n">data</span><span class="o">).</span><span class="nc">ToString</span><span class="bp">()</span> <span class="o">=</span> <span class="o">(</span><span class="nc">AddEnhancement</span> <span class="o">(</span><span class="nc">AddEnhancement</span> <span class="o">(</span><span class="n">treeToXDoc</span> <span class="n">xmlDoc</span><span class="o">)</span> <span class="n">data</span><span class="o">)</span> <span class="n">data</span><span class="o">)</span>
</span><span class='line'>            <span class="o">.</span><span class="nc">ToString</span><span class="bp">()</span>
</span><span class='line'>    <span class="k">static</span> <span class="k">member</span> <span class="o">``</span><span class="nc">AddEnhancement</span> <span class="n">never</span> <span class="n">reduces</span> <span class="n">the</span> <span class="n">number</span> <span class="k">of</span> <span class="n">nodes</span><span class="o">``</span> <span class="o">(</span><span class="n">xmlDoc</span> <span class="o">:</span> <span class="nc">XmlTree</span><span class="o">,</span> <span class="n">data</span> <span class="o">:</span> <span class="kt">string</span><span class="o">)</span> <span class="o">=</span>
</span><span class='line'>        <span class="nn">Seq</span><span class="p">.</span><span class="n">length</span> <span class="o">((</span><span class="n">treeToXDoc</span> <span class="n">xmlDoc</span><span class="o">).</span><span class="nc">DescendantNodes</span><span class="bp">()</span><span class="o">)</span> <span class="o">=</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">length</span> <span class="o">((</span><span class="nc">AddEnhancement</span> <span class="o">(</span><span class="n">treeToXDoc</span> <span class="n">xmlDoc</span><span class="o">)</span> <span class="n">data</span><span class="o">).</span><span class="nc">DescendantNodes</span><span class="bp">()</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="nn">Arb</span><span class="p">.</span><span class="n">register</span><span class="o">&lt;</span><span class="nc">XmlGenerator</span><span class="o">&gt;</span><span class="bp">()</span> <span class="o">|&gt;</span> <span class="n">ignore</span>
</span><span class='line'><span class="nn">Check</span><span class="p">.</span><span class="nc">QuickAll</span><span class="o">&lt;</span><span class="nc">XmlUpdaterProperties</span><span class="o">&gt;</span><span class="bp">()</span>
</span><span class='line'><span class="nn">System</span><span class="p">.</span><span class="nn">Console</span><span class="p">.</span><span class="nc">ReadLine</span><span class="bp">()</span> <span class="o">|&gt;</span> <span class="n">ignore</span>
</span></code></pre></td></tr></table></div></figure>

<p>Thanks for reading this far. If you want to play yourself, a full copy of the example code is <a href="https://github.com/mavnn/DevEd.FsCheck">on GitHub</a> with an MIT license.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/6/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog/page/4/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/process-management-in-easynetq/">Process Management in EasyNetQ</a>
      </li>
    
      <li class="post">
        <a href="/deliberate-poster-fighting-imposter-syndrome/">Deliberate Poster: Fighting Imposter Syndrome</a>
      </li>
    
      <li class="post">
        <a href="/managing-mutable-state-with-computational-expressions/">Managing Mutable State With Computational Expressions</a>
      </li>
    
      <li class="post">
        <a href="/return-to-the-ivory-tower-video/">Return to the Ivory Tower Video</a>
      </li>
    
      <li class="post">
        <a href="/slides-for-f-number-exchange-2017/">Slides for F# Exchange 2017</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/mavnn">@mavnn</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'mavnn',
            count: 3,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>



<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/+MichaelNewtonmavnn?rel=author">
      <img src="https://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2017 - mavnn -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'mavnn';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
