
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Mavnn's blog</title>
  <meta name="author" content="mavnn">

  
  <meta name="description" content="Yesterday night I was about to demo a quick server/client pair with Freya and Fable, and it all went a bit wrong. Some of the issues weren&#39;t &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">


  <link rel="canonical" href="https://blog.mavnn.co.uk/index.html">
  <link href="/favicon.ico" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Mavnn's blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="https://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=Fira+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=Fira+Mono:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
<!-- Google Analytics -->
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-37561687-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


</head>

<body   >
  <header role="banner"><hgroup>
  <a href="https://mavnn.co.uk"><img class="swirl-logo" src="/images/swirl.svg"/></a>
  <h1><a href="/">Mavnn's blog</a></h1>
  
    <h2>Stuff from my brain</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="#" method="get" id="searchbox" >
  <fieldset role="search">
    <input type="hidden" id="site_query" value="site:blog.mavnn.co.uk" />
    <input class="search" type="text" name="q" results="0" id="search_query" placeholder="Search"/>
  </fieldset>
</form>
<ul class="main-navigation">
  <li><a href="https://mavnn.co.uk">Main Site</a></li>
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      

  <header>
    
      <h1 class="entry-title"><a href="/full-stack-with-freya/">Full Stack With Freya</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2018-05-22T15:04:00+01:00" pubdate data-updated="true">May 22<span>nd</span>, 2018</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Yesterday night I was about to demo a quick server/client pair with Freya and Fable, and it all went a bit wrong. Some of the issues weren&#39;t related to what I did (computers, gotta love &#39;em) but others were just bits of configuration that I didn&#39;t have at my finger tips.</p>

<p>This means it&#39;s time for a little practice for me, and a mini-tutorial for you (and future me).</p>

<h2>What we&#39;re going to do</h2>

<p>We&#39;re going to build a small server application based on Freya which will serve JSON and be a nice RESTful (in the loose sense) API.</p>

<p>Then, we&#39;re going to configure Fable with Elmish to load data from that API. The crucial thing here is that we&#39;re going to configure both projects such that we have a seamless development work flow; automated recompile and restart of the server on code changes, and automatic recompile/reload of the Fable UI on change.</p>

<h2>The server</h2>

<p>Make sure your dotnet core Freya template is up to date:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>dotnet new -i Freya
</span></code></pre></td></tr></table></div></figure>

<p>In a root directory for our overall solution, run:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>dotnet new freya -lang f# -c hopac -f kestrel -o FateServer
</span></code></pre></td></tr></table></div></figure>

<p>This will create a new directory called &quot;FateServer&quot; with a F# project in it. Go into the directory and make sure everything has restored correctly:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">cd </span>FateServer
</span><span class='line'>dotnet restore
</span><span class='line'>dotnet build
</span></code></pre></td></tr></table></div></figure>

<p>One thing I&#39;ve been slowly learning with dotnet core is that the <code>restore</code> run by default during a build doesn&#39;t always seem to be as effective as actually running the full restore command. Just in general, if Core is behaving strangely, running <code>restore</code> is a good starting point.</p>

<p>Next up is making our server log something: by default, Kestrel logs basically nothing.</p>

<p>Install the logging package (it&#39;s not part of the default Freya template):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>dotnet add package Microsoft.Extensions.Logging.Console
</span><span class='line'>dotnet restore
</span></code></pre></td></tr></table></div></figure>

<p>In <code>Program.fs</code> add the following at the end of the open statements:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">open</span> <span class="nn">Microsoft</span><span class="p">.</span><span class="nn">AspNetCore</span><span class="p">.</span><span class="nc">Builder</span>
</span><span class='line'><span class="k">open</span> <span class="nn">Microsoft</span><span class="p">.</span><span class="nn">AspNetCore</span><span class="p">.</span><span class="nc">Hosting</span>
</span><span class='line'><span class="k">open</span> <span class="nn">Microsoft</span><span class="p">.</span><span class="nn">Extensions</span><span class="p">.</span><span class="nc">Logging</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">configureLogging</span> <span class="o">(</span><span class="n">b</span> <span class="o">:</span> <span class="nc">IWebHostBuilder</span><span class="o">)</span> <span class="o">=</span>
</span><span class='line'>    <span class="n">b</span><span class="o">.</span><span class="nc">ConfigureLogging</span><span class="o">(</span><span class="k">fun</span> <span class="n">l</span> <span class="o">-&gt;</span> <span class="n">l</span><span class="o">.</span><span class="nc">AddConsole</span><span class="bp">()</span> <span class="o">|&gt;</span> <span class="n">ignore</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>

<p>Then inject the method into your WebHost configuration pipeline:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="nn">WebHost</span><span class="p">.</span><span class="n">create</span> <span class="bp">()</span>
</span><span class='line'><span class="o">|&gt;</span> <span class="nn">WebHost</span><span class="p">.</span><span class="n">bindTo</span> <span class="o">[|</span><span class="s2">&quot;http://localhost:5000&quot;</span><span class="o">|]</span>
</span><span class='line'><span class="o">|&gt;</span> <span class="nn">WebHost</span><span class="p">.</span><span class="n">configure</span> <span class="n">configureApp</span>
</span><span class='line'><span class="o">|&gt;</span> <span class="n">configureLogging</span>
</span><span class='line'><span class="o">|&gt;</span> <span class="nn">WebHost</span><span class="p">.</span><span class="n">buildAndRun</span>
</span></code></pre></td></tr></table></div></figure>

<p>Hey presto! Run your application and get logs!</p>

<p>To finish off the niceties of civilized development, let&#39;s add the watch command to our server.</p>

<p>Crack open the <code>fsproj</code> file and add the following ItemGroup to it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;ItemGroup&gt;</span>
</span><span class='line'>    <span class="nt">&lt;DotNetCliToolReference</span> <span class="na">Include=</span><span class="s">&quot;Microsoft.DotNet.Watcher.Tools&quot;</span> <span class="na">Version=</span><span class="s">&quot;2.0.0&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'><span class="nt">&lt;/ItemGroup&gt;</span>
</span></code></pre></td></tr></table></div></figure>

<p>Run <code>dotnet restore</code> and from now on running <code>dotnet watch run</code> to start continuous development with file watching should work.</p>

<p>Now we just need to serve up some JSON. We want a send a format which Fable understands, and the kind people at the Fable project have written a Newtonsoft configuration for doing exactly that.</p>

<p>Stop watching the build long enough to run:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>dotnet add package Fable.JsonConverter
</span><span class='line'>dotnet restore
</span></code></pre></td></tr></table></div></figure>

<p>Next, set up the domain. Create a new file <code>Character.fs</code> (we&#39;re going to be sending back and forth <a href="https://fate-srd.com/fate-accelerated/get-started">Fate Accelerated</a> characters as data). Make sure you add it to the project file before <code>Api.fs</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">module</span> <span class="nc">Character</span>
</span><span class='line'>
</span><span class='line'><span class="k">type</span> <span class="nc">LadderLevel</span> <span class="o">=</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">BeyondLegendary</span> <span class="k">of</span> <span class="kt">int</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">Legendary</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">Epic</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">Superb</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">Great</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">Good</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">Fair</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">Average</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">Mediocre</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">Poor</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">Terrible</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">Abysmal</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">BeyondAbysmal</span> <span class="k">of</span> <span class="kt">int</span>
</span><span class='line'>
</span><span class='line'><span class="k">type</span> <span class="nc">Character</span> <span class="o">=</span>
</span><span class='line'>    <span class="o">{</span> <span class="nc">Name</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class='line'>      <span class="nc">Careful</span> <span class="o">:</span> <span class="nc">LadderLevel</span>
</span><span class='line'>      <span class="nc">Clever</span> <span class="o">:</span> <span class="nc">LadderLevel</span>
</span><span class='line'>      <span class="nc">Flashy</span> <span class="o">:</span> <span class="nc">LadderLevel</span>
</span><span class='line'>      <span class="nc">Forceful</span> <span class="o">:</span> <span class="nc">LadderLevel</span>
</span><span class='line'>      <span class="nc">Quick</span> <span class="o">:</span> <span class="nc">LadderLevel</span>
</span><span class='line'>      <span class="nc">Sneaky</span> <span class="o">:</span> <span class="nc">LadderLevel</span>
</span><span class='line'>      <span class="nc">HighConcept</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class='line'>      <span class="nc">Trouble</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class='line'>      <span class="nc">Aspects</span> <span class="o">:</span> <span class="kt">string</span> <span class="kt">list</span>
</span><span class='line'>      <span class="nc">Stunts</span> <span class="o">:</span> <span class="kt">string</span> <span class="kt">list</span> <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>Now move across to <code>Api.fs</code>. You&#39;ll see that it defaults to a single &quot;greeting&quot; endpoint which responds with a text response. Let&#39;s add a helper for sending JSON correctly, immediately after the existing <code>open</code> statements:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">open</span> <span class="nn">Freya</span><span class="p">.</span><span class="nn">Machines</span><span class="p">.</span><span class="nn">Http</span><span class="p">.</span><span class="nc">Cors</span>
</span><span class='line'><span class="k">open</span> <span class="nn">Freya</span><span class="p">.</span><span class="nn">Types</span><span class="p">.</span><span class="nn">Http</span><span class="p">.</span><span class="nc">Cors</span>
</span><span class='line'><span class="k">open</span> <span class="nc">System</span>
</span><span class='line'><span class="k">open</span> <span class="nn">System</span><span class="p">.</span><span class="nc">IO</span>
</span><span class='line'><span class="k">open</span> <span class="nn">Newtonsoft</span><span class="p">.</span><span class="nc">Json</span>
</span><span class='line'><span class="k">open</span> <span class="nc">Character</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">jsonConverter</span> <span class="o">=</span> <span class="nn">Fable</span><span class="p">.</span><span class="nc">JsonConverter</span><span class="bp">()</span> <span class="o">:&gt;</span> <span class="nc">JsonConverter</span>
</span><span class='line'>
</span><span class='line'><span class="k">module</span> <span class="nc">Represent</span> <span class="o">=</span>
</span><span class='line'>    <span class="k">let</span> <span class="n">json</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">a</span><span class="o">&gt;</span> <span class="n">value</span> <span class="o">=</span>
</span><span class='line'>        <span class="k">let</span> <span class="n">data</span> <span class="o">=</span>
</span><span class='line'>            <span class="nn">JsonConvert</span><span class="p">.</span><span class="nc">SerializeObject</span><span class="o">(</span><span class="n">value</span><span class="o">,</span> <span class="o">[|</span><span class="n">jsonConverter</span><span class="o">|])</span>
</span><span class='line'>            <span class="o">|&gt;</span> <span class="nn">Text</span><span class="p">.</span><span class="nn">UTF8Encoding</span><span class="p">.</span><span class="nn">UTF8</span><span class="p">.</span><span class="nc">GetBytes</span>
</span><span class='line'>        <span class="k">let</span> <span class="n">desc</span> <span class="o">=</span>
</span><span class='line'>            <span class="o">{</span> <span class="nc">Encodings</span> <span class="o">=</span> <span class="nc">None</span>
</span><span class='line'>              <span class="nc">Charset</span> <span class="o">=</span> <span class="nc">Some</span> <span class="nn">Charset</span><span class="p">.</span><span class="nc">Utf8</span>
</span><span class='line'>              <span class="nc">Languages</span> <span class="o">=</span> <span class="nc">None</span>
</span><span class='line'>              <span class="nc">MediaType</span> <span class="o">=</span> <span class="nc">Some</span> <span class="nn">MediaType</span><span class="p">.</span><span class="nc">Json</span> <span class="o">}</span>
</span><span class='line'>        <span class="o">{</span> <span class="nc">Data</span> <span class="o">=</span> <span class="n">data</span>
</span><span class='line'>          <span class="nc">Description</span> <span class="o">=</span> <span class="n">desc</span> <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>Next, delete the entire rest of the file and add the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="c1">// This endpoint requires a URL template with the &quot;name&quot; atom</span>
</span><span class='line'><span class="k">let</span> <span class="n">name_</span> <span class="o">=</span> <span class="nn">Route</span><span class="p">.</span><span class="n">atom_</span> <span class="s2">&quot;name&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">name</span> <span class="o">=</span>
</span><span class='line'>    <span class="n">freya</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">let</span><span class="o">!</span> <span class="n">nameO</span> <span class="o">=</span> <span class="nn">Freya</span><span class="p">.</span><span class="nn">Optic</span><span class="p">.</span><span class="n">get</span> <span class="n">name_</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">match</span> <span class="n">nameO</span> <span class="k">with</span>
</span><span class='line'>        <span class="o">|</span> <span class="nc">Some</span> <span class="n">name</span> <span class="o">-&gt;</span> <span class="k">return</span> <span class="n">name</span>
</span><span class='line'>        <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="k">return</span> <span class="n">failwith</span> <span class="s2">&quot;Name is a compulsory element of the URL&quot;</span> <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// We&#39;re going to hard code our data for now</span>
</span><span class='line'><span class="k">let</span> <span class="n">exampleCharacters</span> <span class="o">=</span>
</span><span class='line'>    <span class="nc">Map</span> <span class="o">[</span>
</span><span class='line'>        <span class="s2">&quot;bob&quot;</span><span class="o">,</span> <span class="o">{</span> <span class="nc">Name</span> <span class="o">=</span> <span class="s2">&quot;Bob&quot;</span>
</span><span class='line'>                 <span class="nc">Careful</span> <span class="o">=</span> <span class="nc">Mediocre</span>
</span><span class='line'>                 <span class="nc">Clever</span> <span class="o">=</span> <span class="nc">Fair</span>
</span><span class='line'>                 <span class="nc">Flashy</span> <span class="o">=</span> <span class="nc">Fair</span>
</span><span class='line'>                 <span class="nc">Forceful</span> <span class="o">=</span> <span class="nc">Good</span>
</span><span class='line'>                 <span class="nc">Quick</span> <span class="o">=</span> <span class="nc">Average</span>
</span><span class='line'>                 <span class="nc">Sneaky</span> <span class="o">=</span> <span class="nc">Average</span>
</span><span class='line'>                 <span class="nc">HighConcept</span> <span class="o">=</span> <span class="s2">&quot;The eternal example&quot;</span>
</span><span class='line'>                 <span class="nc">Trouble</span> <span class="o">=</span> <span class="s2">&quot;Lives in the test&quot;</span>
</span><span class='line'>                 <span class="nc">Aspects</span> <span class="o">=</span> <span class="o">[</span> <span class="s2">&quot;Really? He&#39;s just Bob&quot;</span> <span class="o">]</span>
</span><span class='line'>                 <span class="nc">Stunts</span> <span class="o">=</span> <span class="o">[</span> <span class="s2">&quot;QA haven&#39;t defeated him yet&quot;</span> <span class="o">]</span> <span class="o">}</span>
</span><span class='line'>    <span class="o">]</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Once per request, try and load the named character (see the memo at the end)</span>
</span><span class='line'><span class="k">let</span> <span class="n">character</span> <span class="o">=</span>
</span><span class='line'>    <span class="n">freya</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">let</span><span class="o">!</span> <span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
</span><span class='line'>        <span class="k">return</span> <span class="nn">Map</span><span class="p">.</span><span class="n">tryFind</span> <span class="o">(</span><span class="n">name</span><span class="o">.</span><span class="nc">ToLowerInvariant</span><span class="bp">()</span><span class="o">)</span> <span class="n">exampleCharacters</span>
</span><span class='line'>    <span class="o">}</span> <span class="o">|&gt;</span> <span class="nn">Freya</span><span class="p">.</span><span class="n">memo</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">characterExists</span> <span class="o">=</span>
</span><span class='line'>    <span class="n">character</span> <span class="o">|&gt;</span> <span class="nn">Freya</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="k">fun</span> <span class="n">c</span> <span class="o">-&gt;</span> <span class="n">c</span><span class="o">.</span><span class="nc">IsSome</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">sendCharacter</span> <span class="o">=</span>
</span><span class='line'>    <span class="n">freya</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">let</span><span class="o">!</span> <span class="n">character</span> <span class="o">=</span> <span class="n">character</span>
</span><span class='line'>        <span class="k">return</span> <span class="nn">Represent</span><span class="p">.</span><span class="n">json</span> <span class="o">(</span><span class="n">character</span><span class="o">.</span><span class="nc">Value</span><span class="o">)</span> <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">characterMachine</span> <span class="o">=</span>
</span><span class='line'>    <span class="n">freyaMachine</span> <span class="o">{</span>
</span><span class='line'><span class="o">#</span><span class="k">if</span> <span class="nc">DEBUG</span>
</span><span class='line'>        <span class="n">cors</span>
</span><span class='line'>        <span class="n">corsOrigins</span> <span class="o">[</span> <span class="nn">SerializedOrigin</span><span class="p">.</span><span class="n">parse</span> <span class="s2">&quot;http://localhost:8080&quot;</span> <span class="o">]</span>
</span><span class='line'><span class="o">#</span><span class="n">endif</span>
</span><span class='line'>        <span class="n">methods</span> <span class="o">[</span><span class="nc">GET</span><span class="o">;</span> <span class="nc">HEAD</span><span class="o">;</span> <span class="nc">OPTIONS</span><span class="o">]</span>
</span><span class='line'>        <span class="n">exists</span> <span class="n">characterExists</span>
</span><span class='line'>        <span class="n">handleOk</span> <span class="n">sendCharacter</span> <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">root</span> <span class="o">=</span>
</span><span class='line'>    <span class="n">freyaRouter</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">resource</span> <span class="s2">&quot;/character/{name}&quot;</span> <span class="n">characterMachine</span> <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>There&#39;s quite a lot going on in there, but what we&#39;ve defined with <code>characterMachine</code> is a resource which checks if a character exists, and sends it as Fable readable JSON if it does. We then configure a route to point to it.</p>

<p>Critically, we also turn on <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS">CORS</a> (Cross Origin Resource Sharing) for localhost:8080 for debug builds. This will enable requests from our Fable client running it&#39;s development server on a different port to talk to the server.</p>

<h2>The client</h2>

<p>Go back up into the root directory of the solution, and run:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>dotnet new -i Fable.Template.Fulma.Minimal
</span></code></pre></td></tr></table></div></figure>

<p>To get a dotnet core template for Fable with F# wrappers for React and Bulma - as well as Elmish pre-installed.</p>

<p>Then run:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>dotnet new fulma-minimal -lang f# -o FateClient
</span></code></pre></td></tr></table></div></figure>

<p>To create our client application.</p>

<p>Go into the newly created project directory, and use the built in build scripts to get everything up and running:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">cd </span>FateClient
</span><span class='line'>./fate.sh -t watch
</span></code></pre></td></tr></table></div></figure>

<p>On first run, it will download most of the internet, but such is modern net development.</p>

<p>Browse on over to <a href="http://localhost:8080/">http://localhost:8080/</a> to see the base template before we start hacking away!</p>

<p>Very pretty: and in <code>App.fs</code> we can see the nice clean Elmish code driving it.</p>

<p>Now! Let&#39;s start hacking away. Firstly, we&#39;re going to want to share our character types. I&#39;ve decided here that they are owned by the server, so we need to link the file into the Fable project.</p>

<p>In <code>FateClient.fsproj</code>, add change:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'>  <span class="nt">&lt;ItemGroup&gt;</span>
</span><span class='line'>    <span class="nt">&lt;Compile</span> <span class="na">Include=</span><span class="s">&quot;App.fs&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/ItemGroup&gt;</span>
</span></code></pre></td></tr></table></div></figure>

<p>to:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'>  <span class="nt">&lt;ItemGroup&gt;</span>
</span><span class='line'>    <span class="nt">&lt;Compile</span> <span class="na">Include=</span><span class="s">&quot;..\..\FateServer\Character.fs&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;Compile</span> <span class="na">Include=</span><span class="s">&quot;App.fs&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/ItemGroup&gt;</span>
</span></code></pre></td></tr></table></div></figure>

<p>Now we can load up our character. In <code>App.fs</code>, it&#39;s time to expand our model. Change our Elmish app as below:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">module</span> <span class="nn">App</span><span class="p">.</span><span class="nc">View</span>
</span><span class='line'>
</span><span class='line'><span class="k">open</span> <span class="nc">Elmish</span>
</span><span class='line'><span class="k">open</span> <span class="nn">Fable</span><span class="p">.</span><span class="nn">Helpers</span><span class="p">.</span><span class="nc">React</span>
</span><span class='line'><span class="k">open</span> <span class="nn">Fable</span><span class="p">.</span><span class="nn">Helpers</span><span class="p">.</span><span class="nn">React</span><span class="p">.</span><span class="nc">Props</span>
</span><span class='line'><span class="k">open</span> <span class="nn">Fable</span><span class="p">.</span><span class="nc">PowerPack</span>
</span><span class='line'><span class="k">open</span> <span class="nn">Fable</span><span class="p">.</span><span class="nn">PowerPack</span><span class="p">.</span><span class="nc">Fetch</span>
</span><span class='line'><span class="k">open</span> <span class="nc">Fulma</span>
</span><span class='line'><span class="k">open</span> <span class="nn">Fulma</span><span class="p">.</span><span class="nc">FontAwesome</span>
</span><span class='line'><span class="k">open</span> <span class="nc">Character</span>
</span><span class='line'>
</span><span class='line'><span class="k">type</span> <span class="nc">Model</span> <span class="o">=</span>
</span><span class='line'>    <span class="o">{</span> <span class="nc">IsLoading</span> <span class="o">:</span> <span class="kt">bool</span>
</span><span class='line'>      <span class="nc">Character</span> <span class="o">:</span> <span class="nc">Character</span> <span class="n">option</span>
</span><span class='line'>      <span class="nc">ErrorMessage</span> <span class="o">:</span> <span class="kt">string</span> <span class="n">option</span> <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">type</span> <span class="nc">Msg</span> <span class="o">=</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">CharacterLoaded</span> <span class="k">of</span> <span class="nc">Character</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">LoadingError</span> <span class="k">of</span> <span class="kt">string</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">loadBob</span> <span class="bp">()</span> <span class="o">=</span>
</span><span class='line'>    <span class="n">promise</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">let</span> <span class="n">props</span> <span class="o">=</span>
</span><span class='line'>            <span class="o">[</span> <span class="nn">RequestProperties</span><span class="p">.</span><span class="nc">Method</span> <span class="nn">HttpMethod</span><span class="p">.</span><span class="nc">GET</span> <span class="o">]</span>
</span><span class='line'>        <span class="k">return</span><span class="o">!</span> <span class="n">fetchAs</span><span class="o">&lt;</span><span class="nc">Character</span><span class="o">&gt;</span> <span class="s2">&quot;http://localhost:5000/character/bob&quot;</span> <span class="n">props</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">init</span> <span class="o">_</span> <span class="o">=</span>
</span><span class='line'>    <span class="o">{</span> <span class="nc">IsLoading</span> <span class="o">=</span> <span class="bp">true</span>
</span><span class='line'>      <span class="nc">Character</span> <span class="o">=</span> <span class="nc">None</span>
</span><span class='line'>      <span class="nc">ErrorMessage</span> <span class="o">=</span> <span class="nc">None</span> <span class="o">},</span>
</span><span class='line'>    <span class="nn">Cmd</span><span class="p">.</span><span class="n">ofPromise</span> <span class="n">loadBob</span> <span class="bp">()</span> <span class="nc">CharacterLoaded</span> <span class="o">(</span><span class="k">fun</span> <span class="n">e</span> <span class="o">-&gt;</span> <span class="nc">LoadingError</span> <span class="n">e</span><span class="o">.</span><span class="nc">Message</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="k">private</span> <span class="n">update</span> <span class="n">msg</span> <span class="n">model</span> <span class="o">=</span>
</span><span class='line'>    <span class="k">match</span> <span class="n">msg</span> <span class="k">with</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">CharacterLoaded</span> <span class="n">bob</span> <span class="o">-&gt;</span>
</span><span class='line'>        <span class="o">{</span> <span class="n">model</span> <span class="k">with</span> <span class="nc">IsLoading</span> <span class="o">=</span> <span class="bp">false</span>
</span><span class='line'>                     <span class="nc">Character</span> <span class="o">=</span> <span class="nc">Some</span> <span class="n">bob</span> <span class="o">},</span> <span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">LoadingError</span> <span class="n">error</span> <span class="o">-&gt;</span>
</span><span class='line'>        <span class="o">{</span> <span class="n">model</span> <span class="k">with</span> <span class="nc">IsLoading</span> <span class="o">=</span> <span class="bp">false</span>
</span><span class='line'>                     <span class="nc">Character</span> <span class="o">=</span> <span class="nc">None</span>
</span><span class='line'>                     <span class="nc">ErrorMessage</span> <span class="o">=</span> <span class="nc">Some</span> <span class="n">error</span> <span class="o">},</span> <span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">loadingMessage</span> <span class="n">model</span> <span class="o">=</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="nc">IsLoading</span> <span class="k">then</span>
</span><span class='line'>        <span class="o">[</span> <span class="n">str</span> <span class="s2">&quot;Loading...&quot;</span> <span class="o">]</span>
</span><span class='line'>    <span class="k">else</span> <span class="bp">[]</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">characterView</span> <span class="n">character</span> <span class="o">=</span>
</span><span class='line'>    <span class="o">[</span> <span class="n">h1</span> <span class="bp">[]</span> <span class="o">[</span> <span class="n">str</span> <span class="n">character</span><span class="o">.</span><span class="nc">Name</span> <span class="o">]</span>
</span><span class='line'>      <span class="n">h2</span> <span class="bp">[]</span> <span class="o">[</span> <span class="n">str</span> <span class="s2">&quot;Aspects&quot;</span> <span class="o">]</span>
</span><span class='line'>      <span class="n">ul</span> <span class="bp">[]</span> <span class="o">[</span>
</span><span class='line'>        <span class="n">li</span> <span class="bp">[]</span> <span class="o">[</span> <span class="n">str</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">&quot;High Concept: %s&quot;</span> <span class="n">character</span><span class="o">.</span><span class="nc">HighConcept</span> <span class="o">]</span>
</span><span class='line'>      <span class="o">]</span>
</span><span class='line'>    <span class="o">]</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">errorView</span> <span class="n">message</span> <span class="o">=</span>
</span><span class='line'>    <span class="o">[</span> <span class="nn">Notification</span><span class="p">.</span><span class="n">notification</span> <span class="o">[</span> <span class="nn">Notification</span><span class="p">.</span><span class="nc">Color</span> <span class="nc">IsDanger</span> <span class="o">]</span> <span class="o">[</span>
</span><span class='line'>        <span class="n">str</span> <span class="n">message</span>
</span><span class='line'>    <span class="o">]</span> <span class="o">]</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="k">private</span> <span class="n">view</span> <span class="n">model</span> <span class="n">dispatch</span> <span class="o">=</span>
</span><span class='line'>    <span class="nn">Hero</span><span class="p">.</span><span class="n">hero</span> <span class="o">[</span> <span class="nn">Hero</span><span class="p">.</span><span class="nc">IsFullHeight</span> <span class="o">]</span>
</span><span class='line'>        <span class="o">[</span> <span class="nn">Hero</span><span class="p">.</span><span class="n">body</span> <span class="o">[</span> <span class="o">]</span>
</span><span class='line'>            <span class="o">[</span> <span class="nn">Container</span><span class="p">.</span><span class="n">container</span> <span class="o">[</span> <span class="o">]</span>
</span><span class='line'>                <span class="o">[</span> <span class="nn">Columns</span><span class="p">.</span><span class="n">columns</span> <span class="o">[</span> <span class="nn">Columns</span><span class="p">.</span><span class="nc">CustomClass</span> <span class="s2">&quot;has-text-centered&quot;</span> <span class="o">]</span>
</span><span class='line'>                    <span class="o">[</span> <span class="nn">Column</span><span class="p">.</span><span class="n">column</span> <span class="o">[</span> <span class="nn">Column</span><span class="p">.</span><span class="nc">Width</span><span class="o">(</span><span class="nn">Screen</span><span class="p">.</span><span class="nc">All</span><span class="o">,</span> <span class="nn">Column</span><span class="p">.</span><span class="nc">IsOneThird</span><span class="o">)</span>
</span><span class='line'>                                      <span class="nn">Column</span><span class="p">.</span><span class="nc">Offset</span><span class="o">(</span><span class="nn">Screen</span><span class="p">.</span><span class="nc">All</span><span class="o">,</span> <span class="nn">Column</span><span class="p">.</span><span class="nc">IsOneThird</span><span class="o">)</span> <span class="o">]</span>
</span><span class='line'>                        <span class="o">[</span> <span class="nn">Image</span><span class="p">.</span><span class="n">image</span> <span class="o">[</span> <span class="nn">Image</span><span class="p">.</span><span class="nc">Is128x128</span>
</span><span class='line'>                                        <span class="nn">Image</span><span class="p">.</span><span class="nc">Props</span> <span class="o">[</span> <span class="nc">Style</span> <span class="o">[</span> <span class="nc">Margin</span> <span class="s2">&quot;auto&quot;</span><span class="o">]</span> <span class="o">]</span> <span class="o">]</span>
</span><span class='line'>                            <span class="o">[</span> <span class="n">img</span> <span class="o">[</span> <span class="nc">Src</span> <span class="s2">&quot;assets/fulma_logo.svg&quot;</span> <span class="o">]</span> <span class="o">]</span>
</span><span class='line'>                          <span class="nn">Content</span><span class="p">.</span><span class="n">content</span> <span class="o">[</span> <span class="o">]</span>
</span><span class='line'>                            <span class="o">[</span> <span class="k">yield</span><span class="o">!</span> <span class="n">loadingMessage</span> <span class="n">model</span>
</span><span class='line'>                              <span class="k">match</span> <span class="n">model</span><span class="o">.</span><span class="nc">Character</span> <span class="k">with</span>
</span><span class='line'>                              <span class="o">|</span> <span class="nc">Some</span> <span class="n">c</span> <span class="o">-&gt;</span>
</span><span class='line'>                                  <span class="k">yield</span><span class="o">!</span> <span class="n">characterView</span> <span class="n">c</span>
</span><span class='line'>                              <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="bp">()</span>
</span><span class='line'>                              <span class="k">match</span> <span class="n">model</span><span class="o">.</span><span class="nc">ErrorMessage</span> <span class="k">with</span>
</span><span class='line'>                              <span class="o">|</span> <span class="nc">Some</span> <span class="n">m</span> <span class="o">-&gt;</span>
</span><span class='line'>                                  <span class="k">yield</span><span class="o">!</span> <span class="n">errorView</span> <span class="n">m</span>
</span><span class='line'>                              <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="bp">()</span> <span class="o">]</span> <span class="o">]</span> <span class="o">]</span> <span class="o">]</span> <span class="o">]</span> <span class="o">]</span>
</span><span class='line'>
</span><span class='line'><span class="k">open</span> <span class="nn">Elmish</span><span class="p">.</span><span class="nc">React</span>
</span><span class='line'><span class="k">open</span> <span class="nn">Elmish</span><span class="p">.</span><span class="nc">Debug</span>
</span><span class='line'><span class="k">open</span> <span class="nn">Elmish</span><span class="p">.</span><span class="nc">HMR</span>
</span><span class='line'>
</span><span class='line'><span class="nn">Program</span><span class="p">.</span><span class="n">mkProgram</span> <span class="n">init</span> <span class="n">update</span> <span class="n">view</span>
</span><span class='line'><span class="o">#</span><span class="k">if</span> <span class="nc">DEBUG</span>
</span><span class='line'><span class="o">|&gt;</span> <span class="nn">Program</span><span class="p">.</span><span class="n">withHMR</span>
</span><span class='line'><span class="o">#</span><span class="n">endif</span>
</span><span class='line'><span class="o">|&gt;</span> <span class="nn">Program</span><span class="p">.</span><span class="n">withReactUnoptimized</span> <span class="s2">&quot;elmish-app&quot;</span>
</span><span class='line'><span class="o">#</span><span class="k">if</span> <span class="nc">DEBUG</span>
</span><span class='line'><span class="o">|&gt;</span> <span class="nn">Program</span><span class="p">.</span><span class="n">withDebugger</span>
</span><span class='line'><span class="o">#</span><span class="n">endif</span>
</span><span class='line'><span class="o">|&gt;</span> <span class="nn">Program</span><span class="p">.</span><span class="n">run</span>
</span></code></pre></td></tr></table></div></figure>

<p>And there you have it - a simple app that loads &quot;Bob&quot; from our server, using the generic <code>fetchAs</code> method to cast the JSON back into our strongly typed world. Making the application interactive and more attractive is left to the user; it gets quite addictive with a nice type safe wrapper over React and auto-reloading.</p>

<p>Till next time&#8230;</p>
</div>
  
  


    </article>
  
  
    <article>
      

  <header>
    
      <h1 class="entry-title"><a href="/routemaster-and-the-tale-of-the-globally-unique-voters/">RouteMaster and the Tale of the Globally Unique Voters</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2018-03-15T21:43:38+00:00" pubdate data-updated="true">Mar 15<span>th</span>, 2018</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="https://github.com/RouteMasterIntegration/RouteMaster">RouteMaster</a> is a process manager library I&#39;ve been working on for simplifying the creation of complex work flows in message based systems.</p>

<p>One of the challenges RouteMaster faces is that once you have defined your &quot;route&quot; in RouteMaster, you generally want to run multiple instances of your process manager service in your distributed environment. This means that a lot of care has been taken to make sure that things like work flow state is handled safely, but it also causes a particular challenge for dealing with timeouts.</p>

</div>
  
  
    <footer>
      <a rel="full-article" href="/routemaster-and-the-tale-of-the-globally-unique-voters/">Read on &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      

  <header>
    
      <h1 class="entry-title"><a href="/cloud-native-net/">Cloud Native .NET</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2018-03-14T11:28:03+00:00" pubdate data-updated="true">Mar 14<span>th</span>, 2018</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>We&#39;re launching a new two day course this April (26th/27th), called &quot;Cloud Native .NET&quot;. Despite the slightly pretentious name the industry has come up with, what we&#39;re really talking about here are the core engineering skills of building code that can be scaled and maintained. This course is a practical workshop using .NET Core and Kuberenetes so we can see what it all looks like in practice.</p>

<p>Full details below!</p>

</div>
  
  
    <footer>
      <a rel="full-article" href="/cloud-native-net/">Read on &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      

  <header>
    
      <h1 class="entry-title"><a href="/getting-started-with-f-number-in-kubernetes/">Getting Started With F# in Kubernetes</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2018-02-02T14:44:21+00:00" pubdate data-updated="true">Feb 2<span>nd</span>, 2018</time>
        
      </p>
    
  </header>


  <div class="entry-content"><blockquote>
<p>Author&#39;s note: This post is a quick start to help you get a single F# based service up and running on Kubernetes. If you want the full story on how to design a distributed system, we offer <a href="https://blog.mavnn.co.uk/building-solid-systems-in-f-number/">commercial training</a> and <a href="https://mavnn.co.uk/">consulting services</a> to help you with that.</p>
</blockquote>

<p>&quot;Kubernetes is an open-source system for automating deployment, scaling, and management of containerized applications&quot; - in other words, it will handle more deployment, health monitoring and service discovery needs out of the box, as long as you can turn your application into a container. So, let&#39;s have a quick look at how to do that with an F# application.</p>

</div>
  
  
    <footer>
      <a rel="full-article" href="/getting-started-with-f-number-in-kubernetes/">Read on &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      

  <header>
    
      <h1 class="entry-title"><a href="/token-bearer-authentication-in-freya/">Token Bearer Authentication in Freya</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2018-01-10T11:03:48+00:00" pubdate data-updated="true">Jan 10<span>th</span>, 2018</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>As part of my <a href="/building-solid-systems-in-f-number/">Building Solid Systems</a> course, I&#39;ll be talking about authentication in distributed systems. I wanted a practical demonstration that people could play with, so I added token bearer authentication to a Freya API.</p>

<p>Here&#39;s how.</p>

</div>
  
  
    <footer>
      <a rel="full-article" href="/token-bearer-authentication-in-freya/">Read on &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      

  <header>
    
      <h1 class="entry-title"><a href="/logging-freya/">Logging Freya</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2017-12-08T15:43:57+00:00" pubdate data-updated="true">Dec 8<span>th</span>, 2017</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Eugene Tolmachev asked in a comment on a previous post <a href="http://disq.us/p/1oeml1a">how I handle dependency injection</a> with <a href="https://freya.io/">Freya</a>.</p>

<p>So&#8230; my first, slightly annoying answer is that I try not to. Mark Seeman has written about this in a <a href="http://blog.ploeh.dk/2017/01/27/from-dependency-injection-to-dependency-rejection/">great series of blog posts</a> which I won&#39;t try and repeat here.</p>

<p>Still, there are occasions where you want to quickly and easily do&#8230; something.. with a dependency making use of the context that being inside a Freya workflow provides. Let&#39;s quickly walk through how I inject a logger into a Freya workflow which &quot;knows&quot; about things like the request ID Kestrel has assigned to the current request.</p>

<p>I&#39;m going to use Serilog as an example below, but you could also use any other structured logging library (I like Logary, but there isn&#39;t a .NET Core release at time of writing).</p>

</div>
  
  
    <footer>
      <a rel="full-article" href="/logging-freya/">Read on &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      

  <header>
    
      <h1 class="entry-title"><a href="/f-number-through-a-ruby-lens/">F# Through a Ruby Lens</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2017-12-07T21:00:00+00:00" pubdate data-updated="true">Dec 7<span>th</span>, 2017</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I spent last week delivering a five day deep dive into F# for a group of (mostly) Ruby developers in Munich, and wanted to capture some of my thoughts before I lost them as well as give people an idea of the types of things internal training can give you.</p>

<p>I won&#39;t be mentioning personal, company or exact team names here as I&#39;ve not been given explicit permission to do so; if the people who were on the course want to chime in I&#39;ll add their comments.</p>

<h2>The background</h2>

<p>Although mostly a Ruby on Rails shop, this company also relies on machine learning and expert systems to deliver some of its core services. The R&amp;D department (who build the models) settled on F# for development as a good balance between:</p>

<ul>
<li>familiarity of syntax (most have a background in Python and/or a ML language)</li>
<li>performance (Ruby had struggled here)</li>
<li>type safety</li>
<li>good &quot;production&quot; library support (logging, etc)</li>
</ul>

<p>Having examined the available options in depth, they decided on a standard stack for creating F# microservices of:</p>

<ul>
<li>Freya on Kestrel via .NET Core</li>
<li>Chiron for type safe JSON serialization/deserialization</li>
</ul>

<p>They wanted to investigate the use of Hephaestus as a rules engine (Freya uses Hephaestus to process HTTP requests). Many of their machine learning models only work with quite constrained ranges of input values, and Hephaestus as a rules engine looked an effective way of routing decisions to the &quot;correct&quot; machine learning algorithm for a particular input range. This in turn would allow for the models to stay reasonably simple and testable.</p>

<h2>The brief</h2>

<p>Having made these decisions, the company needed to bring the production services team up to speed on what R&amp;D were going to produce, especially because production had expressed an interest in having F# as an extra potential tool for their own projects.</p>

<p>My brief was to create 5 days of training, after which production needed to know enough about the F# libraries in use that they could work out what R&amp;D&#39;s code was doing, and enough about running .NET code in production to feel confident adding error handling, logging, metrics, tests and all the rest of the &quot;engineering&quot; side of development which is not about the programming language but the surrounding ecosystem.</p>

<h2>What we did</h2>

<p>I knew that I had a lot of ground to cover in just 5 days, so there was no way that the team was going to come away with all of the new knowledge absorbed and at their finger tips. At the same time, it couldn&#39;t be an overwhelming flood of information.</p>

<p>I decided to split the training time between a deep dive in understanding a few key areas in depth (Freya&#39;s design, optics and testing), and providing worked examples for the rest which could be referred back to when they became needed. Although I had relevant training material on several of the areas already, it was all tailored in this course to fit a single theme: over the course of a week, we were going to build a microservice that did just one thing, and we were going to test the heck out of it.</p>

<p>The timetable ended up looking like this:</p>

<ul>
<li>Monday AM: Introductions

<ul>
<li>high level microservice design</li>
<li>check everyone had all the software they needed installed</li>
</ul></li>
<li>Monday PM: Freya overview

<ul>
<li>install the template</li>
<li>modify the hello world service to accept POSTs with a name</li>
</ul></li>
<li>Tuesday AM: Optics

<ul>
<li>Chiron, Freya and Hephaestus all make heavy use of &quot;Optics&quot;</li>
<li>What are they?</li>
<li>Building our own</li>
</ul></li>
<li>Tuesday PM: Handling external data

<ul>
<li>Using Chiron for translation, version handling and API design (using our new found knowledge of optics)</li>
</ul></li>
<li>Wednesday AM: Start our actual microservice as a real project

<ul>
<li>how .NET solutions are (normally) laid out</li>
<li>using Paket for package management</li>
<li>add a test project with <a href="/going-down-the-property-based-testing-rabbit-hole/">this set of property based tests</a></li>
<li>write our first bit of domain logic to pass these tests, and plug it into the Freya API</li>
</ul></li>
<li>Wednesday PM: Start making our service production worthy

<ul>
<li>Spin up a docker &quot;infrastructure&quot; with Kibana and ElasticSearch</li>
<li>Adding logging to our service, plugged into Freya to automatically capture context like request IDs</li>
<li>Health endpoint</li>
<li>How to capture metrics</li>
</ul></li>
<li>Thursday AM: interesting bits &amp; answers to questions asked

<ul>
<li>How do computational expressions work?</li>
<li>How would I structure a functional UI?</li>
</ul></li>
<li>Thursday PM: flexible rules engines with Hephaestus

<ul>
<li>rebuilt the logic from Wednesday AM reusing the same property tests</li>
<li>looked at how we can splice Hephaestus rules graphs together</li>
</ul></li>
<li>Friday AM: BenchmarkDotNet

<ul>
<li>now we know it&#39;s correct - is it fast?</li>
<li>benchmarked our two implementations of the same logic together</li>
</ul></li>
<li>Friday PM: Using it all in real life

<ul>
<li>code review of pieces of the existing code base, looking at adding what we&#39;d learned</li>
</ul></li>
</ul>

<h2>How it went</h2>

<p>Overall the course seemed to go really well. At the end of it, the delegates were confident about the basics of building HTTP resources with Freya and Chiron, and happily building benchmarks and tests for their existing code base. For other areas (the boiler plate for plugging logging into Kestrel and Freya, for example) they understood the concepts and felt the course notes were sufficiently detailed they that could make use of them in other situations as needed. That was incredibly pleasing to hear from my point of view, as the course notes for these sessions are by far the most time consuming part of the process to create.</p>

<p>Although they missed some of the features of Ruby when writing F#, pattern matching with discriminated unions was a big hit and they liked the enforced discipline of Freya that required separating the logic of the various stages of handling an HTTP request - and how reusable that made components for handling concerns such as authentication.</p>

<p>Finally, all 3 of the core participants (there were other people around for certain parts of the course) came away saying that they&#39;d really enjoyed it and found it interesting throughout - so that&#39;s a big win right there!</p>

<h2>Can you do this for us?</h2>

<p>Yes; this particular course was tailored for the specific circumstances, but I&#39;ve also provided training on the more conceptual side (functional programming concepts) through to the gritty detail of DevOps (with both new and existing code bases).</p>

<p>We can also tailor delivery to match your availability; for this course I traveled to Munich to deliver it, and so it was delivered in a single 5 day unit. For other clients we can arrange regular shorter sessions or even remote workshops (group or individual) with tools such as Zoom.</p>

<p>And if you just want to turn up at a venue and get trained, check out <a href="/building-solid-systems-in-f-number/">Building Solid Systems in F#</a> happening 31st Jan-1st Feb 2018 in London.</p>

<p>Get in touch with us at <a href="us@mavnn.co.uk">us@mavnn.co.uk</a> if you have any ideas.</p>
</div>
  
  


    </article>
  
  
    <article>
      

  <header>
    
      <h1 class="entry-title"><a href="/advent-2017-reading-from-the-firehose-with-fable/">Advent 2017 - Reading From the Firehose With Fable</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2017-12-04T13:00:00+00:00" pubdate data-updated="true">Dec 4<span>th</span>, 2017</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Each year, the F# programming community creates an advent calendar of blog posts, coordinated by Sergey Tihon <a href="https://sergeytihon.com/2017/10/22/f-advent-calendar-in-english-2017/">his blog</a>.</p>

<p>I really like the idea, and have taken part in <a href="https://blog.mavnn.co.uk/advent-2016/">2016</a>, <a href="https://blog.mavnn.co.uk/angels-from-the-realms-of-glory/">2015</a> &amp; <a href="https://blog.mavnn.co.uk/modelling-inheritance-with-inheritance/">2014</a>.</p>

<p>Below is this year&#39;s post.</p>

<h1>The plan: speed read Christmas</h1>

<p>So; you want to find out what Christmas is about, where it really came from&#8230; but you don&#39;t have much time.</p>

<p>The solution is obvious: take the famous bible passages that churches read every year, and speed read them!</p>

<p>Let&#39;s build an app to help us with that.</p>

</div>
  
  
    <footer>
      <a rel="full-article" href="/advent-2017-reading-from-the-firehose-with-fable/">Read on &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      

  <header>
    
      <h1 class="entry-title"><a href="/going-down-the-property-based-testing-rabbit-hole/">Going Down the Property Based Testing Rabbit Hole</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2017-11-10T15:28:47+00:00" pubdate data-updated="true">Nov 10<span>th</span>, 2017</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Imagine, if you will, a card game.</p>

<p>(Don&#39;t worry, there&#39;s code later. Lots of code.)</p>

<p>It&#39;s not a complex card game; it&#39;s a quick and fun game designed to represent over the top martial arts combat in the style of Hong Kong cinema or a beat &#39;em up game.</p>

<p>Each player has a deck of cards which represent their martial art; different arts are differently weighted in their card distribution. These cards come in four main types:</p>

<h3>1 Normal cards</h3>

<p>A &quot;normal&quot; card comes in one of four suits:</p>

<ul>
<li>Punch</li>
<li>Kick</li>
<li>Throw</li>
<li>Defend</li>
</ul>

<p>They also carry a numerical value between 1 and 10, which represents both how &quot;fast&quot; they are and (except for defend cards) how much damage they do. A Defend card can never determine damage.</p>

<h3>2 Special Attack cards</h3>

<p>The fireballs, whirling hurricane kicks and mighty mega throws of the game. A special attack card lists two suits: one to use for the speed of the final attack, and one for the damage. This allows you to play 3 cards together to create an attack which is fast yet damaging.</p>

<h3>3 Combo Attack cards</h3>

<p>A flurry of blows! Combo cards also list two suits: one for speed, and one for the &quot;follow up&quot; flurry. This allows you to play 3 cards together, one of which determines the speed of the attack while the other adds to the total damage. For example, if you play a Punch/Kick Combo with a Punch 3 and a Kick 7 you end up with a speed 3, damage 10 attack.</p>

<h3>4 Knockdown cards</h3>

<p>You can combine a knockdown card with any other valid play to create an action that will &quot;knockdown&quot; your opponent.</p>

<h2>The code</h2>

<p>(This is an <em>example</em> of property based testing; if you need an <em>introduction</em> first, check out <a href="/fscheck-breaking-your-code-in-new-and-exciting-ways/">Breaking Your Code in New and Exciting Ways</a> or the <a href="/sdd-conf-2015/">the video version</a>)</p>

<p>There are of course other rules to the game; but let&#39;s assume for a moment we&#39;re coding this game up in F#. We&#39;ve defined a nice domain model:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">module</span> <span class="nn">BlackBelt</span><span class="p">.</span><span class="nn">Domain</span><span class="p">.</span><span class="nc">Types</span>
</span><span class='line'>
</span><span class='line'><span class="k">open</span> <span class="nc">System</span>
</span><span class='line'>
</span><span class='line'><span class="k">type</span> <span class="nc">Suit</span> <span class="o">=</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">Punch</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">Kick</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">Throw</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">Defend</span>
</span><span class='line'>
</span><span class='line'><span class="k">type</span> <span class="nc">NormalCard</span> <span class="o">=</span>
</span><span class='line'>    <span class="o">{</span> <span class="nc">Suit</span> <span class="o">:</span> <span class="nc">Suit</span>
</span><span class='line'>      <span class="nc">Value</span> <span class="o">:</span> <span class="kt">int</span> <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">type</span> <span class="nc">ComboCard</span> <span class="o">=</span>
</span><span class='line'>    <span class="o">{</span> <span class="nc">SpeedSuit</span> <span class="o">:</span> <span class="nc">Suit</span>
</span><span class='line'>      <span class="nc">FollowUpSuit</span> <span class="o">:</span> <span class="nc">Suit</span> <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">type</span> <span class="nc">SpecialAttackCard</span> <span class="o">=</span>
</span><span class='line'>    <span class="o">{</span> <span class="nc">SpeedSuit</span> <span class="o">:</span> <span class="nc">Suit</span>
</span><span class='line'>      <span class="nc">DamageSuit</span> <span class="o">:</span> <span class="nc">Suit</span> <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">type</span> <span class="nc">Card</span> <span class="o">=</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">Normal</span> <span class="k">of</span> <span class="nc">NormalCard</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">Combo</span> <span class="k">of</span> <span class="nc">ComboCard</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">Special</span> <span class="k">of</span> <span class="nc">SpecialAttackCard</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">Knockdown</span>
</span><span class='line'>
</span><span class='line'><span class="k">type</span> <span class="nc">Action</span> <span class="o">=</span>
</span><span class='line'>    <span class="o">{</span> <span class="nc">Speed</span> <span class="o">:</span> <span class="kt">int</span>
</span><span class='line'>      <span class="nc">Damage</span> <span class="o">:</span> <span class="kt">int</span>
</span><span class='line'>      <span class="nc">Suit</span> <span class="o">:</span> <span class="nc">Suit</span>
</span><span class='line'>      <span class="nc">Knockdown</span> <span class="o">:</span> <span class="kt">bool</span> <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">type</span> <span class="nc">PlayerId</span> <span class="o">=</span> <span class="nc">PlayerId</span> <span class="k">of</span> <span class="kt">string</span>
</span><span class='line'>
</span><span class='line'><span class="k">type</span> <span class="nc">Player</span> <span class="o">=</span>
</span><span class='line'>    <span class="o">{</span> <span class="nc">Name</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class='line'>      <span class="nc">Id</span> <span class="o">:</span> <span class="nc">PlayerId</span>
</span><span class='line'>      <span class="nc">Deck</span> <span class="o">:</span> <span class="nc">Card</span> <span class="kt">list</span>
</span><span class='line'>      <span class="nc">Stance</span> <span class="o">:</span> <span class="nc">Card</span> <span class="kt">list</span>
</span><span class='line'>      <span class="nc">Health</span> <span class="o">:</span> <span class="kt">int</span> <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">type</span> <span class="nc">WaitingFor</span> <span class="o">=</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">Attack</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">Counter</span> <span class="k">of</span> <span class="nc">PlayerId</span> <span class="o">*</span> <span class="nc">Action</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">StanceCard</span>
</span><span class='line'>
</span><span class='line'><span class="k">type</span> <span class="nc">Game</span> <span class="o">=</span>
</span><span class='line'>    <span class="o">{</span> <span class="nc">GameId</span> <span class="o">:</span> <span class="nc">Guid</span>
</span><span class='line'>      <span class="nc">Player1</span> <span class="o">:</span> <span class="nc">Player</span>
</span><span class='line'>      <span class="nc">Player2</span> <span class="o">:</span> <span class="nc">Player</span>
</span><span class='line'>      <span class="nc">TurnOf</span> <span class="o">:</span> <span class="nc">PlayerId</span>
</span><span class='line'>      <span class="nc">WaitingFor</span> <span class="o">:</span> <span class="nc">WaitingFor</span> <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>And now we want to write a function that takes the rules for playing cards above, and turns a <code>Card list</code> into an <code>Action option</code> (telling you if the list is a valid play, and what action will result if it is).</p>

<p>This function is pretty critical to the overall game play, and may well also be used for validating input in the UI so getting it right will make a big difference to the experience of playing the game.</p>

<p>So we&#39;re going to property test our implementation in every which way we can think of&#8230;</p>

<p>First step: make yourself a placeholder version of the function to reference in your tests:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">module</span> <span class="nn">BlackBelt</span><span class="p">.</span><span class="nn">Domain</span><span class="p">.</span><span class="nc">Logic</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">toAction</span> <span class="n">cards</span> <span class="o">=</span> <span class="nc">None</span>
</span></code></pre></td></tr></table></div></figure>

<p>Now, let&#39;s start adding properties. All of the rest goes in a single file, but I&#39;m going to split it up with some commentary as we go.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">module</span> <span class="nn">BlackBelt</span><span class="p">.</span><span class="nn">Tests</span><span class="p">.</span><span class="nc">Logic</span>
</span><span class='line'>
</span><span class='line'><span class="k">open</span> <span class="nc">Expecto</span>
</span><span class='line'><span class="k">open</span> <span class="nn">Expecto</span><span class="p">.</span><span class="nc">ExpectoFsCheck</span>
</span><span class='line'><span class="k">open</span> <span class="nc">FsCheck</span>
</span><span class='line'><span class="k">open</span> <span class="nn">BlackBelt</span><span class="p">.</span><span class="nn">Domain</span><span class="p">.</span><span class="nc">Logic</span>
</span><span class='line'><span class="k">open</span> <span class="nn">BlackBelt</span><span class="p">.</span><span class="nn">Domain</span><span class="p">.</span><span class="nc">Types</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">allSuitsBut</span> <span class="n">suit</span> <span class="o">=</span>
</span><span class='line'>    <span class="o">[</span><span class="nc">Punch</span><span class="o">;</span><span class="nc">Kick</span><span class="o">;</span><span class="nc">Throw</span><span class="o">;</span><span class="nc">Defend</span><span class="o">]</span>
</span><span class='line'>    <span class="o">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">filter</span> <span class="o">((&lt;&gt;)</span> <span class="n">suit</span><span class="o">)</span>
</span><span class='line'>    <span class="o">|&gt;</span> <span class="nn">Gen</span><span class="p">.</span><span class="n">elements</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// We need a custom generator here as only some</span>
</span><span class='line'><span class="c1">// values are valid</span>
</span><span class='line'><span class="k">type</span> <span class="nc">DomainArbs</span><span class="bp">()</span> <span class="o">=</span>
</span><span class='line'>    <span class="k">static</span> <span class="k">member</span> <span class="nc">NormalCard</span><span class="bp">()</span> <span class="o">:</span> <span class="nc">Arbitrary</span><span class="o">&lt;</span><span class="nc">NormalCard</span><span class="o">&gt;</span> <span class="o">=</span>
</span><span class='line'>        <span class="n">gen</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">let</span><span class="o">!</span> <span class="n">suit</span> <span class="o">=</span> <span class="nn">Arb</span><span class="p">.</span><span class="n">generate</span><span class="o">&lt;</span><span class="nc">Suit</span><span class="o">&gt;</span>
</span><span class='line'>            <span class="k">let</span><span class="o">!</span> <span class="n">value</span> <span class="o">=</span> <span class="nn">Gen</span><span class="p">.</span><span class="n">choose</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">10</span><span class="o">)</span>
</span><span class='line'>            <span class="k">return</span>
</span><span class='line'>                <span class="o">{</span> <span class="nc">Suit</span> <span class="o">=</span> <span class="n">suit</span>
</span><span class='line'>                  <span class="nc">Value</span> <span class="o">=</span> <span class="n">value</span> <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span> <span class="o">|&gt;</span> <span class="nn">Arb</span><span class="p">.</span><span class="n">fromGen</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">static</span> <span class="k">member</span> <span class="nc">SpecialAttackCard</span><span class="bp">()</span> <span class="o">:</span> <span class="nc">Arbitrary</span><span class="o">&lt;</span><span class="nc">SpecialAttackCard</span><span class="o">&gt;</span> <span class="o">=</span>
</span><span class='line'>        <span class="n">gen</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">let</span><span class="o">!</span> <span class="n">damageSuit</span> <span class="o">=</span> <span class="n">allSuitsBut</span> <span class="nc">Defend</span>
</span><span class='line'>            <span class="k">let</span><span class="o">!</span> <span class="n">speedSuit</span> <span class="o">=</span> <span class="nn">Arb</span><span class="p">.</span><span class="n">generate</span><span class="o">&lt;</span><span class="nc">Suit</span><span class="o">&gt;</span>
</span><span class='line'>            <span class="k">return</span>
</span><span class='line'>                <span class="o">{</span> <span class="nc">SpeedSuit</span> <span class="o">=</span> <span class="n">speedSuit</span>
</span><span class='line'>                  <span class="nc">DamageSuit</span> <span class="o">=</span> <span class="n">damageSuit</span> <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span> <span class="o">|&gt;</span> <span class="nn">Arb</span><span class="p">.</span><span class="n">fromGen</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">static</span> <span class="k">member</span> <span class="nc">ComboCard</span><span class="bp">()</span> <span class="o">:</span> <span class="nc">Arbitrary</span><span class="o">&lt;</span><span class="nc">ComboCard</span><span class="o">&gt;</span> <span class="o">=</span>
</span><span class='line'>        <span class="n">gen</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">let</span><span class="o">!</span> <span class="n">speedSuit</span> <span class="o">=</span> <span class="n">allSuitsBut</span> <span class="nc">Defend</span>
</span><span class='line'>            <span class="k">let</span><span class="o">!</span> <span class="n">followupSuit</span> <span class="o">=</span> <span class="n">allSuitsBut</span> <span class="nc">Defend</span>
</span><span class='line'>            <span class="k">return</span>
</span><span class='line'>                <span class="o">{</span> <span class="nc">SpeedSuit</span> <span class="o">=</span> <span class="n">speedSuit</span>
</span><span class='line'>                  <span class="nc">FollowUpSuit</span> <span class="o">=</span> <span class="n">followupSuit</span> <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span> <span class="o">|&gt;</span> <span class="nn">Arb</span><span class="p">.</span><span class="n">fromGen</span>
</span></code></pre></td></tr></table></div></figure>

<p>We&#39;ll start off with a few general purpose bits for generating random types in our domain. I haven&#39;t gone the whole hog in making illegal states unrepresentable here, so we need to constrain a few things (like the fact that cards only have values from 1 to 10, and that you can&#39;t combo into a defend card for extra damage).</p>

<p>Now: let&#39;s start generating potential plays of cards. Our properties will be interested in whether a particular play is valid or invalid, and we will want to know what the resulting <code>Action</code> should be for valid plays.</p>

<p>So we define a union to create instances of:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">type</span> <span class="nc">GeneratedAction</span> <span class="o">=</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">ValidAction</span> <span class="k">of</span> <span class="nc">Card</span> <span class="kt">list</span> <span class="o">*</span> <span class="nc">Action</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">InvalidAction</span> <span class="k">of</span> <span class="nc">Card</span> <span class="kt">list</span>
</span></code></pre></td></tr></table></div></figure>

<p>Now let&#39;s add all of the valid actions we can think of.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">let</span> <span class="n">makeNormalAction</span> <span class="o">=</span>
</span><span class='line'>    <span class="n">gen</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">let</span><span class="o">!</span> <span class="n">normal</span> <span class="o">=</span> <span class="nn">Arb</span><span class="p">.</span><span class="n">generate</span><span class="o">&lt;</span><span class="nc">NormalCard</span><span class="o">&gt;</span>
</span><span class='line'>        <span class="k">let</span> <span class="n">cards</span> <span class="o">=</span> <span class="o">[</span><span class="nc">Normal</span> <span class="n">normal</span><span class="o">]</span>
</span><span class='line'>        <span class="k">let</span> <span class="n">action</span> <span class="o">=</span>
</span><span class='line'>            <span class="o">{</span> <span class="nc">Speed</span> <span class="o">=</span> <span class="n">normal</span><span class="o">.</span><span class="nc">Value</span>
</span><span class='line'>              <span class="nc">Damage</span> <span class="o">=</span>
</span><span class='line'>                  <span class="k">if</span> <span class="n">normal</span><span class="o">.</span><span class="nc">Suit</span> <span class="o">=</span> <span class="nc">Defend</span> <span class="k">then</span>
</span><span class='line'>                      <span class="mi">0</span>
</span><span class='line'>                  <span class="k">else</span>
</span><span class='line'>                      <span class="n">normal</span><span class="o">.</span><span class="nc">Value</span>
</span><span class='line'>              <span class="nc">Suit</span> <span class="o">=</span> <span class="n">normal</span><span class="o">.</span><span class="nc">Suit</span>
</span><span class='line'>              <span class="nc">Knockdown</span> <span class="o">=</span> <span class="bp">false</span> <span class="o">}</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">cards</span><span class="o">,</span> <span class="n">action</span>
</span><span class='line'>    <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>So; a normal card on it&#39;s own is always a valid play, the only thing we need to watch out for is that a Defend card causes no damage.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">let</span> <span class="n">makeComboAttack</span> <span class="o">=</span>
</span><span class='line'>    <span class="n">gen</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">let</span><span class="o">!</span> <span class="n">comboCard</span> <span class="o">=</span> <span class="nn">Arb</span><span class="p">.</span><span class="n">generate</span><span class="o">&lt;</span><span class="nc">ComboCard</span><span class="o">&gt;</span>
</span><span class='line'>        <span class="k">let</span><span class="o">!</span> <span class="n">normal1</span> <span class="o">=</span> <span class="nn">Arb</span><span class="p">.</span><span class="n">generate</span><span class="o">&lt;</span><span class="nc">NormalCard</span><span class="o">&gt;</span>
</span><span class='line'>        <span class="k">let</span><span class="o">!</span> <span class="n">normal2</span> <span class="o">=</span> <span class="nn">Arb</span><span class="p">.</span><span class="n">generate</span><span class="o">&lt;</span><span class="nc">NormalCard</span><span class="o">&gt;</span>
</span><span class='line'>        <span class="k">let</span> <span class="n">cards</span> <span class="o">=</span>
</span><span class='line'>            <span class="o">[</span> <span class="nc">Normal</span> <span class="o">{</span> <span class="n">normal1</span> <span class="k">with</span> <span class="nc">Suit</span> <span class="o">=</span> <span class="n">comboCard</span><span class="o">.</span><span class="nc">SpeedSuit</span> <span class="o">}</span>
</span><span class='line'>              <span class="nc">Normal</span> <span class="o">{</span> <span class="n">normal2</span> <span class="k">with</span> <span class="nc">Suit</span> <span class="o">=</span> <span class="n">comboCard</span><span class="o">.</span><span class="nc">FollowUpSuit</span> <span class="o">}</span>
</span><span class='line'>              <span class="nc">Combo</span> <span class="n">comboCard</span> <span class="o">]</span>
</span><span class='line'>        <span class="k">let</span> <span class="n">attack</span> <span class="o">=</span>
</span><span class='line'>            <span class="o">{</span> <span class="nc">Speed</span> <span class="o">=</span>
</span><span class='line'>                  <span class="k">if</span> <span class="n">comboCard</span><span class="o">.</span><span class="nc">SpeedSuit</span> <span class="o">=</span> <span class="n">comboCard</span><span class="o">.</span><span class="nc">FollowUpSuit</span> <span class="k">then</span>
</span><span class='line'>                      <span class="n">min</span> <span class="n">normal1</span><span class="o">.</span><span class="nc">Value</span> <span class="n">normal2</span><span class="o">.</span><span class="nc">Value</span>
</span><span class='line'>                  <span class="k">else</span>
</span><span class='line'>                      <span class="n">normal1</span><span class="o">.</span><span class="nc">Value</span>
</span><span class='line'>              <span class="nc">Damage</span> <span class="o">=</span> <span class="n">normal1</span><span class="o">.</span><span class="nc">Value</span> <span class="o">+</span> <span class="n">normal2</span><span class="o">.</span><span class="nc">Value</span>
</span><span class='line'>              <span class="nc">Suit</span> <span class="o">=</span> <span class="n">comboCard</span><span class="o">.</span><span class="nc">SpeedSuit</span>
</span><span class='line'>              <span class="nc">Knockdown</span> <span class="o">=</span> <span class="bp">false</span> <span class="o">}</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">cards</span><span class="o">,</span> <span class="n">attack</span>
</span><span class='line'>    <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>Here we&#39;ll generate the combo card and two other cards, and then we&#39;ll override the suit of the two normal cards to ensure they&#39;re legal to be played with the combo card.</p>

<p>There&#39;s a quirk here (which in reality I noticed after trying to run these tests). If the two suits are the same, the fast card should determine the speed regardless of &quot;order&quot;.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">let</span> <span class="n">makeSpecialAttack</span> <span class="o">=</span>
</span><span class='line'>    <span class="n">gen</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">let</span><span class="o">!</span> <span class="n">specialCard</span> <span class="o">=</span> <span class="nn">Arb</span><span class="p">.</span><span class="n">generate</span><span class="o">&lt;</span><span class="nc">SpecialAttackCard</span><span class="o">&gt;</span>
</span><span class='line'>        <span class="k">let</span><span class="o">!</span> <span class="n">damageValue</span> <span class="o">=</span> <span class="nn">Gen</span><span class="p">.</span><span class="n">choose</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="mi">10</span><span class="o">)</span>
</span><span class='line'>        <span class="k">let</span><span class="o">!</span> <span class="n">speedValue</span> <span class="o">=</span> <span class="nn">Gen</span><span class="p">.</span><span class="n">choose</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">damageValue</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span>
</span><span class='line'>        <span class="k">let</span> <span class="n">cards</span> <span class="o">=</span>
</span><span class='line'>            <span class="o">[</span> <span class="nc">Normal</span> <span class="o">{</span> <span class="nc">Suit</span> <span class="o">=</span> <span class="n">specialCard</span><span class="o">.</span><span class="nc">SpeedSuit</span><span class="o">;</span> <span class="nc">Value</span> <span class="o">=</span> <span class="n">speedValue</span> <span class="o">}</span>
</span><span class='line'>              <span class="nc">Normal</span> <span class="o">{</span> <span class="nc">Suit</span> <span class="o">=</span> <span class="n">specialCard</span><span class="o">.</span><span class="nc">DamageSuit</span><span class="o">;</span> <span class="nc">Value</span> <span class="o">=</span> <span class="n">damageValue</span> <span class="o">}</span>
</span><span class='line'>              <span class="nc">Special</span> <span class="n">specialCard</span> <span class="o">]</span>
</span><span class='line'>        <span class="k">let</span> <span class="n">attack</span> <span class="o">=</span>
</span><span class='line'>            <span class="o">{</span> <span class="nc">Speed</span> <span class="o">=</span> <span class="n">speedValue</span>
</span><span class='line'>              <span class="nc">Damage</span> <span class="o">=</span> <span class="n">damageValue</span>
</span><span class='line'>              <span class="nc">Suit</span> <span class="o">=</span> <span class="n">specialCard</span><span class="o">.</span><span class="nc">SpeedSuit</span>
</span><span class='line'>              <span class="nc">Knockdown</span> <span class="o">=</span> <span class="bp">false</span> <span class="o">}</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">cards</span><span class="o">,</span> <span class="n">attack</span>
</span><span class='line'>    <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>Special attack cards have an additional constraint: playing a high value speed card with a low value damage card would actually <em>disadvantage</em> the player, and so is not considered a valid play.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">let</span> <span class="n">makeKnockdownAttack</span> <span class="o">=</span>
</span><span class='line'>    <span class="n">gen</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">let</span><span class="o">!</span> <span class="n">cards</span><span class="o">,</span> <span class="n">baseAttack</span> <span class="o">=</span>
</span><span class='line'>            <span class="nn">Gen</span><span class="p">.</span><span class="n">oneof</span> <span class="o">[</span> <span class="n">makeNormalAction</span>
</span><span class='line'>                        <span class="n">makeComboAttack</span>
</span><span class='line'>                        <span class="n">makeSpecialAttack</span> <span class="o">]</span>
</span><span class='line'>        <span class="k">let</span> <span class="n">cards</span> <span class="o">=</span> <span class="nc">Knockdown</span><span class="o">::</span><span class="n">cards</span>
</span><span class='line'>        <span class="k">let</span> <span class="n">attack</span> <span class="o">=</span> <span class="o">{</span> <span class="n">baseAttack</span> <span class="k">with</span> <span class="nc">Knockdown</span> <span class="o">=</span> <span class="bp">true</span> <span class="o">}</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">cards</span><span class="o">,</span> <span class="n">attack</span>
</span><span class='line'>    <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>Here we make use of the generators we&#39;ve constructed above to create a Knockdown action.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">let</span> <span class="n">makeValidAction</span> <span class="o">=</span>
</span><span class='line'>    <span class="n">gen</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">let</span><span class="o">!</span> <span class="n">validAction</span> <span class="o">=</span>
</span><span class='line'>            <span class="nn">Gen</span><span class="p">.</span><span class="n">oneof</span> <span class="o">[</span> <span class="n">makeNormalAction</span>
</span><span class='line'>                        <span class="n">makeComboAttack</span>
</span><span class='line'>                        <span class="n">makeSpecialAttack</span>
</span><span class='line'>                        <span class="n">makeKnockdownAttack</span> <span class="o">]</span>
</span><span class='line'>        <span class="k">return</span> <span class="nc">ValidAction</span> <span class="n">validAction</span>
</span><span class='line'>    <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>Which allows us to write a <code>ValidAction</code> generator.</p>

<p>Now, more interesting is trying to generate plays which are not valid. We&#39;re not trusting the UI to do any validation here, so let&#39;s just come up with everything we can think of&#8230;</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">let</span> <span class="n">multipleNormal</span> <span class="o">=</span>
</span><span class='line'>    <span class="n">gen</span> <span class="o">{</span>
</span><span class='line'>       <span class="k">let</span><span class="o">!</span> <span class="n">first</span> <span class="o">=</span> <span class="nn">Arb</span><span class="p">.</span><span class="n">generate</span><span class="o">&lt;</span><span class="nc">NormalCard</span><span class="o">&gt;</span>
</span><span class='line'>       <span class="k">let</span><span class="o">!</span> <span class="n">normals</span> <span class="o">=</span> <span class="nn">Gen</span><span class="p">.</span><span class="n">nonEmptyListOf</span> <span class="nn">Arb</span><span class="p">.</span><span class="n">generate</span><span class="o">&lt;</span><span class="nc">NormalCard</span><span class="o">&gt;</span>
</span><span class='line'>       <span class="k">return</span> <span class="n">first</span><span class="o">::</span><span class="n">normals</span> <span class="o">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="nc">Normal</span>
</span><span class='line'>    <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>More than one normal card with out another card to combine them is out.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">let</span> <span class="n">incompleteComboOrSpecial</span> <span class="o">=</span>
</span><span class='line'>    <span class="n">gen</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">let</span><span class="o">!</span> <span class="n">special</span> <span class="o">=</span>
</span><span class='line'>            <span class="nn">Gen</span><span class="p">.</span><span class="n">oneof</span> <span class="o">[</span> <span class="nn">Gen</span><span class="p">.</span><span class="n">map</span> <span class="nc">Combo</span> <span class="nn">Arb</span><span class="p">.</span><span class="n">generate</span><span class="o">&lt;</span><span class="nc">ComboCard</span><span class="o">&gt;</span>
</span><span class='line'>                        <span class="nn">Gen</span><span class="p">.</span><span class="n">map</span> <span class="nc">Special</span> <span class="nn">Arb</span><span class="p">.</span><span class="n">generate</span><span class="o">&lt;</span><span class="nc">SpecialAttackCard</span><span class="o">&gt;</span> <span class="o">]</span>
</span><span class='line'>        <span class="k">let</span><span class="o">!</span> <span class="n">other</span> <span class="o">=</span> <span class="nn">Arb</span><span class="p">.</span><span class="n">generate</span><span class="o">&lt;</span><span class="nc">Card</span><span class="o">&gt;</span>
</span><span class='line'>        <span class="k">return</span> <span class="o">[</span><span class="n">special</span><span class="o">;</span> <span class="n">other</span><span class="o">]</span>
</span><span class='line'>    <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>A combo or special card always requires precisely two normal cards to be a valid play; so here, we only generate one.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">let</span> <span class="n">onlyKnockdown</span> <span class="o">=</span>
</span><span class='line'>    <span class="nn">Gen</span><span class="p">.</span><span class="n">constant</span> <span class="o">[</span><span class="nc">Knockdown</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>

<p>A combo card can only be played as part of an otherwise valid play, and isn&#39;t allowed on it&#39;s own.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">let</span> <span class="n">unmatchedSpeedCombo</span> <span class="o">=</span>
</span><span class='line'>    <span class="n">gen</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">let</span><span class="o">!</span> <span class="n">combo</span> <span class="o">=</span> <span class="nn">Arb</span><span class="p">.</span><span class="n">generate</span><span class="o">&lt;</span><span class="nc">ComboCard</span><span class="o">&gt;</span>
</span><span class='line'>        <span class="k">let</span><span class="o">!</span> <span class="n">normal1</span> <span class="o">=</span> <span class="nn">Arb</span><span class="p">.</span><span class="n">generate</span><span class="o">&lt;</span><span class="nc">NormalCard</span><span class="o">&gt;</span>
</span><span class='line'>        <span class="k">let</span><span class="o">!</span> <span class="n">normal2</span> <span class="o">=</span> <span class="nn">Arb</span><span class="p">.</span><span class="n">generate</span><span class="o">&lt;</span><span class="nc">NormalCard</span><span class="o">&gt;</span>
</span><span class='line'>        <span class="k">let</span><span class="o">!</span> <span class="n">unmatched1</span> <span class="o">=</span> <span class="n">allSuitsBut</span> <span class="n">combo</span><span class="o">.</span><span class="nc">SpeedSuit</span>
</span><span class='line'>        <span class="k">let</span><span class="o">!</span> <span class="n">unmatched2</span> <span class="o">=</span> <span class="n">allSuitsBut</span> <span class="n">combo</span><span class="o">.</span><span class="nc">SpeedSuit</span>
</span><span class='line'>        <span class="k">let</span> <span class="n">n1</span> <span class="o">=</span> <span class="o">{</span> <span class="n">normal1</span> <span class="k">with</span> <span class="nc">Suit</span> <span class="o">=</span> <span class="n">unmatched1</span> <span class="o">}</span>
</span><span class='line'>        <span class="k">let</span> <span class="n">n2</span> <span class="o">=</span> <span class="o">{</span> <span class="n">normal2</span> <span class="k">with</span> <span class="nc">Suit</span> <span class="o">=</span> <span class="n">unmatched2</span> <span class="o">}</span>
</span><span class='line'>        <span class="k">return</span> <span class="o">[</span><span class="nc">Combo</span> <span class="n">combo</span><span class="o">;</span> <span class="nc">Normal</span> <span class="n">n1</span><span class="o">;</span> <span class="nc">Normal</span> <span class="n">n2</span><span class="o">]</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">unmatchedSpeedSpecial</span> <span class="o">=</span>
</span><span class='line'>    <span class="n">gen</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">let</span><span class="o">!</span> <span class="n">special</span> <span class="o">=</span> <span class="nn">Arb</span><span class="p">.</span><span class="n">generate</span><span class="o">&lt;</span><span class="nc">SpecialAttackCard</span><span class="o">&gt;</span>
</span><span class='line'>        <span class="k">let</span><span class="o">!</span> <span class="n">normal1</span> <span class="o">=</span> <span class="nn">Arb</span><span class="p">.</span><span class="n">generate</span><span class="o">&lt;</span><span class="nc">NormalCard</span><span class="o">&gt;</span>
</span><span class='line'>        <span class="k">let</span><span class="o">!</span> <span class="n">normal2</span> <span class="o">=</span> <span class="nn">Arb</span><span class="p">.</span><span class="n">generate</span><span class="o">&lt;</span><span class="nc">NormalCard</span><span class="o">&gt;</span>
</span><span class='line'>        <span class="k">let</span><span class="o">!</span> <span class="n">unmatched1</span> <span class="o">=</span> <span class="n">allSuitsBut</span> <span class="n">special</span><span class="o">.</span><span class="nc">SpeedSuit</span>
</span><span class='line'>        <span class="k">let</span><span class="o">!</span> <span class="n">unmatched2</span> <span class="o">=</span> <span class="n">allSuitsBut</span> <span class="n">special</span><span class="o">.</span><span class="nc">SpeedSuit</span>
</span><span class='line'>        <span class="k">let</span> <span class="n">n1</span> <span class="o">=</span> <span class="o">{</span> <span class="n">normal1</span> <span class="k">with</span> <span class="nc">Suit</span> <span class="o">=</span> <span class="n">unmatched1</span> <span class="o">}</span>
</span><span class='line'>        <span class="k">let</span> <span class="n">n2</span> <span class="o">=</span> <span class="o">{</span> <span class="n">normal2</span> <span class="k">with</span> <span class="nc">Suit</span> <span class="o">=</span> <span class="n">unmatched2</span> <span class="o">}</span>
</span><span class='line'>        <span class="k">return</span> <span class="o">[</span><span class="nc">Special</span> <span class="n">special</span><span class="o">;</span> <span class="nc">Normal</span> <span class="n">n1</span><span class="o">;</span> <span class="nc">Normal</span> <span class="n">n2</span><span class="o">]</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">unmatchedDamageCombo</span> <span class="o">=</span>
</span><span class='line'>    <span class="n">gen</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">let</span><span class="o">!</span> <span class="n">combo</span> <span class="o">=</span> <span class="nn">Arb</span><span class="p">.</span><span class="n">generate</span><span class="o">&lt;</span><span class="nc">ComboCard</span><span class="o">&gt;</span>
</span><span class='line'>        <span class="k">let</span><span class="o">!</span> <span class="n">normal1</span> <span class="o">=</span> <span class="nn">Arb</span><span class="p">.</span><span class="n">generate</span><span class="o">&lt;</span><span class="nc">NormalCard</span><span class="o">&gt;</span>
</span><span class='line'>        <span class="k">let</span><span class="o">!</span> <span class="n">normal2</span> <span class="o">=</span> <span class="nn">Arb</span><span class="p">.</span><span class="n">generate</span><span class="o">&lt;</span><span class="nc">NormalCard</span><span class="o">&gt;</span>
</span><span class='line'>        <span class="k">let</span><span class="o">!</span> <span class="n">unmatched1</span> <span class="o">=</span> <span class="n">allSuitsBut</span> <span class="n">combo</span><span class="o">.</span><span class="nc">FollowUpSuit</span>
</span><span class='line'>        <span class="k">let</span><span class="o">!</span> <span class="n">unmatched2</span> <span class="o">=</span> <span class="n">allSuitsBut</span> <span class="n">combo</span><span class="o">.</span><span class="nc">FollowUpSuit</span>
</span><span class='line'>        <span class="k">let</span> <span class="n">n1</span> <span class="o">=</span> <span class="o">{</span> <span class="n">normal1</span> <span class="k">with</span> <span class="nc">Suit</span> <span class="o">=</span> <span class="n">unmatched1</span> <span class="o">}</span>
</span><span class='line'>        <span class="k">let</span> <span class="n">n2</span> <span class="o">=</span> <span class="o">{</span> <span class="n">normal2</span> <span class="k">with</span> <span class="nc">Suit</span> <span class="o">=</span> <span class="n">unmatched2</span> <span class="o">}</span>
</span><span class='line'>        <span class="k">return</span> <span class="o">[</span><span class="nc">Combo</span> <span class="n">combo</span><span class="o">;</span> <span class="nc">Normal</span> <span class="n">n1</span><span class="o">;</span> <span class="nc">Normal</span> <span class="n">n2</span><span class="o">]</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">unmatchedDamageSpecial</span> <span class="o">=</span>
</span><span class='line'>    <span class="n">gen</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">let</span><span class="o">!</span> <span class="n">special</span> <span class="o">=</span> <span class="nn">Arb</span><span class="p">.</span><span class="n">generate</span><span class="o">&lt;</span><span class="nc">SpecialAttackCard</span><span class="o">&gt;</span>
</span><span class='line'>        <span class="k">let</span><span class="o">!</span> <span class="n">normal1</span> <span class="o">=</span> <span class="nn">Arb</span><span class="p">.</span><span class="n">generate</span><span class="o">&lt;</span><span class="nc">NormalCard</span><span class="o">&gt;</span>
</span><span class='line'>        <span class="k">let</span><span class="o">!</span> <span class="n">normal2</span> <span class="o">=</span> <span class="nn">Arb</span><span class="p">.</span><span class="n">generate</span><span class="o">&lt;</span><span class="nc">NormalCard</span><span class="o">&gt;</span>
</span><span class='line'>        <span class="k">let</span><span class="o">!</span> <span class="n">unmatched1</span> <span class="o">=</span> <span class="n">allSuitsBut</span> <span class="n">special</span><span class="o">.</span><span class="nc">DamageSuit</span>
</span><span class='line'>        <span class="k">let</span><span class="o">!</span> <span class="n">unmatched2</span> <span class="o">=</span> <span class="n">allSuitsBut</span> <span class="n">special</span><span class="o">.</span><span class="nc">DamageSuit</span>
</span><span class='line'>        <span class="k">let</span> <span class="n">n1</span> <span class="o">=</span> <span class="o">{</span> <span class="n">normal1</span> <span class="k">with</span> <span class="nc">Suit</span> <span class="o">=</span> <span class="n">unmatched1</span> <span class="o">}</span>
</span><span class='line'>        <span class="k">let</span> <span class="n">n2</span> <span class="o">=</span> <span class="o">{</span> <span class="n">normal2</span> <span class="k">with</span> <span class="nc">Suit</span> <span class="o">=</span> <span class="n">unmatched2</span> <span class="o">}</span>
</span><span class='line'>        <span class="k">return</span> <span class="o">[</span><span class="nc">Special</span> <span class="n">special</span><span class="o">;</span> <span class="nc">Normal</span> <span class="n">n1</span><span class="o">;</span> <span class="nc">Normal</span> <span class="n">n2</span><span class="o">]</span>
</span><span class='line'>    <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>There&#39;s lots of ways to combine three cards which are not valid combos or specials. Here we use are <code>allSuitsBut</code> helper function to always play just the wrong cards compared to what&#39;s needed.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">let</span> <span class="n">swappedSpecial</span> <span class="o">=</span>
</span><span class='line'>    <span class="n">gen</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">let</span><span class="o">!</span> <span class="n">specialCard</span> <span class="o">=</span> <span class="nn">Arb</span><span class="p">.</span><span class="n">generate</span><span class="o">&lt;</span><span class="nc">SpecialAttackCard</span><span class="o">&gt;</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">specialCard</span><span class="o">.</span><span class="nc">SpeedSuit</span> <span class="o">=</span> <span class="n">specialCard</span><span class="o">.</span><span class="nc">DamageSuit</span> <span class="k">then</span>
</span><span class='line'>            <span class="k">return</span> <span class="o">[</span><span class="nc">Special</span> <span class="n">specialCard</span><span class="o">]</span>
</span><span class='line'>        <span class="k">else</span>
</span><span class='line'>            <span class="k">let</span><span class="o">!</span> <span class="n">speedValue</span> <span class="o">=</span> <span class="nn">Gen</span><span class="p">.</span><span class="n">choose</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="mi">10</span><span class="o">)</span>
</span><span class='line'>            <span class="k">let</span><span class="o">!</span> <span class="n">damageValue</span> <span class="o">=</span> <span class="nn">Gen</span><span class="p">.</span><span class="n">choose</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">speedValue</span><span class="o">)</span>
</span><span class='line'>            <span class="k">let</span> <span class="n">cards</span> <span class="o">=</span>
</span><span class='line'>                <span class="o">[</span> <span class="nc">Normal</span> <span class="o">{</span> <span class="nc">Suit</span> <span class="o">=</span> <span class="n">specialCard</span><span class="o">.</span><span class="nc">SpeedSuit</span><span class="o">;</span> <span class="nc">Value</span> <span class="o">=</span> <span class="n">speedValue</span> <span class="o">}</span>
</span><span class='line'>                  <span class="nc">Normal</span> <span class="o">{</span> <span class="nc">Suit</span> <span class="o">=</span> <span class="n">specialCard</span><span class="o">.</span><span class="nc">DamageSuit</span><span class="o">;</span> <span class="nc">Value</span> <span class="o">=</span> <span class="n">damageValue</span> <span class="o">}</span>
</span><span class='line'>                  <span class="nc">Special</span> <span class="n">specialCard</span> <span class="o">]</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">cards</span>
</span><span class='line'>    <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>And here we create special attacks which are slower than they are damaging. If the speed and damage suit are the same, the cards could be used either way around to create a valid action, so instead we just return the Special card on it&#39;s own without companions to form a different invalid play.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">let</span> <span class="n">makeInvalidAction</span> <span class="o">=</span>
</span><span class='line'>    <span class="n">gen</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">let</span><span class="o">!</span> <span class="n">invalidAction</span> <span class="o">=</span>
</span><span class='line'>            <span class="nn">Gen</span><span class="p">.</span><span class="n">oneof</span> <span class="o">[</span> <span class="n">multipleNormal</span>
</span><span class='line'>                        <span class="n">incompleteComboOrSpecial</span>
</span><span class='line'>                        <span class="n">onlyKnockdown</span>
</span><span class='line'>                        <span class="n">unmatchedSpeedCombo</span>
</span><span class='line'>                        <span class="n">unmatchedSpeedSpecial</span>
</span><span class='line'>                        <span class="n">unmatchedDamageCombo</span>
</span><span class='line'>                        <span class="n">unmatchedDamageSpecial</span>
</span><span class='line'>                        <span class="n">swappedSpecial</span> <span class="o">]</span>
</span><span class='line'>        <span class="k">return</span> <span class="nc">InvalidAction</span> <span class="n">invalidAction</span>
</span><span class='line'>    <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>There&#39;s more that could be added here, but I decided that was enough to keep me going for the moment and so added my invalid action generator here.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">type</span> <span class="nc">ActionArbs</span><span class="bp">()</span> <span class="o">=</span>
</span><span class='line'>    <span class="k">static</span> <span class="k">member</span> <span class="nc">GeneratedAction</span><span class="bp">()</span> <span class="o">:</span> <span class="nc">Arbitrary</span><span class="o">&lt;</span><span class="nc">GeneratedAction</span><span class="o">&gt;</span> <span class="o">=</span>
</span><span class='line'>        <span class="n">gen</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">return</span><span class="o">!</span> <span class="nn">Gen</span><span class="p">.</span><span class="n">oneof</span> <span class="o">[</span>
</span><span class='line'>                        <span class="n">makeValidAction</span>
</span><span class='line'>                        <span class="n">makeInvalidAction</span>
</span><span class='line'>                    <span class="o">]</span>
</span><span class='line'>
</span><span class='line'>        <span class="o">}</span> <span class="o">|&gt;</span> <span class="nn">Arb</span><span class="p">.</span><span class="n">fromGen</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">actionConfig</span> <span class="o">=</span>
</span><span class='line'>    <span class="o">{</span> <span class="nn">FsCheckConfig</span><span class="p">.</span><span class="n">defaultConfig</span> <span class="k">with</span>
</span><span class='line'>        <span class="n">arbitrary</span> <span class="o">=</span> <span class="o">[</span><span class="n">typeof</span><span class="o">&lt;</span><span class="nc">DomainArbs</span><span class="o">&gt;</span>
</span><span class='line'>                     <span class="n">typeof</span><span class="o">&lt;</span><span class="nc">ActionArbs</span><span class="o">&gt;]</span> <span class="o">}</span>
</span><span class='line'><span class="o">[&lt;</span><span class="nc">Tests</span><span class="o">&gt;]</span>
</span><span class='line'><span class="k">let</span> <span class="n">toAction</span> <span class="o">=</span>
</span><span class='line'>    <span class="n">testPropertyWithConfig</span> <span class="n">actionConfig</span> <span class="s2">&quot;toAction function&quot;</span> <span class="o">&lt;|</span> <span class="k">fun</span> <span class="n">action</span> <span class="o">-&gt;</span>
</span><span class='line'>        <span class="k">match</span> <span class="n">action</span> <span class="k">with</span>
</span><span class='line'>        <span class="o">|</span> <span class="nc">ValidAction</span> <span class="o">(</span><span class="n">cards</span><span class="o">,</span> <span class="n">action</span><span class="o">)</span> <span class="o">-&gt;</span>
</span><span class='line'>            <span class="nn">Expect</span><span class="p">.</span><span class="n">equal</span> <span class="o">(</span><span class="n">toAction</span> <span class="n">cards</span><span class="o">)</span> <span class="o">(</span><span class="nc">Some</span> <span class="n">action</span><span class="o">)</span> <span class="s2">&quot;Is an action&quot;</span>
</span><span class='line'>        <span class="o">|</span> <span class="nc">InvalidAction</span> <span class="n">cards</span> <span class="o">-&gt;</span>
</span><span class='line'>            <span class="nn">Expect</span><span class="p">.</span><span class="n">isNone</span> <span class="o">(</span><span class="n">toAction</span> <span class="n">cards</span><span class="o">)</span> <span class="s2">&quot;Is not an attack&quot;</span>
</span></code></pre></td></tr></table></div></figure>

<p>Finally, I wired up the generators and defined the single property this function should obey: it should return the correct action for a valid play, or <code>None</code> if the play is erroneous.</p>

<h2>The wrap</h2>

<p>Hopefully this is a useful example for those of you using property based tests of how you can encode business logic into them: although this looks like a lot of code, creating even single examples of each of these cases would have been nearly as long and far less effective in testing.</p>

<p>It does tend to lead to a rather iterative approach to development, where as your code starts working for some of the use cases, you begin to notice errors in or missing cases you need to generate, which helps you find more edges cases in your code and round the circle you go again.</p>

<p>If you want, you&#39;re very welcome to take this code to use as a coding Kata - but be warned, it&#39;s not as simple a challenge as you might expect from the few paragraphs at the top of the post!</p>
</div>
  
  


    </article>
  
  
    <article>
      

  <header>
    
      <h1 class="entry-title"><a href="/all-saints-day-sale/">All Saints&#8217; Day Sale</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2017-11-01T09:01:10+00:00" pubdate data-updated="true">Nov 1<span>st</span>, 2017</time>
        
      </p>
    
  </header>


  <div class="entry-content"><blockquote>
<p>TL;DR: 10% off <a href="/building-solid-systems-in-f-number/">Building Solid Systems in F#</a> until 7th November 2017</p>
</blockquote>

<p>Lots of people these days seem to like giving Halloween sales, but historically and theologically, Halloween is really just the precursor to the real celebration: <a href="https://en.wikipedia.org/wiki/All_Saints%27_Day">All Saints&#39; Day</a>.</p>

<p>So in the interest of getting the details right, we&#39;re having an All Saints&#39; Day sale, starting today for 7 days. It&#39;s already live, get your 10% off <a href="/building-solid-systems-in-f-number/">your tickets</a> now.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/2/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Hire the Author</h1>
  <p>
    Want some help in any of the areas you&#8217;ve read about? Hop across to
    <a href="https://mavnn.co.uk">mavnn.co.uk</a> where you can hire the
    author.
  </p>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/full-stack-with-freya/">Full Stack With Freya</a>
      </li>
    
      <li class="post">
        <a href="/routemaster-and-the-tale-of-the-globally-unique-voters/">RouteMaster and the Tale of the Globally Unique Voters</a>
      </li>
    
      <li class="post">
        <a href="/cloud-native-net/">Cloud Native .NET</a>
      </li>
    
      <li class="post">
        <a href="/getting-started-with-f-number-in-kubernetes/">Getting Started With F# in Kubernetes</a>
      </li>
    
      <li class="post">
        <a href="/token-bearer-authentication-in-freya/">Token Bearer Authentication in Freya</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/mavnn">@mavnn</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'mavnn',
            count: 3,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>



  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2018 - mavnn -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  





  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>



<script type="text/javascript">
 (function() {
   const searchbox = document.getElementById("searchbox");
   const site_query = document.getElementById("site_query").value;
   const search_query = document.getElementById("search_query");

   searchbox.onsubmit = function() {
     const q = encodeURIComponent(search_query.value);
     document.location.assign("https://google.com/search?q=" + site_query + "+" + q);
     return false;
   };
 })()
</script>


</body>
</html>
