
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Mavnn's blog</title>
  <meta name="author" content="mavnn">

  
  <meta name="description" content="This is part 2 in my quotations series, following on from Tap, Tap, Tapping on the Door. As promised in the first part of this series, here we&rsquo; &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://blog.mavnn.co.uk">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Mavnn's blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-37561687-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Mavnn's blog</a></h1>
  
    <h2>Stuff from my brain</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:blog.mavnn.co.uk" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/cutting-quotations-down-to-size/">Cutting Quotations Down to Size</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-10-07T21:30:58+01:00" pubdate data-updated="true">Oct 7<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><blockquote><p>This is part 2 in my quotations series, following on from <a href="/tap/">Tap, Tap, Tapping on the Door</a>.</p></blockquote>

<p>As promised in the first part of this series, here we&rsquo;re going to take a look at manipulating quotations. I mean, we&rsquo;ve got this <a href="http://en.wikipedia.org/wiki/Abstract_syntax_tree">AST</a> &ndash; now what are we going to do with it?</p>

<p>Let&rsquo;s start with something fairly straightforward; <a href="http://en.wikipedia.org/wiki/Boolean_algebra">boolean algebra</a>.</p>

<p>First, let&rsquo;s get a look at how some boolean expressions are represented in quotations.</p>

<p>Firing up F# Interactive, we&rsquo;ll feed a few in and see what happens:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="o">&lt;@@</span> <span class="bp">true</span> <span class="o">@@&gt;;;</span>
</span><span class='line'><span class="c">(* val it : Expr =</span>
</span><span class='line'><span class="c">      Value (true)</span>
</span><span class='line'><span class="c">        {CustomAttributes = [NewTuple (Value (&quot;DebugRange&quot;),</span>
</span><span class='line'><span class="c">              NewTuple (Value (&quot;stdin&quot;), Value (4), Value (4), Value (4), Value (8)))];</span>
</span><span class='line'><span class="c">         Type = System.Boolean;} *)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Hmm. That&rsquo;s&hellip; not as nice as we might want. The custom attributes are being added by F# interactive for debugging purposes, but hopefully the general shape is clear: our expression consists of a single value of <code>true</code>.</p>

<p>I&rsquo;ll cut out the custom attributes from now on to make reading things a bit easier.</p>

<p>Next!</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="o">&lt;@@</span> <span class="bp">true</span> <span class="o">&amp;&amp;</span> <span class="bp">true</span> <span class="o">@@&gt;;;</span>
</span><span class='line'><span class="c">(* val it : Expr =</span>
</span><span class='line'><span class="c">      IfThenElse (Value (true), Value (true), Value (false))</span>
</span><span class='line'><span class="c">        {CustomAttributes = ...;</span>
</span><span class='line'><span class="c">         Type = System.Boolean;} *)</span>
</span></code></pre></td></tr></table></div></figure>


<p>So. Looks like someone has decided to represent the <code>&amp;&amp;</code> operator with the expression tree of an <code>if</code> statement. Useful in some ways; after all, any logic we can apply to an <code>&amp;&amp;</code> operator will equally apply to a logically equivalent <code>if</code> statement. Checking the <a href="http://msdn.microsoft.com/en-us/library/ee370408.aspx">MSDN documentation for Expr.IfThenElse</a> tells if that the 3 values above are <code>guard</code>, <code>thenExpr</code> and <code>elseExpr</code>. Which kind of makes sense; our <code>&lt;@@ true &amp;&amp; true @@&gt;</code> is being turned (loosely) into <code>if true then true else false</code> &ndash; which is equivalent.</p>

<p>Let&rsquo;s put something other than plain boolean constants in to see if we can make it clearer.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="o">&lt;@@</span> <span class="s2">&quot;b&quot;</span> <span class="o">=</span> <span class="s2">&quot;b&quot;</span> <span class="o">&amp;&amp;</span> <span class="s2">&quot;t&quot;</span> <span class="o">=</span> <span class="s2">&quot;t&quot;</span> <span class="o">@@&gt;;;</span>
</span><span class='line'><span class="c">(* val it : Expr =</span>
</span><span class='line'><span class="c">      IfThenElse (Call (None, op_Equality, [Value (&quot;b&quot;), Value (&quot;b&quot;)]),</span>
</span><span class='line'><span class="c">                Call (None, op_Equality, [Value (&quot;t&quot;), Value (&quot;t&quot;)]), Value (false))</span>
</span><span class='line'><span class="c">        {CustomAttributes = ...;</span>
</span><span class='line'><span class="c">         Type = System.Boolean;} *)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Looks hopeful. As a last check, let&rsquo;s take advantage of the fact that quotations are structurally comparable to double check our understanding:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="o">&lt;@@</span> <span class="k">if</span> <span class="s2">&quot;b&quot;</span> <span class="o">=</span> <span class="s2">&quot;b&quot;</span> <span class="k">then</span> <span class="s2">&quot;t&quot;</span> <span class="o">=</span> <span class="s2">&quot;t&quot;</span> <span class="k">else</span> <span class="bp">false</span> <span class="o">@@&gt;</span> <span class="o">=</span> <span class="o">&lt;@@</span> <span class="s2">&quot;b&quot;</span> <span class="o">=</span> <span class="s2">&quot;b&quot;</span> <span class="o">&amp;&amp;</span> <span class="s2">&quot;t&quot;</span> <span class="o">=</span> <span class="s2">&quot;t&quot;</span> <span class="o">@@&gt;;;</span>
</span><span class='line'><span class="c">(* val it : bool = true *)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Awesome!</p>

<p>I&rsquo;m going to take a wild punt that the <code>||</code> operator does something similar:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="o">&lt;@@</span> <span class="k">if</span> <span class="s2">&quot;b&quot;</span> <span class="o">=</span> <span class="s2">&quot;t&quot;</span> <span class="k">then</span> <span class="bp">true</span> <span class="k">else</span> <span class="s2">&quot;t&quot;</span> <span class="o">=</span> <span class="s2">&quot;b&quot;</span> <span class="o">@@&gt;</span> <span class="o">=</span> <span class="o">&lt;@@</span> <span class="s2">&quot;b&quot;</span> <span class="o">=</span> <span class="s2">&quot;t&quot;</span> <span class="o">||</span> <span class="s2">&quot;t&quot;</span> <span class="o">=</span> <span class="s2">&quot;b&quot;</span> <span class="o">@@&gt;;;</span>
</span><span class='line'><span class="c">(* val it : bool = true *)</span>
</span></code></pre></td></tr></table></div></figure>


<p>And it does. Excellent.</p>

<p>We&rsquo;ve now got an idea what the expression trees are going to look like, but how do we go about manipulating them? The answer is the answer we always hope for when traversing data structure in F#: pattern matching.</p>

<p>The <code>Expr</code> types are all recognized by a set of <a href="http://msdn.microsoft.com/en-us/library/ee370259.aspx">active patterns</a> in the <code>Microsoft.FSharp.Quotations.Patterns</code> module. The only problem is that there are about 40 cases in the active patterns, and at the moment we&rsquo;re only interested in one: the <code>IfThenElse</code> case.</p>

<p>That&rsquo;s sounding rather verbose for a language that&rsquo;s normally as succinct as F# and fortunately the language designers agreed. As well as the specific cases in the main <code>Patterns</code> module, there are a number of other modules under the <code>Microsoft.FSharp.Quotations</code> namespace that contain &ldquo;broader&rdquo; active patterns, and helper methods for rebuilding expressions.</p>

<p>Let&rsquo;s take the broadest set, from the <code>ExprShape</code> module, and have a look at a method that takes in an expression, recursively works it way through the tree, and rebuilds it exactly as it was before:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">open</span> <span class="nn">Microsoft</span><span class="p">.</span><span class="nn">FSharp</span><span class="p">.</span><span class="nc">Quotations</span>
</span><span class='line'><span class="k">open</span> <span class="nn">Microsoft</span><span class="p">.</span><span class="nn">FSharp</span><span class="p">.</span><span class="nn">Quotations</span><span class="p">.</span><span class="nc">ExprShape</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="k">rec</span> <span class="n">id</span> <span class="n">q</span> <span class="o">=</span>
</span><span class='line'>    <span class="k">match</span> <span class="n">q</span> <span class="k">with</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">ShapeVar</span> <span class="n">v</span> <span class="o">-&gt;</span> <span class="nn">Expr</span><span class="p">.</span><span class="nc">Var</span> <span class="n">v</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">ShapeLambda</span> <span class="o">(</span><span class="n">v</span><span class="o">,</span> <span class="n">e</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nn">Expr</span><span class="p">.</span><span class="nc">Lambda</span><span class="o">(</span><span class="n">v</span><span class="o">,</span> <span class="n">id</span> <span class="n">e</span><span class="o">)</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">ShapeCombination</span> <span class="o">(</span><span class="n">o</span><span class="o">,</span> <span class="n">es</span><span class="o">)</span> <span class="o">-&gt;</span>
</span><span class='line'>        <span class="nc">RebuildShapeCombination</span><span class="o">(</span><span class="n">o</span><span class="o">,</span> <span class="n">es</span> <span class="o">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="n">id</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>So, as we recurse down there are three possibilities for our expression on any one pass through the <code>id</code> function:</p>

<ul>
<li>We&rsquo;ve hit a <code>Var</code>: this is a leaf node holding a variable, we&rsquo;re done with this branch of the tree.</li>
<li>We&rsquo;ve hit a lambda function, with a variable being bound and an expression representing the body of the function. We apply <code>id</code> to the body to continue recursing down.</li>
<li>We&rsquo;ve hit something else; anything else. The <code>ShapeCombination</code> pattern knows how to take the structure apart, and the <code>RebuildShapeCombination</code> method from the same module knows how to use the object <code>ShapeCombination</code> spits to put it back together again. In the mean time, we still apply <code>id</code> to all the sub-expressions of the combination, whatever they may be.</li>
</ul>


<p>(As an aside, don&rsquo;t actually call your functions <code>id</code> &ndash; there&rsquo;s already a function called that in the standard library.)</p>

<p>Of course, on it&rsquo;s own that&rsquo;s not very exciting. But how about if before moving onto these very broad shapes, we first check some specific cases?</p>

<p>Let&rsquo;s see if we can detect <code>true</code> literals within an expression.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">open</span> <span class="nn">Microsoft</span><span class="p">.</span><span class="nn">FSharp</span><span class="p">.</span><span class="nc">Quotations</span>
</span><span class='line'><span class="k">open</span> <span class="nn">Microsoft</span><span class="p">.</span><span class="nn">FSharp</span><span class="p">.</span><span class="nn">Quotations</span><span class="p">.</span><span class="nc">ExprShape</span>
</span><span class='line'><span class="k">open</span> <span class="nn">Microsoft</span><span class="p">.</span><span class="nn">FSharp</span><span class="p">.</span><span class="nn">Quotations</span><span class="p">.</span><span class="nc">Patterns</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="k">rec</span> <span class="n">detectTrue</span> <span class="n">q</span> <span class="o">=</span>
</span><span class='line'>    <span class="k">match</span> <span class="n">q</span> <span class="k">with</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">Value</span> <span class="o">(</span><span class="n">o</span><span class="o">,</span> <span class="n">t</span><span class="o">)</span> <span class="k">when</span> <span class="n">t</span> <span class="o">=</span> <span class="n">typeof</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">o</span> <span class="o">:?&gt;</span> <span class="kt">bool</span><span class="o">)</span> <span class="o">=</span> <span class="bp">true</span> <span class="o">-&gt;</span>
</span><span class='line'>        <span class="bp">true</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">ShapeVar</span> <span class="o">_</span> <span class="o">-&gt;</span>
</span><span class='line'>        <span class="bp">false</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">ShapeLambda</span> <span class="o">(_,</span> <span class="n">e</span><span class="o">)</span> <span class="o">-&gt;</span>
</span><span class='line'>        <span class="n">detectTrue</span> <span class="n">e</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">ShapeCombination</span> <span class="o">(</span><span class="n">o</span><span class="o">,</span> <span class="n">es</span><span class="o">)</span> <span class="o">-&gt;</span>
</span><span class='line'>        <span class="n">es</span>
</span><span class='line'>        <span class="o">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="n">detectTrue</span>
</span><span class='line'>        <span class="o">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">fold</span> <span class="o">(||)</span> <span class="bp">false</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <code>Value</code> pattern gives us an object representing a literal and it&rsquo;s type as a tuple. We&rsquo;ll add a guard condition to the pattern to specify that we&rsquo;re only interested when the type is <code>bool</code> and (taking advantage of short circuiting to make sure we don&rsquo;t try and cast if it&rsquo;s not a bool!) when the value is <code>true</code>. After that, we move back to our broader patterns, but this time we&rsquo;re happy to throw away most of the information at each step as we&rsquo;re not interested in
reconstructing the tree afterwards.</p>

<p>Loading up the function in F# Interactive, we can feed it some test inputs and see how we&rsquo;re doing.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="n">detectTrue</span> <span class="o">&lt;@@</span> <span class="k">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="bp">true</span> <span class="o">@@&gt;;;</span>
</span><span class='line'><span class="c">(* val it : bool = true *)</span>
</span><span class='line'><span class="n">detectTrue</span> <span class="o">&lt;@@</span> <span class="k">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="bp">false</span> <span class="o">@@&gt;;;</span>
</span><span class='line'><span class="c">(* val it : bool = false *)</span>
</span><span class='line'><span class="n">detectTrue</span> <span class="o">&lt;@@</span> <span class="k">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="bp">false</span> <span class="o">||</span> <span class="bp">true</span> <span class="o">@@&gt;;;</span>
</span><span class='line'><span class="c">(* val it : bool = true *)</span>
</span><span class='line'><span class="n">detectTrue</span> <span class="o">&lt;@@</span> <span class="k">fun</span> <span class="n">x</span> <span class="n">y</span> <span class="o">-&gt;</span> <span class="n">y</span> <span class="o">||</span> <span class="n">x</span> <span class="bp">true</span> <span class="o">@@&gt;;;</span>
</span><span class='line'><span class="c">(* val it : bool = true *)</span>
</span><span class='line'><span class="n">detectTrue</span> <span class="o">&lt;@@</span> <span class="k">fun</span> <span class="n">x</span> <span class="n">y</span> <span class="o">-&gt;</span> <span class="n">y</span> <span class="o">||</span> <span class="n">x</span> <span class="o">=</span> <span class="bp">true</span> <span class="o">@@&gt;;;</span>
</span><span class='line'><span class="c">(* val it : bool = true *)</span>
</span><span class='line'><span class="n">detectTrue</span> <span class="o">&lt;@@</span> <span class="s2">&quot;bob&quot;</span> <span class="o">@@&gt;;;</span>
</span><span class='line'><span class="c">(* val it : bool = false *)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Looking good.</p>

<p>Looks like we need just one final step before we start playing with the rules of boolean algebra; let&rsquo;s check we can detect the <code>||</code> and <code>&amp;&amp;</code> operators.</p>

<p>First, let&rsquo;s give ourselves some helper active patterns of our own to detect literal <code>true</code> and <code>false</code> values:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">open</span> <span class="nn">Microsoft</span><span class="p">.</span><span class="nn">FSharp</span><span class="p">.</span><span class="nc">Quotations</span>
</span><span class='line'><span class="k">open</span> <span class="nn">Microsoft</span><span class="p">.</span><span class="nn">FSharp</span><span class="p">.</span><span class="nn">Quotations</span><span class="p">.</span><span class="nc">ExprShape</span>
</span><span class='line'><span class="k">open</span> <span class="nn">Microsoft</span><span class="p">.</span><span class="nn">FSharp</span><span class="p">.</span><span class="nn">Quotations</span><span class="p">.</span><span class="nc">Patterns</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="o">(|</span><span class="nc">True&#39;</span><span class="o">|_|)</span> <span class="n">expr</span> <span class="o">=</span>
</span><span class='line'>    <span class="k">match</span> <span class="n">expr</span> <span class="k">with</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">Value</span> <span class="o">(</span><span class="n">o</span><span class="o">,</span> <span class="n">t</span><span class="o">)</span> <span class="k">when</span> <span class="n">t</span> <span class="o">=</span> <span class="n">typeof</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">o</span> <span class="o">:?&gt;</span> <span class="kt">bool</span><span class="o">)</span> <span class="o">=</span> <span class="bp">true</span> <span class="o">-&gt;</span>
</span><span class='line'>        <span class="nc">Some</span> <span class="n">expr</span>
</span><span class='line'>    <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span>
</span><span class='line'>        <span class="nc">None</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="o">(|</span><span class="nc">False&#39;</span><span class="o">|_|)</span> <span class="n">expr</span> <span class="o">=</span>
</span><span class='line'>    <span class="k">match</span> <span class="n">expr</span> <span class="k">with</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">Value</span> <span class="o">(</span><span class="n">o</span><span class="o">,</span> <span class="n">t</span><span class="o">)</span> <span class="k">when</span> <span class="n">t</span> <span class="o">=</span> <span class="n">typeof</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">o</span> <span class="o">:?&gt;</span> <span class="kt">bool</span><span class="o">)</span> <span class="o">=</span> <span class="bp">false</span> <span class="o">-&gt;</span>
</span><span class='line'>        <span class="nc">Some</span> <span class="n">expr</span>
</span><span class='line'>    <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span>
</span><span class='line'>        <span class="nc">None</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now, let&rsquo;s add some more for <code>||</code> and <code>&amp;&amp;</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">let</span> <span class="o">(|</span><span class="nc">Or&#39;</span><span class="o">|_|)</span> <span class="n">expr</span> <span class="o">=</span>
</span><span class='line'>    <span class="k">match</span> <span class="n">expr</span> <span class="k">with</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">IfThenElse</span> <span class="o">(</span><span class="n">left</span><span class="o">,</span> <span class="nc">True&#39;</span> <span class="o">_,</span> <span class="n">right</span><span class="o">)</span> <span class="o">-&gt;</span>
</span><span class='line'>        <span class="nc">Some</span> <span class="o">(</span><span class="n">left</span><span class="o">,</span> <span class="n">right</span><span class="o">)</span>
</span><span class='line'>    <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span>
</span><span class='line'>        <span class="nc">None</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="o">(|</span><span class="nc">And&#39;</span><span class="o">|_|)</span> <span class="n">expr</span> <span class="o">=</span>
</span><span class='line'>    <span class="k">match</span> <span class="n">expr</span> <span class="k">with</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">IfThenElse</span> <span class="o">(</span><span class="n">left</span><span class="o">,</span> <span class="n">right</span><span class="o">,</span> <span class="nc">False&#39;</span> <span class="o">_)</span> <span class="o">-&gt;</span>
</span><span class='line'>        <span class="nc">Some</span> <span class="o">(</span><span class="n">left</span><span class="o">,</span> <span class="n">right</span><span class="o">)</span>
</span><span class='line'>    <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span>
</span><span class='line'>        <span class="nc">None</span>
</span></code></pre></td></tr></table></div></figure>


<p>Because you can nest patterns within a pattern match, here we&rsquo;re only matching <code>IfThenElse</code> expressions where the &lsquo;then&rsquo; clause (<code>||</code>) is always <code>true</code> or the &lsquo;else&rsquo; clause (<code>&amp;&amp;</code>) is always <code>false</code>.</p>

<p>And now, with all our pieces in place, let&rsquo;s pick one of the rules of boolean algebra and see if we can apply it. Commutativity sounds like it&rsquo;s probably the simplest:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">let</span> <span class="n">commute</span> <span class="n">quote</span> <span class="o">=</span>
</span><span class='line'>    <span class="k">match</span> <span class="n">quote</span> <span class="k">with</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">Or&#39;</span> <span class="o">(</span><span class="n">left</span><span class="o">,</span> <span class="n">right</span><span class="o">)</span> <span class="o">-&gt;</span>
</span><span class='line'>        <span class="o">&lt;@@</span> <span class="o">%%</span><span class="n">right</span> <span class="o">||</span> <span class="o">%%</span><span class="n">left</span> <span class="o">@@&gt;</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">And&#39;</span> <span class="o">(</span><span class="n">left</span><span class="o">,</span> <span class="n">right</span><span class="o">)</span> <span class="o">-&gt;</span>
</span><span class='line'>        <span class="o">&lt;@@</span> <span class="o">%%</span><span class="n">right</span> <span class="o">&amp;&amp;</span> <span class="o">%%</span><span class="n">left</span> <span class="o">@@&gt;</span>
</span><span class='line'>    <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span>
</span><span class='line'>        <span class="n">quote</span>
</span></code></pre></td></tr></table></div></figure>


<p>Pretty simple: if we see a <code>&amp;&amp;</code> or a <code>||</code> as the top expression in a quotation, swap the arguments. There&rsquo;s no recursion, so we won&rsquo;t go through the tree swapping every <code>&amp;&amp;</code> or <code>||</code> expression, although we could if we wanted&hellip;</p>

<p>For example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="c1">// basic usage</span>
</span><span class='line'><span class="o">&lt;@@</span> <span class="bp">true</span> <span class="o">||</span> <span class="bp">false</span> <span class="o">@@&gt;</span> <span class="o">=</span> <span class="n">commute</span> <span class="o">&lt;@@</span> <span class="bp">false</span> <span class="o">||</span> <span class="bp">true</span> <span class="o">@@&gt;;;</span>
</span><span class='line'><span class="c">(* val it : bool = true *)</span>
</span><span class='line'><span class="o">&lt;@@</span> <span class="s2">&quot;bob&quot;</span> <span class="o">=</span> <span class="s2">&quot;fred&quot;</span> <span class="o">||</span> <span class="s2">&quot;fred&quot;</span> <span class="o">=</span> <span class="s2">&quot;bob&quot;</span> <span class="o">@@&gt;</span> <span class="o">=</span> <span class="n">commute</span> <span class="o">&lt;@@</span> <span class="s2">&quot;fred&quot;</span> <span class="o">=</span> <span class="s2">&quot;bob&quot;</span> <span class="o">||</span> <span class="s2">&quot;bob&quot;</span> <span class="o">=</span> <span class="s2">&quot;fred&quot;</span> <span class="o">@@&gt;;;</span>
</span><span class='line'><span class="c">(* val it : bool = true *)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// only operates at the top level though</span>
</span><span class='line'><span class="o">&lt;@@</span> <span class="k">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="bp">true</span> <span class="o">||</span> <span class="bp">false</span> <span class="o">@@&gt;</span> <span class="o">=</span> <span class="n">commute</span> <span class="o">&lt;@@</span> <span class="k">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="bp">false</span> <span class="o">||</span> <span class="bp">true</span> <span class="o">@@&gt;;;</span>
</span><span class='line'><span class="c">(* val it : bool = false *)</span>
</span></code></pre></td></tr></table></div></figure>


<p>A nice simple function, to apply a nice simple rule. Generally you&rsquo;ll want to choose when to apply something like the <code>commute</code> function, hence not making it recursive. But what about something like the identity law?</p>

<p>The identity law states that <code>true &amp;&amp; x = x</code> and <code>false || x = x</code> for all x. This looks like it might allow us to remove redundant statements from our boolean expressions without changing the logical result, and if we&rsquo;re interested in carrying out this operation at all we almost certainly want to apply it recursively down through the expression.</p>

<p>Time to break out our broad <code>ExprShape</code> patterns again:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">let</span> <span class="n">identity</span> <span class="n">quote</span> <span class="o">=</span>
</span><span class='line'>    <span class="k">let</span> <span class="k">rec</span> <span class="n">transform</span> <span class="n">q</span> <span class="o">=</span>
</span><span class='line'>        <span class="k">match</span> <span class="n">q</span> <span class="k">with</span>
</span><span class='line'>        <span class="o">|</span> <span class="nc">And&#39;</span> <span class="o">(</span><span class="nc">True&#39;</span> <span class="o">_,</span> <span class="n">p</span><span class="o">)</span>
</span><span class='line'>        <span class="o">|</span> <span class="nc">And&#39;</span> <span class="o">(</span><span class="n">p</span><span class="o">,</span> <span class="nc">True&#39;</span> <span class="o">_)</span>
</span><span class='line'>        <span class="o">|</span> <span class="nc">Or&#39;</span> <span class="o">(</span><span class="nc">False&#39;</span> <span class="o">_,</span> <span class="n">p</span><span class="o">)</span>
</span><span class='line'>        <span class="o">|</span> <span class="nc">Or&#39;</span> <span class="o">(</span><span class="n">p</span><span class="o">,</span> <span class="nc">False&#39;</span> <span class="o">_)</span>
</span><span class='line'>            <span class="o">-&gt;</span> <span class="n">transform</span> <span class="n">p</span>
</span><span class='line'>        <span class="o">|</span> <span class="nc">ShapeVar</span> <span class="n">v</span> <span class="o">-&gt;</span> <span class="nn">Expr</span><span class="p">.</span><span class="nc">Var</span> <span class="n">v</span>
</span><span class='line'>        <span class="o">|</span> <span class="nc">ShapeLambda</span> <span class="o">(</span><span class="n">v</span><span class="o">,</span> <span class="n">e</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nn">Expr</span><span class="p">.</span><span class="nc">Lambda</span><span class="o">(</span><span class="n">v</span><span class="o">,</span> <span class="n">transform</span> <span class="n">e</span><span class="o">)</span>
</span><span class='line'>        <span class="o">|</span> <span class="nc">ShapeCombination</span> <span class="o">(</span><span class="n">o</span><span class="o">,</span> <span class="n">es</span><span class="o">)</span> <span class="o">-&gt;</span>
</span><span class='line'>            <span class="nc">RebuildShapeCombination</span><span class="o">(</span><span class="n">o</span><span class="o">,</span> <span class="n">es</span> <span class="o">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="n">transform</span><span class="o">)</span>
</span><span class='line'>    <span class="n">transform</span> <span class="n">quote</span>
</span></code></pre></td></tr></table></div></figure>


<p>Firstly, we check if the top of the quotation matches any of the four relevant conditions for the identity law. If any of them do, we bind the proposition that we&rsquo;re reducing to to the name <code>p</code>, and then we carry on recursing down the tree.</p>

<p>Otherwise, we&rsquo;re back to the <code>id</code> function above: a <code>Var</code> is a leaf node, we <code>transform</code> the body of any lambdas and if we hit a combination we <code>transform</code> all of it&rsquo;s constituent expressions.</p>

<p>This is starting to reach the stage it&rsquo;s worth unit testing, so let&rsquo;s break out xUnit and add some &ldquo;facts&rdquo; (you&rsquo;ll need to reference xUnit manually or via NuGet to build the tests.)</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">open</span> <span class="nn">Algebra</span><span class="p">.</span><span class="nc">Boolean</span>
</span><span class='line'><span class="k">open</span> <span class="nc">Xunit</span>
</span><span class='line'>
</span><span class='line'><span class="o">[&lt;</span><span class="nc">Fact</span><span class="o">&gt;]</span>
</span><span class='line'><span class="k">let</span> <span class="o">``</span><span class="nc">Identity</span> <span class="n">reduction</span> <span class="o">&amp;&amp;``</span> <span class="bp">()</span> <span class="o">=</span>
</span><span class='line'>    <span class="nn">Assert</span><span class="p">.</span><span class="nc">Equal</span> <span class="o">(&lt;@@</span> <span class="bp">false</span> <span class="o">@@&gt;,</span> <span class="n">identity</span> <span class="o">&lt;@@</span> <span class="bp">true</span> <span class="o">&amp;&amp;</span> <span class="bp">false</span> <span class="o">@@&gt;)</span>
</span><span class='line'>
</span><span class='line'><span class="o">[&lt;</span><span class="nc">Fact</span><span class="o">&gt;]</span>
</span><span class='line'><span class="k">let</span> <span class="o">``</span><span class="nc">Identity</span> <span class="n">reduction</span> <span class="o">||``</span> <span class="bp">()</span> <span class="o">=</span>
</span><span class='line'>    <span class="nn">Assert</span><span class="p">.</span><span class="nc">Equal</span> <span class="o">(&lt;@@</span> <span class="bp">true</span> <span class="o">@@&gt;,</span> <span class="n">identity</span> <span class="o">&lt;@@</span> <span class="bp">true</span> <span class="o">||</span> <span class="bp">false</span> <span class="o">@@&gt;)</span>
</span><span class='line'>
</span><span class='line'><span class="o">[&lt;</span><span class="nc">Fact</span><span class="o">&gt;]</span>
</span><span class='line'><span class="k">let</span> <span class="o">``</span><span class="nc">Identity</span> <span class="n">reduction</span> <span class="n">recurses</span><span class="o">``</span> <span class="bp">()</span> <span class="o">=</span>
</span><span class='line'>    <span class="nn">Assert</span><span class="p">.</span><span class="nc">Equal</span> <span class="o">(&lt;@@</span> <span class="bp">true</span> <span class="o">@@&gt;,</span> <span class="n">identity</span> <span class="o">&lt;@@</span> <span class="o">(</span><span class="bp">true</span> <span class="o">||</span> <span class="bp">false</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="bp">true</span> <span class="o">@@&gt;)</span>
</span><span class='line'>
</span><span class='line'><span class="o">[&lt;</span><span class="nc">Fact</span><span class="o">&gt;]</span>
</span><span class='line'><span class="k">let</span> <span class="o">``</span><span class="nc">Identity</span> <span class="n">reduction</span> <span class="n">recurses</span> <span class="k">with</span> <span class="n">none</span> <span class="n">boolean</span><span class="o">``</span> <span class="bp">()</span> <span class="o">=</span>
</span><span class='line'>    <span class="nn">Assert</span><span class="p">.</span><span class="nc">Equal</span> <span class="o">(&lt;@@</span> <span class="s2">&quot;bob&quot;</span> <span class="o">=</span> <span class="s2">&quot;fred&quot;</span> <span class="o">@@&gt;,</span> <span class="n">identity</span> <span class="o">&lt;@@</span> <span class="o">(</span><span class="s2">&quot;bob&quot;</span> <span class="o">=</span> <span class="s2">&quot;fred&quot;</span> <span class="o">||</span> <span class="bp">false</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="bp">true</span> <span class="o">@@&gt;)</span>
</span><span class='line'>
</span><span class='line'><span class="o">[&lt;</span><span class="nc">Fact</span><span class="o">&gt;]</span>
</span><span class='line'><span class="k">let</span> <span class="o">``</span><span class="nc">Identity</span> <span class="n">reduction</span> <span class="n">recurses</span> <span class="k">with</span> <span class="n">none</span> <span class="n">boolean</span> <span class="mi">2</span><span class="o">``</span> <span class="bp">()</span> <span class="o">=</span>
</span><span class='line'>    <span class="nn">Assert</span><span class="p">.</span><span class="nc">Equal</span> <span class="o">(&lt;@@</span> <span class="s2">&quot;bob&quot;</span> <span class="o">=</span> <span class="s2">&quot;fred&quot;</span> <span class="o">@@&gt;,</span> <span class="n">identity</span> <span class="o">&lt;@@</span> <span class="o">(</span><span class="bp">false</span> <span class="o">||</span> <span class="s2">&quot;bob&quot;</span> <span class="o">=</span> <span class="s2">&quot;fred&quot;</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="bp">true</span> <span class="o">@@&gt;)</span>
</span></code></pre></td></tr></table></div></figure>


<p>And there you have it, a function that takes an expression tree and manipulates it in a potentially useful fashion.</p>

<p>Why did we go to all this trouble? Well, I&rsquo;m afraid for that, dear reader, you&rsquo;ll have to either wait for the next installment or come along to my session at <a href="https://skillsmatter.com/conferences/1926-progressive-f-tutorials-2014#program">Progressive F# London 2014</a> where we look at translating quotations into other languages.</p>

<p>If you want to look into this further yourself in the mean time, an implementation of all of the rules of boolean algebra and a basic test suite can be found in a <a href="https://gist.github.com/mavnn/9acfb52c8c311879266b">gist on github</a>.</p>

<p>If you&rsquo;re feeling really brave, I also highly recommend looking into &ldquo;A Practical Theory of Language-Integrated Query&rdquo;:</p>

<ul>
<li><a href="https://skillsmatter.com/skillscasts/4486-a-practical-theory-of-language-integrated-query">Talk by Philip Wadler</a></li>
<li><a href="http://homepages.inf.ed.ac.uk/slindley/papers/practical-theory-of-linq.pdf">Academic paper describing the techniques</a> &ndash; the first few sections are very readable even without a background in programming language research, and definitely worth looking at before you get to&hellip;</li>
<li><a href="https://github.com/fsprojects/FSharp.Linq.ComposableQuery">The practical implementation</a> &ndash; if you want to watch people much cleverer than me <strong>really</strong> apply some of these principles.</li>
</ul>


<p>That&rsquo;s all till next time, and I hope your brains recover sooner than mine.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/remote-working/">If I Ruled the World&#8230; Remote Working</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-07-15T20:43:06+01:00" pubdate data-updated="true">Jul 15<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Welcome to a new category of posts for my blog. It&rsquo;s the &ldquo;Rule the World&rdquo; category, where I spout opinions on a subject with gay abandon, even if I can&rsquo;t actually offer that much beyond anecdotal evidence to back the opinion up.</p>

<p>On this occasion I even feel justified as someone has actively asked my opinion about something.</p>

<p>Well, that was foolish now, wasn&rsquo;t it?</p>

</div>
  
  
    <footer>
      <a rel="full-article" href="/remote-working/">Read on &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/property-checking-start-challenge/">Property Checking Start Challenge</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-06-25T12:25:17+01:00" pubdate data-updated="true">Jun 25<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Almost a year ago now, I wrote up a <a href="/fscheck-breaking-your-code-in-new-and-exciting-ways/">blog post</a> on using <a href="https://github.com/fsharp/FsCheck">FsCheck</a>. I still rate it as an excellent tool, but unfortunately we don&rsquo;t manage to use it that much. The reasons for this basically boil down to the fact that a) we tend to forget it exists and b) a good deal of our code is written in C# or VB.net, and the original API is not very friendly from those languages.</p>

<p>So as part of the <a href="http://15below.com/">15below</a> developer education sessions we&rsquo;re going to try an exercise to see if we can bring a bit more property based testing into our code base!</p>

</div>
  
  
    <footer>
      <a rel="full-article" href="/property-checking-start-challenge/">Read on &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/tap/">Tap, Tap, Tapping on the Door</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-05-30T11:45:35+01:00" pubdate data-updated="true">May 30<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In my investigations into <a href="/blog/categories/typeprovider/">type providers</a>, I started digging into a feature of F# called quotations. These blur the boundary between code and data; a representation of an expression tree that you can then evaluate or manipulate.</p>

<p>Why is this useful? Well; it&rsquo;s used in a number of places in various F# libraries. As mentioned above, type providers use them as a mechanism for providing the invocation code for the types that are being provided. The compiler can then take that expression tree and turn in into clr code.</p>

<p>They can also be useful as a way of defining code within your F# that can then be translated into other programming languages. The linq to sql implementation does this (turning your linq into SQL, fairly obviously!) while the FunScript project compiles your F# quotations into JavaScript.</p>

<p>So; linked features, often used in concert: quotations allow you to generate expressions at runtime, manipulate them at run time and evaluate them at run time &ndash; where evaluation covers everything from running the code on the clr to outputting it as a different language.</p>

</div>
  
  
    <footer>
      <a rel="full-article" href="/tap/">Read on &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/functionally-solid-2/">Functionally SOLID 2</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-05-09T13:43:02+01:00" pubdate data-updated="true">May 9<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><em>This post follows on directly from <a href="/going-functionally-solid">Going Functionally SOLID</a></em></p>

<p>In our first session looking at <a href="http://en.wikipedia.org/wiki/Solid_%28object-oriented_design%29">SOLID</a> and functional programming, we tried to apply some SOLID principles to an example piece of code.</p>

<p>We ended up with a set of interfaces like those below, and robot classes could then implement the interfaces to define their capabilities and state. I mentioned the example code was for a giant robot game, yes?</p>

</div>
  
  
    <footer>
      <a rel="full-article" href="/functionally-solid-2/">Read on &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/type-safe-printf-via-type-providers/">Type Safe Printf via Type Providers</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-05-06T15:33:15+01:00" pubdate data-updated="true">May 6<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://twitter.com/puffnfresh">Brian McKenna</a> posted an interesting <a href="http://www.youtube.com/watch?v=fVBck2Zngjo">video</a> and <a href="https://gist.github.com/puffnfresh/11202637">gist</a> on implementing a type safe printf in Idris with dependent types.</p>

<p>This led me down a nice little rabbit hole wondering if something similar could be achieved with an F# type provider.</p>

<p>With a <a href="http://stackoverflow.com/questions/23375469/how-can-i-build-an-arbitary-curried-function-in-an-f-type-provider">bit of help from Tomas</a> the final solution turned out to be surprisingly nice, although not quite so clean as the Idris original.</p>

</div>
  
  
    <footer>
      <a rel="full-article" href="/type-safe-printf-via-type-providers/">Read on &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/going-functionally-solid/">Going Functionally SOLID</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-04-11T11:45:47+01:00" pubdate data-updated="true">Apr 11<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><em>The one giant robot every programmer should know and love! Meet Big O!</em></p>

<p><img src="/images/Big_o.jpg" alt="Big O" /></p>

<p><em>For all your algorithmic complexity needs. And any giant mecha in need of a good pounding.</em></p>

<p>And now, back to your regularly scheduled blog post&hellip;</p>

<p>Inspired both by <a href="http://blog.ploeh.dk/2014/03/10/solid-the-next-step-is-functional/">Mark Seemann&rsquo;s excellent blog post</a> and by my ongoing campaign to introduce functional programming techniques to <a href="http://www.15below.com/">15below</a> developers who aren&rsquo;t familiar with them yet, I decided it was time to run a mini-series on applying good principles like <a href="http://en.wikipedia.org/wiki/Solid_%28object-oriented_design%29">SOLID</a> in a functional world.</p>

<p>We run weekly one hour &ldquo;Developer Education&rdquo; sessions. For this series I started with a badly written piece of code (it came naturally, given I had limited prep time&hellip;) in a style of someone who has kind of heard about SOLID and functional programming:</p>

<ul>
<li><strong>SOLID</strong>: &ldquo;So, eh, I need some interfaces and things. Concrete bad, interface good. In wonder what the whole DI thing is?&rdquo;</li>
<li><strong>Functional</strong>: &ldquo;And, erm. Chainable functions? Fluent APIs, maybe? That&rsquo;s kind of functional, right?&rdquo;</li>
</ul>


</div>
  
  
    <footer>
      <a rel="full-article" href="/going-functionally-solid/">Read on &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/type-providers-from-the-first-floor/">Type Providers From the First Floor</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-03-19T21:06:05+00:00" pubdate data-updated="true">Mar 19<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><em>This post follows on directly from my previous post <a href="http://blog.mavnn.co.uk/type-providers-from-the-ground-up/">Type Providers from the Ground Up</a>. I highly recommend that you read that first, and check out the relevant example code from GitHub.</em></p>

<p><em>It&rsquo;s also a bit epic&hellip; grab yourself a coffee before you start.</em></p>

<p>So we have a working type provider now. Unfortunately, we&rsquo;re missing out on at least two major features that your new type provider will almost certainly want to make use of.</p>

<p>The first is that in our example, we&rsquo;re reading the metadata that defines our types from a fixed file location. In almost every real life case, you will want to be able to parametrize your provider to specify where this instance is getting it&rsquo;s metadata from.</p>

<p>The second is that in many cases getting the metadata will be slow, and the number of types available to generate may be very large. In these situations, you really want to be able to only generate the types that are required as they are requested, especially because this will reduce the size of the final compiled output. This is particularly important for type providers that read from large network based data sources like the Freebase provider.</p>

<p>We&rsquo;ll take the second first, because it&rsquo;s easy &ndash; and we like easy&hellip;</p>

</div>
  
  
    <footer>
      <a rel="full-article" href="/type-providers-from-the-first-floor/">Read on &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/single-file-websites-with-suave/">Single File Websites With Suave</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-02-28T09:54:46+00:00" pubdate data-updated="true">Feb 28<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><blockquote><p>As of a few days ago, the embedded module <a href="https://github.com/SuaveIO/suave/pull/100/files">was merged</a> into Suave master. Enjoy!</p></blockquote>

<p>I&rsquo;m a great fan of <a href="http://suave.io/">Suave</a> for simple web development in F#. I highly recommend checking out the site for details, but in the mean time I&rsquo;d like to share a little trick I&rsquo;ve been using for rapid prototyping that I&rsquo;m finding very useful.</p>

<p>The Suave.Http module contains a few helpers for serving static files from disk. Unfortunately, depending on use case and deployment strategy, relying on the location of a bunch of files on disk can be problematic.</p>

<p>So (open source to the rescue!) I cracked open the code and wrote a small alternative implementation that serves files from the current assembly&rsquo;s embedded resources. I&rsquo;m finding it especially useful for single page JavaScript apps where you have a small number of resources and then a lot of end points providing api functionality.</p>

<p>Setting up your website looks something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">module</span> <span class="nc">Website</span>
</span><span class='line'><span class="k">open</span> <span class="nc">System</span>
</span><span class='line'><span class="k">open</span> <span class="nn">Suave</span><span class="p">.</span><span class="nc">Http</span>
</span><span class='line'><span class="k">open</span> <span class="nn">Suave</span><span class="p">.</span><span class="nc">Types</span>
</span><span class='line'><span class="k">open</span> <span class="nc">Embedded</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">app</span> <span class="o">=</span>
</span><span class='line'>    <span class="n">choose</span> <span class="o">[</span>
</span><span class='line'>        <span class="c1">// serve the embedded index.html for &quot;/&quot;</span>
</span><span class='line'>        <span class="nc">GET</span> <span class="o">&gt;&gt;=</span> <span class="n">url</span> <span class="s2">&quot;/&quot;</span> <span class="o">&gt;&gt;=</span> <span class="n">resource</span> <span class="s2">&quot;index.html&quot;</span>
</span><span class='line'>        <span class="c1">// check if the request matches the name of an embedded resource</span>
</span><span class='line'>        <span class="c1">// if it does, serve it up with a reasonable cache</span>
</span><span class='line'>        <span class="nc">GET</span> <span class="o">&gt;&gt;=</span> <span class="n">browse_embedded</span>
</span><span class='line'>        <span class="c1">// If it doesn&#39;t, try and trigger your api end points</span>
</span><span class='line'>        <span class="nc">GET</span> <span class="o">&gt;&gt;=</span> <span class="n">url</span> <span class="s2">&quot;/json&quot;</span> <span class="o">&gt;&gt;==</span> <span class="o">(</span><span class="k">fun</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">serveJson</span> <span class="o">&lt;|</span> <span class="n">makeData</span><span class="bp">()</span><span class="o">)</span>
</span><span class='line'>        <span class="nc">GET</span> <span class="o">&gt;&gt;=</span> <span class="n">url</span> <span class="s2">&quot;/carrier&quot;</span> <span class="o">&gt;&gt;==</span> <span class="o">(</span><span class="k">fun</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">getCarrierCodes</span> <span class="bp">()</span><span class="o">)</span>
</span><span class='line'>        <span class="c1">// Nothing else has worked - 404</span>
</span><span class='line'>        <span class="nc">NOT_FOUND</span> <span class="s2">&quot;Sorry, couldn&#39;t find your page&quot;</span>
</span><span class='line'>    <span class="o">]</span>
</span><span class='line'>
</span><span class='line'><span class="n">web_server</span> <span class="n">default_config</span> <span class="n">app</span>
</span></code></pre></td></tr></table></div></figure>


<p>And the embedded module looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">module</span> <span class="nc">Embedded</span>
</span><span class='line'>
</span><span class='line'><span class="k">open</span> <span class="nc">System</span>
</span><span class='line'><span class="k">open</span> <span class="nn">System</span><span class="p">.</span><span class="nc">IO</span>
</span><span class='line'><span class="k">open</span> <span class="nn">System</span><span class="p">.</span><span class="nc">Reflection</span>
</span><span class='line'><span class="k">open</span> <span class="nc">Suave</span>
</span><span class='line'><span class="k">open</span> <span class="nn">Suave</span><span class="p">.</span><span class="nc">Http</span>
</span><span class='line'><span class="k">open</span> <span class="nn">Suave</span><span class="p">.</span><span class="nc">Types</span>
</span><span class='line'><span class="k">open</span> <span class="nn">Suave</span><span class="p">.</span><span class="nc">Socket</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="k">private</span> <span class="n">ass</span> <span class="o">=</span> <span class="nn">Assembly</span><span class="p">.</span><span class="nc">GetExecutingAssembly</span><span class="bp">()</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="k">private</span> <span class="n">resources</span> <span class="o">=</span>
</span><span class='line'>    <span class="n">ass</span><span class="o">.</span><span class="nc">GetManifestResourceNames</span><span class="bp">()</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="k">private</span> <span class="nc">CACHE_CONTROL_MAX_AGE</span> <span class="o">=</span> <span class="mi">600</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="k">private</span> <span class="n">lastModified</span> <span class="o">=</span> <span class="nn">DateTime</span><span class="p">.</span><span class="nc">UtcNow</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="k">private</span> <span class="n">send_embedded</span> <span class="n">resourceName</span> <span class="n">r</span> <span class="o">=</span>
</span><span class='line'>    <span class="k">let</span> <span class="n">write_embedded</span> <span class="n">file</span> <span class="o">(</span><span class="n">r</span> <span class="o">:</span> <span class="nc">HttpRequest</span><span class="o">)</span> <span class="o">=</span> <span class="n">async</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">use</span> <span class="n">s</span> <span class="o">=</span> <span class="n">ass</span><span class="o">.</span><span class="nc">GetManifestResourceStream</span><span class="o">(</span><span class="n">resourceName</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="nc">Length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="n">L</span> <span class="k">then</span>
</span><span class='line'>        <span class="k">do</span><span class="o">!</span> <span class="n">async_writeln</span> <span class="n">r</span><span class="o">.</span><span class="n">connection</span> <span class="o">(</span><span class="n">sprintf</span> <span class="s2">&quot;Content-Length: %d&quot;</span> <span class="n">s</span><span class="o">.</span><span class="nc">Length</span><span class="o">)</span> <span class="n">r</span><span class="o">.</span><span class="n">line_buffer</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">do</span><span class="o">!</span> <span class="n">async_writeln</span> <span class="n">r</span><span class="o">.</span><span class="n">connection</span> <span class="s2">&quot;&quot;</span> <span class="n">r</span><span class="o">.</span><span class="n">line_buffer</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="nc">Length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="n">L</span> <span class="k">then</span>
</span><span class='line'>        <span class="k">do</span><span class="o">!</span> <span class="n">transfer_x</span> <span class="n">r</span><span class="o">.</span><span class="n">connection</span> <span class="n">s</span> <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">async</span> <span class="o">{</span> <span class="k">do</span><span class="o">!</span> <span class="n">response_f</span> <span class="mi">200</span> <span class="s2">&quot;OK&quot;</span> <span class="o">(</span><span class="n">write_embedded</span> <span class="n">resourceName</span><span class="o">)</span> <span class="n">r</span> <span class="o">}</span> <span class="o">|&gt;</span> <span class="n">succeed</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">resource</span> <span class="n">resourceName</span> <span class="o">=</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">resources</span> <span class="o">|&gt;</span> <span class="nn">Array</span><span class="p">.</span><span class="n">exists</span> <span class="o">((=)</span> <span class="n">resourceName</span><span class="o">)</span> <span class="k">then</span>
</span><span class='line'>      <span class="k">let</span> <span class="n">send_it</span> <span class="o">_</span> <span class="o">=</span>
</span><span class='line'>        <span class="k">let</span> <span class="n">mimes</span> <span class="o">=</span> <span class="n">mime_type</span> <span class="o">&lt;|</span> <span class="nn">IO</span><span class="p">.</span><span class="nn">Path</span><span class="p">.</span><span class="nc">GetExtension</span> <span class="n">resourceName</span>
</span><span class='line'>        <span class="o">#</span><span class="k">if</span> <span class="nc">DEBUG</span>
</span><span class='line'>        <span class="n">set_mime_type</span> <span class="n">mimes</span>
</span><span class='line'>        <span class="o">&gt;&gt;</span> <span class="n">send_embedded</span> <span class="o">(</span><span class="n">resourceName</span><span class="o">)</span>
</span><span class='line'>        <span class="o">#</span><span class="k">else</span>
</span><span class='line'>        <span class="n">set_header</span> <span class="s2">&quot;Cache-Control&quot;</span> <span class="o">(</span><span class="n">sprintf</span> <span class="s2">&quot;max-age=%d&quot;</span> <span class="nc">CACHE_CONTROL_MAX_AGE</span><span class="o">)</span>
</span><span class='line'>        <span class="o">&gt;&gt;</span> <span class="n">set_header</span> <span class="s2">&quot;Last-Modified&quot;</span> <span class="o">(</span><span class="n">lastModified</span><span class="o">.</span><span class="nc">ToString</span><span class="o">(</span><span class="s2">&quot;R&quot;</span><span class="o">))</span>
</span><span class='line'>        <span class="o">&gt;&gt;</span> <span class="n">set_header</span> <span class="s2">&quot;Expires&quot;</span> <span class="o">(</span><span class="nn">DateTime</span><span class="p">.</span><span class="nn">UtcNow</span><span class="p">.</span><span class="nc">AddSeconds</span><span class="o">(</span><span class="kt">float</span><span class="o">(</span><span class="nc">CACHE_CONTROL_MAX_AGE</span><span class="o">)).</span><span class="nc">ToString</span><span class="o">(</span><span class="s2">&quot;R&quot;</span><span class="o">))</span>
</span><span class='line'>        <span class="o">&gt;&gt;</span> <span class="n">set_mime_type</span> <span class="n">mimes</span>
</span><span class='line'>        <span class="o">&gt;&gt;</span> <span class="n">send_embedded</span> <span class="o">(</span><span class="n">resourceName</span><span class="o">)</span>
</span><span class='line'>        <span class="o">#</span><span class="n">endif</span>
</span><span class='line'>      <span class="n">warbler</span> <span class="o">(</span> <span class="k">fun</span> <span class="o">(</span><span class="n">r</span><span class="o">:</span><span class="nc">HttpRequest</span><span class="o">)</span> <span class="o">-&gt;</span>
</span><span class='line'>        <span class="k">let</span> <span class="n">modified_since</span> <span class="o">=</span> <span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="n">headers</span> <span class="o">?</span> <span class="o">``</span><span class="k">if</span><span class="o">-</span><span class="n">modified</span><span class="o">-</span><span class="n">since</span><span class="o">``</span> <span class="o">)</span>
</span><span class='line'>        <span class="k">match</span> <span class="n">modified_since</span> <span class="k">with</span>
</span><span class='line'>        <span class="o">|</span> <span class="nc">Some</span> <span class="n">v</span> <span class="o">-&gt;</span> <span class="k">let</span> <span class="n">date</span> <span class="o">=</span> <span class="nn">DateTime</span><span class="p">.</span><span class="nc">Parse</span> <span class="n">v</span>
</span><span class='line'>                    <span class="k">if</span> <span class="n">lastModified</span> <span class="o">&gt;</span> <span class="n">date</span> <span class="k">then</span> <span class="n">send_it</span> <span class="bp">()</span>
</span><span class='line'>                    <span class="k">else</span> <span class="nc">NOT_MODIFIED</span>
</span><span class='line'>        <span class="o">|</span> <span class="nc">None</span>   <span class="o">-&gt;</span> <span class="n">send_it</span> <span class="bp">()</span><span class="o">)</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="n">never</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">browse_embedded</span> <span class="o">:</span> <span class="nc">WebPart</span> <span class="o">=</span>
</span><span class='line'>    <span class="n">warbler</span> <span class="o">(</span><span class="k">fun</span> <span class="n">req</span> <span class="o">-&gt;</span> <span class="n">resource</span> <span class="o">(</span><span class="n">req</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="nc">TrimStart</span><span class="o">([|</span> <span class="sc">&#39;/&#39;</span> <span class="o">|])))</span>
</span></code></pre></td></tr></table></div></figure>


<p><a href="https://twitter.com/ad3mar">@ad3mar</a> if you feel like rolling this into Suave, you can consider it licenced under what ever is most convenient. An official licence file would make me much happier using Suave in production, by the way (hint, hint).</p>

<p>Edit: ad3mar has pointed out in the comments that Suave is already Apache2 licensed, I just failed to find the file last time I looked.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/type-provider-protip/">Type Provider ProTip</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-01-10T12:15:15+00:00" pubdate data-updated="true">Jan 10<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>While type providers are incredibly powerful, the ProvidedTypes api for creating them is sometimes a bit rough around the edges. And not always as functional as you might hope.</p>

<p>At some point I&rsquo;d like to do something about that, but for the moment I&rsquo;m just going to collect a few helpful tips and hints (mostly for own reference).</p>

<p>Tip one is in the case where you have XmlDocs to add to ProvidedTypes, ProvidedMethods and ProvidedProperties; in our case we have an optional description field in our metadata and the boiler plate was getting tiresome.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">let</span> <span class="k">inline</span> <span class="n">addDoc</span> <span class="o">(</span><span class="n">desc</span> <span class="o">:</span> <span class="nc">Descriptor</span><span class="o">)</span> <span class="n">def</span> <span class="o">=</span>
</span><span class='line'>    <span class="k">match</span> <span class="n">desc</span><span class="o">.</span><span class="nc">Description</span> <span class="k">with</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">Some</span> <span class="n">d</span> <span class="o">-&gt;</span>
</span><span class='line'>        <span class="o">(^</span><span class="nc">T</span> <span class="o">:</span> <span class="o">(</span><span class="k">member</span> <span class="nc">AddXmlDoc</span> <span class="o">:</span> <span class="kt">string</span> <span class="o">-&gt;</span> <span class="kt">unit</span><span class="o">)</span> <span class="o">(</span><span class="n">def</span><span class="o">,</span> <span class="n">d</span><span class="o">))</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="bp">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>This function takes a <code>Descriptor</code> with a <code>string option</code> Description field and any <code>def</code> with an AddXmlDoc member with the noted signature &ndash; and adds description as the xml doc if it exists.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/2/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/cutting-quotations-down-to-size/">Cutting Quotations Down to Size</a>
      </li>
    
      <li class="post">
        <a href="/remote-working/">If I Ruled the World&#8230; Remote Working</a>
      </li>
    
      <li class="post">
        <a href="/property-checking-start-challenge/">Property Checking Start Challenge</a>
      </li>
    
      <li class="post">
        <a href="/tap/">Tap, Tap, Tapping on the Door</a>
      </li>
    
      <li class="post">
        <a href="/functionally-solid-2/">Functionally SOLID 2</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Tip the author</h1>
  <p><script data-gittip-username="mavnn"
        data-gittip-widget="button"
        src="//gttp.co/v1.js"></script></p>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/mavnn">@mavnn</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'mavnn',
            count: 3,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>



<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/+MichaelNewtonmavnn?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - mavnn -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'mavnn';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
